<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="robots" content="noindex">

	<title>File Kronolith.php</title>

	<link rel="stylesheet" href="resources/style.css?1648332946">

</head>

<body>
<div id="left">
	<div id="menu">
		<a href="index.html" title="Overview"><span>Overview</span></a>


		<div id="groups">
			<h3>Packages</h3>
			<ul>
				<li class="active"><a href="namespace-Kronolith.html">Kronolith</a>
						</li>
				<li><a href="namespace-None.html">None</a>
						</li>
			</ul>
		</div>

		<hr>


		<div id="elements">
			<h3>Classes</h3>
			<ul>
				<li class="active"><a href="class-Kronolith.html">Kronolith</a></li>
				<li><a href="class-Kronolith_Ajax_Application.html">Kronolith_Ajax_Application</a></li>
				<li><a href="class-Kronolith_Ajax_Imple_ContactAutoCompleter.html">Kronolith_Ajax_Imple_ContactAutoCompleter</a></li>
				<li><a href="class-Kronolith_Ajax_Imple_Embed.html">Kronolith_Ajax_Imple_Embed</a></li>
				<li><a href="class-Kronolith_Ajax_Imple_TagActions.html">Kronolith_Ajax_Imple_TagActions</a></li>
				<li><a href="class-Kronolith_Ajax_Imple_TagAutoCompleter.html">Kronolith_Ajax_Imple_TagAutoCompleter</a></li>
				<li><a href="class-Kronolith_Api.html">Kronolith_Api</a></li>
				<li><a href="class-Kronolith_Calendar.html">Kronolith_Calendar</a></li>
				<li><a href="class-Kronolith_Calendar_External.html">Kronolith_Calendar_External</a></li>
				<li><a href="class-Kronolith_Calendar_External_Tasks.html">Kronolith_Calendar_External_Tasks</a></li>
				<li><a href="class-Kronolith_Calendar_Holiday.html">Kronolith_Calendar_Holiday</a></li>
				<li><a href="class-Kronolith_Calendar_Internal.html">Kronolith_Calendar_Internal</a></li>
				<li><a href="class-Kronolith_Calendar_Remote.html">Kronolith_Calendar_Remote</a></li>
				<li><a href="class-Kronolith_Calendar_Resource.html">Kronolith_Calendar_Resource</a></li>
				<li><a href="class-Kronolith_Calendars_Base.html">Kronolith_Calendars_Base</a></li>
				<li><a href="class-Kronolith_Calendars_Default.html">Kronolith_Calendars_Default</a></li>
				<li><a href="class-Kronolith_Calendars_Kolab.html">Kronolith_Calendars_Kolab</a></li>
				<li><a href="class-Kronolith_Day.html">Kronolith_Day</a></li>
				<li><a href="class-Kronolith_Driver.html">Kronolith_Driver</a></li>
				<li><a href="class-Kronolith_Driver_Holidays.html">Kronolith_Driver_Holidays</a></li>
				<li><a href="class-Kronolith_Driver_Horde.html">Kronolith_Driver_Horde</a></li>
				<li><a href="class-Kronolith_Driver_Ical.html">Kronolith_Driver_Ical</a></li>
				<li><a href="class-Kronolith_Driver_Kolab.html">Kronolith_Driver_Kolab</a></li>
				<li><a href="class-Kronolith_Driver_Mock.html">Kronolith_Driver_Mock</a></li>
				<li><a href="class-Kronolith_Driver_Resource.html">Kronolith_Driver_Resource</a></li>
				<li><a href="class-Kronolith_Driver_Sql.html">Kronolith_Driver_Sql</a></li>
				<li><a href="class-Kronolith_Event.html">Kronolith_Event</a></li>
				<li><a href="class-Kronolith_Event_Holidays.html">Kronolith_Event_Holidays</a></li>
				<li><a href="class-Kronolith_Event_Horde.html">Kronolith_Event_Horde</a></li>
				<li><a href="class-Kronolith_Event_Ical.html">Kronolith_Event_Ical</a></li>
				<li><a href="class-Kronolith_Event_Kolab.html">Kronolith_Event_Kolab</a></li>
				<li><a href="class-Kronolith_Event_Resource.html">Kronolith_Event_Resource</a></li>
				<li><a href="class-Kronolith_Event_Sql.html">Kronolith_Event_Sql</a></li>
				<li><a href="class-Kronolith_Exception.html">Kronolith_Exception</a></li>
				<li><a href="class-Kronolith_Factory_Calendars.html">Kronolith_Factory_Calendars</a></li>
				<li><a href="class-Kronolith_Factory_Geo.html">Kronolith_Factory_Geo</a></li>
				<li><a href="class-Kronolith_Form_CreateCalendar.html">Kronolith_Form_CreateCalendar</a></li>
				<li><a href="class-Kronolith_Form_CreateResource.html">Kronolith_Form_CreateResource</a></li>
				<li><a href="class-Kronolith_Form_CreateResourceGroup.html">Kronolith_Form_CreateResourceGroup</a></li>
				<li><a href="class-Kronolith_Form_DeleteCalendar.html">Kronolith_Form_DeleteCalendar</a></li>
				<li><a href="class-Kronolith_Form_DeleteResource.html">Kronolith_Form_DeleteResource</a></li>
				<li><a href="class-Kronolith_Form_DeleteResourceGroup.html">Kronolith_Form_DeleteResourceGroup</a></li>
				<li><a href="class-Kronolith_Form_EditCalendar.html">Kronolith_Form_EditCalendar</a></li>
				<li><a href="class-Kronolith_Form_EditRemoteCalendar.html">Kronolith_Form_EditRemoteCalendar</a></li>
				<li><a href="class-Kronolith_Form_EditResource.html">Kronolith_Form_EditResource</a></li>
				<li><a href="class-Kronolith_Form_EditResourceGroup.html">Kronolith_Form_EditResourceGroup</a></li>
				<li><a href="class-Kronolith_Form_SubscribeRemoteCalendar.html">Kronolith_Form_SubscribeRemoteCalendar</a></li>
				<li><a href="class-Kronolith_Form_UnsubscribeRemoteCalendar.html">Kronolith_Form_UnsubscribeRemoteCalendar</a></li>
				<li><a href="class-Kronolith_FreeBusy.html">Kronolith_FreeBusy</a></li>
				<li><a href="class-Kronolith_FreeBusy_View.html">Kronolith_FreeBusy_View</a></li>
				<li><a href="class-Kronolith_FreeBusy_View_Day.html">Kronolith_FreeBusy_View_Day</a></li>
				<li><a href="class-Kronolith_FreeBusy_View_Month.html">Kronolith_FreeBusy_View_Month</a></li>
				<li><a href="class-Kronolith_FreeBusy_View_Week.html">Kronolith_FreeBusy_View_Week</a></li>
				<li><a href="class-Kronolith_FreeBusy_View_Workweek.html">Kronolith_FreeBusy_View_Workweek</a></li>
				<li><a href="class-Kronolith_Geo_Base.html">Kronolith_Geo_Base</a></li>
				<li><a href="class-Kronolith_Geo_Mysql.html">Kronolith_Geo_Mysql</a></li>
				<li><a href="class-Kronolith_Geo_Sql.html">Kronolith_Geo_Sql</a></li>
				<li><a href="class-Kronolith_LoginTasks_SystemTask_Upgrade.html">Kronolith_LoginTasks_SystemTask_Upgrade</a></li>
				<li><a href="class-Kronolith_LoginTasks_Task_PurgeEvents.html">Kronolith_LoginTasks_Task_PurgeEvents</a></li>
				<li><a href="class-Kronolith_Notification_Listener_AjaxStatus.html">Kronolith_Notification_Listener_AjaxStatus</a></li>
				<li><a href="class-Kronolith_Resource.html">Kronolith_Resource</a></li>
				<li><a href="class-Kronolith_Resource_Base.html">Kronolith_Resource_Base</a></li>
				<li><a href="class-Kronolith_Resource_Group.html">Kronolith_Resource_Group</a></li>
				<li><a href="class-Kronolith_Resource_Single.html">Kronolith_Resource_Single</a></li>
				<li><a href="class-Kronolith_Storage.html">Kronolith_Storage</a></li>
				<li><a href="class-Kronolith_Storage_Kolab.html">Kronolith_Storage_Kolab</a></li>
				<li><a href="class-Kronolith_Storage_Sql.html">Kronolith_Storage_Sql</a></li>
				<li><a href="class-Kronolith_Tagger.html">Kronolith_Tagger</a></li>
				<li><a href="class-Kronolith_Test.html">Kronolith_Test</a></li>
				<li><a href="class-Kronolith_View_Day.html">Kronolith_View_Day</a></li>
				<li><a href="class-Kronolith_View_DeleteEvent.html">Kronolith_View_DeleteEvent</a></li>
				<li><a href="class-Kronolith_View_EditEvent.html">Kronolith_View_EditEvent</a></li>
				<li><a href="class-Kronolith_View_Event.html">Kronolith_View_Event</a></li>
				<li><a href="class-Kronolith_View_ExportEvent.html">Kronolith_View_ExportEvent</a></li>
				<li><a href="class-Kronolith_View_Month.html">Kronolith_View_Month</a></li>
				<li><a href="class-Kronolith_View_Week.html">Kronolith_View_Week</a></li>
				<li><a href="class-Kronolith_View_WorkWeek.html">Kronolith_View_WorkWeek</a></li>
				<li><a href="class-Kronolith_View_Year.html">Kronolith_View_Year</a></li>
			</ul>





		</div>
	</div>
</div>

<div id="splitter"></div>

<div id="right">
<div id="rightInner">
	<form id="search">
		<input type="hidden" name="cx" value="">
		<input type="hidden" name="ie" value="UTF-8">
		<input type="text" name="q" class="text" placeholder="Search">
	</form>

	<div id="navigation">
		<ul>
			<li>
				<a href="index.html" title="Overview"><span>Overview</span></a>
			</li>
			<li>
				<a href="package-Kronolith.html" title="Summary of Kronolith"><span>Package</span></a>
			</li>
			<li>
				<a href="class-Kronolith.html" title="Summary of Kronolith"><span>Class</span></a>
			</li>
		</ul>
		<ul>
			<li>
				<a href="tree.html" title="Tree view of classes, interfaces, traits and exceptions"><span>Tree</span></a>
			</li>
		</ul>
		<ul>
		</ul>
	</div>

<pre><code><span id="1" class="l"><a class="l" href="#1">   1: </a><span class="xlang">&lt;?php</span>
</span><span id="2" class="l"><a class="l" href="#2">   2: </a><span class="php-comment">/**
</span></span><span id="3" class="l"><a class="l" href="#3">   3: </a><span class="php-comment"> * Copyright 1999-2012 Horde LLC (http://www.horde.org/)
</span></span><span id="4" class="l"><a class="l" href="#4">   4: </a><span class="php-comment"> *
</span></span><span id="5" class="l"><a class="l" href="#5">   5: </a><span class="php-comment"> * See the enclosed file COPYING for license information (GPL). If you
</span></span><span id="6" class="l"><a class="l" href="#6">   6: </a><span class="php-comment"> * did not receive this file, see http://www.horde.org/licenses/gpl.
</span></span><span id="7" class="l"><a class="l" href="#7">   7: </a><span class="php-comment"> *
</span></span><span id="8" class="l"><a class="l" href="#8">   8: </a><span class="php-comment"> * @package Kronolith
</span></span><span id="9" class="l"><a class="l" href="#9">   9: </a><span class="php-comment"> */</span>
</span><span id="10" class="l"><a class="l" href="#10">  10: </a>
</span><span id="11" class="l"><a class="l" href="#11">  11: </a><span class="php-comment">/**
</span></span><span id="12" class="l"><a class="l" href="#12">  12: </a><span class="php-comment"> * The Kronolith:: class provides functionality common to all of Kronolith.
</span></span><span id="13" class="l"><a class="l" href="#13">  13: </a><span class="php-comment"> *
</span></span><span id="14" class="l"><a class="l" href="#14">  14: </a><span class="php-comment"> * @author  Chuck Hagenbuch &lt;chuck@horde.org&gt;
</span></span><span id="15" class="l"><a class="l" href="#15">  15: </a><span class="php-comment"> * @package Kronolith
</span></span><span id="16" class="l"><a class="l" href="#16">  16: </a><span class="php-comment"> */</span>
</span><span id="17" class="l"><a class="l" href="#17">  17: </a><span class="php-keyword1">class</span> <a id="Kronolith" href="#Kronolith">Kronolith</a>
</span><span id="18" class="l"><a class="l" href="#18">  18: </a>{
</span><span id="19" class="l"><a class="l" href="#19">  19: </a>    <span class="php-comment">/** Event status */</span>
</span><span id="20" class="l"><a class="l" href="#20">  20: </a>    <span class="php-keyword1">const</span> <a id="STATUS_NONE" href="#STATUS_NONE">STATUS_NONE</a>      = <span class="php-num">0</span>;
</span><span id="21" class="l"><a class="l" href="#21">  21: </a>    <span class="php-keyword1">const</span> <a id="STATUS_TENTATIVE" href="#STATUS_TENTATIVE">STATUS_TENTATIVE</a> = <span class="php-num">1</span>;
</span><span id="22" class="l"><a class="l" href="#22">  22: </a>    <span class="php-keyword1">const</span> <a id="STATUS_CONFIRMED" href="#STATUS_CONFIRMED">STATUS_CONFIRMED</a> = <span class="php-num">2</span>;
</span><span id="23" class="l"><a class="l" href="#23">  23: </a>    <span class="php-keyword1">const</span> <a id="STATUS_CANCELLED" href="#STATUS_CANCELLED">STATUS_CANCELLED</a> = <span class="php-num">3</span>;
</span><span id="24" class="l"><a class="l" href="#24">  24: </a>    <span class="php-keyword1">const</span> <a id="STATUS_FREE" href="#STATUS_FREE">STATUS_FREE</a>      = <span class="php-num">4</span>;
</span><span id="25" class="l"><a class="l" href="#25">  25: </a>
</span><span id="26" class="l"><a class="l" href="#26">  26: </a>    <span class="php-comment">/** Invitation responses */</span>
</span><span id="27" class="l"><a class="l" href="#27">  27: </a>    <span class="php-keyword1">const</span> <a id="RESPONSE_NONE" href="#RESPONSE_NONE">RESPONSE_NONE</a>      = <span class="php-num">1</span>;
</span><span id="28" class="l"><a class="l" href="#28">  28: </a>    <span class="php-keyword1">const</span> <a id="RESPONSE_ACCEPTED" href="#RESPONSE_ACCEPTED">RESPONSE_ACCEPTED</a>  = <span class="php-num">2</span>;
</span><span id="29" class="l"><a class="l" href="#29">  29: </a>    <span class="php-keyword1">const</span> <a id="RESPONSE_DECLINED" href="#RESPONSE_DECLINED">RESPONSE_DECLINED</a>  = <span class="php-num">3</span>;
</span><span id="30" class="l"><a class="l" href="#30">  30: </a>    <span class="php-keyword1">const</span> <a id="RESPONSE_TENTATIVE" href="#RESPONSE_TENTATIVE">RESPONSE_TENTATIVE</a> = <span class="php-num">4</span>;
</span><span id="31" class="l"><a class="l" href="#31">  31: </a>
</span><span id="32" class="l"><a class="l" href="#32">  32: </a>    <span class="php-comment">/** Attendee status */</span>
</span><span id="33" class="l"><a class="l" href="#33">  33: </a>    <span class="php-keyword1">const</span> <a id="PART_REQUIRED" href="#PART_REQUIRED">PART_REQUIRED</a> = <span class="php-num">1</span>;
</span><span id="34" class="l"><a class="l" href="#34">  34: </a>    <span class="php-keyword1">const</span> <a id="PART_OPTIONAL" href="#PART_OPTIONAL">PART_OPTIONAL</a> = <span class="php-num">2</span>;
</span><span id="35" class="l"><a class="l" href="#35">  35: </a>    <span class="php-keyword1">const</span> <a id="PART_NONE" href="#PART_NONE">PART_NONE</a>     = <span class="php-num">3</span>;
</span><span id="36" class="l"><a class="l" href="#36">  36: </a>    <span class="php-keyword1">const</span> <a id="PART_IGNORE" href="#PART_IGNORE">PART_IGNORE</a>   = <span class="php-num">4</span>;
</span><span id="37" class="l"><a class="l" href="#37">  37: </a>
</span><span id="38" class="l"><a class="l" href="#38">  38: </a>    <span class="php-comment">/** iTip requests */</span>
</span><span id="39" class="l"><a class="l" href="#39">  39: </a>    <span class="php-keyword1">const</span> <a id="ITIP_REQUEST" href="#ITIP_REQUEST">ITIP_REQUEST</a> = <span class="php-num">1</span>;
</span><span id="40" class="l"><a class="l" href="#40">  40: </a>    <span class="php-keyword1">const</span> <a id="ITIP_CANCEL" href="#ITIP_CANCEL">ITIP_CANCEL</a>  = <span class="php-num">2</span>;
</span><span id="41" class="l"><a class="l" href="#41">  41: </a>
</span><span id="42" class="l"><a class="l" href="#42">  42: </a>    <span class="php-comment">/** The event can be delegated. */</span>
</span><span id="43" class="l"><a class="l" href="#43">  43: </a>    <span class="php-keyword1">const</span> <a id="PERMS_DELEGATE" href="#PERMS_DELEGATE">PERMS_DELEGATE</a> = <span class="php-num">1024</span>;
</span><span id="44" class="l"><a class="l" href="#44">  44: </a>
</span><span id="45" class="l"><a class="l" href="#45">  45: </a>    <span class="php-comment">/**
</span></span><span id="46" class="l"><a class="l" href="#46">  46: </a><span class="php-comment">     * Driver singleton instances.
</span></span><span id="47" class="l"><a class="l" href="#47">  47: </a><span class="php-comment">     *
</span></span><span id="48" class="l"><a class="l" href="#48">  48: </a><span class="php-comment">     * @var array
</span></span><span id="49" class="l"><a class="l" href="#49">  49: </a><span class="php-comment">     */</span>
</span><span id="50" class="l"><a class="l" href="#50">  50: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">private</span> <span class="php-var"><a id="$_instances" href="#$_instances">$_instances</a></span> = <span class="php-keyword1">array</span>();
</span><span id="51" class="l"><a class="l" href="#51">  51: </a>
</span><span id="52" class="l"><a class="l" href="#52">  52: </a>    <span class="php-comment">/**
</span></span><span id="53" class="l"><a class="l" href="#53">  53: </a><span class="php-comment">     * @var Kronolith_Tagger
</span></span><span id="54" class="l"><a class="l" href="#54">  54: </a><span class="php-comment">     */</span>
</span><span id="55" class="l"><a class="l" href="#55">  55: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">private</span> <span class="php-var"><a id="$_tagger" href="#$_tagger">$_tagger</a></span>;
</span><span id="56" class="l"><a class="l" href="#56">  56: </a>
</span><span id="57" class="l"><a class="l" href="#57">  57: </a>    <span class="php-comment">/**
</span></span><span id="58" class="l"><a class="l" href="#58">  58: </a><span class="php-comment">     * Output everything for the AJAX interface up to but not including the
</span></span><span id="59" class="l"><a class="l" href="#59">  59: </a><span class="php-comment">     * &lt;body&gt; tag.
</span></span><span id="60" class="l"><a class="l" href="#60">  60: </a><span class="php-comment">     */</span>
</span><span id="61" class="l"><a class="l" href="#61">  61: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">header</span>()
</span><span id="62" class="l"><a class="l" href="#62">  62: </a>    {
</span><span id="63" class="l"><a class="l" href="#63">  63: </a>        <span class="php-comment">// Need to include script files before we start output</span>
</span><span id="64" class="l"><a class="l" href="#64">  64: </a>        <span class="php-var">$datejs</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'_'</span>, <span class="php-quote">'-'</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>]) . <span class="php-quote">'.js'</span>;
</span><span id="65" class="l"><a class="l" href="#65">  65: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;get(<span class="php-quote">'jsfs'</span>, <span class="php-quote">'horde'</span>) . <span class="php-quote">'/date/'</span> . <span class="php-var">$datejs</span>)) {
</span><span id="66" class="l"><a class="l" href="#66">  66: </a>            <span class="php-var">$datejs</span> = <span class="php-quote">'en-US.js'</span>;
</span><span id="67" class="l"><a class="l" href="#67">  67: </a>        }
</span><span id="68" class="l"><a class="l" href="#68">  68: </a>        Horde::addScriptFile(<span class="php-quote">'effects.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="69" class="l"><a class="l" href="#69">  69: </a>        Horde::addScriptFile(<span class="php-quote">'sound.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="70" class="l"><a class="l" href="#70">  70: </a>        Horde::addScriptFile(<span class="php-quote">'horde.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="71" class="l"><a class="l" href="#71">  71: </a>        Horde::addScriptFile(<span class="php-quote">'dragdrop2.js'</span>, <span class="php-quote">'kronolith'</span>);
</span><span id="72" class="l"><a class="l" href="#72">  72: </a>        Horde::addScriptFile(<span class="php-quote">'growler.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="73" class="l"><a class="l" href="#73">  73: </a>        Horde::addScriptFile(<span class="php-quote">'redbox.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="74" class="l"><a class="l" href="#74">  74: </a>        Horde::addScriptFile(<span class="php-quote">'tooltips.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="75" class="l"><a class="l" href="#75">  75: </a>        Horde::addScriptFile(<span class="php-quote">'colorpicker.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="76" class="l"><a class="l" href="#76">  76: </a>        Horde::addScriptFile(<span class="php-quote">'date/'</span> . <span class="php-var">$datejs</span>, <span class="php-quote">'horde'</span>);
</span><span id="77" class="l"><a class="l" href="#77">  77: </a>        Horde::addScriptFile(<span class="php-quote">'date/date.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="78" class="l"><a class="l" href="#78">  78: </a>        Horde::addScriptFile(<span class="php-quote">'kronolith.js'</span>, <span class="php-quote">'kronolith'</span>);
</span><span id="79" class="l"><a class="l" href="#79">  79: </a>        Horde_Core_Ui_JsCalendar::init(<span class="php-keyword1">array</span>(<span class="php-quote">'short_weekdays'</span> =&gt; <span class="php-keyword1">true</span>));
</span><span id="80" class="l"><a class="l" href="#80">  80: </a>
</span><span id="81" class="l"><a class="l" href="#81">  81: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>])) {
</span><span id="82" class="l"><a class="l" href="#82">  82: </a>            <span class="php-keyword2">header</span>(<span class="php-quote">'Content-type: text/html; charset=UTF-8'</span>);
</span><span id="83" class="l"><a class="l" href="#83">  83: </a>            <span class="php-keyword2">header</span>(<span class="php-quote">'Vary: Accept-Language'</span>);
</span><span id="84" class="l"><a class="l" href="#84">  84: </a>        }
</span><span id="85" class="l"><a class="l" href="#85">  85: </a>
</span><span id="86" class="l"><a class="l" href="#86">  86: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">'&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;DTD/xhtml1-transitional.dtd&quot;&gt;'</span> . <span class="php-quote">&quot;\n&quot;</span> .
</span><span id="87" class="l"><a class="l" href="#87">  87: </a>             (!<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>]) ? <span class="php-quote">'&lt;html lang=&quot;'</span> . <span class="php-keyword2">strtr</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>], <span class="php-quote">'_'</span>, <span class="php-quote">'-'</span>) . <span class="php-quote">'&quot;'</span> : <span class="php-quote">'&lt;html'</span>) . <span class="php-quote">&quot;&gt;\n&quot;</span>.
</span><span id="88" class="l"><a class="l" href="#88">  88: </a>             <span class="php-quote">&quot;&lt;head&gt;\n&quot;</span> .
</span><span id="89" class="l"><a class="l" href="#89">  89: </a>             <span class="php-quote">'&lt;title&gt;'</span> . <span class="php-keyword2">htmlspecialchars</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;get(<span class="php-quote">'name'</span>)) . <span class="php-quote">&quot;&lt;/title&gt;\n&quot;</span>;
</span><span id="90" class="l"><a class="l" href="#90">  90: </a>
</span><span id="91" class="l"><a class="l" href="#91">  91: </a>        Horde::includeFavicon();
</span><span id="92" class="l"><a class="l" href="#92">  92: </a>        <span class="php-keyword1">echo</span> Horde::wrapInlineScript(self::includeJSVars());
</span><span id="93" class="l"><a class="l" href="#93">  93: </a>        Horde::includeStylesheetFiles();
</span><span id="94" class="l"><a class="l" href="#94">  94: </a>
</span><span id="95" class="l"><a class="l" href="#95">  95: </a>        <span class="php-keyword1">echo</span> <span class="php-quote">&quot;&lt;/head&gt;\n&quot;</span>;
</span><span id="96" class="l"><a class="l" href="#96">  96: </a>
</span><span id="97" class="l"><a class="l" href="#97">  97: </a>        <span class="php-comment">// Send what we have currently output so the browser can start</span>
</span><span id="98" class="l"><a class="l" href="#98">  98: </a>        <span class="php-comment">// loading CSS/JS. See:</span>
</span><span id="99" class="l"><a class="l" href="#99">  99: </a>        <span class="php-comment">// http://developer.yahoo.com/performance/rules.html#flush</span>
</span><span id="100" class="l"><a class="l" href="#100"> 100: </a>        <span class="php-keyword1">echo</span> Horde::endBuffer();
</span><span id="101" class="l"><a class="l" href="#101"> 101: </a>        <span class="php-keyword2">flush</span>();
</span><span id="102" class="l"><a class="l" href="#102"> 102: </a>    }
</span><span id="103" class="l"><a class="l" href="#103"> 103: </a>
</span><span id="104" class="l"><a class="l" href="#104"> 104: </a>    <span class="php-comment">/**
</span></span><span id="105" class="l"><a class="l" href="#105"> 105: </a><span class="php-comment">     * Outputs the javascript code which defines all javascript variables
</span></span><span id="106" class="l"><a class="l" href="#106"> 106: </a><span class="php-comment">     * that are dependent on the local user's account.
</span></span><span id="107" class="l"><a class="l" href="#107"> 107: </a><span class="php-comment">     *
</span></span><span id="108" class="l"><a class="l" href="#108"> 108: </a><span class="php-comment">     * @private
</span></span><span id="109" class="l"><a class="l" href="#109"> 109: </a><span class="php-comment">     *
</span></span><span id="110" class="l"><a class="l" href="#110"> 110: </a><span class="php-comment">     * @return string
</span></span><span id="111" class="l"><a class="l" href="#111"> 111: </a><span class="php-comment">     */</span>
</span><span id="112" class="l"><a class="l" href="#112"> 112: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_includeJSVars" href="#_includeJSVars">includeJSVars</a>()
</span><span id="113" class="l"><a class="l" href="#113"> 113: </a>    {
</span><span id="114" class="l"><a class="l" href="#114"> 114: </a>        <span class="php-keyword1">global</span> <span class="php-var">$prefs</span>, <span class="php-var">$registry</span>;
</span><span id="115" class="l"><a class="l" href="#115"> 115: </a>
</span><span id="116" class="l"><a class="l" href="#116"> 116: </a>        <span class="php-var">$kronolith_webroot</span> = <span class="php-var">$registry</span>-&gt;get(<span class="php-quote">'webroot'</span>);
</span><span id="117" class="l"><a class="l" href="#117"> 117: </a>        <span class="php-var">$horde_webroot</span> = <span class="php-var">$registry</span>-&gt;get(<span class="php-quote">'webroot'</span>, <span class="php-quote">'horde'</span>);
</span><span id="118" class="l"><a class="l" href="#118"> 118: </a>        <span class="php-var">$has_tasks</span> = self::hasApiPermission(<span class="php-quote">'tasks'</span>);
</span><span id="119" class="l"><a class="l" href="#119"> 119: </a>        <span class="php-var">$app_urls</span> = <span class="php-keyword1">array</span>();
</span><span id="120" class="l"><a class="l" href="#120"> 120: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'menu'</span>][<span class="php-quote">'apps'</span>]) &amp;&amp;
</span><span id="121" class="l"><a class="l" href="#121"> 121: </a>            <span class="php-keyword2">is_array</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'menu'</span>][<span class="php-quote">'apps'</span>])) {
</span><span id="122" class="l"><a class="l" href="#122"> 122: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'menu'</span>][<span class="php-quote">'apps'</span>] <span class="php-keyword1">as</span> <span class="php-var">$app</span>) {
</span><span id="123" class="l"><a class="l" href="#123"> 123: </a>                <span class="php-var">$app_urls</span>[<span class="php-var">$app</span>] = (string)Horde::url(<span class="php-var">$registry</span>-&gt;getInitialPage(<span class="php-var">$app</span>), <span class="php-keyword1">true</span>)-&gt;add(<span class="php-quote">'ajaxui'</span>, <span class="php-num">1</span>);
</span><span id="124" class="l"><a class="l" href="#124"> 124: </a>            }
</span><span id="125" class="l"><a class="l" href="#125"> 125: </a>        }
</span><span id="126" class="l"><a class="l" href="#126"> 126: </a>
</span><span id="127" class="l"><a class="l" href="#127"> 127: </a>        <span class="php-comment">/* Variables used in core javascript files. */</span>
</span><span id="128" class="l"><a class="l" href="#128"> 128: </a>        <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>] = <span class="php-keyword1">array</span>(
</span><span id="129" class="l"><a class="l" href="#129"> 129: </a>            <span class="php-quote">'URI_AJAX'</span> =&gt; (string)Horde::getServiceLink(<span class="php-quote">'ajax'</span>, <span class="php-quote">'kronolith'</span>),
</span><span id="130" class="l"><a class="l" href="#130"> 130: </a>            <span class="php-quote">'URI_SNOOZE'</span> =&gt; (string)Horde::url(<span class="php-var">$registry</span>-&gt;get(<span class="php-quote">'webroot'</span>, <span class="php-quote">'horde'</span>) . <span class="php-quote">'/services/snooze.php'</span>, <span class="php-keyword1">true</span>, -<span class="php-num">1</span>),
</span><span id="131" class="l"><a class="l" href="#131"> 131: </a>            <span class="php-quote">'URI_CALENDAR_EXPORT'</span> =&gt; (string)Horde::url(<span class="php-quote">'data.php'</span>, <span class="php-keyword1">true</span>)-&gt;add(<span class="php-keyword1">array</span>(<span class="php-quote">'actionID'</span> =&gt; <span class="php-quote">'export'</span>, <span class="php-quote">'all_events'</span> =&gt; <span class="php-num">1</span>, <span class="php-quote">'exportID'</span> =&gt; Horde_Data::EXPORT_ICALENDAR, <span class="php-quote">'exportCal'</span> =&gt; <span class="php-quote">'internal_'</span>)),
</span><span id="132" class="l"><a class="l" href="#132"> 132: </a>            <span class="php-quote">'URI_EVENT_EXPORT'</span> =&gt; <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">'%23'</span>, <span class="php-quote">'%7B'</span>, <span class="php-quote">'%7D'</span>), <span class="php-keyword1">array</span>(<span class="php-quote">'#'</span>, <span class="php-quote">'{'</span>, <span class="php-quote">'}'</span>), Horde::url(<span class="php-quote">'event.php'</span>, <span class="php-keyword1">true</span>)-&gt;add(<span class="php-keyword1">array</span>(<span class="php-quote">'view'</span> =&gt; <span class="php-quote">'ExportEvent'</span>, <span class="php-quote">'eventID'</span> =&gt; <span class="php-quote">'#{id}'</span>, <span class="php-quote">'calendar'</span> =&gt; <span class="php-quote">'#{calendar}'</span>, <span class="php-quote">'type'</span> =&gt; <span class="php-quote">'#{type}'</span>))),
</span><span id="133" class="l"><a class="l" href="#133"> 133: </a>            <span class="php-quote">'SESSION_ID'</span> =&gt; <span class="php-keyword2">defined</span>(<span class="php-quote">'SID'</span>) ? SID : <span class="php-quote">''</span>,
</span><span id="134" class="l"><a class="l" href="#134"> 134: </a>            <span class="php-quote">'images'</span> =&gt; <span class="php-keyword1">array</span>(
</span><span id="135" class="l"><a class="l" href="#135"> 135: </a>                <span class="php-quote">'attendees'</span> =&gt; (string)Horde_Themes::img(<span class="php-quote">'attendees-fff.png'</span>),
</span><span id="136" class="l"><a class="l" href="#136"> 136: </a>                <span class="php-quote">'alarm'</span>     =&gt; (string)Horde_Themes::img(<span class="php-quote">'alarm-fff.png'</span>),
</span><span id="137" class="l"><a class="l" href="#137"> 137: </a>                <span class="php-quote">'recur'</span>     =&gt; (string)Horde_Themes::img(<span class="php-quote">'recur-fff.png'</span>),
</span><span id="138" class="l"><a class="l" href="#138"> 138: </a>                <span class="php-quote">'exception'</span> =&gt; (string)Horde_Themes::img(<span class="php-quote">'exception-fff.png'</span>),
</span><span id="139" class="l"><a class="l" href="#139"> 139: </a>            ),
</span><span id="140" class="l"><a class="l" href="#140"> 140: </a>            <span class="php-quote">'user'</span> =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;convertUsername(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(), <span class="php-keyword1">false</span>),
</span><span id="141" class="l"><a class="l" href="#141"> 141: </a>            <span class="php-quote">'prefs_url'</span> =&gt; (string)Horde::getServiceLink(<span class="php-quote">'prefs'</span>, <span class="php-quote">'kronolith'</span>)-&gt;setRaw(<span class="php-keyword1">true</span>)-&gt;add(<span class="php-quote">'ajaxui'</span>, <span class="php-num">1</span>),
</span><span id="142" class="l"><a class="l" href="#142"> 142: </a>            <span class="php-quote">'app_urls'</span> =&gt; <span class="php-var">$app_urls</span>,
</span><span id="143" class="l"><a class="l" href="#143"> 143: </a>            <span class="php-quote">'use_iframe'</span> =&gt; !<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'menu'</span>][<span class="php-quote">'apps_iframe'</span>]),
</span><span id="144" class="l"><a class="l" href="#144"> 144: </a>            <span class="php-quote">'name'</span> =&gt; <span class="php-var">$registry</span>-&gt;get(<span class="php-quote">'name'</span>),
</span><span id="145" class="l"><a class="l" href="#145"> 145: </a>            <span class="php-quote">'has_tasks'</span> =&gt; (bool)<span class="php-var">$has_tasks</span>,
</span><span id="146" class="l"><a class="l" href="#146"> 146: </a>            <span class="php-quote">'is_ie6'</span> =&gt; (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'browser'</span>]-&gt;isBrowser(<span class="php-quote">'msie'</span>) &amp;&amp; (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'browser'</span>]-&gt;getMajor() &lt; <span class="php-num">7</span>)),
</span><span id="147" class="l"><a class="l" href="#147"> 147: </a>            <span class="php-quote">'login_view'</span> =&gt; <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'defaultview'</span>) == <span class="php-quote">'workweek'</span> ? <span class="php-quote">'week'</span> : <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'defaultview'</span>),
</span><span id="148" class="l"><a class="l" href="#148"> 148: </a>            <span class="php-quote">'default_calendar'</span> =&gt; <span class="php-quote">'internal|'</span> . self::getDefaultCalendar(Horde_Perms::EDIT),
</span><span id="149" class="l"><a class="l" href="#149"> 149: </a>            <span class="php-quote">'week_start'</span> =&gt; (int)<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'week_start_monday'</span>),
</span><span id="150" class="l"><a class="l" href="#150"> 150: </a>            <span class="php-quote">'max_events'</span> =&gt; (int)<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'max_events'</span>),
</span><span id="151" class="l"><a class="l" href="#151"> 151: </a>            <span class="php-quote">'date_format'</span> =&gt; <span class="php-keyword2">str_replace</span>(<span class="php-keyword1">array</span>(<span class="php-quote">'%e'</span>, <span class="php-quote">'%d'</span>, <span class="php-quote">'%a'</span>, <span class="php-quote">'%A'</span>, <span class="php-quote">'%m'</span>, <span class="php-quote">'%h'</span>, <span class="php-quote">'%b'</span>, <span class="php-quote">'%B'</span>, <span class="php-quote">'%y'</span>, <span class="php-quote">'%Y'</span>),
</span><span id="152" class="l"><a class="l" href="#152"> 152: </a>                                         <span class="php-keyword1">array</span>(<span class="php-quote">'d'</span>, <span class="php-quote">'dd'</span>, <span class="php-quote">'ddd'</span>, <span class="php-quote">'dddd'</span>, <span class="php-quote">'MM'</span>, <span class="php-quote">'MMM'</span>, <span class="php-quote">'MMM'</span>, <span class="php-quote">'MMMM'</span>, <span class="php-quote">'yy'</span>, <span class="php-quote">'yyyy'</span>),
</span><span id="153" class="l"><a class="l" href="#153"> 153: </a>                                         Horde_Nls::getLangInfo(D_FMT)),
</span><span id="154" class="l"><a class="l" href="#154"> 154: </a>            <span class="php-quote">'time_format'</span> =&gt; <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'twentyFour'</span>) ? <span class="php-quote">'HH:mm'</span> : <span class="php-quote">'hh:mm tt'</span>,
</span><span id="155" class="l"><a class="l" href="#155"> 155: </a>            <span class="php-quote">'show_time'</span> =&gt; self::viewShowTime(),
</span><span id="156" class="l"><a class="l" href="#156"> 156: </a>            <span class="php-quote">'default_alarm'</span> =&gt; (int)<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'default_alarm'</span>),
</span><span id="157" class="l"><a class="l" href="#157"> 157: </a>            <span class="php-quote">'status'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'tentative'</span> =&gt; self::STATUS_TENTATIVE,
</span><span id="158" class="l"><a class="l" href="#158"> 158: </a>                              <span class="php-quote">'confirmed'</span> =&gt; self::STATUS_CONFIRMED,
</span><span id="159" class="l"><a class="l" href="#159"> 159: </a>                              <span class="php-quote">'cancelled'</span> =&gt; self::STATUS_CANCELLED,
</span><span id="160" class="l"><a class="l" href="#160"> 160: </a>                              <span class="php-quote">'free'</span> =&gt; self::STATUS_FREE),
</span><span id="161" class="l"><a class="l" href="#161"> 161: </a>            <span class="php-quote">'recur'</span> =&gt; <span class="php-keyword1">array</span>(Horde_Date_Recurrence::RECUR_NONE =&gt; <span class="php-quote">'None'</span>,
</span><span id="162" class="l"><a class="l" href="#162"> 162: </a>                             Horde_Date_Recurrence::RECUR_DAILY =&gt; <span class="php-quote">'Daily'</span>,
</span><span id="163" class="l"><a class="l" href="#163"> 163: </a>                             Horde_Date_Recurrence::RECUR_WEEKLY =&gt; <span class="php-quote">'Weekly'</span>,
</span><span id="164" class="l"><a class="l" href="#164"> 164: </a>                             Horde_Date_Recurrence::RECUR_MONTHLY_DATE =&gt; <span class="php-quote">'Monthly'</span>,
</span><span id="165" class="l"><a class="l" href="#165"> 165: </a>                             Horde_Date_Recurrence::RECUR_MONTHLY_WEEKDAY =&gt; <span class="php-quote">'Monthly'</span>,
</span><span id="166" class="l"><a class="l" href="#166"> 166: </a>                             Horde_Date_Recurrence::RECUR_YEARLY_DATE =&gt; <span class="php-quote">'Yearly'</span>,
</span><span id="167" class="l"><a class="l" href="#167"> 167: </a>                             Horde_Date_Recurrence::RECUR_YEARLY_DAY =&gt; <span class="php-quote">'Yearly'</span>,
</span><span id="168" class="l"><a class="l" href="#168"> 168: </a>                             Horde_Date_Recurrence::RECUR_YEARLY_WEEKDAY =&gt; <span class="php-quote">'Yearly'</span>),
</span><span id="169" class="l"><a class="l" href="#169"> 169: </a>            <span class="php-quote">'perms'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'all'</span> =&gt; Horde_Perms::ALL,
</span><span id="170" class="l"><a class="l" href="#170"> 170: </a>                             <span class="php-quote">'show'</span> =&gt; Horde_Perms::SHOW,
</span><span id="171" class="l"><a class="l" href="#171"> 171: </a>                             <span class="php-quote">'read'</span> =&gt; Horde_Perms::READ,
</span><span id="172" class="l"><a class="l" href="#172"> 172: </a>                             <span class="php-quote">'edit'</span> =&gt; Horde_Perms::EDIT,
</span><span id="173" class="l"><a class="l" href="#173"> 173: </a>                             <span class="php-quote">'delete'</span> =&gt; Horde_Perms::<span class="php-keyword2">DELETE</span>,
</span><span id="174" class="l"><a class="l" href="#174"> 174: </a>                             <span class="php-quote">'delegate'</span> =&gt; self::PERMS_DELEGATE),
</span><span id="175" class="l"><a class="l" href="#175"> 175: </a>            <span class="php-quote">'snooze'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'0'</span> =&gt; _(<span class="php-quote">&quot;select...&quot;</span>),
</span><span id="176" class="l"><a class="l" href="#176"> 176: </a>                              <span class="php-quote">'5'</span> =&gt; _(<span class="php-quote">&quot;5 minutes&quot;</span>),
</span><span id="177" class="l"><a class="l" href="#177"> 177: </a>                              <span class="php-quote">'15'</span> =&gt; _(<span class="php-quote">&quot;15 minutes&quot;</span>),
</span><span id="178" class="l"><a class="l" href="#178"> 178: </a>                              <span class="php-quote">'60'</span> =&gt; _(<span class="php-quote">&quot;1 hour&quot;</span>),
</span><span id="179" class="l"><a class="l" href="#179"> 179: </a>                              <span class="php-quote">'360'</span> =&gt; _(<span class="php-quote">&quot;6 hours&quot;</span>),
</span><span id="180" class="l"><a class="l" href="#180"> 180: </a>                              <span class="php-quote">'1440'</span> =&gt; _(<span class="php-quote">&quot;1 day&quot;</span>)),
</span><span id="181" class="l"><a class="l" href="#181"> 181: </a>        );
</span><span id="182" class="l"><a class="l" href="#182"> 182: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'logo'</span>][<span class="php-quote">'link'</span>])) {
</span><span id="183" class="l"><a class="l" href="#183"> 183: </a>            <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'URI_HOME'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'logo'</span>][<span class="php-quote">'link'</span>];
</span><span id="184" class="l"><a class="l" href="#184"> 184: </a>        }
</span><span id="185" class="l"><a class="l" href="#185"> 185: </a>
</span><span id="186" class="l"><a class="l" href="#186"> 186: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$has_tasks</span>) {
</span><span id="187" class="l"><a class="l" href="#187"> 187: </a>            <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'tasks'</span>] = <span class="php-var">$registry</span>-&gt;tasks-&gt;ajaxDefaults();
</span><span id="188" class="l"><a class="l" href="#188"> 188: </a>        }
</span><span id="189" class="l"><a class="l" href="#189"> 189: </a>
</span><span id="190" class="l"><a class="l" href="#190"> 190: </a>        <span class="php-comment">// Calendars. Do some twisting to sort own calendar before shared</span>
</span><span id="191" class="l"><a class="l" href="#191"> 191: </a>        <span class="php-comment">// calendars.</span>
</span><span id="192" class="l"><a class="l" href="#192"> 192: </a>        <span class="php-keyword1">foreach</span> (<span class="php-keyword1">array</span>(<span class="php-keyword1">true</span>, <span class="php-keyword1">false</span>) <span class="php-keyword1">as</span> <span class="php-var">$my</span>) {
</span><span id="193" class="l"><a class="l" href="#193"> 193: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="194" class="l"><a class="l" href="#194"> 194: </a>                <span class="php-var">$owner</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() &amp;&amp;
</span><span id="195" class="l"><a class="l" href="#195"> 195: </a>                    <span class="php-var">$calendar</span>-&gt;owner() == <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth();
</span><span id="196" class="l"><a class="l" href="#196"> 196: </a>                <span class="php-keyword1">if</span> ((<span class="php-var">$my</span> &amp;&amp; <span class="php-var">$owner</span>) || (!<span class="php-var">$my</span> &amp;&amp; !<span class="php-var">$owner</span>)) {
</span><span id="197" class="l"><a class="l" href="#197"> 197: </a>                    <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendars'</span>][<span class="php-quote">'internal'</span>][<span class="php-var">$id</span>] = <span class="php-var">$calendar</span>-&gt;toHash();
</span><span id="198" class="l"><a class="l" href="#198"> 198: </a>                }
</span><span id="199" class="l"><a class="l" href="#199"> 199: </a>            }
</span><span id="200" class="l"><a class="l" href="#200"> 200: </a>
</span><span id="201" class="l"><a class="l" href="#201"> 201: </a>            <span class="php-comment">// Tasklists</span>
</span><span id="202" class="l"><a class="l" href="#202"> 202: </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$has_tasks</span>) {
</span><span id="203" class="l"><a class="l" href="#203"> 203: </a>                <span class="php-keyword1">continue</span>;
</span><span id="204" class="l"><a class="l" href="#204"> 204: </a>            }
</span><span id="205" class="l"><a class="l" href="#205"> 205: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$registry</span>-&gt;tasks-&gt;listTasklists(<span class="php-var">$my</span>, Horde_Perms::SHOW) <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$tasklist</span>) {
</span><span id="206" class="l"><a class="l" href="#206"> 206: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>][<span class="php-quote">'tasks/'</span> . <span class="php-var">$id</span>])) {
</span><span id="207" class="l"><a class="l" href="#207"> 207: </a>                    <span class="php-keyword1">continue</span>;
</span><span id="208" class="l"><a class="l" href="#208"> 208: </a>                }
</span><span id="209" class="l"><a class="l" href="#209"> 209: </a>                <span class="php-var">$owner</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() &amp;&amp;
</span><span id="210" class="l"><a class="l" href="#210"> 210: </a>                    <span class="php-var">$tasklist</span>-&gt;get(<span class="php-quote">'owner'</span>) == <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth();
</span><span id="211" class="l"><a class="l" href="#211"> 211: </a>                <span class="php-keyword1">if</span> ((<span class="php-var">$my</span> &amp;&amp; <span class="php-var">$owner</span>) || (!<span class="php-var">$my</span> &amp;&amp; !<span class="php-var">$owner</span>)) {
</span><span id="212" class="l"><a class="l" href="#212"> 212: </a>                    <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendars'</span>][<span class="php-quote">'tasklists'</span>][<span class="php-quote">'tasks/'</span> . <span class="php-var">$id</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>][<span class="php-quote">'tasks/'</span> . <span class="php-var">$id</span>]-&gt;toHash();
</span><span id="213" class="l"><a class="l" href="#213"> 213: </a>                }
</span><span id="214" class="l"><a class="l" href="#214"> 214: </a>            }
</span><span id="215" class="l"><a class="l" href="#215"> 215: </a>        }
</span><span id="216" class="l"><a class="l" href="#216"> 216: </a>
</span><span id="217" class="l"><a class="l" href="#217"> 217: </a>        <span class="php-comment">// Timeobjects</span>
</span><span id="218" class="l"><a class="l" href="#218"> 218: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="219" class="l"><a class="l" href="#219"> 219: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>-&gt;api() == <span class="php-quote">'tasks'</span>) {
</span><span id="220" class="l"><a class="l" href="#220"> 220: </a>                <span class="php-keyword1">continue</span>;
</span><span id="221" class="l"><a class="l" href="#221"> 221: </a>            }
</span><span id="222" class="l"><a class="l" href="#222"> 222: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'hidden'</span>]) &amp;&amp;
</span><span id="223" class="l"><a class="l" href="#223"> 223: </a>                !<span class="php-keyword2">in_array</span>(<span class="php-var">$id</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>])) {
</span><span id="224" class="l"><a class="l" href="#224"> 224: </a>                <span class="php-keyword1">continue</span>;
</span><span id="225" class="l"><a class="l" href="#225"> 225: </a>            }
</span><span id="226" class="l"><a class="l" href="#226"> 226: </a>            <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendars'</span>][<span class="php-quote">'external'</span>][<span class="php-var">$id</span>] = <span class="php-var">$calendar</span>-&gt;toHash();
</span><span id="227" class="l"><a class="l" href="#227"> 227: </a>        }
</span><span id="228" class="l"><a class="l" href="#228"> 228: </a>
</span><span id="229" class="l"><a class="l" href="#229"> 229: </a>        <span class="php-comment">// Remote calendars</span>
</span><span id="230" class="l"><a class="l" href="#230"> 230: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_remote_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$url</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="231" class="l"><a class="l" href="#231"> 231: </a>            <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendars'</span>][<span class="php-quote">'remote'</span>][<span class="php-var">$url</span>] = <span class="php-var">$calendar</span>-&gt;toHash();
</span><span id="232" class="l"><a class="l" href="#232"> 232: </a>        }
</span><span id="233" class="l"><a class="l" href="#233"> 233: </a>
</span><span id="234" class="l"><a class="l" href="#234"> 234: </a>        <span class="php-comment">// Holidays</span>
</span><span id="235" class="l"><a class="l" href="#235"> 235: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_holidays'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="236" class="l"><a class="l" href="#236"> 236: </a>            <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendars'</span>][<span class="php-quote">'holiday'</span>][<span class="php-var">$id</span>] = <span class="php-var">$calendar</span>-&gt;toHash();
</span><span id="237" class="l"><a class="l" href="#237"> 237: </a>        }
</span><span id="238" class="l"><a class="l" href="#238"> 238: </a>
</span><span id="239" class="l"><a class="l" href="#239"> 239: </a>        <span class="php-comment">/* Gettext strings used in core javascript files. */</span>
</span><span id="240" class="l"><a class="l" href="#240"> 240: </a>        <span class="php-var">$code</span>[<span class="php-quote">'text'</span>] = <span class="php-keyword1">array</span>(
</span><span id="241" class="l"><a class="l" href="#241"> 241: </a>            <span class="php-quote">'ajax_error'</span> =&gt; _(<span class="php-quote">&quot;Error when communicating with the server.&quot;</span>),
</span><span id="242" class="l"><a class="l" href="#242"> 242: </a>            <span class="php-quote">'ajax_timeout'</span> =&gt; _(<span class="php-quote">&quot;There has been no contact with the server for several minutes. The server may be temporarily unavailable or network problems may be interrupting your session. You will not see any updates until the connection is restored.&quot;</span>),
</span><span id="243" class="l"><a class="l" href="#243"> 243: </a>            <span class="php-quote">'ajax_recover'</span> =&gt; _(<span class="php-quote">&quot;The connection to the server has been restored.&quot;</span>),
</span><span id="244" class="l"><a class="l" href="#244"> 244: </a>            <span class="php-quote">'alarm'</span> =&gt; _(<span class="php-quote">&quot;Alarm:&quot;</span>),
</span><span id="245" class="l"><a class="l" href="#245"> 245: </a>            <span class="php-quote">'snooze'</span> =&gt; <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;You can snooze it for %s or %s dismiss %s it entirely&quot;</span>), <span class="php-quote">'#{time}'</span>, <span class="php-quote">'#{dismiss_start}'</span>, <span class="php-quote">'#{dismiss_end}'</span>),
</span><span id="246" class="l"><a class="l" href="#246"> 246: </a>            <span class="php-quote">'noalerts'</span> =&gt; _(<span class="php-quote">&quot;No Notifications&quot;</span>),
</span><span id="247" class="l"><a class="l" href="#247"> 247: </a>            <span class="php-quote">'alerts'</span> =&gt; <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;%s notifications&quot;</span>), <span class="php-quote">'#{count}'</span>),
</span><span id="248" class="l"><a class="l" href="#248"> 248: </a>            <span class="php-quote">'hidelog'</span> =&gt; _(<span class="php-quote">&quot;Hide Notifications&quot;</span>),
</span><span id="249" class="l"><a class="l" href="#249"> 249: </a>            <span class="php-quote">'growlerinfo'</span> =&gt; _(<span class="php-quote">&quot;This is the notification backlog&quot;</span>),
</span><span id="250" class="l"><a class="l" href="#250"> 250: </a>            <span class="php-quote">'agenda'</span> =&gt; _(<span class="php-quote">&quot;Agenda&quot;</span>),
</span><span id="251" class="l"><a class="l" href="#251"> 251: </a>            <span class="php-quote">'tasks'</span> =&gt; _(<span class="php-quote">&quot;Tasks&quot;</span>),
</span><span id="252" class="l"><a class="l" href="#252"> 252: </a>            <span class="php-quote">'searching'</span> =&gt; <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Events matching \&quot;%s\&quot;&quot;</span>), <span class="php-quote">'#{term}'</span>),
</span><span id="253" class="l"><a class="l" href="#253"> 253: </a>            <span class="php-quote">'allday'</span> =&gt; _(<span class="php-quote">&quot;All day&quot;</span>),
</span><span id="254" class="l"><a class="l" href="#254"> 254: </a>            <span class="php-quote">'more'</span> =&gt; _(<span class="php-quote">&quot;more...&quot;</span>),
</span><span id="255" class="l"><a class="l" href="#255"> 255: </a>            <span class="php-quote">'prefs'</span> =&gt; _(<span class="php-quote">&quot;Preferences&quot;</span>),
</span><span id="256" class="l"><a class="l" href="#256"> 256: </a>            <span class="php-quote">'shared'</span> =&gt; _(<span class="php-quote">&quot;Shared&quot;</span>),
</span><span id="257" class="l"><a class="l" href="#257"> 257: </a>            <span class="php-quote">'external_category'</span> =&gt; _(<span class="php-quote">&quot;Other events&quot;</span>),
</span><span id="258" class="l"><a class="l" href="#258"> 258: </a>            <span class="php-quote">'no_url'</span> =&gt; _(<span class="php-quote">&quot;You must specify a URL.&quot;</span>),
</span><span id="259" class="l"><a class="l" href="#259"> 259: </a>            <span class="php-quote">'no_calendar_title'</span> =&gt; _(<span class="php-quote">&quot;The calendar title must not be empty.&quot;</span>),
</span><span id="260" class="l"><a class="l" href="#260"> 260: </a>            <span class="php-quote">'no_tasklist_title'</span> =&gt; _(<span class="php-quote">&quot;The task list title must not be empty.&quot;</span>),
</span><span id="261" class="l"><a class="l" href="#261"> 261: </a>            <span class="php-quote">'delete_calendar'</span> =&gt; _(<span class="php-quote">&quot;Are you sure you want to delete this calendar and all the events in it?&quot;</span>),
</span><span id="262" class="l"><a class="l" href="#262"> 262: </a>            <span class="php-quote">'delete_tasklist'</span> =&gt; _(<span class="php-quote">&quot;Are you sure you want to delete this task list and all the tasks in it?&quot;</span>),
</span><span id="263" class="l"><a class="l" href="#263"> 263: </a>            <span class="php-quote">'wrong_auth'</span> =&gt; _(<span class="php-quote">&quot;The authentication information you specified wasn't accepted.&quot;</span>),
</span><span id="264" class="l"><a class="l" href="#264"> 264: </a>            <span class="php-quote">'geocode_error'</span> =&gt; _(<span class="php-quote">&quot;Unable to locate requested address&quot;</span>),
</span><span id="265" class="l"><a class="l" href="#265"> 265: </a>            <span class="php-quote">'wrong_date_format'</span> =&gt; <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;You used an unknown date format \&quot;%s\&quot;. Please try something like \&quot;%s\&quot;.&quot;</span>), <span class="php-quote">'#{wrong}'</span>, <span class="php-quote">'#{right}'</span>),
</span><span id="266" class="l"><a class="l" href="#266"> 266: </a>            <span class="php-quote">'wrong_time_format'</span> =&gt; <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;You used an unknown time format \&quot;%s\&quot;. Please try something like \&quot;%s\&quot;.&quot;</span>), <span class="php-quote">'#{wrong}'</span>, <span class="php-quote">'#{right}'</span>),
</span><span id="267" class="l"><a class="l" href="#267"> 267: </a>            <span class="php-quote">'fix_form_values'</span> =&gt; _(<span class="php-quote">&quot;Please enter correct values in the form first.&quot;</span>),
</span><span id="268" class="l"><a class="l" href="#268"> 268: </a>        );
</span><span id="269" class="l"><a class="l" href="#269"> 269: </a>        <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt;= <span class="php-num">12</span>; ++<span class="php-var">$i</span>) {
</span><span id="270" class="l"><a class="l" href="#270"> 270: </a>            <span class="php-var">$code</span>[<span class="php-quote">'text'</span>][<span class="php-quote">'month'</span>][<span class="php-var">$i</span> - <span class="php-num">1</span>] = Horde_Nls::getLangInfo(<span class="php-keyword2">constant</span>(<span class="php-quote">'MON_'</span> . <span class="php-var">$i</span>));
</span><span id="271" class="l"><a class="l" href="#271"> 271: </a>        }
</span><span id="272" class="l"><a class="l" href="#272"> 272: </a>        <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">1</span>; <span class="php-var">$i</span> &lt;= <span class="php-num">7</span>; ++<span class="php-var">$i</span>) {
</span><span id="273" class="l"><a class="l" href="#273"> 273: </a>            <span class="php-var">$code</span>[<span class="php-quote">'text'</span>][<span class="php-quote">'weekday'</span>][<span class="php-var">$i</span>] = Horde_Nls::getLangInfo(<span class="php-keyword2">constant</span>(<span class="php-quote">'DAY_'</span> . <span class="php-var">$i</span>));
</span><span id="274" class="l"><a class="l" href="#274"> 274: </a>        }
</span><span id="275" class="l"><a class="l" href="#275"> 275: </a>        <span class="php-keyword1">foreach</span> (<span class="php-keyword1">array</span>(Horde_Date_Recurrence::RECUR_DAILY,
</span><span id="276" class="l"><a class="l" href="#276"> 276: </a>                       Horde_Date_Recurrence::RECUR_WEEKLY,
</span><span id="277" class="l"><a class="l" href="#277"> 277: </a>                       Horde_Date_Recurrence::RECUR_MONTHLY_DATE,
</span><span id="278" class="l"><a class="l" href="#278"> 278: </a>                       Horde_Date_Recurrence::RECUR_MONTHLY_WEEKDAY,
</span><span id="279" class="l"><a class="l" href="#279"> 279: </a>                       Horde_Date_Recurrence::RECUR_YEARLY_DATE,
</span><span id="280" class="l"><a class="l" href="#280"> 280: </a>                       Horde_Date_Recurrence::RECUR_YEARLY_DAY,
</span><span id="281" class="l"><a class="l" href="#281"> 281: </a>                       Horde_Date_Recurrence::RECUR_YEARLY_WEEKDAY) <span class="php-keyword1">as</span> <span class="php-var">$recurType</span>) {
</span><span id="282" class="l"><a class="l" href="#282"> 282: </a>            <span class="php-var">$code</span>[<span class="php-quote">'text'</span>][<span class="php-quote">'recur'</span>][<span class="php-var">$recurType</span>] = self::recurToString(<span class="php-var">$recurType</span>);
</span><span id="283" class="l"><a class="l" href="#283"> 283: </a>        }
</span><span id="284" class="l"><a class="l" href="#284"> 284: </a>
</span><span id="285" class="l"><a class="l" href="#285"> 285: </a>        <span class="php-var">$code</span>[<span class="php-quote">'text'</span>][<span class="php-quote">'recur'</span>][<span class="php-quote">'exception'</span>] = _(<span class="php-quote">&quot;Exception&quot;</span>);
</span><span id="286" class="l"><a class="l" href="#286"> 286: </a>
</span><span id="287" class="l"><a class="l" href="#287"> 287: </a>        <span class="php-comment">// Maps</span>
</span><span id="288" class="l"><a class="l" href="#288"> 288: </a>        <span class="php-var">$code</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'maps'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'maps'</span>];
</span><span id="289" class="l"><a class="l" href="#289"> 289: </a>
</span><span id="290" class="l"><a class="l" href="#290"> 290: </a>        <span class="php-keyword1">return</span> Horde::addInlineJsVars(<span class="php-keyword1">array</span>(
</span><span id="291" class="l"><a class="l" href="#291"> 291: </a>            <span class="php-quote">'var Kronolith'</span> =&gt; <span class="php-var">$code</span>
</span><span id="292" class="l"><a class="l" href="#292"> 292: </a>        ), <span class="php-keyword1">array</span>(<span class="php-quote">'ret_vars'</span> =&gt; <span class="php-keyword1">true</span>));
</span><span id="293" class="l"><a class="l" href="#293"> 293: </a>    }
</span><span id="294" class="l"><a class="l" href="#294"> 294: </a>
</span><span id="295" class="l"><a class="l" href="#295"> 295: </a>    <span class="php-comment">/**
</span></span><span id="296" class="l"><a class="l" href="#296"> 296: </a><span class="php-comment">     * Converts a permission object to a json object.
</span></span><span id="297" class="l"><a class="l" href="#297"> 297: </a><span class="php-comment">     *
</span></span><span id="298" class="l"><a class="l" href="#298"> 298: </a><span class="php-comment">     * This methods filters out any permissions for the owner and converts the
</span></span><span id="299" class="l"><a class="l" href="#299"> 299: </a><span class="php-comment">     * user name if necessary.
</span></span><span id="300" class="l"><a class="l" href="#300"> 300: </a><span class="php-comment">     *
</span></span><span id="301" class="l"><a class="l" href="#301"> 301: </a><span class="php-comment">     * @param Horde_Perms_Permission $perm  A permission object.
</span></span><span id="302" class="l"><a class="l" href="#302"> 302: </a><span class="php-comment">     *
</span></span><span id="303" class="l"><a class="l" href="#303"> 303: </a><span class="php-comment">     * @return array  A hash suitable for json.
</span></span><span id="304" class="l"><a class="l" href="#304"> 304: </a><span class="php-comment">     */</span>
</span><span id="305" class="l"><a class="l" href="#305"> 305: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_permissionToJson" href="#_permissionToJson">permissionToJson</a>(Horde_Perms_Permission <span class="php-var">$perm</span>)
</span><span id="306" class="l"><a class="l" href="#306"> 306: </a>    {
</span><span id="307" class="l"><a class="l" href="#307"> 307: </a>        <span class="php-var">$json</span> = <span class="php-var">$perm</span>-&gt;data;
</span><span id="308" class="l"><a class="l" href="#308"> 308: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$json</span>[<span class="php-quote">'users'</span>])) {
</span><span id="309" class="l"><a class="l" href="#309"> 309: </a>            <span class="php-var">$users</span> = <span class="php-keyword1">array</span>();
</span><span id="310" class="l"><a class="l" href="#310"> 310: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$json</span>[<span class="php-quote">'users'</span>] <span class="php-keyword1">as</span> <span class="php-var">$user</span> =&gt; <span class="php-var">$value</span>) {
</span><span id="311" class="l"><a class="l" href="#311"> 311: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$user</span> == <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth()) {
</span><span id="312" class="l"><a class="l" href="#312"> 312: </a>                    <span class="php-keyword1">continue</span>;
</span><span id="313" class="l"><a class="l" href="#313"> 313: </a>                }
</span><span id="314" class="l"><a class="l" href="#314"> 314: </a>                <span class="php-var">$user</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;convertUsername(<span class="php-var">$user</span>, <span class="php-keyword1">false</span>);
</span><span id="315" class="l"><a class="l" href="#315"> 315: </a>                <span class="php-var">$users</span>[<span class="php-var">$user</span>] = <span class="php-var">$value</span>;
</span><span id="316" class="l"><a class="l" href="#316"> 316: </a>            }
</span><span id="317" class="l"><a class="l" href="#317"> 317: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$users</span>) {
</span><span id="318" class="l"><a class="l" href="#318"> 318: </a>                <span class="php-var">$json</span>[<span class="php-quote">'users'</span>] = <span class="php-var">$users</span>;
</span><span id="319" class="l"><a class="l" href="#319"> 319: </a>            } <span class="php-keyword1">else</span> {
</span><span id="320" class="l"><a class="l" href="#320"> 320: </a>                <span class="php-keyword1">unset</span>(<span class="php-var">$json</span>[<span class="php-quote">'users'</span>]);
</span><span id="321" class="l"><a class="l" href="#321"> 321: </a>            }
</span><span id="322" class="l"><a class="l" href="#322"> 322: </a>        }
</span><span id="323" class="l"><a class="l" href="#323"> 323: </a>        <span class="php-keyword1">return</span> <span class="php-var">$json</span>;
</span><span id="324" class="l"><a class="l" href="#324"> 324: </a>   }
</span><span id="325" class="l"><a class="l" href="#325"> 325: </a>
</span><span id="326" class="l"><a class="l" href="#326"> 326: </a>    <span class="php-comment">/**
</span></span><span id="327" class="l"><a class="l" href="#327"> 327: </a><span class="php-comment">     * Returns all the alarms active on a specific date.
</span></span><span id="328" class="l"><a class="l" href="#328"> 328: </a><span class="php-comment">     *
</span></span><span id="329" class="l"><a class="l" href="#329"> 329: </a><span class="php-comment">     * @param Horde_Date $date    The date to check for alarms.
</span></span><span id="330" class="l"><a class="l" href="#330"> 330: </a><span class="php-comment">     * @param array $calendars    The calendars to check for events.
</span></span><span id="331" class="l"><a class="l" href="#331"> 331: </a><span class="php-comment">     * @param boolean $fullevent  Whether to return complete alarm objects or
</span></span><span id="332" class="l"><a class="l" href="#332"> 332: </a><span class="php-comment">     *                            only alarm IDs.
</span></span><span id="333" class="l"><a class="l" href="#333"> 333: </a><span class="php-comment">     *
</span></span><span id="334" class="l"><a class="l" href="#334"> 334: </a><span class="php-comment">     * @return array  The alarms active on the date. A hash with calendar names
</span></span><span id="335" class="l"><a class="l" href="#335"> 335: </a><span class="php-comment">     *                as keys and arrays of events or event ids as values.
</span></span><span id="336" class="l"><a class="l" href="#336"> 336: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="337" class="l"><a class="l" href="#337"> 337: </a><span class="php-comment">     */</span>
</span><span id="338" class="l"><a class="l" href="#338"> 338: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_listAlarms" href="#_listAlarms">listAlarms</a>(<span class="php-var">$date</span>, <span class="php-var">$calendars</span>, <span class="php-var">$fullevent</span> = <span class="php-keyword1">false</span>)
</span><span id="339" class="l"><a class="l" href="#339"> 339: </a>    {
</span><span id="340" class="l"><a class="l" href="#340"> 340: </a>        <span class="php-var">$kronolith_driver</span> = self::getDriver();
</span><span id="341" class="l"><a class="l" href="#341"> 341: </a>
</span><span id="342" class="l"><a class="l" href="#342"> 342: </a>        <span class="php-var">$alarms</span> = <span class="php-keyword1">array</span>();
</span><span id="343" class="l"><a class="l" href="#343"> 343: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$cal</span>) {
</span><span id="344" class="l"><a class="l" href="#344"> 344: </a>            <span class="php-var">$kronolith_driver</span>-&gt;open(<span class="php-var">$cal</span>);
</span><span id="345" class="l"><a class="l" href="#345"> 345: </a>            <span class="php-var">$alarms</span>[<span class="php-var">$cal</span>] = <span class="php-var">$kronolith_driver</span>-&gt;listAlarms(<span class="php-var">$date</span>, <span class="php-var">$fullevent</span>);
</span><span id="346" class="l"><a class="l" href="#346"> 346: </a>        }
</span><span id="347" class="l"><a class="l" href="#347"> 347: </a>
</span><span id="348" class="l"><a class="l" href="#348"> 348: </a>        <span class="php-keyword1">return</span> <span class="php-var">$alarms</span>;
</span><span id="349" class="l"><a class="l" href="#349"> 349: </a>    }
</span><span id="350" class="l"><a class="l" href="#350"> 350: </a>
</span><span id="351" class="l"><a class="l" href="#351"> 351: </a>    <span class="php-comment">/**
</span></span><span id="352" class="l"><a class="l" href="#352"> 352: </a><span class="php-comment">     * Searches for events with the given properties.
</span></span><span id="353" class="l"><a class="l" href="#353"> 353: </a><span class="php-comment">     *
</span></span><span id="354" class="l"><a class="l" href="#354"> 354: </a><span class="php-comment">     * @param object $query     The search query.
</span></span><span id="355" class="l"><a class="l" href="#355"> 355: </a><span class="php-comment">     * @param string $calendar  The calendar to search in the form
</span></span><span id="356" class="l"><a class="l" href="#356"> 356: </a><span class="php-comment">     *                          &quot;Driver|calendar_id&quot;.
</span></span><span id="357" class="l"><a class="l" href="#357"> 357: </a><span class="php-comment">     *
</span></span><span id="358" class="l"><a class="l" href="#358"> 358: </a><span class="php-comment">     * @return array  The events.
</span></span><span id="359" class="l"><a class="l" href="#359"> 359: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="360" class="l"><a class="l" href="#360"> 360: </a><span class="php-comment">     */</span>
</span><span id="361" class="l"><a class="l" href="#361"> 361: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_search" href="#_search">search</a>(<span class="php-var">$query</span>, <span class="php-var">$calendar</span> = <span class="php-keyword1">null</span>)
</span><span id="362" class="l"><a class="l" href="#362"> 362: </a>    {
</span><span id="363" class="l"><a class="l" href="#363"> 363: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>) {
</span><span id="364" class="l"><a class="l" href="#364"> 364: </a>            <span class="php-var">$driver</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">'|'</span>, <span class="php-var">$calendar</span>, <span class="php-num">2</span>);
</span><span id="365" class="l"><a class="l" href="#365"> 365: </a>            <span class="php-var">$calendars</span> = <span class="php-keyword1">array</span>(<span class="php-var">$driver</span>[<span class="php-num">0</span>] =&gt; <span class="php-keyword1">array</span>(<span class="php-var">$driver</span>[<span class="php-num">1</span>]));
</span><span id="366" class="l"><a class="l" href="#366"> 366: </a>        } <span class="php-keyword1">elseif</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$query</span>-&gt;calendars)) {
</span><span id="367" class="l"><a class="l" href="#367"> 367: </a>            <span class="php-var">$calendars</span> = <span class="php-var">$query</span>-&gt;calendars;
</span><span id="368" class="l"><a class="l" href="#368"> 368: </a>        } <span class="php-keyword1">else</span> {
</span><span id="369" class="l"><a class="l" href="#369"> 369: </a>            <span class="php-var">$calendars</span> = <span class="php-keyword1">array</span>(
</span><span id="370" class="l"><a class="l" href="#370"> 370: </a>                Horde_String::<span class="php-keyword2">ucfirst</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendar'</span>][<span class="php-quote">'driver'</span>]) =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>],
</span><span id="371" class="l"><a class="l" href="#371"> 371: </a>                <span class="php-quote">'Horde'</span> =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>],
</span><span id="372" class="l"><a class="l" href="#372"> 372: </a>                <span class="php-quote">'Ical'</span> =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>],
</span><span id="373" class="l"><a class="l" href="#373"> 373: </a>                <span class="php-quote">'Holidays'</span> =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>]);
</span><span id="374" class="l"><a class="l" href="#374"> 374: </a>        }
</span><span id="375" class="l"><a class="l" href="#375"> 375: </a>
</span><span id="376" class="l"><a class="l" href="#376"> 376: </a>        <span class="php-var">$events</span> = <span class="php-keyword1">array</span>();
</span><span id="377" class="l"><a class="l" href="#377"> 377: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$type</span> =&gt; <span class="php-var">$list</span>) {
</span><span id="378" class="l"><a class="l" href="#378"> 378: </a>            <span class="php-var">$kronolith_driver</span> = self::getDriver(<span class="php-var">$type</span>);
</span><span id="379" class="l"><a class="l" href="#379"> 379: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$list</span> <span class="php-keyword1">as</span> <span class="php-var">$cal</span>) {
</span><span id="380" class="l"><a class="l" href="#380"> 380: </a>                <span class="php-var">$kronolith_driver</span>-&gt;open(<span class="php-var">$cal</span>);
</span><span id="381" class="l"><a class="l" href="#381"> 381: </a>                <span class="php-var">$retevents</span> = <span class="php-var">$kronolith_driver</span>-&gt;search(<span class="php-var">$query</span>);
</span><span id="382" class="l"><a class="l" href="#382"> 382: </a>                self::mergeEvents(<span class="php-var">$events</span>, <span class="php-var">$retevents</span>);
</span><span id="383" class="l"><a class="l" href="#383"> 383: </a>            }
</span><span id="384" class="l"><a class="l" href="#384"> 384: </a>        }
</span><span id="385" class="l"><a class="l" href="#385"> 385: </a>
</span><span id="386" class="l"><a class="l" href="#386"> 386: </a>        <span class="php-keyword1">return</span> <span class="php-var">$events</span>;
</span><span id="387" class="l"><a class="l" href="#387"> 387: </a>    }
</span><span id="388" class="l"><a class="l" href="#388"> 388: </a>
</span><span id="389" class="l"><a class="l" href="#389"> 389: </a>    <span class="php-comment">/**
</span></span><span id="390" class="l"><a class="l" href="#390"> 390: </a><span class="php-comment">     * Returns all the events that happen each day within a time period
</span></span><span id="391" class="l"><a class="l" href="#391"> 391: </a><span class="php-comment">     *
</span></span><span id="392" class="l"><a class="l" href="#392"> 392: </a><span class="php-comment">     * @deprecated
</span></span><span id="393" class="l"><a class="l" href="#393"> 393: </a><span class="php-comment">     *
</span></span><span id="394" class="l"><a class="l" href="#394"> 394: </a><span class="php-comment">     * @param Horde_Date $startDate    The start of the time range.
</span></span><span id="395" class="l"><a class="l" href="#395"> 395: </a><span class="php-comment">     * @param Horde_Date $endDate      The end of the time range.
</span></span><span id="396" class="l"><a class="l" href="#396"> 396: </a><span class="php-comment">     * @param array $calendars         The calendars to check for events.
</span></span><span id="397" class="l"><a class="l" href="#397"> 397: </a><span class="php-comment">     * @param boolean $showRecurrence  Return every instance of a recurring
</span></span><span id="398" class="l"><a class="l" href="#398"> 398: </a><span class="php-comment">     *                                 event? If false, will only return
</span></span><span id="399" class="l"><a class="l" href="#399"> 399: </a><span class="php-comment">     *                                 recurring events once inside the
</span></span><span id="400" class="l"><a class="l" href="#400"> 400: </a><span class="php-comment">     *                                 $startDate - $endDate range.
</span></span><span id="401" class="l"><a class="l" href="#401"> 401: </a><span class="php-comment">     *                                 Defaults to true
</span></span><span id="402" class="l"><a class="l" href="#402"> 402: </a><span class="php-comment">     * @param boolean $alarmsOnly      Filter results for events with alarms
</span></span><span id="403" class="l"><a class="l" href="#403"> 403: </a><span class="php-comment">     *                                 Defaults to false
</span></span><span id="404" class="l"><a class="l" href="#404"> 404: </a><span class="php-comment">     * @param boolean $showRemote      Return events from remote and
</span></span><span id="405" class="l"><a class="l" href="#405"> 405: </a><span class="php-comment">     *                                 listTimeObjects as well?
</span></span><span id="406" class="l"><a class="l" href="#406"> 406: </a><span class="php-comment">     * @param boolean $hideExceptions  Hide events that represent exceptions to
</span></span><span id="407" class="l"><a class="l" href="#407"> 407: </a><span class="php-comment">     *                                 a recurring event?
</span></span><span id="408" class="l"><a class="l" href="#408"> 408: </a><span class="php-comment">     * @param boolean $fetchTags       Should we fetch each event's tags from
</span></span><span id="409" class="l"><a class="l" href="#409"> 409: </a><span class="php-comment">     *                                 storage?
</span></span><span id="410" class="l"><a class="l" href="#410"> 410: </a><span class="php-comment">     *
</span></span><span id="411" class="l"><a class="l" href="#411"> 411: </a><span class="php-comment">     * @return array  The events happening in this time period.
</span></span><span id="412" class="l"><a class="l" href="#412"> 412: </a><span class="php-comment">     */</span>
</span><span id="413" class="l"><a class="l" href="#413"> 413: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_listEvents" href="#_listEvents">listEvents</a>(<span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>, <span class="php-var">$calendars</span> = <span class="php-keyword1">null</span>,
</span><span id="414" class="l"><a class="l" href="#414"> 414: </a>                                      <span class="php-var">$showRecurrence</span> = <span class="php-keyword1">true</span>,
</span><span id="415" class="l"><a class="l" href="#415"> 415: </a>                                      <span class="php-var">$alarmsOnly</span> = <span class="php-keyword1">false</span>, <span class="php-var">$showRemote</span> = <span class="php-keyword1">true</span>,
</span><span id="416" class="l"><a class="l" href="#416"> 416: </a>                                      <span class="php-var">$hideExceptions</span> = <span class="php-keyword1">false</span>,
</span><span id="417" class="l"><a class="l" href="#417"> 417: </a>                                      <span class="php-var">$coverDates</span> = <span class="php-keyword1">true</span>, <span class="php-var">$fetchTags</span> = <span class="php-keyword1">false</span>)
</span><span id="418" class="l"><a class="l" href="#418"> 418: </a>    {
</span><span id="419" class="l"><a class="l" href="#419"> 419: </a>        <span class="php-var">$results</span> = <span class="php-keyword1">array</span>();
</span><span id="420" class="l"><a class="l" href="#420"> 420: </a>
</span><span id="421" class="l"><a class="l" href="#421"> 421: </a>        <span class="php-comment">/* Internal calendars. */</span>
</span><span id="422" class="l"><a class="l" href="#422"> 422: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$calendars</span>)) {
</span><span id="423" class="l"><a class="l" href="#423"> 423: </a>            <span class="php-var">$calendars</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>];
</span><span id="424" class="l"><a class="l" href="#424"> 424: </a>        }
</span><span id="425" class="l"><a class="l" href="#425"> 425: </a>        <span class="php-var">$driver</span> = self::getDriver();
</span><span id="426" class="l"><a class="l" href="#426"> 426: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$calendar</span>) {
</span><span id="427" class="l"><a class="l" href="#427"> 427: </a>            <span class="php-keyword1">try</span> {
</span><span id="428" class="l"><a class="l" href="#428"> 428: </a>                <span class="php-var">$driver</span>-&gt;open(<span class="php-var">$calendar</span>);
</span><span id="429" class="l"><a class="l" href="#429"> 429: </a>                <span class="php-var">$events</span> = <span class="php-var">$driver</span>-&gt;listEvents(<span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>,
</span><span id="430" class="l"><a class="l" href="#430"> 430: </a>                                              <span class="php-var">$showRecurrence</span>, <span class="php-var">$alarmsOnly</span>,
</span><span id="431" class="l"><a class="l" href="#431"> 431: </a>                                              <span class="php-keyword1">false</span>, <span class="php-var">$coverDates</span>,
</span><span id="432" class="l"><a class="l" href="#432"> 432: </a>                                              <span class="php-var">$hideExceptions</span>, <span class="php-var">$fetchTags</span>);
</span><span id="433" class="l"><a class="l" href="#433"> 433: </a>                self::mergeEvents(<span class="php-var">$results</span>, <span class="php-var">$events</span>);
</span><span id="434" class="l"><a class="l" href="#434"> 434: </a>            } <span class="php-keyword1">catch</span> (Kronolith_Exception <span class="php-var">$e</span>) {
</span><span id="435" class="l"><a class="l" href="#435"> 435: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-var">$e</span>);
</span><span id="436" class="l"><a class="l" href="#436"> 436: </a>            }
</span><span id="437" class="l"><a class="l" href="#437"> 437: </a>        }
</span><span id="438" class="l"><a class="l" href="#438"> 438: </a>
</span><span id="439" class="l"><a class="l" href="#439"> 439: </a>        <span class="php-comment">/* Resource calendars (this would only be populated if explicitly
</span></span><span id="440" class="l"><a class="l" href="#440"> 440: </a><span class="php-comment">         * requested in the request, so include them if this is set regardless
</span></span><span id="441" class="l"><a class="l" href="#441"> 441: </a><span class="php-comment">         * of $calendars value).
</span></span><span id="442" class="l"><a class="l" href="#442"> 442: </a><span class="php-comment">         *
</span></span><span id="443" class="l"><a class="l" href="#443"> 443: </a><span class="php-comment">         * @TODO: Should we disallow even *viewing* these if the user is not an
</span></span><span id="444" class="l"><a class="l" href="#444"> 444: </a><span class="php-comment">         *        admin?
</span></span><span id="445" class="l"><a class="l" href="#445"> 445: </a><span class="php-comment">         */</span>
</span><span id="446" class="l"><a class="l" href="#446"> 446: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_resource_calendars'</span>])) {
</span><span id="447" class="l"><a class="l" href="#447"> 447: </a>            <span class="php-var">$driver</span> = self::getDriver(<span class="php-quote">'Resource'</span>);
</span><span id="448" class="l"><a class="l" href="#448"> 448: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_resource_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$calendar</span>) {
</span><span id="449" class="l"><a class="l" href="#449"> 449: </a>                <span class="php-keyword1">try</span> {
</span><span id="450" class="l"><a class="l" href="#450"> 450: </a>                    <span class="php-var">$driver</span>-&gt;open(<span class="php-var">$calendar</span>);
</span><span id="451" class="l"><a class="l" href="#451"> 451: </a>                    <span class="php-var">$events</span> = <span class="php-var">$driver</span>-&gt;listEvents(<span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>, <span class="php-var">$showRecurrence</span>);
</span><span id="452" class="l"><a class="l" href="#452"> 452: </a>                    self::mergeEvents(<span class="php-var">$results</span>, <span class="php-var">$events</span>);
</span><span id="453" class="l"><a class="l" href="#453"> 453: </a>                } <span class="php-keyword1">catch</span> (Kronolith_Exception <span class="php-var">$e</span>) {
</span><span id="454" class="l"><a class="l" href="#454"> 454: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-var">$e</span>);
</span><span id="455" class="l"><a class="l" href="#455"> 455: </a>                }
</span><span id="456" class="l"><a class="l" href="#456"> 456: </a>            }
</span><span id="457" class="l"><a class="l" href="#457"> 457: </a>        }
</span><span id="458" class="l"><a class="l" href="#458"> 458: </a>
</span><span id="459" class="l"><a class="l" href="#459"> 459: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$showRemote</span>) {
</span><span id="460" class="l"><a class="l" href="#460"> 460: </a>            <span class="php-comment">/* Horde applications providing listTimeObjects. */</span>
</span><span id="461" class="l"><a class="l" href="#461"> 461: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>])) {
</span><span id="462" class="l"><a class="l" href="#462"> 462: </a>                <span class="php-var">$driver</span> = self::getDriver(<span class="php-quote">'Horde'</span>);
</span><span id="463" class="l"><a class="l" href="#463"> 463: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$external_cal</span>) {
</span><span id="464" class="l"><a class="l" href="#464"> 464: </a>                    <span class="php-keyword1">try</span> {
</span><span id="465" class="l"><a class="l" href="#465"> 465: </a>                        <span class="php-var">$driver</span>-&gt;open(<span class="php-var">$external_cal</span>);
</span><span id="466" class="l"><a class="l" href="#466"> 466: </a>                        <span class="php-var">$events</span> = <span class="php-var">$driver</span>-&gt;listEvents(<span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>, <span class="php-var">$showRecurrence</span>);
</span><span id="467" class="l"><a class="l" href="#467"> 467: </a>                        self::mergeEvents(<span class="php-var">$results</span>, <span class="php-var">$events</span>);
</span><span id="468" class="l"><a class="l" href="#468"> 468: </a>                    } <span class="php-keyword1">catch</span> (Kronolith_Exception <span class="php-var">$e</span>) {
</span><span id="469" class="l"><a class="l" href="#469"> 469: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-var">$e</span>);
</span><span id="470" class="l"><a class="l" href="#470"> 470: </a>                    }
</span><span id="471" class="l"><a class="l" href="#471"> 471: </a>                }
</span><span id="472" class="l"><a class="l" href="#472"> 472: </a>            }
</span><span id="473" class="l"><a class="l" href="#473"> 473: </a>
</span><span id="474" class="l"><a class="l" href="#474"> 474: </a>            <span class="php-comment">/* Remote Calendars. */</span>
</span><span id="475" class="l"><a class="l" href="#475"> 475: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$url</span>) {
</span><span id="476" class="l"><a class="l" href="#476"> 476: </a>                <span class="php-keyword1">try</span> {
</span><span id="477" class="l"><a class="l" href="#477"> 477: </a>                    <span class="php-var">$driver</span> = self::getDriver(<span class="php-quote">'Ical'</span>, <span class="php-var">$url</span>);
</span><span id="478" class="l"><a class="l" href="#478"> 478: </a>                    <span class="php-var">$events</span> = <span class="php-var">$driver</span>-&gt;listEvents(<span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>, <span class="php-var">$showRecurrence</span>);
</span><span id="479" class="l"><a class="l" href="#479"> 479: </a>                    self::mergeEvents(<span class="php-var">$results</span>, <span class="php-var">$events</span>);
</span><span id="480" class="l"><a class="l" href="#480"> 480: </a>                } <span class="php-keyword1">catch</span> (Kronolith_Exception <span class="php-var">$e</span>) {
</span><span id="481" class="l"><a class="l" href="#481"> 481: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-var">$e</span>);
</span><span id="482" class="l"><a class="l" href="#482"> 482: </a>                }
</span><span id="483" class="l"><a class="l" href="#483"> 483: </a>            }
</span><span id="484" class="l"><a class="l" href="#484"> 484: </a>
</span><span id="485" class="l"><a class="l" href="#485"> 485: </a>            <span class="php-comment">/* Holidays. */</span>
</span><span id="486" class="l"><a class="l" href="#486"> 486: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>]) &amp;&amp; !<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'holidays'</span>][<span class="php-quote">'enable'</span>])) {
</span><span id="487" class="l"><a class="l" href="#487"> 487: </a>                <span class="php-var">$driver</span> = self::getDriver(<span class="php-quote">'Holidays'</span>);
</span><span id="488" class="l"><a class="l" href="#488"> 488: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>] <span class="php-keyword1">as</span> <span class="php-var">$holiday</span>) {
</span><span id="489" class="l"><a class="l" href="#489"> 489: </a>                    <span class="php-keyword1">try</span> {
</span><span id="490" class="l"><a class="l" href="#490"> 490: </a>                        <span class="php-var">$driver</span>-&gt;open(<span class="php-var">$holiday</span>);
</span><span id="491" class="l"><a class="l" href="#491"> 491: </a>                        <span class="php-var">$events</span> = <span class="php-var">$driver</span>-&gt;listEvents(<span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>, <span class="php-var">$showRecurrence</span>);
</span><span id="492" class="l"><a class="l" href="#492"> 492: </a>                        self::mergeEvents(<span class="php-var">$results</span>, <span class="php-var">$events</span>);
</span><span id="493" class="l"><a class="l" href="#493"> 493: </a>                    } <span class="php-keyword1">catch</span> (Kronolith_Exception <span class="php-var">$e</span>) {
</span><span id="494" class="l"><a class="l" href="#494"> 494: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-var">$e</span>);
</span><span id="495" class="l"><a class="l" href="#495"> 495: </a>                    }
</span><span id="496" class="l"><a class="l" href="#496"> 496: </a>                }
</span><span id="497" class="l"><a class="l" href="#497"> 497: </a>            }
</span><span id="498" class="l"><a class="l" href="#498"> 498: </a>        }
</span><span id="499" class="l"><a class="l" href="#499"> 499: </a>
</span><span id="500" class="l"><a class="l" href="#500"> 500: </a>        <span class="php-comment">/* Sort events. */</span>
</span><span id="501" class="l"><a class="l" href="#501"> 501: </a>        <span class="php-var">$results</span> = Kronolith::sortEvents(<span class="php-var">$results</span>);
</span><span id="502" class="l"><a class="l" href="#502"> 502: </a>
</span><span id="503" class="l"><a class="l" href="#503"> 503: </a>        <span class="php-keyword1">return</span> <span class="php-var">$results</span>;
</span><span id="504" class="l"><a class="l" href="#504"> 504: </a>    }
</span><span id="505" class="l"><a class="l" href="#505"> 505: </a>
</span><span id="506" class="l"><a class="l" href="#506"> 506: </a>    <span class="php-comment">/**
</span></span><span id="507" class="l"><a class="l" href="#507"> 507: </a><span class="php-comment">     * Merges results from two listEvents() result sets.
</span></span><span id="508" class="l"><a class="l" href="#508"> 508: </a><span class="php-comment">     *
</span></span><span id="509" class="l"><a class="l" href="#509"> 509: </a><span class="php-comment">     * @param array $results  First list of events.
</span></span><span id="510" class="l"><a class="l" href="#510"> 510: </a><span class="php-comment">     * @param array $events   List of events to be merged into the first one.
</span></span><span id="511" class="l"><a class="l" href="#511"> 511: </a><span class="php-comment">     */</span>
</span><span id="512" class="l"><a class="l" href="#512"> 512: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_mergeEvents" href="#_mergeEvents">mergeEvents</a>(&amp;<span class="php-var">$results</span>, <span class="php-var">$events</span>)
</span><span id="513" class="l"><a class="l" href="#513"> 513: </a>    {
</span><span id="514" class="l"><a class="l" href="#514"> 514: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$events</span> <span class="php-keyword1">as</span> <span class="php-var">$day</span> =&gt; <span class="php-var">$day_events</span>) {
</span><span id="515" class="l"><a class="l" href="#515"> 515: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$results</span>[<span class="php-var">$day</span>])) {
</span><span id="516" class="l"><a class="l" href="#516"> 516: </a>                <span class="php-var">$results</span>[<span class="php-var">$day</span>] = <span class="php-keyword2">array_merge</span>(<span class="php-var">$results</span>[<span class="php-var">$day</span>], <span class="php-var">$day_events</span>);
</span><span id="517" class="l"><a class="l" href="#517"> 517: </a>            } <span class="php-keyword1">else</span> {
</span><span id="518" class="l"><a class="l" href="#518"> 518: </a>                <span class="php-var">$results</span>[<span class="php-var">$day</span>] = <span class="php-var">$day_events</span>;
</span><span id="519" class="l"><a class="l" href="#519"> 519: </a>            }
</span><span id="520" class="l"><a class="l" href="#520"> 520: </a>        }
</span><span id="521" class="l"><a class="l" href="#521"> 521: </a>        <span class="php-keyword2">ksort</span>(<span class="php-var">$results</span>);
</span><span id="522" class="l"><a class="l" href="#522"> 522: </a>    }
</span><span id="523" class="l"><a class="l" href="#523"> 523: </a>
</span><span id="524" class="l"><a class="l" href="#524"> 524: </a>    <span class="php-comment">/**
</span></span><span id="525" class="l"><a class="l" href="#525"> 525: </a><span class="php-comment">     * Calculates recurrences of an event during a certain period.
</span></span><span id="526" class="l"><a class="l" href="#526"> 526: </a><span class="php-comment">     */</span>
</span><span id="527" class="l"><a class="l" href="#527"> 527: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_addEvents" href="#_addEvents">addEvents</a>(&amp;<span class="php-var">$results</span>, &amp;<span class="php-var">$event</span>, <span class="php-var">$startDate</span>, <span class="php-var">$endDate</span>,
</span><span id="528" class="l"><a class="l" href="#528"> 528: </a>                                     <span class="php-var">$showRecurrence</span>, <span class="php-var">$json</span>, <span class="php-var">$coverDates</span> = <span class="php-keyword1">true</span>)
</span><span id="529" class="l"><a class="l" href="#529"> 529: </a>    {
</span><span id="530" class="l"><a class="l" href="#530"> 530: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;recurs() &amp;&amp; <span class="php-var">$showRecurrence</span>) {
</span><span id="531" class="l"><a class="l" href="#531"> 531: </a>            <span class="php-comment">/* Recurring Event. */</span>
</span><span id="532" class="l"><a class="l" href="#532"> 532: </a>
</span><span id="533" class="l"><a class="l" href="#533"> 533: </a>            <span class="php-comment">/* If the event ends at 12am and does not end at the same time
</span></span><span id="534" class="l"><a class="l" href="#534"> 534: </a><span class="php-comment">             * that it starts (0 duration), set the end date to the previous
</span></span><span id="535" class="l"><a class="l" href="#535"> 535: </a><span class="php-comment">             * day's end date. */</span>
</span><span id="536" class="l"><a class="l" href="#536"> 536: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;hour == <span class="php-num">0</span> &amp;&amp;
</span><span id="537" class="l"><a class="l" href="#537"> 537: </a>                <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;<span class="php-keyword2">min</span> == <span class="php-num">0</span> &amp;&amp;
</span><span id="538" class="l"><a class="l" href="#538"> 538: </a>                <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;sec == <span class="php-num">0</span> &amp;&amp;
</span><span id="539" class="l"><a class="l" href="#539"> 539: </a>                <span class="php-var">$event</span>-&gt;start-&gt;compareDateTime(<span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>) != <span class="php-num">0</span>) {
</span><span id="540" class="l"><a class="l" href="#540"> 540: </a>                <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span> = <span class="php-keyword1">new</span> Horde_Date(
</span><span id="541" class="l"><a class="l" href="#541"> 541: </a>                    <span class="php-keyword1">array</span>(<span class="php-quote">'hour'</span> =&gt;  <span class="php-num">23</span>,
</span><span id="542" class="l"><a class="l" href="#542"> 542: </a>                          <span class="php-quote">'min'</span> =&gt;   <span class="php-num">59</span>,
</span><span id="543" class="l"><a class="l" href="#543"> 543: </a>                          <span class="php-quote">'sec'</span> =&gt;   <span class="php-num">59</span>,
</span><span id="544" class="l"><a class="l" href="#544"> 544: </a>                          <span class="php-quote">'month'</span> =&gt; <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;month,
</span><span id="545" class="l"><a class="l" href="#545"> 545: </a>                          <span class="php-quote">'mday'</span> =&gt;  <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;mday - <span class="php-num">1</span>,
</span><span id="546" class="l"><a class="l" href="#546"> 546: </a>                          <span class="php-quote">'year'</span> =&gt;  <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;year));
</span><span id="547" class="l"><a class="l" href="#547"> 547: </a>            }
</span><span id="548" class="l"><a class="l" href="#548"> 548: </a>
</span><span id="549" class="l"><a class="l" href="#549"> 549: </a>            <span class="php-comment">/* We can't use the event duration here because we might cover a
</span></span><span id="550" class="l"><a class="l" href="#550"> 550: </a><span class="php-comment">             * daylight saving time switch. */</span>
</span><span id="551" class="l"><a class="l" href="#551"> 551: </a>            <span class="php-var">$diff</span> = <span class="php-keyword1">array</span>(<span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;year - <span class="php-var">$event</span>-&gt;start-&gt;year,
</span><span id="552" class="l"><a class="l" href="#552"> 552: </a>                          <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;month - <span class="php-var">$event</span>-&gt;start-&gt;month,
</span><span id="553" class="l"><a class="l" href="#553"> 553: </a>                          <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;mday - <span class="php-var">$event</span>-&gt;start-&gt;mday,
</span><span id="554" class="l"><a class="l" href="#554"> 554: </a>                          <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;hour - <span class="php-var">$event</span>-&gt;start-&gt;hour,
</span><span id="555" class="l"><a class="l" href="#555"> 555: </a>                          <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;<span class="php-keyword2">min</span> - <span class="php-var">$event</span>-&gt;start-&gt;<span class="php-keyword2">min</span>);
</span><span id="556" class="l"><a class="l" href="#556"> 556: </a>
</span><span id="557" class="l"><a class="l" href="#557"> 557: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;start-&gt;compareDateTime(<span class="php-var">$startDate</span>) &lt; <span class="php-num">0</span>) {
</span><span id="558" class="l"><a class="l" href="#558"> 558: </a>                <span class="php-comment">/* The first time the event happens was before the period
</span></span><span id="559" class="l"><a class="l" href="#559"> 559: </a><span class="php-comment">                 * started. Start searching for recurrences from the start of
</span></span><span id="560" class="l"><a class="l" href="#560"> 560: </a><span class="php-comment">                 * the period. */</span>
</span><span id="561" class="l"><a class="l" href="#561"> 561: </a>                <span class="php-var">$next</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'year'</span> =&gt; <span class="php-var">$startDate</span>-&gt;year,
</span><span id="562" class="l"><a class="l" href="#562"> 562: </a>                              <span class="php-quote">'month'</span> =&gt; <span class="php-var">$startDate</span>-&gt;month,
</span><span id="563" class="l"><a class="l" href="#563"> 563: </a>                              <span class="php-quote">'mday'</span> =&gt; <span class="php-var">$startDate</span>-&gt;mday);
</span><span id="564" class="l"><a class="l" href="#564"> 564: </a>            } <span class="php-keyword1">else</span> {
</span><span id="565" class="l"><a class="l" href="#565"> 565: </a>                <span class="php-comment">/* The first time the event happens is in the range; unless
</span></span><span id="566" class="l"><a class="l" href="#566"> 566: </a><span class="php-comment">                 * there is an exception for this ocurrence, add it. */</span>
</span><span id="567" class="l"><a class="l" href="#567"> 567: </a>                <span class="php-keyword1">if</span> (!<span class="php-var">$event</span>-&gt;recurrence-&gt;hasException(<span class="php-var">$event</span>-&gt;start-&gt;year,
</span><span id="568" class="l"><a class="l" href="#568"> 568: </a>                                                      <span class="php-var">$event</span>-&gt;start-&gt;month,
</span><span id="569" class="l"><a class="l" href="#569"> 569: </a>                                                      <span class="php-var">$event</span>-&gt;start-&gt;mday)) {
</span><span id="570" class="l"><a class="l" href="#570"> 570: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$coverDates</span>) {
</span><span id="571" class="l"><a class="l" href="#571"> 571: </a>                        self::addCoverDates(<span class="php-var">$results</span>, <span class="php-var">$event</span>, <span class="php-var">$event</span>-&gt;start, <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>, <span class="php-var">$json</span>);
</span><span id="572" class="l"><a class="l" href="#572"> 572: </a>                    } <span class="php-keyword1">else</span> {
</span><span id="573" class="l"><a class="l" href="#573"> 573: </a>                        <span class="php-var">$results</span>[<span class="php-var">$event</span>-&gt;start-&gt;dateString()][<span class="php-var">$event</span>-&gt;id] = <span class="php-var">$json</span> ? <span class="php-var">$event</span>-&gt;toJson() : <span class="php-var">$event</span>;
</span><span id="574" class="l"><a class="l" href="#574"> 574: </a>                    }
</span><span id="575" class="l"><a class="l" href="#575"> 575: </a>                }
</span><span id="576" class="l"><a class="l" href="#576"> 576: </a>
</span><span id="577" class="l"><a class="l" href="#577"> 577: </a>                <span class="php-comment">/* Start searching for recurrences from the day after it
</span></span><span id="578" class="l"><a class="l" href="#578"> 578: </a><span class="php-comment">                 * starts. */</span>
</span><span id="579" class="l"><a class="l" href="#579"> 579: </a>                <span class="php-var">$next</span> = <span class="php-keyword1">clone</span> <span class="php-var">$event</span>-&gt;start;
</span><span id="580" class="l"><a class="l" href="#580"> 580: </a>                ++<span class="php-var">$next</span>-&gt;mday;
</span><span id="581" class="l"><a class="l" href="#581"> 581: </a>            }
</span><span id="582" class="l"><a class="l" href="#582"> 582: </a>
</span><span id="583" class="l"><a class="l" href="#583"> 583: </a>            <span class="php-comment">/* Add all recurrences of the event. */</span>
</span><span id="584" class="l"><a class="l" href="#584"> 584: </a>            <span class="php-var">$next</span> = <span class="php-var">$event</span>-&gt;recurrence-&gt;nextRecurrence(<span class="php-var">$next</span>);
</span><span id="585" class="l"><a class="l" href="#585"> 585: </a>            <span class="php-keyword1">while</span> (<span class="php-var">$next</span> !== <span class="php-keyword1">false</span> &amp;&amp; <span class="php-var">$next</span>-&gt;compareDate(<span class="php-var">$endDate</span>) &lt;= <span class="php-num">0</span>) {
</span><span id="586" class="l"><a class="l" href="#586"> 586: </a>                <span class="php-keyword1">if</span> (!<span class="php-var">$event</span>-&gt;recurrence-&gt;hasException(<span class="php-var">$next</span>-&gt;year, <span class="php-var">$next</span>-&gt;month, <span class="php-var">$next</span>-&gt;mday)) {
</span><span id="587" class="l"><a class="l" href="#587"> 587: </a>                    <span class="php-comment">/* Add the event to all the days it covers. */</span>
</span><span id="588" class="l"><a class="l" href="#588"> 588: </a>                    <span class="php-var">$nextEnd</span> = <span class="php-keyword1">clone</span> <span class="php-var">$next</span>;
</span><span id="589" class="l"><a class="l" href="#589"> 589: </a>                    <span class="php-var">$nextEnd</span>-&gt;year  += <span class="php-var">$diff</span>[<span class="php-num">0</span>];
</span><span id="590" class="l"><a class="l" href="#590"> 590: </a>                    <span class="php-var">$nextEnd</span>-&gt;month += <span class="php-var">$diff</span>[<span class="php-num">1</span>];
</span><span id="591" class="l"><a class="l" href="#591"> 591: </a>                    <span class="php-var">$nextEnd</span>-&gt;mday  += <span class="php-var">$diff</span>[<span class="php-num">2</span>];
</span><span id="592" class="l"><a class="l" href="#592"> 592: </a>                    <span class="php-var">$nextEnd</span>-&gt;hour  += <span class="php-var">$diff</span>[<span class="php-num">3</span>];
</span><span id="593" class="l"><a class="l" href="#593"> 593: </a>                    <span class="php-var">$nextEnd</span>-&gt;<span class="php-keyword2">min</span>   += <span class="php-var">$diff</span>[<span class="php-num">4</span>];
</span><span id="594" class="l"><a class="l" href="#594"> 594: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$coverDates</span>) {
</span><span id="595" class="l"><a class="l" href="#595"> 595: </a>                        self::addCoverDates(<span class="php-var">$results</span>, <span class="php-var">$event</span>, <span class="php-var">$next</span>, <span class="php-var">$nextEnd</span>, <span class="php-var">$json</span>);
</span><span id="596" class="l"><a class="l" href="#596"> 596: </a>                    } <span class="php-keyword1">else</span> {
</span><span id="597" class="l"><a class="l" href="#597"> 597: </a>                        <span class="php-var">$addEvent</span> = <span class="php-keyword1">clone</span> <span class="php-var">$event</span>;
</span><span id="598" class="l"><a class="l" href="#598"> 598: </a>                        <span class="php-var">$addEvent</span>-&gt;start = <span class="php-var">$next</span>;
</span><span id="599" class="l"><a class="l" href="#599"> 599: </a>                        <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span> = <span class="php-var">$nextEnd</span>;
</span><span id="600" class="l"><a class="l" href="#600"> 600: </a>                        <span class="php-var">$results</span>[<span class="php-var">$addEvent</span>-&gt;start-&gt;dateString()][<span class="php-var">$addEvent</span>-&gt;id] = <span class="php-var">$json</span> ? <span class="php-var">$addEvent</span>-&gt;toJson() : <span class="php-var">$addEvent</span>;
</span><span id="601" class="l"><a class="l" href="#601"> 601: </a>
</span><span id="602" class="l"><a class="l" href="#602"> 602: </a>                    }
</span><span id="603" class="l"><a class="l" href="#603"> 603: </a>                }
</span><span id="604" class="l"><a class="l" href="#604"> 604: </a>                <span class="php-var">$next</span> = <span class="php-var">$event</span>-&gt;recurrence-&gt;nextRecurrence(
</span><span id="605" class="l"><a class="l" href="#605"> 605: </a>                    <span class="php-keyword1">array</span>(<span class="php-quote">'year'</span> =&gt; <span class="php-var">$next</span>-&gt;year,
</span><span id="606" class="l"><a class="l" href="#606"> 606: </a>                          <span class="php-quote">'month'</span> =&gt; <span class="php-var">$next</span>-&gt;month,
</span><span id="607" class="l"><a class="l" href="#607"> 607: </a>                          <span class="php-quote">'mday'</span> =&gt; <span class="php-var">$next</span>-&gt;mday + <span class="php-num">1</span>,
</span><span id="608" class="l"><a class="l" href="#608"> 608: </a>                          <span class="php-quote">'hour'</span> =&gt; <span class="php-var">$next</span>-&gt;hour,
</span><span id="609" class="l"><a class="l" href="#609"> 609: </a>                          <span class="php-quote">'min'</span> =&gt; <span class="php-var">$next</span>-&gt;<span class="php-keyword2">min</span>,
</span><span id="610" class="l"><a class="l" href="#610"> 610: </a>                          <span class="php-quote">'sec'</span> =&gt; <span class="php-var">$next</span>-&gt;sec));
</span><span id="611" class="l"><a class="l" href="#611"> 611: </a>            }
</span><span id="612" class="l"><a class="l" href="#612"> 612: </a>        } <span class="php-keyword1">else</span> {
</span><span id="613" class="l"><a class="l" href="#613"> 613: </a>            <span class="php-comment">/* Event only occurs once. */</span>
</span><span id="614" class="l"><a class="l" href="#614"> 614: </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$coverDates</span>) {
</span><span id="615" class="l"><a class="l" href="#615"> 615: </a>                <span class="php-var">$results</span>[<span class="php-var">$event</span>-&gt;start-&gt;dateString()][<span class="php-var">$event</span>-&gt;id] = <span class="php-var">$json</span> ? <span class="php-var">$event</span>-&gt;toJson() : <span class="php-var">$event</span>;
</span><span id="616" class="l"><a class="l" href="#616"> 616: </a>            } <span class="php-keyword1">else</span> {
</span><span id="617" class="l"><a class="l" href="#617"> 617: </a>                <span class="php-var">$allDay</span> = <span class="php-var">$event</span>-&gt;isAllDay();
</span><span id="618" class="l"><a class="l" href="#618"> 618: </a>
</span><span id="619" class="l"><a class="l" href="#619"> 619: </a>                <span class="php-comment">/* Work out what day it starts on. */</span>
</span><span id="620" class="l"><a class="l" href="#620"> 620: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$startDate</span> &amp;&amp;
</span><span id="621" class="l"><a class="l" href="#621"> 621: </a>                    <span class="php-var">$event</span>-&gt;start-&gt;compareDateTime(<span class="php-var">$startDate</span>) &lt; <span class="php-num">0</span>) {
</span><span id="622" class="l"><a class="l" href="#622"> 622: </a>                    <span class="php-comment">/* It started before the beginning of the period. */</span>
</span><span id="623" class="l"><a class="l" href="#623"> 623: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;recurs()) {
</span><span id="624" class="l"><a class="l" href="#624"> 624: </a>                        <span class="php-var">$eventStart</span> = <span class="php-var">$event</span>-&gt;recurrence-&gt;nextRecurrence(<span class="php-var">$startDate</span>);
</span><span id="625" class="l"><a class="l" href="#625"> 625: </a>                    } <span class="php-keyword1">else</span> {
</span><span id="626" class="l"><a class="l" href="#626"> 626: </a>                        <span class="php-var">$eventStart</span> = <span class="php-keyword1">clone</span> <span class="php-var">$startDate</span>;
</span><span id="627" class="l"><a class="l" href="#627"> 627: </a>                    }
</span><span id="628" class="l"><a class="l" href="#628"> 628: </a>                } <span class="php-keyword1">else</span> {
</span><span id="629" class="l"><a class="l" href="#629"> 629: </a>                    <span class="php-var">$eventStart</span> = <span class="php-keyword1">clone</span> <span class="php-var">$event</span>-&gt;start;
</span><span id="630" class="l"><a class="l" href="#630"> 630: </a>                }
</span><span id="631" class="l"><a class="l" href="#631"> 631: </a>
</span><span id="632" class="l"><a class="l" href="#632"> 632: </a>                <span class="php-comment">/* Work out what day it ends on. */</span>
</span><span id="633" class="l"><a class="l" href="#633"> 633: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$endDate</span> &amp;&amp;
</span><span id="634" class="l"><a class="l" href="#634"> 634: </a>                    <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;compareDateTime(<span class="php-var">$endDate</span>) &gt; <span class="php-num">0</span>) {
</span><span id="635" class="l"><a class="l" href="#635"> 635: </a>                    <span class="php-comment">/* Ends after the end of the period. */</span>
</span><span id="636" class="l"><a class="l" href="#636"> 636: </a>                    <span class="php-keyword1">if</span> (<span class="php-keyword2">is_object</span>(<span class="php-var">$endDate</span>)) {
</span><span id="637" class="l"><a class="l" href="#637"> 637: </a>                        <span class="php-var">$eventEnd</span> = <span class="php-keyword1">clone</span> <span class="php-var">$endDate</span>;
</span><span id="638" class="l"><a class="l" href="#638"> 638: </a>                    } <span class="php-keyword1">else</span> {
</span><span id="639" class="l"><a class="l" href="#639"> 639: </a>                        <span class="php-var">$eventEnd</span> = <span class="php-var">$endDate</span>;
</span><span id="640" class="l"><a class="l" href="#640"> 640: </a>                    }
</span><span id="641" class="l"><a class="l" href="#641"> 641: </a>                } <span class="php-keyword1">else</span> {
</span><span id="642" class="l"><a class="l" href="#642"> 642: </a>                    <span class="php-comment">/* Need to perform some magic if this is a single instance
</span></span><span id="643" class="l"><a class="l" href="#643"> 643: </a><span class="php-comment">                     * of a recurring event since $event-&gt;end would be the
</span></span><span id="644" class="l"><a class="l" href="#644"> 644: </a><span class="php-comment">                     * original end date, not the recurrence's end date. */</span>
</span><span id="645" class="l"><a class="l" href="#645"> 645: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;recurs()) {
</span><span id="646" class="l"><a class="l" href="#646"> 646: </a>
</span><span id="647" class="l"><a class="l" href="#647"> 647: </a>                        <span class="php-var">$diff</span> = <span class="php-keyword1">array</span>(<span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;year - <span class="php-var">$event</span>-&gt;start-&gt;year,
</span><span id="648" class="l"><a class="l" href="#648"> 648: </a>                                      <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;month - <span class="php-var">$event</span>-&gt;start-&gt;month,
</span><span id="649" class="l"><a class="l" href="#649"> 649: </a>                                      <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;mday - <span class="php-var">$event</span>-&gt;start-&gt;mday,
</span><span id="650" class="l"><a class="l" href="#650"> 650: </a>                                      <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;hour - <span class="php-var">$event</span>-&gt;start-&gt;hour,
</span><span id="651" class="l"><a class="l" href="#651"> 651: </a>                                      <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>-&gt;<span class="php-keyword2">min</span> - <span class="php-var">$event</span>-&gt;start-&gt;<span class="php-keyword2">min</span>);
</span><span id="652" class="l"><a class="l" href="#652"> 652: </a>
</span><span id="653" class="l"><a class="l" href="#653"> 653: </a>                        <span class="php-var">$theEnd</span> = <span class="php-var">$event</span>-&gt;recurrence-&gt;nextRecurrence(<span class="php-var">$eventStart</span>);
</span><span id="654" class="l"><a class="l" href="#654"> 654: </a>                        <span class="php-var">$theEnd</span>-&gt;year  += <span class="php-var">$diff</span>[<span class="php-num">0</span>];
</span><span id="655" class="l"><a class="l" href="#655"> 655: </a>                        <span class="php-var">$theEnd</span>-&gt;month += <span class="php-var">$diff</span>[<span class="php-num">1</span>];
</span><span id="656" class="l"><a class="l" href="#656"> 656: </a>                        <span class="php-var">$theEnd</span>-&gt;mday  += <span class="php-var">$diff</span>[<span class="php-num">2</span>];
</span><span id="657" class="l"><a class="l" href="#657"> 657: </a>                        <span class="php-var">$theEnd</span>-&gt;hour  += <span class="php-var">$diff</span>[<span class="php-num">3</span>];
</span><span id="658" class="l"><a class="l" href="#658"> 658: </a>                        <span class="php-var">$theEnd</span>-&gt;<span class="php-keyword2">min</span>   += <span class="php-var">$diff</span>[<span class="php-num">4</span>];
</span><span id="659" class="l"><a class="l" href="#659"> 659: </a>                    } <span class="php-keyword1">else</span> {
</span><span id="660" class="l"><a class="l" href="#660"> 660: </a>                        <span class="php-var">$theEnd</span> = <span class="php-keyword1">clone</span> <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>;
</span><span id="661" class="l"><a class="l" href="#661"> 661: </a>                    }
</span><span id="662" class="l"><a class="l" href="#662"> 662: </a>
</span><span id="663" class="l"><a class="l" href="#663"> 663: </a>                    <span class="php-comment">/* If the event doesn't end at 12am set the end date to
</span></span><span id="664" class="l"><a class="l" href="#664"> 664: </a><span class="php-comment">                     * the current end date. If it ends at 12am and does not
</span></span><span id="665" class="l"><a class="l" href="#665"> 665: </a><span class="php-comment">                     * end at the same time that it starts (0 duration), set
</span></span><span id="666" class="l"><a class="l" href="#666"> 666: </a><span class="php-comment">                     * the end date to the previous day's end date. */</span>
</span><span id="667" class="l"><a class="l" href="#667"> 667: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$theEnd</span>-&gt;hour != <span class="php-num">0</span> ||
</span><span id="668" class="l"><a class="l" href="#668"> 668: </a>                        <span class="php-var">$theEnd</span>-&gt;<span class="php-keyword2">min</span> != <span class="php-num">0</span> ||
</span><span id="669" class="l"><a class="l" href="#669"> 669: </a>                        <span class="php-var">$theEnd</span>-&gt;sec != <span class="php-num">0</span> ||
</span><span id="670" class="l"><a class="l" href="#670"> 670: </a>                        <span class="php-var">$event</span>-&gt;start-&gt;compareDateTime(<span class="php-var">$theEnd</span>) == <span class="php-num">0</span> ||
</span><span id="671" class="l"><a class="l" href="#671"> 671: </a>                        <span class="php-var">$allDay</span>) {
</span><span id="672" class="l"><a class="l" href="#672"> 672: </a>                        <span class="php-var">$eventEnd</span> = <span class="php-keyword1">clone</span> <span class="php-var">$theEnd</span>;
</span><span id="673" class="l"><a class="l" href="#673"> 673: </a>                    } <span class="php-keyword1">else</span> {
</span><span id="674" class="l"><a class="l" href="#674"> 674: </a>                        <span class="php-var">$eventEnd</span> = <span class="php-keyword1">new</span> Horde_Date(
</span><span id="675" class="l"><a class="l" href="#675"> 675: </a>                            <span class="php-keyword1">array</span>(<span class="php-quote">'hour'</span> =&gt;  <span class="php-num">23</span>,
</span><span id="676" class="l"><a class="l" href="#676"> 676: </a>                                  <span class="php-quote">'min'</span> =&gt;   <span class="php-num">59</span>,
</span><span id="677" class="l"><a class="l" href="#677"> 677: </a>                                  <span class="php-quote">'sec'</span> =&gt;   <span class="php-num">59</span>,
</span><span id="678" class="l"><a class="l" href="#678"> 678: </a>                                  <span class="php-quote">'month'</span> =&gt; <span class="php-var">$theEnd</span>-&gt;month,
</span><span id="679" class="l"><a class="l" href="#679"> 679: </a>                                  <span class="php-quote">'mday'</span> =&gt;  <span class="php-var">$theEnd</span>-&gt;mday - <span class="php-num">1</span>,
</span><span id="680" class="l"><a class="l" href="#680"> 680: </a>                                  <span class="php-quote">'year'</span> =&gt;  <span class="php-var">$theEnd</span>-&gt;year));
</span><span id="681" class="l"><a class="l" href="#681"> 681: </a>                    }
</span><span id="682" class="l"><a class="l" href="#682"> 682: </a>                }
</span><span id="683" class="l"><a class="l" href="#683"> 683: </a>
</span><span id="684" class="l"><a class="l" href="#684"> 684: </a>                <span class="php-comment">/* Add the event to all the days it covers. This is similar to
</span></span><span id="685" class="l"><a class="l" href="#685"> 685: </a><span class="php-comment">                 * Kronolith::addCoverDates(), but for days in between the
</span></span><span id="686" class="l"><a class="l" href="#686"> 686: </a><span class="php-comment">                 * start and end day, the range is midnight to midnight, and
</span></span><span id="687" class="l"><a class="l" href="#687"> 687: </a><span class="php-comment">                 * for the edge days it's start to midnight, and midnight to
</span></span><span id="688" class="l"><a class="l" href="#688"> 688: </a><span class="php-comment">                 * end. */</span>
</span><span id="689" class="l"><a class="l" href="#689"> 689: </a>                <span class="php-var">$i</span> = <span class="php-var">$eventStart</span>-&gt;mday;
</span><span id="690" class="l"><a class="l" href="#690"> 690: </a>                <span class="php-var">$loopDate</span> = <span class="php-keyword1">new</span> Horde_Date(<span class="php-keyword1">array</span>(<span class="php-quote">'month'</span> =&gt; <span class="php-var">$eventStart</span>-&gt;month,
</span><span id="691" class="l"><a class="l" href="#691"> 691: </a>                                                 <span class="php-quote">'mday'</span> =&gt; <span class="php-var">$i</span>,
</span><span id="692" class="l"><a class="l" href="#692"> 692: </a>                                                 <span class="php-quote">'year'</span> =&gt; <span class="php-var">$eventStart</span>-&gt;year));
</span><span id="693" class="l"><a class="l" href="#693"> 693: </a>                <span class="php-keyword1">while</span> (<span class="php-var">$loopDate</span>-&gt;compareDateTime(<span class="php-var">$eventEnd</span>) &lt;= <span class="php-num">0</span>) {
</span><span id="694" class="l"><a class="l" href="#694"> 694: </a>                    <span class="php-keyword1">if</span> (!<span class="php-var">$allDay</span> ||
</span><span id="695" class="l"><a class="l" href="#695"> 695: </a>                        <span class="php-var">$loopDate</span>-&gt;compareDateTime(<span class="php-var">$eventEnd</span>) != <span class="php-num">0</span>) {
</span><span id="696" class="l"><a class="l" href="#696"> 696: </a>                        <span class="php-var">$addEvent</span> = <span class="php-keyword1">clone</span> <span class="php-var">$event</span>;
</span><span id="697" class="l"><a class="l" href="#697"> 697: </a>
</span><span id="698" class="l"><a class="l" href="#698"> 698: </a>                        <span class="php-comment">/* If this is the start day, set the start time to
</span></span><span id="699" class="l"><a class="l" href="#699"> 699: </a><span class="php-comment">                         * the real start time, otherwise set it to
</span></span><span id="700" class="l"><a class="l" href="#700"> 700: </a><span class="php-comment">                         * 00:00 */</span>
</span><span id="701" class="l"><a class="l" href="#701"> 701: </a>                        <span class="php-keyword1">if</span> (<span class="php-var">$loopDate</span>-&gt;compareDate(<span class="php-var">$eventStart</span>) == <span class="php-num">0</span>) {
</span><span id="702" class="l"><a class="l" href="#702"> 702: </a>                            <span class="php-var">$addEvent</span>-&gt;start = <span class="php-var">$eventStart</span>;
</span><span id="703" class="l"><a class="l" href="#703"> 703: </a>                        } <span class="php-keyword1">else</span> {
</span><span id="704" class="l"><a class="l" href="#704"> 704: </a>                            <span class="php-var">$addEvent</span>-&gt;start = <span class="php-keyword1">clone</span> <span class="php-var">$loopDate</span>;
</span><span id="705" class="l"><a class="l" href="#705"> 705: </a>                            <span class="php-var">$addEvent</span>-&gt;start-&gt;hour = <span class="php-var">$addEvent</span>-&gt;start-&gt;<span class="php-keyword2">min</span> = <span class="php-var">$addEvent</span>-&gt;start-&gt;sec = <span class="php-num">0</span>;
</span><span id="706" class="l"><a class="l" href="#706"> 706: </a>                            <span class="php-var">$addEvent</span>-&gt;first = <span class="php-keyword1">false</span>;
</span><span id="707" class="l"><a class="l" href="#707"> 707: </a>                        }
</span><span id="708" class="l"><a class="l" href="#708"> 708: </a>
</span><span id="709" class="l"><a class="l" href="#709"> 709: </a>                        <span class="php-comment">/* If this is the end day, set the end time to the
</span></span><span id="710" class="l"><a class="l" href="#710"> 710: </a><span class="php-comment">                         * real event end, otherwise set it to 23:59. */</span>
</span><span id="711" class="l"><a class="l" href="#711"> 711: </a>                        <span class="php-keyword1">if</span> (<span class="php-var">$loopDate</span>-&gt;compareDate(<span class="php-var">$eventEnd</span>) == <span class="php-num">0</span>) {
</span><span id="712" class="l"><a class="l" href="#712"> 712: </a>                            <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span> = <span class="php-var">$eventEnd</span>;
</span><span id="713" class="l"><a class="l" href="#713"> 713: </a>                        } <span class="php-keyword1">else</span> {
</span><span id="714" class="l"><a class="l" href="#714"> 714: </a>                            <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span> = <span class="php-keyword1">clone</span> <span class="php-var">$loopDate</span>;
</span><span id="715" class="l"><a class="l" href="#715"> 715: </a>                            <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span>-&gt;hour = <span class="php-num">23</span>;
</span><span id="716" class="l"><a class="l" href="#716"> 716: </a>                            <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span>-&gt;<span class="php-keyword2">min</span> = <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span>-&gt;sec = <span class="php-num">59</span>;
</span><span id="717" class="l"><a class="l" href="#717"> 717: </a>                            <span class="php-var">$addEvent</span>-&gt;last = <span class="php-keyword1">false</span>;
</span><span id="718" class="l"><a class="l" href="#718"> 718: </a>                        }
</span><span id="719" class="l"><a class="l" href="#719"> 719: </a>
</span><span id="720" class="l"><a class="l" href="#720"> 720: </a>                        <span class="php-var">$results</span>[<span class="php-var">$loopDate</span>-&gt;dateString()][<span class="php-var">$addEvent</span>-&gt;id] = <span class="php-var">$json</span> ? <span class="php-var">$addEvent</span>-&gt;toJson(<span class="php-var">$allDay</span>) : <span class="php-var">$addEvent</span>;
</span><span id="721" class="l"><a class="l" href="#721"> 721: </a>                    }
</span><span id="722" class="l"><a class="l" href="#722"> 722: </a>
</span><span id="723" class="l"><a class="l" href="#723"> 723: </a>                    <span class="php-var">$loopDate</span> = <span class="php-keyword1">new</span> Horde_Date(
</span><span id="724" class="l"><a class="l" href="#724"> 724: </a>                        <span class="php-keyword1">array</span>(<span class="php-quote">'month'</span> =&gt; <span class="php-var">$eventStart</span>-&gt;month,
</span><span id="725" class="l"><a class="l" href="#725"> 725: </a>                              <span class="php-quote">'mday'</span> =&gt; ++<span class="php-var">$i</span>,
</span><span id="726" class="l"><a class="l" href="#726"> 726: </a>                              <span class="php-quote">'year'</span> =&gt; <span class="php-var">$eventStart</span>-&gt;year));
</span><span id="727" class="l"><a class="l" href="#727"> 727: </a>                }
</span><span id="728" class="l"><a class="l" href="#728"> 728: </a>            }
</span><span id="729" class="l"><a class="l" href="#729"> 729: </a>        }
</span><span id="730" class="l"><a class="l" href="#730"> 730: </a>        <span class="php-keyword2">ksort</span>(<span class="php-var">$results</span>);
</span><span id="731" class="l"><a class="l" href="#731"> 731: </a>    }
</span><span id="732" class="l"><a class="l" href="#732"> 732: </a>
</span><span id="733" class="l"><a class="l" href="#733"> 733: </a>    <span class="php-comment">/**
</span></span><span id="734" class="l"><a class="l" href="#734"> 734: </a><span class="php-comment">     * Adds an event to all the days it covers.
</span></span><span id="735" class="l"><a class="l" href="#735"> 735: </a><span class="php-comment">     *
</span></span><span id="736" class="l"><a class="l" href="#736"> 736: </a><span class="php-comment">     * @param array $result           The current result list.
</span></span><span id="737" class="l"><a class="l" href="#737"> 737: </a><span class="php-comment">     * @param Kronolith_Event $event  An event object.
</span></span><span id="738" class="l"><a class="l" href="#738"> 738: </a><span class="php-comment">     * @param Horde_Date $eventStart  The event's start at the actual
</span></span><span id="739" class="l"><a class="l" href="#739"> 739: </a><span class="php-comment">     *                                recurrence.
</span></span><span id="740" class="l"><a class="l" href="#740"> 740: </a><span class="php-comment">     * @param Horde_Date $eventEnd    The event's end at the actual recurrence.
</span></span><span id="741" class="l"><a class="l" href="#741"> 741: </a><span class="php-comment">     * @param boolean $json           Store the results of the events' toJson()
</span></span><span id="742" class="l"><a class="l" href="#742"> 742: </a><span class="php-comment">     *                                method?
</span></span><span id="743" class="l"><a class="l" href="#743"> 743: </a><span class="php-comment">     */</span>
</span><span id="744" class="l"><a class="l" href="#744"> 744: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_addCoverDates" href="#_addCoverDates">addCoverDates</a>(&amp;<span class="php-var">$results</span>, <span class="php-var">$event</span>, <span class="php-var">$eventStart</span>,
</span><span id="745" class="l"><a class="l" href="#745"> 745: </a>                                         <span class="php-var">$eventEnd</span>, <span class="php-var">$json</span>)
</span><span id="746" class="l"><a class="l" href="#746"> 746: </a>    {
</span><span id="747" class="l"><a class="l" href="#747"> 747: </a>        <span class="php-var">$loopDate</span> = <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$eventStart</span>-&gt;year, <span class="php-var">$eventStart</span>-&gt;month, <span class="php-var">$eventStart</span>-&gt;mday);
</span><span id="748" class="l"><a class="l" href="#748"> 748: </a>        <span class="php-var">$allDay</span> = <span class="php-var">$event</span>-&gt;isAllDay();
</span><span id="749" class="l"><a class="l" href="#749"> 749: </a>        <span class="php-var">$first</span> = <span class="php-keyword1">true</span>;
</span><span id="750" class="l"><a class="l" href="#750"> 750: </a>        <span class="php-keyword1">while</span> (<span class="php-var">$loopDate</span>-&gt;compareDateTime(<span class="php-var">$eventEnd</span>) &lt;= <span class="php-num">0</span>) {
</span><span id="751" class="l"><a class="l" href="#751"> 751: </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$allDay</span> ||
</span><span id="752" class="l"><a class="l" href="#752"> 752: </a>                <span class="php-var">$loopDate</span>-&gt;compareDateTime(<span class="php-var">$eventEnd</span>) != <span class="php-num">0</span>) {
</span><span id="753" class="l"><a class="l" href="#753"> 753: </a>                <span class="php-var">$addEvent</span> = <span class="php-keyword1">clone</span> <span class="php-var">$event</span>;
</span><span id="754" class="l"><a class="l" href="#754"> 754: </a>                <span class="php-var">$addEvent</span>-&gt;start = <span class="php-var">$eventStart</span>;
</span><span id="755" class="l"><a class="l" href="#755"> 755: </a>                <span class="php-var">$addEvent</span>-&gt;<span class="php-keyword2">end</span> = <span class="php-var">$eventEnd</span>;
</span><span id="756" class="l"><a class="l" href="#756"> 756: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$loopDate</span>-&gt;compareDate(<span class="php-var">$eventStart</span>) != <span class="php-num">0</span>) {
</span><span id="757" class="l"><a class="l" href="#757"> 757: </a>                    <span class="php-var">$addEvent</span>-&gt;first = <span class="php-keyword1">false</span>;
</span><span id="758" class="l"><a class="l" href="#758"> 758: </a>                }
</span><span id="759" class="l"><a class="l" href="#759"> 759: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$loopDate</span>-&gt;compareDate(<span class="php-var">$eventEnd</span>) != <span class="php-num">0</span>) {
</span><span id="760" class="l"><a class="l" href="#760"> 760: </a>                    <span class="php-var">$addEvent</span>-&gt;last = <span class="php-keyword1">false</span>;
</span><span id="761" class="l"><a class="l" href="#761"> 761: </a>                }
</span><span id="762" class="l"><a class="l" href="#762"> 762: </a>                <span class="php-var">$results</span>[<span class="php-var">$loopDate</span>-&gt;dateString()][<span class="php-var">$addEvent</span>-&gt;id] = <span class="php-var">$json</span> ? <span class="php-var">$addEvent</span>-&gt;toJson(<span class="php-var">$allDay</span>) : <span class="php-var">$addEvent</span>;
</span><span id="763" class="l"><a class="l" href="#763"> 763: </a>            }
</span><span id="764" class="l"><a class="l" href="#764"> 764: </a>            <span class="php-var">$loopDate</span>-&gt;mday++;
</span><span id="765" class="l"><a class="l" href="#765"> 765: </a>        }
</span><span id="766" class="l"><a class="l" href="#766"> 766: </a>    }
</span><span id="767" class="l"><a class="l" href="#767"> 767: </a>
</span><span id="768" class="l"><a class="l" href="#768"> 768: </a>    <span class="php-comment">/**
</span></span><span id="769" class="l"><a class="l" href="#769"> 769: </a><span class="php-comment">     * Adds an event to set of search results.
</span></span><span id="770" class="l"><a class="l" href="#770"> 770: </a><span class="php-comment">     *
</span></span><span id="771" class="l"><a class="l" href="#771"> 771: </a><span class="php-comment">     * @param array $events           The list of events to update with the new
</span></span><span id="772" class="l"><a class="l" href="#772"> 772: </a><span class="php-comment">     *                                event.
</span></span><span id="773" class="l"><a class="l" href="#773"> 773: </a><span class="php-comment">     * @param Kronolith_Event $event  An event from a search result.
</span></span><span id="774" class="l"><a class="l" href="#774"> 774: </a><span class="php-comment">     * @param stdClass $query         A search query.
</span></span><span id="775" class="l"><a class="l" href="#775"> 775: </a><span class="php-comment">     * @param boolean $json           Store the results of the events' toJson()
</span></span><span id="776" class="l"><a class="l" href="#776"> 776: </a><span class="php-comment">     *                                method?
</span></span><span id="777" class="l"><a class="l" href="#777"> 777: </a><span class="php-comment">     */</span>
</span><span id="778" class="l"><a class="l" href="#778"> 778: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_addSearchEvents" href="#_addSearchEvents">addSearchEvents</a>(&amp;<span class="php-var">$events</span>, <span class="php-var">$event</span>, <span class="php-var">$query</span>, <span class="php-var">$json</span>)
</span><span id="779" class="l"><a class="l" href="#779"> 779: </a>    {
</span><span id="780" class="l"><a class="l" href="#780"> 780: </a>        <span class="php-keyword1">static</span> <span class="php-var"><a id="$now" href="#$now">$now</a></span>;
</span><span id="781" class="l"><a class="l" href="#781"> 781: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$now</span>)) {
</span><span id="782" class="l"><a class="l" href="#782"> 782: </a>            <span class="php-var">$now</span> = <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_TIME'</span>]);
</span><span id="783" class="l"><a class="l" href="#783"> 783: </a>        }
</span><span id="784" class="l"><a class="l" href="#784"> 784: </a>        <span class="php-var">$showRecurrence</span> = <span class="php-keyword1">true</span>;
</span><span id="785" class="l"><a class="l" href="#785"> 785: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;recurs()) {
</span><span id="786" class="l"><a class="l" href="#786"> 786: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$query</span>-&gt;start) &amp;&amp; <span class="php-keyword1">empty</span>(<span class="php-var">$query</span>-&gt;<span class="php-keyword2">end</span>)) {
</span><span id="787" class="l"><a class="l" href="#787"> 787: </a>                <span class="php-var">$eventStart</span> = <span class="php-var">$event</span>-&gt;start;
</span><span id="788" class="l"><a class="l" href="#788"> 788: </a>                <span class="php-var">$eventEnd</span> = <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>;
</span><span id="789" class="l"><a class="l" href="#789"> 789: </a>            } <span class="php-keyword1">else</span> {
</span><span id="790" class="l"><a class="l" href="#790"> 790: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$query</span>-&gt;<span class="php-keyword2">end</span>)) {
</span><span id="791" class="l"><a class="l" href="#791"> 791: </a>                    <span class="php-var">$eventEnd</span> = <span class="php-var">$event</span>-&gt;recurrence-&gt;nextRecurrence(<span class="php-var">$now</span>);
</span><span id="792" class="l"><a class="l" href="#792"> 792: </a>                    <span class="php-keyword1">if</span> (!<span class="php-var">$eventEnd</span>) {
</span><span id="793" class="l"><a class="l" href="#793"> 793: </a>                        <span class="php-keyword1">return</span>;
</span><span id="794" class="l"><a class="l" href="#794"> 794: </a>                    }
</span><span id="795" class="l"><a class="l" href="#795"> 795: </a>                } <span class="php-keyword1">else</span> {
</span><span id="796" class="l"><a class="l" href="#796"> 796: </a>                    <span class="php-var">$eventEnd</span> = <span class="php-var">$query</span>-&gt;<span class="php-keyword2">end</span>;
</span><span id="797" class="l"><a class="l" href="#797"> 797: </a>                }
</span><span id="798" class="l"><a class="l" href="#798"> 798: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$query</span>-&gt;start)) {
</span><span id="799" class="l"><a class="l" href="#799"> 799: </a>                    <span class="php-var">$eventStart</span> = <span class="php-var">$event</span>-&gt;start;
</span><span id="800" class="l"><a class="l" href="#800"> 800: </a>                    <span class="php-var">$showRecurrence</span> = <span class="php-keyword1">false</span>;
</span><span id="801" class="l"><a class="l" href="#801"> 801: </a>                } <span class="php-keyword1">else</span> {
</span><span id="802" class="l"><a class="l" href="#802"> 802: </a>                    <span class="php-var">$eventStart</span> = <span class="php-var">$query</span>-&gt;start;
</span><span id="803" class="l"><a class="l" href="#803"> 803: </a>                }
</span><span id="804" class="l"><a class="l" href="#804"> 804: </a>            }
</span><span id="805" class="l"><a class="l" href="#805"> 805: </a>        } <span class="php-keyword1">else</span> {
</span><span id="806" class="l"><a class="l" href="#806"> 806: </a>            <span class="php-var">$eventStart</span> = <span class="php-var">$event</span>-&gt;start;
</span><span id="807" class="l"><a class="l" href="#807"> 807: </a>            <span class="php-var">$eventEnd</span> = <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span>;
</span><span id="808" class="l"><a class="l" href="#808"> 808: </a>        }
</span><span id="809" class="l"><a class="l" href="#809"> 809: </a>        self::addEvents(<span class="php-var">$events</span>, <span class="php-var">$event</span>, <span class="php-var">$eventStart</span>, <span class="php-var">$eventEnd</span>, <span class="php-var">$showRecurrence</span>, <span class="php-var">$json</span>, <span class="php-keyword1">false</span>);
</span><span id="810" class="l"><a class="l" href="#810"> 810: </a>    }
</span><span id="811" class="l"><a class="l" href="#811"> 811: </a>
</span><span id="812" class="l"><a class="l" href="#812"> 812: </a>    <span class="php-comment">/**
</span></span><span id="813" class="l"><a class="l" href="#813"> 813: </a><span class="php-comment">     * Returns the number of events in calendars that the current user owns.
</span></span><span id="814" class="l"><a class="l" href="#814"> 814: </a><span class="php-comment">     *
</span></span><span id="815" class="l"><a class="l" href="#815"> 815: </a><span class="php-comment">     * @return integer  The number of events.
</span></span><span id="816" class="l"><a class="l" href="#816"> 816: </a><span class="php-comment">     */</span>
</span><span id="817" class="l"><a class="l" href="#817"> 817: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_countEvents" href="#_countEvents">countEvents</a>()
</span><span id="818" class="l"><a class="l" href="#818"> 818: </a>    {
</span><span id="819" class="l"><a class="l" href="#819"> 819: </a>        <span class="php-keyword1">static</span> <span class="php-var"><a id="$count" href="#$count">$count</a></span>;
</span><span id="820" class="l"><a class="l" href="#820"> 820: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$count</span>)) {
</span><span id="821" class="l"><a class="l" href="#821"> 821: </a>            <span class="php-keyword1">return</span> <span class="php-var">$count</span>;
</span><span id="822" class="l"><a class="l" href="#822"> 822: </a>        }
</span><span id="823" class="l"><a class="l" href="#823"> 823: </a>
</span><span id="824" class="l"><a class="l" href="#824"> 824: </a>        <span class="php-var">$kronolith_driver</span> = self::getDriver();
</span><span id="825" class="l"><a class="l" href="#825"> 825: </a>        <span class="php-var">$calendars</span> = self::listInternalCalendars(<span class="php-keyword1">true</span>, Horde_Perms::ALL);
</span><span id="826" class="l"><a class="l" href="#826"> 826: </a>        <span class="php-var">$current_calendar</span> = <span class="php-var">$kronolith_driver</span>-&gt;calendar;
</span><span id="827" class="l"><a class="l" href="#827"> 827: </a>
</span><span id="828" class="l"><a class="l" href="#828"> 828: </a>        <span class="php-var">$count</span> = <span class="php-num">0</span>;
</span><span id="829" class="l"><a class="l" href="#829"> 829: </a>        <span class="php-keyword1">foreach</span> (<span class="php-keyword2">array_keys</span>(<span class="php-var">$calendars</span>) <span class="php-keyword1">as</span> <span class="php-var">$calendar</span>) {
</span><span id="830" class="l"><a class="l" href="#830"> 830: </a>            <span class="php-var">$kronolith_driver</span>-&gt;open(<span class="php-var">$calendar</span>);
</span><span id="831" class="l"><a class="l" href="#831"> 831: </a>            <span class="php-keyword1">try</span> {
</span><span id="832" class="l"><a class="l" href="#832"> 832: </a>                <span class="php-var">$count</span> += <span class="php-var">$kronolith_driver</span>-&gt;countEvents();
</span><span id="833" class="l"><a class="l" href="#833"> 833: </a>            } <span class="php-keyword1">catch</span> (Exception <span class="php-var">$e</span>) {
</span><span id="834" class="l"><a class="l" href="#834"> 834: </a>            }
</span><span id="835" class="l"><a class="l" href="#835"> 835: </a>        }
</span><span id="836" class="l"><a class="l" href="#836"> 836: </a>
</span><span id="837" class="l"><a class="l" href="#837"> 837: </a>        <span class="php-comment">/* Reopen last calendar. */</span>
</span><span id="838" class="l"><a class="l" href="#838"> 838: </a>        <span class="php-var">$kronolith_driver</span>-&gt;open(<span class="php-var">$current_calendar</span>);
</span><span id="839" class="l"><a class="l" href="#839"> 839: </a>
</span><span id="840" class="l"><a class="l" href="#840"> 840: </a>        <span class="php-keyword1">return</span> <span class="php-var">$count</span>;
</span><span id="841" class="l"><a class="l" href="#841"> 841: </a>    }
</span><span id="842" class="l"><a class="l" href="#842"> 842: </a>
</span><span id="843" class="l"><a class="l" href="#843"> 843: </a>    <span class="php-comment">/**
</span></span><span id="844" class="l"><a class="l" href="#844"> 844: </a><span class="php-comment">     * Imports an event parsed from a string.
</span></span><span id="845" class="l"><a class="l" href="#845"> 845: </a><span class="php-comment">     *
</span></span><span id="846" class="l"><a class="l" href="#846"> 846: </a><span class="php-comment">     * @param string $text      The text to parse into an event
</span></span><span id="847" class="l"><a class="l" href="#847"> 847: </a><span class="php-comment">     * @param string $calendar  The calendar into which the event will be
</span></span><span id="848" class="l"><a class="l" href="#848"> 848: </a><span class="php-comment">     *                          imported.  If 'null', the user's default
</span></span><span id="849" class="l"><a class="l" href="#849"> 849: </a><span class="php-comment">     *                          calendar will be used.
</span></span><span id="850" class="l"><a class="l" href="#850"> 850: </a><span class="php-comment">     *
</span></span><span id="851" class="l"><a class="l" href="#851"> 851: </a><span class="php-comment">     * @return array  The UID of all events that were added.
</span></span><span id="852" class="l"><a class="l" href="#852"> 852: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="853" class="l"><a class="l" href="#853"> 853: </a><span class="php-comment">     */</span>
</span><span id="854" class="l"><a class="l" href="#854"> 854: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_quickAdd" href="#_quickAdd">quickAdd</a>(<span class="php-var">$text</span>, <span class="php-var">$calendar</span> = <span class="php-keyword1">null</span>)
</span><span id="855" class="l"><a class="l" href="#855"> 855: </a>    {
</span><span id="856" class="l"><a class="l" href="#856"> 856: </a>        <span class="php-var">$text</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$text</span>);
</span><span id="857" class="l"><a class="l" href="#857"> 857: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$text</span>, <span class="php-quote">&quot;\n&quot;</span>) !== <span class="php-keyword1">false</span>) {
</span><span id="858" class="l"><a class="l" href="#858"> 858: </a>            <span class="php-keyword1">list</span>(<span class="php-var">$title</span>, <span class="php-var">$description</span>) = <span class="php-keyword2">explode</span>(<span class="php-var">$text</span>, <span class="php-quote">&quot;\n&quot;</span>, <span class="php-num">2</span>);
</span><span id="859" class="l"><a class="l" href="#859"> 859: </a>        } <span class="php-keyword1">else</span> {
</span><span id="860" class="l"><a class="l" href="#860"> 860: </a>            <span class="php-var">$title</span> = <span class="php-var">$text</span>;
</span><span id="861" class="l"><a class="l" href="#861"> 861: </a>            <span class="php-var">$description</span> = <span class="php-quote">''</span>;
</span><span id="862" class="l"><a class="l" href="#862"> 862: </a>        }
</span><span id="863" class="l"><a class="l" href="#863"> 863: </a>        <span class="php-var">$title</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$title</span>);
</span><span id="864" class="l"><a class="l" href="#864"> 864: </a>        <span class="php-var">$description</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$description</span>);
</span><span id="865" class="l"><a class="l" href="#865"> 865: </a>
</span><span id="866" class="l"><a class="l" href="#866"> 866: </a>        <span class="php-var">$dateParser</span> = Horde_Date_Parser::factory(<span class="php-keyword1">array</span>(<span class="php-quote">'locale'</span> =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>]));
</span><span id="867" class="l"><a class="l" href="#867"> 867: </a>        <span class="php-var">$r</span> = <span class="php-var">$dateParser</span>-&gt;parse(<span class="php-var">$title</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'return'</span> =&gt; <span class="php-quote">'result'</span>));
</span><span id="868" class="l"><a class="l" href="#868"> 868: </a>        <span class="php-keyword1">if</span> (!(<span class="php-var">$d</span> = <span class="php-var">$r</span>-&gt;guess())) {
</span><span id="869" class="l"><a class="l" href="#869"> 869: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Horde_Exception(<span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Cannot parse event description \&quot;%s\&quot;&quot;</span>), Horde_String::truncate(<span class="php-var">$text</span>)));
</span><span id="870" class="l"><a class="l" href="#870"> 870: </a>        }
</span><span id="871" class="l"><a class="l" href="#871"> 871: </a>
</span><span id="872" class="l"><a class="l" href="#872"> 872: </a>        <span class="php-var">$title</span> = <span class="php-var">$r</span>-&gt;untaggedText();
</span><span id="873" class="l"><a class="l" href="#873"> 873: </a>        <span class="php-var">$start</span> = <span class="php-var">$d</span>-&gt;timestamp();
</span><span id="874" class="l"><a class="l" href="#874"> 874: </a>
</span><span id="875" class="l"><a class="l" href="#875"> 875: </a>        <span class="php-var">$kronolith_driver</span> = self::getDriver(<span class="php-keyword1">null</span>, <span class="php-var">$calendar</span>);
</span><span id="876" class="l"><a class="l" href="#876"> 876: </a>        <span class="php-var">$event</span> = <span class="php-var">$kronolith_driver</span>-&gt;getEvent();
</span><span id="877" class="l"><a class="l" href="#877"> 877: </a>        <span class="php-var">$event</span>-&gt;initialized = <span class="php-keyword1">true</span>;
</span><span id="878" class="l"><a class="l" href="#878"> 878: </a>        <span class="php-var">$event</span>-&gt;title = <span class="php-var">$title</span>;
</span><span id="879" class="l"><a class="l" href="#879"> 879: </a>        <span class="php-var">$event</span>-&gt;description = <span class="php-var">$description</span>;
</span><span id="880" class="l"><a class="l" href="#880"> 880: </a>        <span class="php-var">$event</span>-&gt;start = <span class="php-var">$d</span>;
</span><span id="881" class="l"><a class="l" href="#881"> 881: </a>        <span class="php-var">$event</span>-&gt;<span class="php-keyword2">end</span> = <span class="php-var">$d</span>-&gt;add(<span class="php-keyword1">array</span>(<span class="php-quote">'hour'</span> =&gt; <span class="php-num">1</span>));
</span><span id="882" class="l"><a class="l" href="#882"> 882: </a>        <span class="php-var">$event</span>-&gt;save();
</span><span id="883" class="l"><a class="l" href="#883"> 883: </a>
</span><span id="884" class="l"><a class="l" href="#884"> 884: </a>        <span class="php-keyword1">return</span> <span class="php-var">$event</span>;
</span><span id="885" class="l"><a class="l" href="#885"> 885: </a>    }
</span><span id="886" class="l"><a class="l" href="#886"> 886: </a>
</span><span id="887" class="l"><a class="l" href="#887"> 887: </a>    <span class="php-comment">/**
</span></span><span id="888" class="l"><a class="l" href="#888"> 888: </a><span class="php-comment">     * Initial app setup code.
</span></span><span id="889" class="l"><a class="l" href="#889"> 889: </a><span class="php-comment">     */</span>
</span><span id="890" class="l"><a class="l" href="#890"> 890: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_initialize" href="#_initialize">initialize</a>()
</span><span id="891" class="l"><a class="l" href="#891"> 891: </a>    {
</span><span id="892" class="l"><a class="l" href="#892"> 892: </a>        <span class="php-comment">/* Store the request timestamp if it's not already present. */</span>
</span><span id="893" class="l"><a class="l" href="#893"> 893: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_TIME'</span>])) {
</span><span id="894" class="l"><a class="l" href="#894"> 894: </a>            <span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_TIME'</span>] = <span class="php-keyword2">time</span>();
</span><span id="895" class="l"><a class="l" href="#895"> 895: </a>        }
</span><span id="896" class="l"><a class="l" href="#896"> 896: </a>
</span><span id="897" class="l"><a class="l" href="#897"> 897: </a>        <span class="php-comment">/* Fetch display preferences. */</span>
</span><span id="898" class="l"><a class="l" href="#898"> 898: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>] = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'display_cals'</span>));
</span><span id="899" class="l"><a class="l" href="#899"> 899: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>] = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'display_remote_cals'</span>));
</span><span id="900" class="l"><a class="l" href="#900"> 900: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>] = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'display_external_cals'</span>));
</span><span id="901" class="l"><a class="l" href="#901"> 901: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>] = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'holiday_drivers'</span>));
</span><span id="902" class="l"><a class="l" href="#902"> 902: </a>
</span><span id="903" class="l"><a class="l" href="#903"> 903: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>])) {
</span><span id="904" class="l"><a class="l" href="#904"> 904: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="905" class="l"><a class="l" href="#905"> 905: </a>        }
</span><span id="906" class="l"><a class="l" href="#906"> 906: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>])) {
</span><span id="907" class="l"><a class="l" href="#907"> 907: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="908" class="l"><a class="l" href="#908"> 908: </a>        }
</span><span id="909" class="l"><a class="l" href="#909"> 909: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>])) {
</span><span id="910" class="l"><a class="l" href="#910"> 910: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="911" class="l"><a class="l" href="#911"> 911: </a>        }
</span><span id="912" class="l"><a class="l" href="#912"> 912: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>]) ||
</span><span id="913" class="l"><a class="l" href="#913"> 913: </a>            <span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'holidays'</span>][<span class="php-quote">'enable'</span>])) {
</span><span id="914" class="l"><a class="l" href="#914"> 914: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>] = <span class="php-keyword1">array</span>();
</span><span id="915" class="l"><a class="l" href="#915"> 915: </a>        }
</span><span id="916" class="l"><a class="l" href="#916"> 916: </a>
</span><span id="917" class="l"><a class="l" href="#917"> 917: </a>        <span class="php-comment">/* Update preferences for which calendars to display. If the
</span></span><span id="918" class="l"><a class="l" href="#918"> 918: </a><span class="php-comment">         * user doesn't have any selected calendars to view then fall
</span></span><span id="919" class="l"><a class="l" href="#919"> 919: </a><span class="php-comment">         * back to an available calendar. An empty string passed in this
</span></span><span id="920" class="l"><a class="l" href="#920"> 920: </a><span class="php-comment">         * parameter will clear any existing session value.*/</span>
</span><span id="921" class="l"><a class="l" href="#921"> 921: </a>        <span class="php-keyword1">if</span> ((<span class="php-var">$calendarId</span> = Horde_Util::getFormData(<span class="php-quote">'display_cal'</span>)) !== <span class="php-keyword1">null</span>) {
</span><span id="922" class="l"><a class="l" href="#922"> 922: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;set(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'display_cal'</span>, <span class="php-var">$calendarId</span>);
</span><span id="923" class="l"><a class="l" href="#923"> 923: </a>        }
</span><span id="924" class="l"><a class="l" href="#924"> 924: </a>
</span><span id="925" class="l"><a class="l" href="#925"> 925: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">strlen</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;get(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'display_cal'</span>))) {
</span><span id="926" class="l"><a class="l" href="#926"> 926: </a>            <span class="php-comment">/* Specifying a value for display_cal is always to make sure
</span></span><span id="927" class="l"><a class="l" href="#927"> 927: </a><span class="php-comment">             * that only the specified calendars are shown. Use the
</span></span><span id="928" class="l"><a class="l" href="#928"> 928: </a><span class="php-comment">             * &quot;toggle_calendar&quot; argument  to toggle the state of a single
</span></span><span id="929" class="l"><a class="l" href="#929"> 929: </a><span class="php-comment">             * calendar. */</span>
</span><span id="930" class="l"><a class="l" href="#930"> 930: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="931" class="l"><a class="l" href="#931"> 931: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="932" class="l"><a class="l" href="#932"> 932: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="933" class="l"><a class="l" href="#933"> 933: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_resource_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="934" class="l"><a class="l" href="#934"> 934: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>] = <span class="php-keyword1">array</span>();
</span><span id="935" class="l"><a class="l" href="#935"> 935: </a>            <span class="php-var">$calendars</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;get(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'display_cal'</span>);
</span><span id="936" class="l"><a class="l" href="#936"> 936: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$calendars</span>)) {
</span><span id="937" class="l"><a class="l" href="#937"> 937: </a>                <span class="php-var">$calendars</span> = <span class="php-keyword1">array</span>(<span class="php-var">$calendars</span>);
</span><span id="938" class="l"><a class="l" href="#938"> 938: </a>            }
</span><span id="939" class="l"><a class="l" href="#939"> 939: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$calendarId</span>) {
</span><span id="940" class="l"><a class="l" href="#940"> 940: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'remote_'</span>, <span class="php-num">7</span>) === <span class="php-num">0</span>) {
</span><span id="941" class="l"><a class="l" href="#941"> 941: </a>                    <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">7</span>);
</span><span id="942" class="l"><a class="l" href="#942"> 942: </a>                    <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>])) {
</span><span id="943" class="l"><a class="l" href="#943"> 943: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="944" class="l"><a class="l" href="#944"> 944: </a>                    }
</span><span id="945" class="l"><a class="l" href="#945"> 945: </a>                } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'external_'</span>, <span class="php-num">9</span>) === <span class="php-num">0</span>) {
</span><span id="946" class="l"><a class="l" href="#946"> 946: </a>                    <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">9</span>);
</span><span id="947" class="l"><a class="l" href="#947"> 947: </a>                    <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>])) {
</span><span id="948" class="l"><a class="l" href="#948"> 948: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="949" class="l"><a class="l" href="#949"> 949: </a>                    }
</span><span id="950" class="l"><a class="l" href="#950"> 950: </a>                } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'resource_'</span>, <span class="php-num">9</span>) === <span class="php-num">0</span>) {
</span><span id="951" class="l"><a class="l" href="#951"> 951: </a>                    <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">9</span>);
</span><span id="952" class="l"><a class="l" href="#952"> 952: </a>                    <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_resource_calendars'</span>])) {
</span><span id="953" class="l"><a class="l" href="#953"> 953: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_resource_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="954" class="l"><a class="l" href="#954"> 954: </a>                    }
</span><span id="955" class="l"><a class="l" href="#955"> 955: </a>                } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'holidays_'</span>, <span class="php-num">9</span>) === <span class="php-num">0</span>) {
</span><span id="956" class="l"><a class="l" href="#956"> 956: </a>                    <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">9</span>);
</span><span id="957" class="l"><a class="l" href="#957"> 957: </a>                    <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>])) {
</span><span id="958" class="l"><a class="l" href="#958"> 958: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="959" class="l"><a class="l" href="#959"> 959: </a>                    }
</span><span id="960" class="l"><a class="l" href="#960"> 960: </a>                } <span class="php-keyword1">else</span> {
</span><span id="961" class="l"><a class="l" href="#961"> 961: </a>                    <span class="php-keyword1">if</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'internal_'</span>, <span class="php-num">9</span>) === <span class="php-num">0</span>) {
</span><span id="962" class="l"><a class="l" href="#962"> 962: </a>                        <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">9</span>);
</span><span id="963" class="l"><a class="l" href="#963"> 963: </a>                    }
</span><span id="964" class="l"><a class="l" href="#964"> 964: </a>                    <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>])) {
</span><span id="965" class="l"><a class="l" href="#965"> 965: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="966" class="l"><a class="l" href="#966"> 966: </a>                    }
</span><span id="967" class="l"><a class="l" href="#967"> 967: </a>                }
</span><span id="968" class="l"><a class="l" href="#968"> 968: </a>            }
</span><span id="969" class="l"><a class="l" href="#969"> 969: </a>        }
</span><span id="970" class="l"><a class="l" href="#970"> 970: </a>
</span><span id="971" class="l"><a class="l" href="#971"> 971: </a>        <span class="php-comment">/* Check for single &quot;toggle&quot; calendars. */</span>
</span><span id="972" class="l"><a class="l" href="#972"> 972: </a>        <span class="php-keyword1">if</span> ((<span class="php-var">$calendarId</span> = Horde_Util::getFormData(<span class="php-quote">'toggle_calendar'</span>)) !== <span class="php-keyword1">null</span>) {
</span><span id="973" class="l"><a class="l" href="#973"> 973: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'remote_'</span>, <span class="php-num">7</span>) === <span class="php-num">0</span>) {
</span><span id="974" class="l"><a class="l" href="#974"> 974: </a>                <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">7</span>);
</span><span id="975" class="l"><a class="l" href="#975"> 975: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>])) {
</span><span id="976" class="l"><a class="l" href="#976"> 976: </a>                    <span class="php-var">$key</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>]);
</span><span id="977" class="l"><a class="l" href="#977"> 977: </a>                    <span class="php-keyword1">unset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>][<span class="php-var">$key</span>]);
</span><span id="978" class="l"><a class="l" href="#978"> 978: </a>                } <span class="php-keyword1">else</span> {
</span><span id="979" class="l"><a class="l" href="#979"> 979: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="980" class="l"><a class="l" href="#980"> 980: </a>                }
</span><span id="981" class="l"><a class="l" href="#981"> 981: </a>            } <span class="php-keyword1">elseif</span> ((<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'external_'</span>, <span class="php-num">9</span>) === <span class="php-num">0</span> &amp;&amp;
</span><span id="982" class="l"><a class="l" href="#982"> 982: </a>                       <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">9</span>)) ||
</span><span id="983" class="l"><a class="l" href="#983"> 983: </a>                      (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'tasklists_'</span>, <span class="php-num">10</span>) === <span class="php-num">0</span> &amp;&amp;
</span><span id="984" class="l"><a class="l" href="#984"> 984: </a>                       <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">10</span>))) {
</span><span id="985" class="l"><a class="l" href="#985"> 985: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>])) {
</span><span id="986" class="l"><a class="l" href="#986"> 986: </a>                    <span class="php-var">$key</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>]);
</span><span id="987" class="l"><a class="l" href="#987"> 987: </a>                    <span class="php-keyword1">unset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>][<span class="php-var">$key</span>]);
</span><span id="988" class="l"><a class="l" href="#988"> 988: </a>                } <span class="php-keyword1">else</span> {
</span><span id="989" class="l"><a class="l" href="#989"> 989: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="990" class="l"><a class="l" href="#990"> 990: </a>                }
</span><span id="991" class="l"><a class="l" href="#991"> 991: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'tasks/'</span>) === <span class="php-num">0</span>) {
</span><span id="992" class="l"><a class="l" href="#992"> 992: </a>                    <span class="php-var">$tasklists</span> = <span class="php-keyword1">array</span>();
</span><span id="993" class="l"><a class="l" href="#993"> 993: </a>                    <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span>) {
</span><span id="994" class="l"><a class="l" href="#994"> 994: </a>                        <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$id</span>, <span class="php-quote">'tasks/'</span>) === <span class="php-num">0</span>) {
</span><span id="995" class="l"><a class="l" href="#995"> 995: </a>                            <span class="php-var">$tasklists</span>[] = <span class="php-keyword2">substr</span>(<span class="php-var">$id</span>, <span class="php-num">6</span>);
</span><span id="996" class="l"><a class="l" href="#996"> 996: </a>                        }
</span><span id="997" class="l"><a class="l" href="#997"> 997: </a>                    }
</span><span id="998" class="l"><a class="l" href="#998"> 998: </a>                    <span class="php-keyword1">try</span> {
</span><span id="999" class="l"><a class="l" href="#999"> 999: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;tasks-&gt;setDisplayedTasklists(<span class="php-var">$tasklists</span>);
</span><span id="1000" class="l"><a class="l" href="#1000">1000: </a>                    } <span class="php-keyword1">catch</span> (Horde_Exception <span class="php-var">$e</span>) {
</span><span id="1001" class="l"><a class="l" href="#1001">1001: </a>                    }
</span><span id="1002" class="l"><a class="l" href="#1002">1002: </a>                }
</span><span id="1003" class="l"><a class="l" href="#1003">1003: </a>            } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">strncmp</span>(<span class="php-var">$calendarId</span>, <span class="php-quote">'holiday_'</span>, <span class="php-num">8</span>) === <span class="php-num">0</span>) {
</span><span id="1004" class="l"><a class="l" href="#1004">1004: </a>                <span class="php-var">$calendarId</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$calendarId</span>, <span class="php-num">8</span>);
</span><span id="1005" class="l"><a class="l" href="#1005">1005: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>])) {
</span><span id="1006" class="l"><a class="l" href="#1006">1006: </a>                    <span class="php-var">$key</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>]);
</span><span id="1007" class="l"><a class="l" href="#1007">1007: </a>                    <span class="php-keyword1">unset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>][<span class="php-var">$key</span>]);
</span><span id="1008" class="l"><a class="l" href="#1008">1008: </a>                } <span class="php-keyword1">else</span> {
</span><span id="1009" class="l"><a class="l" href="#1009">1009: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="1010" class="l"><a class="l" href="#1010">1010: </a>                }
</span><span id="1011" class="l"><a class="l" href="#1011">1011: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1012" class="l"><a class="l" href="#1012">1012: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>])) {
</span><span id="1013" class="l"><a class="l" href="#1013">1013: </a>                    <span class="php-var">$key</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$calendarId</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>]);
</span><span id="1014" class="l"><a class="l" href="#1014">1014: </a>                    <span class="php-keyword1">unset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>][<span class="php-var">$key</span>]);
</span><span id="1015" class="l"><a class="l" href="#1015">1015: </a>                } <span class="php-keyword1">else</span> {
</span><span id="1016" class="l"><a class="l" href="#1016">1016: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="1017" class="l"><a class="l" href="#1017">1017: </a>                }
</span><span id="1018" class="l"><a class="l" href="#1018">1018: </a>            }
</span><span id="1019" class="l"><a class="l" href="#1019">1019: </a>
</span><span id="1020" class="l"><a class="l" href="#1020">1020: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'display_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>]));
</span><span id="1021" class="l"><a class="l" href="#1021">1021: </a>        }
</span><span id="1022" class="l"><a class="l" href="#1022">1022: </a>
</span><span id="1023" class="l"><a class="l" href="#1023">1023: </a>        <span class="php-comment">/* Make sure all shares exists now to save on checking later. */</span>
</span><span id="1024" class="l"><a class="l" href="#1024">1024: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1025" class="l"><a class="l" href="#1025">1025: </a>        <span class="php-keyword1">foreach</span> (self::listInternalCalendars() <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="1026" class="l"><a class="l" href="#1026">1026: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>][<span class="php-var">$id</span>] = <span class="php-keyword1">new</span> Kronolith_Calendar_Internal(<span class="php-keyword1">array</span>(<span class="php-quote">'share'</span> =&gt; <span class="php-var">$calendar</span>));
</span><span id="1027" class="l"><a class="l" href="#1027">1027: </a>        }
</span><span id="1028" class="l"><a class="l" href="#1028">1028: </a>        <span class="php-var">$calendar_keys</span> = <span class="php-keyword2">array_values</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>]);
</span><span id="1029" class="l"><a class="l" href="#1029">1029: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1030" class="l"><a class="l" href="#1030">1030: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$calendar_keys</span> <span class="php-keyword1">as</span> <span class="php-var">$id</span>) {
</span><span id="1031" class="l"><a class="l" href="#1031">1031: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>][<span class="php-var">$id</span>])) {
</span><span id="1032" class="l"><a class="l" href="#1032">1032: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>][] = <span class="php-var">$id</span>;
</span><span id="1033" class="l"><a class="l" href="#1033">1033: </a>            }
</span><span id="1034" class="l"><a class="l" href="#1034">1034: </a>        }
</span><span id="1035" class="l"><a class="l" href="#1035">1035: </a>
</span><span id="1036" class="l"><a class="l" href="#1036">1036: </a>        <span class="php-comment">/* Make sure all the remote calendars still exist. */</span>
</span><span id="1037" class="l"><a class="l" href="#1037">1037: </a>        <span class="php-var">$_temp</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>];
</span><span id="1038" class="l"><a class="l" href="#1038">1038: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1039" class="l"><a class="l" href="#1039">1039: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_remote_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1040" class="l"><a class="l" href="#1040">1040: </a>        <span class="php-var">$calendars</span> = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'remote_cals'</span>));
</span><span id="1041" class="l"><a class="l" href="#1041">1041: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$calendars</span>)) {
</span><span id="1042" class="l"><a class="l" href="#1042">1042: </a>            <span class="php-var">$calendars</span> = <span class="php-keyword1">array</span>();
</span><span id="1043" class="l"><a class="l" href="#1043">1043: </a>        }
</span><span id="1044" class="l"><a class="l" href="#1044">1044: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$calendar</span>) {
</span><span id="1045" class="l"><a class="l" href="#1045">1045: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_remote_calendars'</span>][<span class="php-var">$calendar</span>[<span class="php-quote">'url'</span>]] = <span class="php-keyword1">new</span> Kronolith_Calendar_Remote(<span class="php-var">$calendar</span>);
</span><span id="1046" class="l"><a class="l" href="#1046">1046: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$calendar</span>[<span class="php-quote">'url'</span>], <span class="php-var">$_temp</span>)) {
</span><span id="1047" class="l"><a class="l" href="#1047">1047: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>][] = <span class="php-var">$calendar</span>[<span class="php-quote">'url'</span>];
</span><span id="1048" class="l"><a class="l" href="#1048">1048: </a>            }
</span><span id="1049" class="l"><a class="l" href="#1049">1049: </a>        }
</span><span id="1050" class="l"><a class="l" href="#1050">1050: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'display_remote_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>]));
</span><span id="1051" class="l"><a class="l" href="#1051">1051: </a>
</span><span id="1052" class="l"><a class="l" href="#1052">1052: </a>        <span class="php-comment">/* Make sure all the holiday drivers still exist. */</span>
</span><span id="1053" class="l"><a class="l" href="#1053">1053: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_holidays'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1054" class="l"><a class="l" href="#1054">1054: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'holidays'</span>][<span class="php-quote">'enable'</span>])) {
</span><span id="1055" class="l"><a class="l" href="#1055">1055: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">class_exists</span>(<span class="php-quote">'Date_Holidays'</span>)) {
</span><span id="1056" class="l"><a class="l" href="#1056">1056: </a>                <span class="php-keyword1">foreach</span> (Date_Holidays::getInstalledDrivers() <span class="php-keyword1">as</span> <span class="php-var">$driver</span>) {
</span><span id="1057" class="l"><a class="l" href="#1057">1057: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$driver</span>[<span class="php-quote">'id'</span>] == <span class="php-quote">'Composite'</span>) {
</span><span id="1058" class="l"><a class="l" href="#1058">1058: </a>                        <span class="php-keyword1">continue</span>;
</span><span id="1059" class="l"><a class="l" href="#1059">1059: </a>                    }
</span><span id="1060" class="l"><a class="l" href="#1060">1060: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_holidays'</span>][<span class="php-var">$driver</span>[<span class="php-quote">'id'</span>]] = <span class="php-keyword1">new</span> Kronolith_Calendar_Holiday(<span class="php-keyword1">array</span>(<span class="php-quote">'driver'</span> =&gt; <span class="php-var">$driver</span>));
</span><span id="1061" class="l"><a class="l" href="#1061">1061: </a>                    <span class="php-keyword2">ksort</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_holidays'</span>]);
</span><span id="1062" class="l"><a class="l" href="#1062">1062: </a>                }
</span><span id="1063" class="l"><a class="l" href="#1063">1063: </a>            }
</span><span id="1064" class="l"><a class="l" href="#1064">1064: </a>        }
</span><span id="1065" class="l"><a class="l" href="#1065">1065: </a>        <span class="php-var">$_temp</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>];
</span><span id="1066" class="l"><a class="l" href="#1066">1066: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1067" class="l"><a class="l" href="#1067">1067: </a>        <span class="php-keyword1">foreach</span> (<span class="php-keyword2">array_keys</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_holidays'</span>]) <span class="php-keyword1">as</span> <span class="php-var">$id</span>) {
</span><span id="1068" class="l"><a class="l" href="#1068">1068: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$id</span>, <span class="php-var">$_temp</span>)) {
</span><span id="1069" class="l"><a class="l" href="#1069">1069: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>][] = <span class="php-var">$id</span>;
</span><span id="1070" class="l"><a class="l" href="#1070">1070: </a>            }
</span><span id="1071" class="l"><a class="l" href="#1071">1071: </a>        }
</span><span id="1072" class="l"><a class="l" href="#1072">1072: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'holiday_drivers'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_holidays'</span>]));
</span><span id="1073" class="l"><a class="l" href="#1073">1073: </a>
</span><span id="1074" class="l"><a class="l" href="#1074">1074: </a>        <span class="php-comment">/* Get a list of external calendars. */</span>
</span><span id="1075" class="l"><a class="l" href="#1075">1075: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1076" class="l"><a class="l" href="#1076">1076: </a>
</span><span id="1077" class="l"><a class="l" href="#1077">1077: </a>        <span class="php-comment">/* Make sure all task lists exist. */</span>
</span><span id="1078" class="l"><a class="l" href="#1078">1078: </a>        <span class="php-keyword1">if</span> (self::hasApiPermission(<span class="php-quote">'tasks'</span>) &amp;&amp;
</span><span id="1079" class="l"><a class="l" href="#1079">1079: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;hasMethod(<span class="php-quote">'tasks/listTimeObjects'</span>)) {
</span><span id="1080" class="l"><a class="l" href="#1080">1080: </a>            <span class="php-keyword1">try</span> {
</span><span id="1081" class="l"><a class="l" href="#1081">1081: </a>                <span class="php-var">$tasklists</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;tasks-&gt;listTasklists();
</span><span id="1082" class="l"><a class="l" href="#1082">1082: </a>                <span class="php-var">$categories</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;call(<span class="php-quote">'tasks/listTimeObjectCategories'</span>);
</span><span id="1083" class="l"><a class="l" href="#1083">1083: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$categories</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$description</span>) {
</span><span id="1084" class="l"><a class="l" href="#1084">1084: </a>                    <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$tasklists</span>[<span class="php-var">$name</span>])) {
</span><span id="1085" class="l"><a class="l" href="#1085">1085: </a>                        <span class="php-keyword1">continue</span>;
</span><span id="1086" class="l"><a class="l" href="#1086">1086: </a>                    }
</span><span id="1087" class="l"><a class="l" href="#1087">1087: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>][<span class="php-quote">'tasks/'</span> . <span class="php-var">$name</span>] = <span class="php-keyword1">new</span> Kronolith_Calendar_External_Tasks(<span class="php-keyword1">array</span>(<span class="php-quote">'api'</span> =&gt; <span class="php-quote">'tasks'</span>, <span class="php-quote">'name'</span> =&gt; <span class="php-var">$description</span>, <span class="php-quote">'share'</span> =&gt; <span class="php-var">$tasklists</span>[<span class="php-var">$name</span>]));
</span><span id="1088" class="l"><a class="l" href="#1088">1088: </a>                }
</span><span id="1089" class="l"><a class="l" href="#1089">1089: </a>            } <span class="php-keyword1">catch</span> (Horde_Exception <span class="php-var">$e</span>) {
</span><span id="1090" class="l"><a class="l" href="#1090">1090: </a>                Horde::logMessage(<span class="php-var">$e</span>, <span class="php-quote">'DEBUG'</span>);
</span><span id="1091" class="l"><a class="l" href="#1091">1091: </a>            }
</span><span id="1092" class="l"><a class="l" href="#1092">1092: </a>        }
</span><span id="1093" class="l"><a class="l" href="#1093">1093: </a>
</span><span id="1094" class="l"><a class="l" href="#1094">1094: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;exists(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'all_external_calendars'</span>)) {
</span><span id="1095" class="l"><a class="l" href="#1095">1095: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;get(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'all_external_calendars'</span>) <span class="php-keyword1">as</span> <span class="php-var">$calendar</span>) {
</span><span id="1096" class="l"><a class="l" href="#1096">1096: </a>                <span class="php-keyword1">if</span> (!self::hasApiPermission(<span class="php-var">$calendar</span>[<span class="php-quote">'a'</span>]) ||
</span><span id="1097" class="l"><a class="l" href="#1097">1097: </a>                    <span class="php-var">$calendar</span>[<span class="php-quote">'a'</span>] == <span class="php-quote">'tasks'</span>) {
</span><span id="1098" class="l"><a class="l" href="#1098">1098: </a>                    <span class="php-keyword1">continue</span>;
</span><span id="1099" class="l"><a class="l" href="#1099">1099: </a>                }
</span><span id="1100" class="l"><a class="l" href="#1100">1100: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>][<span class="php-var">$calendar</span>[<span class="php-quote">'a'</span>] . <span class="php-quote">'/'</span> . <span class="php-var">$calendar</span>[<span class="php-quote">'n'</span>]] = <span class="php-keyword1">new</span> Kronolith_Calendar_External(<span class="php-keyword1">array</span>(<span class="php-quote">'api'</span> =&gt; <span class="php-var">$calendar</span>[<span class="php-quote">'a'</span>], <span class="php-quote">'name'</span> =&gt; <span class="php-var">$calendar</span>[<span class="php-quote">'d'</span>], <span class="php-quote">'id'</span> =&gt; <span class="php-var">$calendar</span>[<span class="php-quote">'n'</span>]));
</span><span id="1101" class="l"><a class="l" href="#1101">1101: </a>            }
</span><span id="1102" class="l"><a class="l" href="#1102">1102: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1103" class="l"><a class="l" href="#1103">1103: </a>            <span class="php-var">$apis</span> = <span class="php-keyword2">array_unique</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;listAPIs());
</span><span id="1104" class="l"><a class="l" href="#1104">1104: </a>            <span class="php-var">$ext_cals</span> = <span class="php-keyword1">array</span>();
</span><span id="1105" class="l"><a class="l" href="#1105">1105: </a>
</span><span id="1106" class="l"><a class="l" href="#1106">1106: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$apis</span> <span class="php-keyword1">as</span> <span class="php-var">$api</span>) {
</span><span id="1107" class="l"><a class="l" href="#1107">1107: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$api</span> == <span class="php-quote">'tasks'</span> ||
</span><span id="1108" class="l"><a class="l" href="#1108">1108: </a>                    !self::hasApiPermission(<span class="php-var">$api</span>) ||
</span><span id="1109" class="l"><a class="l" href="#1109">1109: </a>                    !<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;hasMethod(<span class="php-var">$api</span> . <span class="php-quote">'/listTimeObjects'</span>)) {
</span><span id="1110" class="l"><a class="l" href="#1110">1110: </a>                    <span class="php-keyword1">continue</span>;
</span><span id="1111" class="l"><a class="l" href="#1111">1111: </a>                }
</span><span id="1112" class="l"><a class="l" href="#1112">1112: </a>                <span class="php-keyword1">try</span> {
</span><span id="1113" class="l"><a class="l" href="#1113">1113: </a>                    <span class="php-var">$categories</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;call(<span class="php-var">$api</span> . <span class="php-quote">'/listTimeObjectCategories'</span>);
</span><span id="1114" class="l"><a class="l" href="#1114">1114: </a>                } <span class="php-keyword1">catch</span> (Horde_Exception <span class="php-var">$e</span>) {
</span><span id="1115" class="l"><a class="l" href="#1115">1115: </a>                    Horde::logMessage(<span class="php-var">$e</span>, <span class="php-quote">'DEBUG'</span>);
</span><span id="1116" class="l"><a class="l" href="#1116">1116: </a>                    <span class="php-keyword1">continue</span>;
</span><span id="1117" class="l"><a class="l" href="#1117">1117: </a>                }
</span><span id="1118" class="l"><a class="l" href="#1118">1118: </a>
</span><span id="1119" class="l"><a class="l" href="#1119">1119: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$categories</span> <span class="php-keyword1">as</span> <span class="php-var">$name</span> =&gt; <span class="php-var">$description</span>) {
</span><span id="1120" class="l"><a class="l" href="#1120">1120: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>][<span class="php-var">$api</span> . <span class="php-quote">'/'</span> . <span class="php-var">$name</span>] = <span class="php-keyword1">new</span> Kronolith_Calendar_External(<span class="php-keyword1">array</span>(<span class="php-quote">'api'</span> =&gt; <span class="php-var">$api</span>, <span class="php-quote">'name'</span> =&gt; <span class="php-var">$description</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-var">$name</span>));
</span><span id="1121" class="l"><a class="l" href="#1121">1121: </a>                    <span class="php-var">$ext_cals</span>[] = <span class="php-keyword1">array</span>(
</span><span id="1122" class="l"><a class="l" href="#1122">1122: </a>                        <span class="php-quote">'a'</span> =&gt; <span class="php-var">$api</span>,
</span><span id="1123" class="l"><a class="l" href="#1123">1123: </a>                        <span class="php-quote">'n'</span> =&gt; <span class="php-var">$name</span>,
</span><span id="1124" class="l"><a class="l" href="#1124">1124: </a>                        <span class="php-quote">'d'</span> =&gt; <span class="php-var">$description</span>
</span><span id="1125" class="l"><a class="l" href="#1125">1125: </a>                    );
</span><span id="1126" class="l"><a class="l" href="#1126">1126: </a>                }
</span><span id="1127" class="l"><a class="l" href="#1127">1127: </a>            }
</span><span id="1128" class="l"><a class="l" href="#1128">1128: </a>
</span><span id="1129" class="l"><a class="l" href="#1129">1129: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;set(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'all_external_calendars'</span>, <span class="php-var">$ext_cals</span>);
</span><span id="1130" class="l"><a class="l" href="#1130">1130: </a>        }
</span><span id="1131" class="l"><a class="l" href="#1131">1131: </a>
</span><span id="1132" class="l"><a class="l" href="#1132">1132: </a>        <span class="php-comment">/* Make sure all the external calendars still exist. */</span>
</span><span id="1133" class="l"><a class="l" href="#1133">1133: </a>        <span class="php-var">$_tasklists</span> = <span class="php-var">$_temp</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>];
</span><span id="1134" class="l"><a class="l" href="#1134">1134: </a>        <span class="php-keyword1">if</span> (self::hasApiPermission(<span class="php-quote">'tasks'</span>)) {
</span><span id="1135" class="l"><a class="l" href="#1135">1135: </a>            <span class="php-keyword1">try</span> {
</span><span id="1136" class="l"><a class="l" href="#1136">1136: </a>                <span class="php-var">$_tasklists</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;tasks-&gt;getDisplayedTasklists();
</span><span id="1137" class="l"><a class="l" href="#1137">1137: </a>            } <span class="php-keyword1">catch</span> (Horde_Exception <span class="php-var">$e</span>) {
</span><span id="1138" class="l"><a class="l" href="#1138">1138: </a>            }
</span><span id="1139" class="l"><a class="l" href="#1139">1139: </a>        }
</span><span id="1140" class="l"><a class="l" href="#1140">1140: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>] = <span class="php-keyword1">array</span>();
</span><span id="1141" class="l"><a class="l" href="#1141">1141: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="1142" class="l"><a class="l" href="#1142">1142: </a>            <span class="php-keyword1">if</span> ((<span class="php-keyword2">substr</span>(<span class="php-var">$id</span>, <span class="php-num">0</span>, <span class="php-num">6</span>) == <span class="php-quote">'tasks/'</span> &amp;&amp;
</span><span id="1143" class="l"><a class="l" href="#1143">1143: </a>                 <span class="php-keyword2">in_array</span>(<span class="php-keyword2">substr</span>(<span class="php-var">$id</span>, <span class="php-num">6</span>), <span class="php-var">$_tasklists</span>)) ||
</span><span id="1144" class="l"><a class="l" href="#1144">1144: </a>                <span class="php-keyword2">in_array</span>(<span class="php-var">$id</span>, <span class="php-var">$_temp</span>)) {
</span><span id="1145" class="l"><a class="l" href="#1145">1145: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>][] = <span class="php-var">$id</span>;
</span><span id="1146" class="l"><a class="l" href="#1146">1146: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1147" class="l"><a class="l" href="#1147">1147: </a>                <span class="php-comment">/* Convert Kronolith 2 preferences.
</span></span><span id="1148" class="l"><a class="l" href="#1148">1148: </a><span class="php-comment">                 * @todo: remove in Kronolith 3.1. */</span>
</span><span id="1149" class="l"><a class="l" href="#1149">1149: </a>                <span class="php-keyword1">list</span>(,<span class="php-var">$oldid</span>,) = <span class="php-keyword2">explode</span>(<span class="php-quote">'/'</span>, <span class="php-var">$id</span>);
</span><span id="1150" class="l"><a class="l" href="#1150">1150: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$calendar</span>-&gt;api() . <span class="php-quote">'/'</span> . <span class="php-var">$oldid</span>, <span class="php-var">$_temp</span>)) {
</span><span id="1151" class="l"><a class="l" href="#1151">1151: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>][] = <span class="php-var">$calendarId</span>;
</span><span id="1152" class="l"><a class="l" href="#1152">1152: </a>                }
</span><span id="1153" class="l"><a class="l" href="#1153">1153: </a>            }
</span><span id="1154" class="l"><a class="l" href="#1154">1154: </a>        }
</span><span id="1155" class="l"><a class="l" href="#1155">1155: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'display_external_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_external_calendars'</span>]));
</span><span id="1156" class="l"><a class="l" href="#1156">1156: </a>
</span><span id="1157" class="l"><a class="l" href="#1157">1157: </a>        <span class="php-comment">/* If an authenticated user doesn't own a calendar, create it. */</span>
</span><span id="1158" class="l"><a class="l" href="#1158">1158: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'auto_create'</span>]) &amp;&amp;
</span><span id="1159" class="l"><a class="l" href="#1159">1159: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() &amp;&amp;
</span><span id="1160" class="l"><a class="l" href="#1160">1160: </a>            !<span class="php-keyword2">count</span>(self::listInternalCalendars(<span class="php-keyword1">true</span>))) {
</span><span id="1161" class="l"><a class="l" href="#1161">1161: </a>            <span class="php-var">$calendars</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Kronolith_Factory_Calendars'</span>)
</span><span id="1162" class="l"><a class="l" href="#1162">1162: </a>                -&gt;create();
</span><span id="1163" class="l"><a class="l" href="#1163">1163: </a>
</span><span id="1164" class="l"><a class="l" href="#1164">1164: </a>            <span class="php-var">$share</span> = <span class="php-var">$calendars</span>-&gt;createDefaultShare();
</span><span id="1165" class="l"><a class="l" href="#1165">1165: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>][<span class="php-var">$share</span>-&gt;getName()] = <span class="php-keyword1">new</span> Kronolith_Calendar_Internal(<span class="php-keyword1">array</span>(<span class="php-quote">'share'</span> =&gt; <span class="php-var">$share</span>));
</span><span id="1166" class="l"><a class="l" href="#1166">1166: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>][] = <span class="php-var">$share</span>-&gt;getName();
</span><span id="1167" class="l"><a class="l" href="#1167">1167: </a>
</span><span id="1168" class="l"><a class="l" href="#1168">1168: </a>            <span class="php-comment">/* Calendar auto-sharing with the user's groups */</span>
</span><span id="1169" class="l"><a class="l" href="#1169">1169: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'autoshare'</span>][<span class="php-quote">'shareperms'</span>] != <span class="php-quote">'none'</span>) {
</span><span id="1170" class="l"><a class="l" href="#1170">1170: </a>                <span class="php-var">$perm_value</span> = <span class="php-num">0</span>;
</span><span id="1171" class="l"><a class="l" href="#1171">1171: </a>                <span class="php-keyword1">switch</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'autoshare'</span>][<span class="php-quote">'shareperms'</span>]) {
</span><span id="1172" class="l"><a class="l" href="#1172">1172: </a>                <span class="php-keyword1">case</span> <span class="php-quote">'read'</span>:
</span><span id="1173" class="l"><a class="l" href="#1173">1173: </a>                    <span class="php-var">$perm_value</span> = Horde_Perms::READ | Horde_Perms::SHOW;
</span><span id="1174" class="l"><a class="l" href="#1174">1174: </a>                    <span class="php-keyword1">break</span>;
</span><span id="1175" class="l"><a class="l" href="#1175">1175: </a>                <span class="php-keyword1">case</span> <span class="php-quote">'edit'</span>:
</span><span id="1176" class="l"><a class="l" href="#1176">1176: </a>                    <span class="php-var">$perm_value</span> = Horde_Perms::READ | Horde_Perms::SHOW | Horde_Perms::EDIT;
</span><span id="1177" class="l"><a class="l" href="#1177">1177: </a>                    <span class="php-keyword1">break</span>;
</span><span id="1178" class="l"><a class="l" href="#1178">1178: </a>                <span class="php-keyword1">case</span> <span class="php-quote">'full'</span>:
</span><span id="1179" class="l"><a class="l" href="#1179">1179: </a>                    <span class="php-var">$perm_value</span> = Horde_Perms::READ | Horde_Perms::SHOW | Horde_Perms::EDIT | Horde_Perms::<span class="php-keyword2">DELETE</span>;
</span><span id="1180" class="l"><a class="l" href="#1180">1180: </a>                    <span class="php-keyword1">break</span>;
</span><span id="1181" class="l"><a class="l" href="#1181">1181: </a>                }
</span><span id="1182" class="l"><a class="l" href="#1182">1182: </a>
</span><span id="1183" class="l"><a class="l" href="#1183">1183: </a>                <span class="php-keyword1">try</span> {
</span><span id="1184" class="l"><a class="l" href="#1184">1184: </a>                    <span class="php-var">$group_list</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]
</span><span id="1185" class="l"><a class="l" href="#1185">1185: </a>                        -&gt;getInstance(<span class="php-quote">'Horde_Group'</span>)
</span><span id="1186" class="l"><a class="l" href="#1186">1186: </a>                        -&gt;listGroups(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth());
</span><span id="1187" class="l"><a class="l" href="#1187">1187: </a>                    <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$group_list</span>)) {
</span><span id="1188" class="l"><a class="l" href="#1188">1188: </a>                        <span class="php-var">$perm</span> = <span class="php-var">$share</span>-&gt;getPermission();
</span><span id="1189" class="l"><a class="l" href="#1189">1189: </a>                        <span class="php-comment">// Add the default perm, not added otherwise</span>
</span><span id="1190" class="l"><a class="l" href="#1190">1190: </a>                        <span class="php-keyword1">foreach</span> (<span class="php-var">$group_list</span> <span class="php-keyword1">as</span> <span class="php-var">$group_id</span> =&gt; <span class="php-var">$group_name</span>) {
</span><span id="1191" class="l"><a class="l" href="#1191">1191: </a>                            <span class="php-var">$perm</span>-&gt;addGroupPermission(<span class="php-var">$group_id</span>, <span class="php-var">$perm_value</span>, <span class="php-keyword1">false</span>);
</span><span id="1192" class="l"><a class="l" href="#1192">1192: </a>                        }
</span><span id="1193" class="l"><a class="l" href="#1193">1193: </a>                        <span class="php-var">$share</span>-&gt;setPermission(<span class="php-var">$perm</span>);
</span><span id="1194" class="l"><a class="l" href="#1194">1194: </a>                        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;New calendar created and automatically shared with the following group(s): %s.&quot;</span>), <span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-var">$group_list</span>)), <span class="php-quote">'horde.success'</span>);
</span><span id="1195" class="l"><a class="l" href="#1195">1195: </a>                    }
</span><span id="1196" class="l"><a class="l" href="#1196">1196: </a>                } <span class="php-keyword1">catch</span> (Horde_Group_Exception <span class="php-var">$e</span>) {}
</span><span id="1197" class="l"><a class="l" href="#1197">1197: </a>            }
</span><span id="1198" class="l"><a class="l" href="#1198">1198: </a>
</span><span id="1199" class="l"><a class="l" href="#1199">1199: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'display_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>]));
</span><span id="1200" class="l"><a class="l" href="#1200">1200: </a>        }
</span><span id="1201" class="l"><a class="l" href="#1201">1201: </a>    }
</span><span id="1202" class="l"><a class="l" href="#1202">1202: </a>
</span><span id="1203" class="l"><a class="l" href="#1203">1203: </a>    <span class="php-comment">/**
</span></span><span id="1204" class="l"><a class="l" href="#1204">1204: </a><span class="php-comment">     * Initialize the event map.
</span></span><span id="1205" class="l"><a class="l" href="#1205">1205: </a><span class="php-comment">     *
</span></span><span id="1206" class="l"><a class="l" href="#1206">1206: </a><span class="php-comment">     * @param array $params Parameters to pass the the map
</span></span><span id="1207" class="l"><a class="l" href="#1207">1207: </a><span class="php-comment">     *
</span></span><span id="1208" class="l"><a class="l" href="#1208">1208: </a><span class="php-comment">     * @return void
</span></span><span id="1209" class="l"><a class="l" href="#1209">1209: </a><span class="php-comment">     */</span>
</span><span id="1210" class="l"><a class="l" href="#1210">1210: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_initEventMap" href="#_initEventMap">initEventMap</a>(<span class="php-var">$params</span>)
</span><span id="1211" class="l"><a class="l" href="#1211">1211: </a>    {
</span><span id="1212" class="l"><a class="l" href="#1212">1212: </a>        <span class="php-comment">// Add the apikeys</span>
</span><span id="1213" class="l"><a class="l" href="#1213">1213: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>[<span class="php-quote">'providers'</span>])) {
</span><span id="1214" class="l"><a class="l" href="#1214">1214: </a>            <span class="php-comment">/* It is safe to put configuration specific to horde driver inside
</span></span><span id="1215" class="l"><a class="l" href="#1215">1215: </a><span class="php-comment">            this block since horde driver *must* contain a provider array */</span>
</span><span id="1216" class="l"><a class="l" href="#1216">1216: </a>
</span><span id="1217" class="l"><a class="l" href="#1217">1217: </a>            <span class="php-comment">// Language specific file needed?</span>
</span><span id="1218" class="l"><a class="l" href="#1218">1218: </a>            <span class="php-var">$language</span> = <span class="php-keyword2">str_replace</span>(<span class="php-quote">'_'</span>, <span class="php-quote">'-'</span>, <span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>]);
</span><span id="1219" class="l"><a class="l" href="#1219">1219: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword2">file_exists</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;get(<span class="php-quote">'jsfs'</span>, <span class="php-quote">'horde'</span>) . <span class="php-quote">'/map/lang/'</span> . <span class="php-var">$language</span> . <span class="php-quote">'.js'</span>)) {
</span><span id="1220" class="l"><a class="l" href="#1220">1220: </a>                <span class="php-var">$language</span> = <span class="php-quote">'en-US'</span>;
</span><span id="1221" class="l"><a class="l" href="#1221">1221: </a>            }
</span><span id="1222" class="l"><a class="l" href="#1222">1222: </a>            <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>] = <span class="php-keyword1">array</span>(
</span><span id="1223" class="l"><a class="l" href="#1223">1223: </a>                <span class="php-quote">'markerImage'</span> =&gt; (string)Horde_Themes::img(<span class="php-quote">'map/marker.png'</span>),
</span><span id="1224" class="l"><a class="l" href="#1224">1224: </a>                <span class="php-quote">'markerBackground'</span> =&gt; (string)Horde_Themes::img(<span class="php-quote">'map/marker-shadow.png'</span>),
</span><span id="1225" class="l"><a class="l" href="#1225">1225: </a>                <span class="php-quote">'useMarkerLayer'</span> =&gt; <span class="php-keyword1">true</span>,
</span><span id="1226" class="l"><a class="l" href="#1226">1226: </a>                <span class="php-quote">'language'</span> =&gt; <span class="php-var">$language</span>,
</span><span id="1227" class="l"><a class="l" href="#1227">1227: </a>            );
</span><span id="1228" class="l"><a class="l" href="#1228">1228: </a>
</span><span id="1229" class="l"><a class="l" href="#1229">1229: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$params</span>[<span class="php-quote">'providers'</span>] <span class="php-keyword1">as</span> <span class="php-var">$layer</span>) {
</span><span id="1230" class="l"><a class="l" href="#1230">1230: </a>                <span class="php-keyword1">switch</span> (<span class="php-var">$layer</span>) {
</span><span id="1231" class="l"><a class="l" href="#1231">1231: </a>                <span class="php-keyword1">case</span> <span class="php-quote">'Google'</span>:
</span><span id="1232" class="l"><a class="l" href="#1232">1232: </a>                    <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'apikeys'</span>][<span class="php-quote">'google'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'api'</span>][<span class="php-quote">'googlemaps'</span>];
</span><span id="1233" class="l"><a class="l" href="#1233">1233: </a>                    <span class="php-keyword1">break</span>;
</span><span id="1234" class="l"><a class="l" href="#1234">1234: </a>                <span class="php-keyword1">case</span> <span class="php-quote">'Yahoo'</span>:
</span><span id="1235" class="l"><a class="l" href="#1235">1235: </a>                    <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'apikeys'</span>][<span class="php-quote">'yahoo'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'api'</span>][<span class="php-quote">'yahoomaps'</span>];
</span><span id="1236" class="l"><a class="l" href="#1236">1236: </a>                    <span class="php-keyword1">break</span>;
</span><span id="1237" class="l"><a class="l" href="#1237">1237: </a>                <span class="php-keyword1">case</span> <span class="php-quote">'Cloudmade'</span>:
</span><span id="1238" class="l"><a class="l" href="#1238">1238: </a>                    <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'apikeys'</span>][<span class="php-quote">'cloudmade'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'api'</span>][<span class="php-quote">'cloudmade'</span>];
</span><span id="1239" class="l"><a class="l" href="#1239">1239: </a>                    <span class="php-keyword1">break</span>;
</span><span id="1240" class="l"><a class="l" href="#1240">1240: </a>                }
</span><span id="1241" class="l"><a class="l" href="#1241">1241: </a>            }
</span><span id="1242" class="l"><a class="l" href="#1242">1242: </a>        }
</span><span id="1243" class="l"><a class="l" href="#1243">1243: </a>
</span><span id="1244" class="l"><a class="l" href="#1244">1244: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$params</span>[<span class="php-quote">'geocoder'</span>])) {
</span><span id="1245" class="l"><a class="l" href="#1245">1245: </a>            <span class="php-keyword1">switch</span> (<span class="php-var">$params</span>[<span class="php-quote">'geocoder'</span>]) {
</span><span id="1246" class="l"><a class="l" href="#1246">1246: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Google'</span>:
</span><span id="1247" class="l"><a class="l" href="#1247">1247: </a>                <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'apikeys'</span>][<span class="php-quote">'google'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'api'</span>][<span class="php-quote">'googlemaps'</span>];
</span><span id="1248" class="l"><a class="l" href="#1248">1248: </a>                <span class="php-keyword1">break</span>;
</span><span id="1249" class="l"><a class="l" href="#1249">1249: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Yahoo'</span>:
</span><span id="1250" class="l"><a class="l" href="#1250">1250: </a>                <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'apikeys'</span>][<span class="php-quote">'yahoo'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'api'</span>][<span class="php-quote">'yahoomaps'</span>];
</span><span id="1251" class="l"><a class="l" href="#1251">1251: </a>                <span class="php-keyword1">break</span>;
</span><span id="1252" class="l"><a class="l" href="#1252">1252: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Cloudmade'</span>:
</span><span id="1253" class="l"><a class="l" href="#1253">1253: </a>                <span class="php-var">$params</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'apikeys'</span>][<span class="php-quote">'cloudmade'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'api'</span>][<span class="php-quote">'cloudmade'</span>];
</span><span id="1254" class="l"><a class="l" href="#1254">1254: </a>                <span class="php-keyword1">break</span>;
</span><span id="1255" class="l"><a class="l" href="#1255">1255: </a>            }
</span><span id="1256" class="l"><a class="l" href="#1256">1256: </a>        }
</span><span id="1257" class="l"><a class="l" href="#1257">1257: </a>        <span class="php-var">$params</span>[<span class="php-quote">'jsuri'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;get(<span class="php-quote">'jsuri'</span>, <span class="php-quote">'horde'</span>) . <span class="php-quote">'/map/'</span>;
</span><span id="1258" class="l"><a class="l" href="#1258">1258: </a>        <span class="php-var">$params</span>[<span class="php-quote">'ssl'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'browser'</span>]-&gt;usingSSLConnection();
</span><span id="1259" class="l"><a class="l" href="#1259">1259: </a>        Horde::addScriptFile(<span class="php-quote">'map/map.js'</span>, <span class="php-quote">'horde'</span>);
</span><span id="1260" class="l"><a class="l" href="#1260">1260: </a>        <span class="php-var">$js</span> = <span class="php-quote">'HordeMap.initialize('</span> . Horde_Serialize::<span class="php-keyword2">serialize</span>(<span class="php-var">$params</span>, HORDE_SERIALIZE::JSON) . <span class="php-quote">');'</span>;
</span><span id="1261" class="l"><a class="l" href="#1261">1261: </a>        Horde::addinlineScript(<span class="php-var">$js</span>);
</span><span id="1262" class="l"><a class="l" href="#1262">1262: </a>    }
</span><span id="1263" class="l"><a class="l" href="#1263">1263: </a>
</span><span id="1264" class="l"><a class="l" href="#1264">1264: </a>    <span class="php-comment">/**
</span></span><span id="1265" class="l"><a class="l" href="#1265">1265: </a><span class="php-comment">     * Returns the real name, if available, of a user.
</span></span><span id="1266" class="l"><a class="l" href="#1266">1266: </a><span class="php-comment">     */</span>
</span><span id="1267" class="l"><a class="l" href="#1267">1267: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getUserName" href="#_getUserName">getUserName</a>(<span class="php-var">$uid</span>)
</span><span id="1268" class="l"><a class="l" href="#1268">1268: </a>    {
</span><span id="1269" class="l"><a class="l" href="#1269">1269: </a>        <span class="php-keyword1">static</span> <span class="php-var"><a id="$names" href="#$names">$names</a></span> = <span class="php-keyword1">array</span>();
</span><span id="1270" class="l"><a class="l" href="#1270">1270: </a>
</span><span id="1271" class="l"><a class="l" href="#1271">1271: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$names</span>[<span class="php-var">$uid</span>])) {
</span><span id="1272" class="l"><a class="l" href="#1272">1272: </a>            <span class="php-var">$ident</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)-&gt;create(<span class="php-var">$uid</span>);
</span><span id="1273" class="l"><a class="l" href="#1273">1273: </a>            <span class="php-var">$ident</span>-&gt;setDefault(<span class="php-var">$ident</span>-&gt;getDefault());
</span><span id="1274" class="l"><a class="l" href="#1274">1274: </a>            <span class="php-var">$names</span>[<span class="php-var">$uid</span>] = <span class="php-var">$ident</span>-&gt;getValue(<span class="php-quote">'fullname'</span>);
</span><span id="1275" class="l"><a class="l" href="#1275">1275: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$names</span>[<span class="php-var">$uid</span>])) {
</span><span id="1276" class="l"><a class="l" href="#1276">1276: </a>                <span class="php-var">$names</span>[<span class="php-var">$uid</span>] = <span class="php-var">$uid</span>;
</span><span id="1277" class="l"><a class="l" href="#1277">1277: </a>            }
</span><span id="1278" class="l"><a class="l" href="#1278">1278: </a>        }
</span><span id="1279" class="l"><a class="l" href="#1279">1279: </a>
</span><span id="1280" class="l"><a class="l" href="#1280">1280: </a>        <span class="php-keyword1">return</span> <span class="php-var">$names</span>[<span class="php-var">$uid</span>];
</span><span id="1281" class="l"><a class="l" href="#1281">1281: </a>    }
</span><span id="1282" class="l"><a class="l" href="#1282">1282: </a>
</span><span id="1283" class="l"><a class="l" href="#1283">1283: </a>    <span class="php-comment">/**
</span></span><span id="1284" class="l"><a class="l" href="#1284">1284: </a><span class="php-comment">     * Returns the email address, if available, of a user.
</span></span><span id="1285" class="l"><a class="l" href="#1285">1285: </a><span class="php-comment">     */</span>
</span><span id="1286" class="l"><a class="l" href="#1286">1286: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getUserEmail" href="#_getUserEmail">getUserEmail</a>(<span class="php-var">$uid</span>)
</span><span id="1287" class="l"><a class="l" href="#1287">1287: </a>    {
</span><span id="1288" class="l"><a class="l" href="#1288">1288: </a>        <span class="php-keyword1">static</span> <span class="php-var"><a id="$emails" href="#$emails">$emails</a></span> = <span class="php-keyword1">array</span>();
</span><span id="1289" class="l"><a class="l" href="#1289">1289: </a>
</span><span id="1290" class="l"><a class="l" href="#1290">1290: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$emails</span>[<span class="php-var">$uid</span>])) {
</span><span id="1291" class="l"><a class="l" href="#1291">1291: </a>            <span class="php-var">$ident</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)-&gt;create(<span class="php-var">$uid</span>);
</span><span id="1292" class="l"><a class="l" href="#1292">1292: </a>            <span class="php-var">$emails</span>[<span class="php-var">$uid</span>] = <span class="php-var">$ident</span>-&gt;getValue(<span class="php-quote">'from_addr'</span>);
</span><span id="1293" class="l"><a class="l" href="#1293">1293: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$emails</span>[<span class="php-var">$uid</span>])) {
</span><span id="1294" class="l"><a class="l" href="#1294">1294: </a>                <span class="php-var">$emails</span>[<span class="php-var">$uid</span>] = <span class="php-var">$uid</span>;
</span><span id="1295" class="l"><a class="l" href="#1295">1295: </a>            }
</span><span id="1296" class="l"><a class="l" href="#1296">1296: </a>        }
</span><span id="1297" class="l"><a class="l" href="#1297">1297: </a>
</span><span id="1298" class="l"><a class="l" href="#1298">1298: </a>        <span class="php-keyword1">return</span> <span class="php-var">$emails</span>[<span class="php-var">$uid</span>];
</span><span id="1299" class="l"><a class="l" href="#1299">1299: </a>    }
</span><span id="1300" class="l"><a class="l" href="#1300">1300: </a>
</span><span id="1301" class="l"><a class="l" href="#1301">1301: </a>    <span class="php-comment">/**
</span></span><span id="1302" class="l"><a class="l" href="#1302">1302: </a><span class="php-comment">     * Checks if an email address belongs to a user.
</span></span><span id="1303" class="l"><a class="l" href="#1303">1303: </a><span class="php-comment">     */</span>
</span><span id="1304" class="l"><a class="l" href="#1304">1304: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_isUserEmail" href="#_isUserEmail">isUserEmail</a>(<span class="php-var">$uid</span>, <span class="php-var">$email</span>)
</span><span id="1305" class="l"><a class="l" href="#1305">1305: </a>    {
</span><span id="1306" class="l"><a class="l" href="#1306">1306: </a>        <span class="php-keyword1">static</span> <span class="php-var"><a id="$emails" href="#$emails">$emails</a></span> = <span class="php-keyword1">array</span>();
</span><span id="1307" class="l"><a class="l" href="#1307">1307: </a>
</span><span id="1308" class="l"><a class="l" href="#1308">1308: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$emails</span>[<span class="php-var">$uid</span>])) {
</span><span id="1309" class="l"><a class="l" href="#1309">1309: </a>            <span class="php-var">$ident</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)-&gt;create(<span class="php-var">$uid</span>);
</span><span id="1310" class="l"><a class="l" href="#1310">1310: </a>
</span><span id="1311" class="l"><a class="l" href="#1311">1311: </a>            <span class="php-var">$addrs</span> = <span class="php-var">$ident</span>-&gt;getAll(<span class="php-quote">'from_addr'</span>);
</span><span id="1312" class="l"><a class="l" href="#1312">1312: </a>            <span class="php-var">$addrs</span>[] = <span class="php-var">$uid</span>;
</span><span id="1313" class="l"><a class="l" href="#1313">1313: </a>
</span><span id="1314" class="l"><a class="l" href="#1314">1314: </a>            <span class="php-var">$emails</span>[<span class="php-var">$uid</span>] = <span class="php-var">$addrs</span>;
</span><span id="1315" class="l"><a class="l" href="#1315">1315: </a>        }
</span><span id="1316" class="l"><a class="l" href="#1316">1316: </a>
</span><span id="1317" class="l"><a class="l" href="#1317">1317: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">in_array</span>(<span class="php-var">$email</span>, <span class="php-var">$emails</span>[<span class="php-var">$uid</span>]);
</span><span id="1318" class="l"><a class="l" href="#1318">1318: </a>    }
</span><span id="1319" class="l"><a class="l" href="#1319">1319: </a>
</span><span id="1320" class="l"><a class="l" href="#1320">1320: </a>    <span class="php-comment">/**
</span></span><span id="1321" class="l"><a class="l" href="#1321">1321: </a><span class="php-comment">     * Maps a Kronolith recurrence value to a translated string suitable for
</span></span><span id="1322" class="l"><a class="l" href="#1322">1322: </a><span class="php-comment">     * display.
</span></span><span id="1323" class="l"><a class="l" href="#1323">1323: </a><span class="php-comment">     *
</span></span><span id="1324" class="l"><a class="l" href="#1324">1324: </a><span class="php-comment">     * @param integer $type  The recurrence value; one of the
</span></span><span id="1325" class="l"><a class="l" href="#1325">1325: </a><span class="php-comment">     *                       Horde_Date_Recurrence::RECUR_XXX constants.
</span></span><span id="1326" class="l"><a class="l" href="#1326">1326: </a><span class="php-comment">     *
</span></span><span id="1327" class="l"><a class="l" href="#1327">1327: </a><span class="php-comment">     * @return string  The translated displayable recurrence value string.
</span></span><span id="1328" class="l"><a class="l" href="#1328">1328: </a><span class="php-comment">     */</span>
</span><span id="1329" class="l"><a class="l" href="#1329">1329: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_recurToString" href="#_recurToString">recurToString</a>(<span class="php-var">$type</span>)
</span><span id="1330" class="l"><a class="l" href="#1330">1330: </a>    {
</span><span id="1331" class="l"><a class="l" href="#1331">1331: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$type</span>) {
</span><span id="1332" class="l"><a class="l" href="#1332">1332: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_NONE:
</span><span id="1333" class="l"><a class="l" href="#1333">1333: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Does not recur&quot;</span>);
</span><span id="1334" class="l"><a class="l" href="#1334">1334: </a>
</span><span id="1335" class="l"><a class="l" href="#1335">1335: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_DAILY:
</span><span id="1336" class="l"><a class="l" href="#1336">1336: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Recurs daily&quot;</span>);
</span><span id="1337" class="l"><a class="l" href="#1337">1337: </a>
</span><span id="1338" class="l"><a class="l" href="#1338">1338: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_WEEKLY:
</span><span id="1339" class="l"><a class="l" href="#1339">1339: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Recurs weekly&quot;</span>);
</span><span id="1340" class="l"><a class="l" href="#1340">1340: </a>
</span><span id="1341" class="l"><a class="l" href="#1341">1341: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_MONTHLY_DATE:
</span><span id="1342" class="l"><a class="l" href="#1342">1342: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_MONTHLY_WEEKDAY:
</span><span id="1343" class="l"><a class="l" href="#1343">1343: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Recurs monthly&quot;</span>);
</span><span id="1344" class="l"><a class="l" href="#1344">1344: </a>
</span><span id="1345" class="l"><a class="l" href="#1345">1345: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_YEARLY_DATE:
</span><span id="1346" class="l"><a class="l" href="#1346">1346: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_YEARLY_DAY:
</span><span id="1347" class="l"><a class="l" href="#1347">1347: </a>        <span class="php-keyword1">case</span> Horde_Date_Recurrence::RECUR_YEARLY_WEEKDAY:
</span><span id="1348" class="l"><a class="l" href="#1348">1348: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Recurs yearly&quot;</span>);
</span><span id="1349" class="l"><a class="l" href="#1349">1349: </a>        }
</span><span id="1350" class="l"><a class="l" href="#1350">1350: </a>    }
</span><span id="1351" class="l"><a class="l" href="#1351">1351: </a>
</span><span id="1352" class="l"><a class="l" href="#1352">1352: </a>    <span class="php-comment">/**
</span></span><span id="1353" class="l"><a class="l" href="#1353">1353: </a><span class="php-comment">     * Maps a Kronolith meeting status string to a translated string suitable
</span></span><span id="1354" class="l"><a class="l" href="#1354">1354: </a><span class="php-comment">     * for display.
</span></span><span id="1355" class="l"><a class="l" href="#1355">1355: </a><span class="php-comment">     *
</span></span><span id="1356" class="l"><a class="l" href="#1356">1356: </a><span class="php-comment">     * @param integer $status  The meeting status; one of the
</span></span><span id="1357" class="l"><a class="l" href="#1357">1357: </a><span class="php-comment">     *                         Kronolith::STATUS_XXX constants.
</span></span><span id="1358" class="l"><a class="l" href="#1358">1358: </a><span class="php-comment">     *
</span></span><span id="1359" class="l"><a class="l" href="#1359">1359: </a><span class="php-comment">     * @return string  The translated displayable meeting status string.
</span></span><span id="1360" class="l"><a class="l" href="#1360">1360: </a><span class="php-comment">     */</span>
</span><span id="1361" class="l"><a class="l" href="#1361">1361: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_statusToString" href="#_statusToString">statusToString</a>(<span class="php-var">$status</span>)
</span><span id="1362" class="l"><a class="l" href="#1362">1362: </a>    {
</span><span id="1363" class="l"><a class="l" href="#1363">1363: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$status</span>) {
</span><span id="1364" class="l"><a class="l" href="#1364">1364: </a>        <span class="php-keyword1">case</span> self::STATUS_CONFIRMED:
</span><span id="1365" class="l"><a class="l" href="#1365">1365: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Confirmed&quot;</span>);
</span><span id="1366" class="l"><a class="l" href="#1366">1366: </a>
</span><span id="1367" class="l"><a class="l" href="#1367">1367: </a>        <span class="php-keyword1">case</span> self::STATUS_CANCELLED:
</span><span id="1368" class="l"><a class="l" href="#1368">1368: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Cancelled&quot;</span>);
</span><span id="1369" class="l"><a class="l" href="#1369">1369: </a>
</span><span id="1370" class="l"><a class="l" href="#1370">1370: </a>        <span class="php-keyword1">case</span> self::STATUS_FREE:
</span><span id="1371" class="l"><a class="l" href="#1371">1371: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Free&quot;</span>);
</span><span id="1372" class="l"><a class="l" href="#1372">1372: </a>
</span><span id="1373" class="l"><a class="l" href="#1373">1373: </a>        <span class="php-keyword1">case</span> self::STATUS_TENTATIVE:
</span><span id="1374" class="l"><a class="l" href="#1374">1374: </a>        <span class="php-keyword1">default</span>:
</span><span id="1375" class="l"><a class="l" href="#1375">1375: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Tentative&quot;</span>);
</span><span id="1376" class="l"><a class="l" href="#1376">1376: </a>        }
</span><span id="1377" class="l"><a class="l" href="#1377">1377: </a>    }
</span><span id="1378" class="l"><a class="l" href="#1378">1378: </a>
</span><span id="1379" class="l"><a class="l" href="#1379">1379: </a>    <span class="php-comment">/**
</span></span><span id="1380" class="l"><a class="l" href="#1380">1380: </a><span class="php-comment">     * Maps a Kronolith attendee response string to a translated string
</span></span><span id="1381" class="l"><a class="l" href="#1381">1381: </a><span class="php-comment">     * suitable for display.
</span></span><span id="1382" class="l"><a class="l" href="#1382">1382: </a><span class="php-comment">     *
</span></span><span id="1383" class="l"><a class="l" href="#1383">1383: </a><span class="php-comment">     * @param integer $response  The attendee response; one of the
</span></span><span id="1384" class="l"><a class="l" href="#1384">1384: </a><span class="php-comment">     *                           Kronolith::RESPONSE_XXX constants.
</span></span><span id="1385" class="l"><a class="l" href="#1385">1385: </a><span class="php-comment">     *
</span></span><span id="1386" class="l"><a class="l" href="#1386">1386: </a><span class="php-comment">     * @return string  The translated displayable attendee response string.
</span></span><span id="1387" class="l"><a class="l" href="#1387">1387: </a><span class="php-comment">     */</span>
</span><span id="1388" class="l"><a class="l" href="#1388">1388: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_responseToString" href="#_responseToString">responseToString</a>(<span class="php-var">$response</span>)
</span><span id="1389" class="l"><a class="l" href="#1389">1389: </a>    {
</span><span id="1390" class="l"><a class="l" href="#1390">1390: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$response</span>) {
</span><span id="1391" class="l"><a class="l" href="#1391">1391: </a>        <span class="php-keyword1">case</span> self::RESPONSE_ACCEPTED:
</span><span id="1392" class="l"><a class="l" href="#1392">1392: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Accepted&quot;</span>);
</span><span id="1393" class="l"><a class="l" href="#1393">1393: </a>
</span><span id="1394" class="l"><a class="l" href="#1394">1394: </a>        <span class="php-keyword1">case</span> self::RESPONSE_DECLINED:
</span><span id="1395" class="l"><a class="l" href="#1395">1395: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Declined&quot;</span>);
</span><span id="1396" class="l"><a class="l" href="#1396">1396: </a>
</span><span id="1397" class="l"><a class="l" href="#1397">1397: </a>        <span class="php-keyword1">case</span> self::RESPONSE_TENTATIVE:
</span><span id="1398" class="l"><a class="l" href="#1398">1398: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Tentative&quot;</span>);
</span><span id="1399" class="l"><a class="l" href="#1399">1399: </a>
</span><span id="1400" class="l"><a class="l" href="#1400">1400: </a>        <span class="php-keyword1">case</span> self::RESPONSE_NONE:
</span><span id="1401" class="l"><a class="l" href="#1401">1401: </a>        <span class="php-keyword1">default</span>:
</span><span id="1402" class="l"><a class="l" href="#1402">1402: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;None&quot;</span>);
</span><span id="1403" class="l"><a class="l" href="#1403">1403: </a>        }
</span><span id="1404" class="l"><a class="l" href="#1404">1404: </a>    }
</span><span id="1405" class="l"><a class="l" href="#1405">1405: </a>
</span><span id="1406" class="l"><a class="l" href="#1406">1406: </a>    <span class="php-comment">/**
</span></span><span id="1407" class="l"><a class="l" href="#1407">1407: </a><span class="php-comment">     * Maps a Kronolith attendee participation string to a translated string
</span></span><span id="1408" class="l"><a class="l" href="#1408">1408: </a><span class="php-comment">     * suitable for display.
</span></span><span id="1409" class="l"><a class="l" href="#1409">1409: </a><span class="php-comment">     *
</span></span><span id="1410" class="l"><a class="l" href="#1410">1410: </a><span class="php-comment">     * @param integer $part  The attendee participation; one of the
</span></span><span id="1411" class="l"><a class="l" href="#1411">1411: </a><span class="php-comment">     *                       Kronolith::PART_XXX constants.
</span></span><span id="1412" class="l"><a class="l" href="#1412">1412: </a><span class="php-comment">     *
</span></span><span id="1413" class="l"><a class="l" href="#1413">1413: </a><span class="php-comment">     * @return string  The translated displayable attendee participation
</span></span><span id="1414" class="l"><a class="l" href="#1414">1414: </a><span class="php-comment">     *                 string.
</span></span><span id="1415" class="l"><a class="l" href="#1415">1415: </a><span class="php-comment">     */</span>
</span><span id="1416" class="l"><a class="l" href="#1416">1416: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_partToString" href="#_partToString">partToString</a>(<span class="php-var">$part</span>)
</span><span id="1417" class="l"><a class="l" href="#1417">1417: </a>    {
</span><span id="1418" class="l"><a class="l" href="#1418">1418: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$part</span>) {
</span><span id="1419" class="l"><a class="l" href="#1419">1419: </a>        <span class="php-keyword1">case</span> self::PART_OPTIONAL:
</span><span id="1420" class="l"><a class="l" href="#1420">1420: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Optional&quot;</span>);
</span><span id="1421" class="l"><a class="l" href="#1421">1421: </a>
</span><span id="1422" class="l"><a class="l" href="#1422">1422: </a>        <span class="php-keyword1">case</span> self::PART_NONE:
</span><span id="1423" class="l"><a class="l" href="#1423">1423: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;None&quot;</span>);
</span><span id="1424" class="l"><a class="l" href="#1424">1424: </a>
</span><span id="1425" class="l"><a class="l" href="#1425">1425: </a>        <span class="php-keyword1">case</span> self::PART_REQUIRED:
</span><span id="1426" class="l"><a class="l" href="#1426">1426: </a>        <span class="php-keyword1">default</span>:
</span><span id="1427" class="l"><a class="l" href="#1427">1427: </a>            <span class="php-keyword1">return</span> _(<span class="php-quote">&quot;Required&quot;</span>);
</span><span id="1428" class="l"><a class="l" href="#1428">1428: </a>        }
</span><span id="1429" class="l"><a class="l" href="#1429">1429: </a>    }
</span><span id="1430" class="l"><a class="l" href="#1430">1430: </a>
</span><span id="1431" class="l"><a class="l" href="#1431">1431: </a>    <span class="php-comment">/**
</span></span><span id="1432" class="l"><a class="l" href="#1432">1432: </a><span class="php-comment">     * Maps an iCalendar attendee response string to the corresponding
</span></span><span id="1433" class="l"><a class="l" href="#1433">1433: </a><span class="php-comment">     * Kronolith value.
</span></span><span id="1434" class="l"><a class="l" href="#1434">1434: </a><span class="php-comment">     *
</span></span><span id="1435" class="l"><a class="l" href="#1435">1435: </a><span class="php-comment">     * @param string $response  The attendee response.
</span></span><span id="1436" class="l"><a class="l" href="#1436">1436: </a><span class="php-comment">     *
</span></span><span id="1437" class="l"><a class="l" href="#1437">1437: </a><span class="php-comment">     * @return string  The Kronolith response value.
</span></span><span id="1438" class="l"><a class="l" href="#1438">1438: </a><span class="php-comment">     */</span>
</span><span id="1439" class="l"><a class="l" href="#1439">1439: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_responseFromICal" href="#_responseFromICal">responseFromICal</a>(<span class="php-var">$response</span>)
</span><span id="1440" class="l"><a class="l" href="#1440">1440: </a>    {
</span><span id="1441" class="l"><a class="l" href="#1441">1441: </a>        <span class="php-keyword1">switch</span> (Horde_String::upper(<span class="php-var">$response</span>)) {
</span><span id="1442" class="l"><a class="l" href="#1442">1442: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'ACCEPTED'</span>:
</span><span id="1443" class="l"><a class="l" href="#1443">1443: </a>            <span class="php-keyword1">return</span> self::RESPONSE_ACCEPTED;
</span><span id="1444" class="l"><a class="l" href="#1444">1444: </a>
</span><span id="1445" class="l"><a class="l" href="#1445">1445: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'DECLINED'</span>:
</span><span id="1446" class="l"><a class="l" href="#1446">1446: </a>            <span class="php-keyword1">return</span> self::RESPONSE_DECLINED;
</span><span id="1447" class="l"><a class="l" href="#1447">1447: </a>
</span><span id="1448" class="l"><a class="l" href="#1448">1448: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'TENTATIVE'</span>:
</span><span id="1449" class="l"><a class="l" href="#1449">1449: </a>            <span class="php-keyword1">return</span> self::RESPONSE_TENTATIVE;
</span><span id="1450" class="l"><a class="l" href="#1450">1450: </a>
</span><span id="1451" class="l"><a class="l" href="#1451">1451: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'NEEDS-ACTION'</span>:
</span><span id="1452" class="l"><a class="l" href="#1452">1452: </a>        <span class="php-keyword1">default</span>:
</span><span id="1453" class="l"><a class="l" href="#1453">1453: </a>            <span class="php-keyword1">return</span> self::RESPONSE_NONE;
</span><span id="1454" class="l"><a class="l" href="#1454">1454: </a>        }
</span><span id="1455" class="l"><a class="l" href="#1455">1455: </a>    }
</span><span id="1456" class="l"><a class="l" href="#1456">1456: </a>
</span><span id="1457" class="l"><a class="l" href="#1457">1457: </a>    <span class="php-comment">/**
</span></span><span id="1458" class="l"><a class="l" href="#1458">1458: </a><span class="php-comment">     * Builds the HTML for an event status widget.
</span></span><span id="1459" class="l"><a class="l" href="#1459">1459: </a><span class="php-comment">     *
</span></span><span id="1460" class="l"><a class="l" href="#1460">1460: </a><span class="php-comment">     * @param string $name     The name of the widget.
</span></span><span id="1461" class="l"><a class="l" href="#1461">1461: </a><span class="php-comment">     * @param string $current  The selected status value.
</span></span><span id="1462" class="l"><a class="l" href="#1462">1462: </a><span class="php-comment">     * @param string $any      Whether an 'any' item should be added
</span></span><span id="1463" class="l"><a class="l" href="#1463">1463: </a><span class="php-comment">     *
</span></span><span id="1464" class="l"><a class="l" href="#1464">1464: </a><span class="php-comment">     * @return string  The HTML &lt;select&gt; widget.
</span></span><span id="1465" class="l"><a class="l" href="#1465">1465: </a><span class="php-comment">     */</span>
</span><span id="1466" class="l"><a class="l" href="#1466">1466: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_buildStatusWidget" href="#_buildStatusWidget">buildStatusWidget</a>(<span class="php-var">$name</span>,
</span><span id="1467" class="l"><a class="l" href="#1467">1467: </a>                                             <span class="php-var">$current</span> = self::STATUS_CONFIRMED,
</span><span id="1468" class="l"><a class="l" href="#1468">1468: </a>                                             <span class="php-var">$any</span> = <span class="php-keyword1">false</span>)
</span><span id="1469" class="l"><a class="l" href="#1469">1469: </a>    {
</span><span id="1470" class="l"><a class="l" href="#1470">1470: </a>        <span class="php-var">$html</span> = <span class="php-quote">&quot;&lt;select id=\&quot;</span><span class="php-var">$name</span><span class="php-quote">\&quot; name=\&quot;</span><span class="php-var">$name</span><span class="php-quote">\&quot;&gt;&quot;</span>;
</span><span id="1471" class="l"><a class="l" href="#1471">1471: </a>
</span><span id="1472" class="l"><a class="l" href="#1472">1472: </a>        <span class="php-var">$statii</span> = <span class="php-keyword1">array</span>(
</span><span id="1473" class="l"><a class="l" href="#1473">1473: </a>            self::STATUS_FREE,
</span><span id="1474" class="l"><a class="l" href="#1474">1474: </a>            self::STATUS_TENTATIVE,
</span><span id="1475" class="l"><a class="l" href="#1475">1475: </a>            self::STATUS_CONFIRMED,
</span><span id="1476" class="l"><a class="l" href="#1476">1476: </a>            self::STATUS_CANCELLED
</span><span id="1477" class="l"><a class="l" href="#1477">1477: </a>        );
</span><span id="1478" class="l"><a class="l" href="#1478">1478: </a>
</span><span id="1479" class="l"><a class="l" href="#1479">1479: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$current</span>)) {
</span><span id="1480" class="l"><a class="l" href="#1480">1480: </a>            <span class="php-var">$current</span> = self::STATUS_NONE;
</span><span id="1481" class="l"><a class="l" href="#1481">1481: </a>        }
</span><span id="1482" class="l"><a class="l" href="#1482">1482: </a>
</span><span id="1483" class="l"><a class="l" href="#1483">1483: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$any</span>) {
</span><span id="1484" class="l"><a class="l" href="#1484">1484: </a>            <span class="php-var">$html</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;&quot;</span> . self::STATUS_NONE . <span class="php-quote">&quot;\&quot;&quot;</span>;
</span><span id="1485" class="l"><a class="l" href="#1485">1485: </a>            <span class="php-var">$html</span> .= (<span class="php-var">$current</span> == self::STATUS_NONE) ? <span class="php-quote">' selected=&quot;selected&quot;&gt;'</span> : <span class="php-quote">'&gt;'</span>;
</span><span id="1486" class="l"><a class="l" href="#1486">1486: </a>            <span class="php-var">$html</span> .= _(<span class="php-quote">&quot;Any&quot;</span>) . <span class="php-quote">&quot;&lt;/option&gt;&quot;</span>;
</span><span id="1487" class="l"><a class="l" href="#1487">1487: </a>        }
</span><span id="1488" class="l"><a class="l" href="#1488">1488: </a>
</span><span id="1489" class="l"><a class="l" href="#1489">1489: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$statii</span> <span class="php-keyword1">as</span> <span class="php-var">$status</span>) {
</span><span id="1490" class="l"><a class="l" href="#1490">1490: </a>            <span class="php-var">$html</span> .= <span class="php-quote">&quot;&lt;option value=\&quot;</span><span class="php-var">$status</span><span class="php-quote">\&quot;&quot;</span>;
</span><span id="1491" class="l"><a class="l" href="#1491">1491: </a>            <span class="php-var">$html</span> .= (<span class="php-var">$status</span> == <span class="php-var">$current</span>) ? <span class="php-quote">' selected=&quot;selected&quot;&gt;'</span> : <span class="php-quote">'&gt;'</span>;
</span><span id="1492" class="l"><a class="l" href="#1492">1492: </a>            <span class="php-var">$html</span> .= self::statusToString(<span class="php-var">$status</span>) . <span class="php-quote">&quot;&lt;/option&gt;&quot;</span>;
</span><span id="1493" class="l"><a class="l" href="#1493">1493: </a>        }
</span><span id="1494" class="l"><a class="l" href="#1494">1494: </a>        <span class="php-var">$html</span> .= <span class="php-quote">'&lt;/select&gt;'</span>;
</span><span id="1495" class="l"><a class="l" href="#1495">1495: </a>
</span><span id="1496" class="l"><a class="l" href="#1496">1496: </a>        <span class="php-keyword1">return</span> <span class="php-var">$html</span>;
</span><span id="1497" class="l"><a class="l" href="#1497">1497: </a>    }
</span><span id="1498" class="l"><a class="l" href="#1498">1498: </a>
</span><span id="1499" class="l"><a class="l" href="#1499">1499: </a>    <span class="php-comment">/**
</span></span><span id="1500" class="l"><a class="l" href="#1500">1500: </a><span class="php-comment">     * Returns all internal calendars a user has access to, according
</span></span><span id="1501" class="l"><a class="l" href="#1501">1501: </a><span class="php-comment">     * to several parameters/permission levels.
</span></span><span id="1502" class="l"><a class="l" href="#1502">1502: </a><span class="php-comment">     *
</span></span><span id="1503" class="l"><a class="l" href="#1503">1503: </a><span class="php-comment">     * This method takes the $conf['share']['hidden'] setting into account. If
</span></span><span id="1504" class="l"><a class="l" href="#1504">1504: </a><span class="php-comment">     * this setting is enabled, even if requesting permissions different than
</span></span><span id="1505" class="l"><a class="l" href="#1505">1505: </a><span class="php-comment">     * SHOW, it will only return calendars that the user owns or has SHOW
</span></span><span id="1506" class="l"><a class="l" href="#1506">1506: </a><span class="php-comment">     * permissions for. For checking individual calendar's permissions, use
</span></span><span id="1507" class="l"><a class="l" href="#1507">1507: </a><span class="php-comment">     * hasPermission() instead.
</span></span><span id="1508" class="l"><a class="l" href="#1508">1508: </a><span class="php-comment">     *
</span></span><span id="1509" class="l"><a class="l" href="#1509">1509: </a><span class="php-comment">     * @param boolean $owneronly   Only return calenders that this user owns?
</span></span><span id="1510" class="l"><a class="l" href="#1510">1510: </a><span class="php-comment">     *                             Defaults to false.
</span></span><span id="1511" class="l"><a class="l" href="#1511">1511: </a><span class="php-comment">     * @param integer $permission  The permission to filter calendars by.
</span></span><span id="1512" class="l"><a class="l" href="#1512">1512: </a><span class="php-comment">     *
</span></span><span id="1513" class="l"><a class="l" href="#1513">1513: </a><span class="php-comment">     * @return array  The calendar list.
</span></span><span id="1514" class="l"><a class="l" href="#1514">1514: </a><span class="php-comment">     */</span>
</span><span id="1515" class="l"><a class="l" href="#1515">1515: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_listInternalCalendars" href="#_listInternalCalendars">listInternalCalendars</a>(<span class="php-var">$owneronly</span> = <span class="php-keyword1">false</span>, <span class="php-var">$permission</span> = Horde_Perms::SHOW)
</span><span id="1516" class="l"><a class="l" href="#1516">1516: </a>    {
</span><span id="1517" class="l"><a class="l" href="#1517">1517: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$owneronly</span> &amp;&amp; !<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth()) {
</span><span id="1518" class="l"><a class="l" href="#1518">1518: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="1519" class="l"><a class="l" href="#1519">1519: </a>        }
</span><span id="1520" class="l"><a class="l" href="#1520">1520: </a>
</span><span id="1521" class="l"><a class="l" href="#1521">1521: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$owneronly</span> || <span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'hidden'</span>])) {
</span><span id="1522" class="l"><a class="l" href="#1522">1522: </a>            <span class="php-keyword1">try</span> {
</span><span id="1523" class="l"><a class="l" href="#1523">1523: </a>                <span class="php-var">$calendars</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;listShares(
</span><span id="1524" class="l"><a class="l" href="#1524">1524: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(),
</span><span id="1525" class="l"><a class="l" href="#1525">1525: </a>                    <span class="php-keyword1">array</span>(<span class="php-quote">'perm'</span> =&gt; <span class="php-var">$permission</span>,
</span><span id="1526" class="l"><a class="l" href="#1526">1526: </a>                          <span class="php-quote">'attributes'</span> =&gt; <span class="php-var">$owneronly</span> ? <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() : <span class="php-keyword1">null</span>,
</span><span id="1527" class="l"><a class="l" href="#1527">1527: </a>                          <span class="php-quote">'sort_by'</span> =&gt; <span class="php-quote">'name'</span>));
</span><span id="1528" class="l"><a class="l" href="#1528">1528: </a>            } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1529" class="l"><a class="l" href="#1529">1529: </a>                Horde::logMessage(<span class="php-var">$e</span>);
</span><span id="1530" class="l"><a class="l" href="#1530">1530: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="1531" class="l"><a class="l" href="#1531">1531: </a>            }
</span><span id="1532" class="l"><a class="l" href="#1532">1532: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1533" class="l"><a class="l" href="#1533">1533: </a>            <span class="php-keyword1">try</span> {
</span><span id="1534" class="l"><a class="l" href="#1534">1534: </a>                <span class="php-var">$calendars</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;listShares(
</span><span id="1535" class="l"><a class="l" href="#1535">1535: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(),
</span><span id="1536" class="l"><a class="l" href="#1536">1536: </a>                    <span class="php-keyword1">array</span>(<span class="php-quote">'perm'</span> =&gt; <span class="php-var">$permission</span>,
</span><span id="1537" class="l"><a class="l" href="#1537">1537: </a>                          <span class="php-quote">'attributes'</span> =&gt; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(),
</span><span id="1538" class="l"><a class="l" href="#1538">1538: </a>                          <span class="php-quote">'sort_by'</span> =&gt; <span class="php-quote">'name'</span>));
</span><span id="1539" class="l"><a class="l" href="#1539">1539: </a>            } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1540" class="l"><a class="l" href="#1540">1540: </a>                Horde::logMessage(<span class="php-var">$e</span>);
</span><span id="1541" class="l"><a class="l" href="#1541">1541: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="1542" class="l"><a class="l" href="#1542">1542: </a>            }
</span><span id="1543" class="l"><a class="l" href="#1543">1543: </a>            <span class="php-var">$display_calendars</span> = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'display_cals'</span>));
</span><span id="1544" class="l"><a class="l" href="#1544">1544: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">is_array</span>(<span class="php-var">$display_calendars</span>)) {
</span><span id="1545" class="l"><a class="l" href="#1545">1545: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$display_calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$id</span>) {
</span><span id="1546" class="l"><a class="l" href="#1546">1546: </a>                    <span class="php-keyword1">try</span> {
</span><span id="1547" class="l"><a class="l" href="#1547">1547: </a>                        <span class="php-var">$calendar</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;getShare(<span class="php-var">$id</span>);
</span><span id="1548" class="l"><a class="l" href="#1548">1548: </a>                        <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>-&gt;hasPermission(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(), <span class="php-var">$permission</span>)) {
</span><span id="1549" class="l"><a class="l" href="#1549">1549: </a>                            <span class="php-var">$calendars</span>[<span class="php-var">$id</span>] = <span class="php-var">$calendar</span>;
</span><span id="1550" class="l"><a class="l" href="#1550">1550: </a>                        }
</span><span id="1551" class="l"><a class="l" href="#1551">1551: </a>                    } <span class="php-keyword1">catch</span> (Horde_Exception_NotFound <span class="php-var">$e</span>) {
</span><span id="1552" class="l"><a class="l" href="#1552">1552: </a>                    } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1553" class="l"><a class="l" href="#1553">1553: </a>                        Horde::logMessage(<span class="php-var">$e</span>);
</span><span id="1554" class="l"><a class="l" href="#1554">1554: </a>                        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="1555" class="l"><a class="l" href="#1555">1555: </a>                    }
</span><span id="1556" class="l"><a class="l" href="#1556">1556: </a>                }
</span><span id="1557" class="l"><a class="l" href="#1557">1557: </a>            }
</span><span id="1558" class="l"><a class="l" href="#1558">1558: </a>        }
</span><span id="1559" class="l"><a class="l" href="#1559">1559: </a>
</span><span id="1560" class="l"><a class="l" href="#1560">1560: </a>        <span class="php-var">$default_share</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'default_share'</span>);
</span><span id="1561" class="l"><a class="l" href="#1561">1561: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$calendars</span>[<span class="php-var">$default_share</span>])) {
</span><span id="1562" class="l"><a class="l" href="#1562">1562: </a>            <span class="php-var">$calendar</span> = <span class="php-var">$calendars</span>[<span class="php-var">$default_share</span>];
</span><span id="1563" class="l"><a class="l" href="#1563">1563: </a>            <span class="php-keyword1">unset</span>(<span class="php-var">$calendars</span>[<span class="php-var">$default_share</span>]);
</span><span id="1564" class="l"><a class="l" href="#1564">1564: </a>            <span class="php-var">$calendars</span> = <span class="php-keyword1">array</span>(<span class="php-var">$default_share</span> =&gt; <span class="php-var">$calendar</span>) + <span class="php-var">$calendars</span>;
</span><span id="1565" class="l"><a class="l" href="#1565">1565: </a>        }
</span><span id="1566" class="l"><a class="l" href="#1566">1566: </a>
</span><span id="1567" class="l"><a class="l" href="#1567">1567: </a>        <span class="php-keyword1">return</span> <span class="php-var">$calendars</span>;
</span><span id="1568" class="l"><a class="l" href="#1568">1568: </a>    }
</span><span id="1569" class="l"><a class="l" href="#1569">1569: </a>
</span><span id="1570" class="l"><a class="l" href="#1570">1570: </a>    <span class="php-comment">/**
</span></span><span id="1571" class="l"><a class="l" href="#1571">1571: </a><span class="php-comment">     * Returns all calendars a user has access to, according to several
</span></span><span id="1572" class="l"><a class="l" href="#1572">1572: </a><span class="php-comment">     * parameters/permission levels.
</span></span><span id="1573" class="l"><a class="l" href="#1573">1573: </a><span class="php-comment">     *
</span></span><span id="1574" class="l"><a class="l" href="#1574">1574: </a><span class="php-comment">     * @param boolean $owneronly   Only return calenders that this user owns?
</span></span><span id="1575" class="l"><a class="l" href="#1575">1575: </a><span class="php-comment">     *                             Defaults to false.
</span></span><span id="1576" class="l"><a class="l" href="#1576">1576: </a><span class="php-comment">     * @param boolean $display     Only return calendars that are supposed to
</span></span><span id="1577" class="l"><a class="l" href="#1577">1577: </a><span class="php-comment">     *                             be displayed per configuration and user
</span></span><span id="1578" class="l"><a class="l" href="#1578">1578: </a><span class="php-comment">     *                             preference.
</span></span><span id="1579" class="l"><a class="l" href="#1579">1579: </a><span class="php-comment">     * @param integer $permission  The permission to filter calendars by.
</span></span><span id="1580" class="l"><a class="l" href="#1580">1580: </a><span class="php-comment">     *
</span></span><span id="1581" class="l"><a class="l" href="#1581">1581: </a><span class="php-comment">     * @return array  The calendar list.
</span></span><span id="1582" class="l"><a class="l" href="#1582">1582: </a><span class="php-comment">     */</span>
</span><span id="1583" class="l"><a class="l" href="#1583">1583: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_listCalendars" href="#_listCalendars">listCalendars</a>(<span class="php-var">$permission</span> = Horde_Perms::SHOW,
</span><span id="1584" class="l"><a class="l" href="#1584">1584: </a>                                         <span class="php-var">$display</span> = <span class="php-keyword1">false</span>,
</span><span id="1585" class="l"><a class="l" href="#1585">1585: </a>                                         <span class="php-var">$flat</span> = <span class="php-keyword1">true</span>)
</span><span id="1586" class="l"><a class="l" href="#1586">1586: </a>    {
</span><span id="1587" class="l"><a class="l" href="#1587">1587: </a>        <span class="php-var">$calendars</span> = <span class="php-keyword1">array</span>();
</span><span id="1588" class="l"><a class="l" href="#1588">1588: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="1589" class="l"><a class="l" href="#1589">1589: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>-&gt;hasPermission(<span class="php-var">$permission</span>) &amp;&amp;
</span><span id="1590" class="l"><a class="l" href="#1590">1590: </a>                (!<span class="php-var">$display</span> || <span class="php-var">$calendar</span>-&gt;display())) {
</span><span id="1591" class="l"><a class="l" href="#1591">1591: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$flat</span>) {
</span><span id="1592" class="l"><a class="l" href="#1592">1592: </a>                    <span class="php-var">$calendars</span>[<span class="php-quote">'internal_'</span> . <span class="php-var">$id</span>] = <span class="php-var">$calendar</span>;
</span><span id="1593" class="l"><a class="l" href="#1593">1593: </a>                }
</span><span id="1594" class="l"><a class="l" href="#1594">1594: </a>            }
</span><span id="1595" class="l"><a class="l" href="#1595">1595: </a>        }
</span><span id="1596" class="l"><a class="l" href="#1596">1596: </a>
</span><span id="1597" class="l"><a class="l" href="#1597">1597: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_remote_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="1598" class="l"><a class="l" href="#1598">1598: </a>            <span class="php-keyword1">try</span> {
</span><span id="1599" class="l"><a class="l" href="#1599">1599: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>-&gt;hasPermission(<span class="php-var">$permission</span>) &amp;&amp;
</span><span id="1600" class="l"><a class="l" href="#1600">1600: </a>                    (!<span class="php-var">$display</span> || <span class="php-var">$calendar</span>-&gt;display())) {
</span><span id="1601" class="l"><a class="l" href="#1601">1601: </a>                    <span class="php-keyword1">if</span> (<span class="php-var">$flat</span>) {
</span><span id="1602" class="l"><a class="l" href="#1602">1602: </a>                        <span class="php-var">$calendars</span>[<span class="php-quote">'remote_'</span> . <span class="php-var">$id</span>] = <span class="php-var">$calendar</span>;
</span><span id="1603" class="l"><a class="l" href="#1603">1603: </a>                    }
</span><span id="1604" class="l"><a class="l" href="#1604">1604: </a>                }
</span><span id="1605" class="l"><a class="l" href="#1605">1605: </a>            } <span class="php-keyword1">catch</span> (Kronolith_Exception <span class="php-var">$e</span>) {
</span><span id="1606" class="l"><a class="l" href="#1606">1606: </a>                <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;The calendar %s returned the error: %s&quot;</span>), <span class="php-var">$calendar</span>-&gt;name(), <span class="php-var">$e</span>-&gt;getMessage()), <span class="php-quote">'horde.error'</span>);
</span><span id="1607" class="l"><a class="l" href="#1607">1607: </a>            }
</span><span id="1608" class="l"><a class="l" href="#1608">1608: </a>        }
</span><span id="1609" class="l"><a class="l" href="#1609">1609: </a>
</span><span id="1610" class="l"><a class="l" href="#1610">1610: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_external_calendars'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="1611" class="l"><a class="l" href="#1611">1611: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>-&gt;hasPermission(<span class="php-var">$permission</span>) &amp;&amp;
</span><span id="1612" class="l"><a class="l" href="#1612">1612: </a>                (!<span class="php-var">$display</span> || <span class="php-var">$calendar</span>-&gt;display())) {
</span><span id="1613" class="l"><a class="l" href="#1613">1613: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$flat</span>) {
</span><span id="1614" class="l"><a class="l" href="#1614">1614: </a>                    <span class="php-var">$calendars</span>[<span class="php-quote">'external_'</span> . <span class="php-var">$id</span>] = <span class="php-var">$calendar</span>;
</span><span id="1615" class="l"><a class="l" href="#1615">1615: </a>                }
</span><span id="1616" class="l"><a class="l" href="#1616">1616: </a>            }
</span><span id="1617" class="l"><a class="l" href="#1617">1617: </a>        }
</span><span id="1618" class="l"><a class="l" href="#1618">1618: </a>
</span><span id="1619" class="l"><a class="l" href="#1619">1619: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_holidays'</span>] <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="1620" class="l"><a class="l" href="#1620">1620: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>-&gt;hasPermission(<span class="php-var">$permission</span>) &amp;&amp;
</span><span id="1621" class="l"><a class="l" href="#1621">1621: </a>                (!<span class="php-var">$display</span> || <span class="php-var">$calendar</span>-&gt;display())) {
</span><span id="1622" class="l"><a class="l" href="#1622">1622: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$flat</span>) {
</span><span id="1623" class="l"><a class="l" href="#1623">1623: </a>                    <span class="php-var">$calendars</span>[<span class="php-quote">'holiday_'</span> . <span class="php-var">$id</span>] = <span class="php-var">$calendar</span>;
</span><span id="1624" class="l"><a class="l" href="#1624">1624: </a>                }
</span><span id="1625" class="l"><a class="l" href="#1625">1625: </a>            }
</span><span id="1626" class="l"><a class="l" href="#1626">1626: </a>        }
</span><span id="1627" class="l"><a class="l" href="#1627">1627: </a>
</span><span id="1628" class="l"><a class="l" href="#1628">1628: </a>        <span class="php-keyword1">return</span> <span class="php-var">$calendars</span>;
</span><span id="1629" class="l"><a class="l" href="#1629">1629: </a>    }
</span><span id="1630" class="l"><a class="l" href="#1630">1630: </a>
</span><span id="1631" class="l"><a class="l" href="#1631">1631: </a>    <span class="php-comment">/**
</span></span><span id="1632" class="l"><a class="l" href="#1632">1632: </a><span class="php-comment">     * Returns the default calendar for the current user at the specified
</span></span><span id="1633" class="l"><a class="l" href="#1633">1633: </a><span class="php-comment">     * permissions level.
</span></span><span id="1634" class="l"><a class="l" href="#1634">1634: </a><span class="php-comment">     *
</span></span><span id="1635" class="l"><a class="l" href="#1635">1635: </a><span class="php-comment">     * @param integer $permission  Horde_Perms constant for permission level required.
</span></span><span id="1636" class="l"><a class="l" href="#1636">1636: </a><span class="php-comment">     * @param boolean $owner_only  Only consider owner-owned calendars.
</span></span><span id="1637" class="l"><a class="l" href="#1637">1637: </a><span class="php-comment">     *
</span></span><span id="1638" class="l"><a class="l" href="#1638">1638: </a><span class="php-comment">     * @return mixed  The calendar id, or false if none found.
</span></span><span id="1639" class="l"><a class="l" href="#1639">1639: </a><span class="php-comment">     */</span>
</span><span id="1640" class="l"><a class="l" href="#1640">1640: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getDefaultCalendar" href="#_getDefaultCalendar">getDefaultCalendar</a>(<span class="php-var">$permission</span> = Horde_Perms::SHOW, <span class="php-var">$owner_only</span> = <span class="php-keyword1">false</span>)
</span><span id="1641" class="l"><a class="l" href="#1641">1641: </a>    {
</span><span id="1642" class="l"><a class="l" href="#1642">1642: </a>        <span class="php-keyword1">global</span> <span class="php-var">$prefs</span>;
</span><span id="1643" class="l"><a class="l" href="#1643">1643: </a>
</span><span id="1644" class="l"><a class="l" href="#1644">1644: </a>        <span class="php-var">$default_share</span> = <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'default_share'</span>);
</span><span id="1645" class="l"><a class="l" href="#1645">1645: </a>        <span class="php-var">$calendars</span> = self::listInternalCalendars(<span class="php-var">$owner_only</span>, <span class="php-var">$permission</span>);
</span><span id="1646" class="l"><a class="l" href="#1646">1646: </a>
</span><span id="1647" class="l"><a class="l" href="#1647">1647: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$calendars</span>[<span class="php-var">$default_share</span>]) ||
</span><span id="1648" class="l"><a class="l" href="#1648">1648: </a>            <span class="php-var">$prefs</span>-&gt;isLocked(<span class="php-quote">'default_share'</span>)) {
</span><span id="1649" class="l"><a class="l" href="#1649">1649: </a>            <span class="php-keyword1">return</span> <span class="php-var">$default_share</span>;
</span><span id="1650" class="l"><a class="l" href="#1650">1650: </a>        } <span class="php-keyword1">elseif</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>][<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth()]) &amp;&amp;
</span><span id="1651" class="l"><a class="l" href="#1651">1651: </a>                  <span class="php-var">$GLOBALS</span>[<span class="php-quote">'all_calendars'</span>][<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth()]-&gt;hasPermission(<span class="php-var">$permission</span>)) {
</span><span id="1652" class="l"><a class="l" href="#1652">1652: </a>            <span class="php-comment">// This is for older, existing default shares. New default shares</span>
</span><span id="1653" class="l"><a class="l" href="#1653">1653: </a>            <span class="php-comment">// are not named as the username.</span>
</span><span id="1654" class="l"><a class="l" href="#1654">1654: </a>            <span class="php-keyword1">return</span> <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth();
</span><span id="1655" class="l"><a class="l" href="#1655">1655: </a>        } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">count</span>(<span class="php-var">$calendars</span>)) {
</span><span id="1656" class="l"><a class="l" href="#1656">1656: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">key</span>(<span class="php-var">$calendars</span>);
</span><span id="1657" class="l"><a class="l" href="#1657">1657: </a>        }
</span><span id="1658" class="l"><a class="l" href="#1658">1658: </a>
</span><span id="1659" class="l"><a class="l" href="#1659">1659: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="1660" class="l"><a class="l" href="#1660">1660: </a>    }
</span><span id="1661" class="l"><a class="l" href="#1661">1661: </a>
</span><span id="1662" class="l"><a class="l" href="#1662">1662: </a>    <span class="php-comment">/**
</span></span><span id="1663" class="l"><a class="l" href="#1663">1663: </a><span class="php-comment">     * Returns the calendars that should be used for syncing.
</span></span><span id="1664" class="l"><a class="l" href="#1664">1664: </a><span class="php-comment">     *
</span></span><span id="1665" class="l"><a class="l" href="#1665">1665: </a><span class="php-comment">     * @param boolean $prune  Remove calendar ids from the sync list that no
</span></span><span id="1666" class="l"><a class="l" href="#1666">1666: </a><span class="php-comment">     *                        longer exist. The values are pruned *after* the
</span></span><span id="1667" class="l"><a class="l" href="#1667">1667: </a><span class="php-comment">     *                        results are passed back to the client to give
</span></span><span id="1668" class="l"><a class="l" href="#1668">1668: </a><span class="php-comment">     *                        sync clients a chance to remove their entries.
</span></span><span id="1669" class="l"><a class="l" href="#1669">1669: </a><span class="php-comment">     *
</span></span><span id="1670" class="l"><a class="l" href="#1670">1670: </a><span class="php-comment">     * @return array  An array of calendar ids
</span></span><span id="1671" class="l"><a class="l" href="#1671">1671: </a><span class="php-comment">     */</span>
</span><span id="1672" class="l"><a class="l" href="#1672">1672: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getSyncCalendars" href="#_getSyncCalendars">getSyncCalendars</a>(<span class="php-var">$prune</span> = <span class="php-keyword1">false</span>)
</span><span id="1673" class="l"><a class="l" href="#1673">1673: </a>    {
</span><span id="1674" class="l"><a class="l" href="#1674">1674: </a>        <span class="php-var">$haveRemoved</span> = <span class="php-keyword1">false</span>;
</span><span id="1675" class="l"><a class="l" href="#1675">1675: </a>        <span class="php-var">$cs</span> = <span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'sync_calendars'</span>));
</span><span id="1676" class="l"><a class="l" href="#1676">1676: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$cs</span>)) {
</span><span id="1677" class="l"><a class="l" href="#1677">1677: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$prune</span>) {
</span><span id="1678" class="l"><a class="l" href="#1678">1678: </a>                <span class="php-var">$calendars</span> = self::listInternalCalendars(<span class="php-keyword1">true</span>, Horde_Perms::EDIT);
</span><span id="1679" class="l"><a class="l" href="#1679">1679: </a>                <span class="php-var">$cscopy</span> = <span class="php-keyword2">array_flip</span>(<span class="php-var">$cs</span>);
</span><span id="1680" class="l"><a class="l" href="#1680">1680: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$cs</span> <span class="php-keyword1">as</span> <span class="php-var">$c</span>) {
</span><span id="1681" class="l"><a class="l" href="#1681">1681: </a>                    <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$calendars</span>[<span class="php-var">$c</span>])) {
</span><span id="1682" class="l"><a class="l" href="#1682">1682: </a>                        <span class="php-keyword1">unset</span>(<span class="php-var">$cscopy</span>[<span class="php-var">$c</span>]);
</span><span id="1683" class="l"><a class="l" href="#1683">1683: </a>                        <span class="php-var">$haveRemoved</span> = <span class="php-keyword1">true</span>;
</span><span id="1684" class="l"><a class="l" href="#1684">1684: </a>                    }
</span><span id="1685" class="l"><a class="l" href="#1685">1685: </a>                }
</span><span id="1686" class="l"><a class="l" href="#1686">1686: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$haveRemoved</span>) {
</span><span id="1687" class="l"><a class="l" href="#1687">1687: </a>                    <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'sync_calendars'</span>, <span class="php-keyword2">serialize</span>(<span class="php-keyword2">array_flip</span>(<span class="php-var">$cscopy</span>)));
</span><span id="1688" class="l"><a class="l" href="#1688">1688: </a>                }
</span><span id="1689" class="l"><a class="l" href="#1689">1689: </a>            }
</span><span id="1690" class="l"><a class="l" href="#1690">1690: </a>            <span class="php-keyword1">return</span> <span class="php-var">$cs</span>;
</span><span id="1691" class="l"><a class="l" href="#1691">1691: </a>        }
</span><span id="1692" class="l"><a class="l" href="#1692">1692: </a>
</span><span id="1693" class="l"><a class="l" href="#1693">1693: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$cs</span> = self::getDefaultCalendar(Horde_Perms::EDIT, <span class="php-keyword1">true</span>)) {
</span><span id="1694" class="l"><a class="l" href="#1694">1694: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-var">$cs</span>);
</span><span id="1695" class="l"><a class="l" href="#1695">1695: </a>        }
</span><span id="1696" class="l"><a class="l" href="#1696">1696: </a>
</span><span id="1697" class="l"><a class="l" href="#1697">1697: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="1698" class="l"><a class="l" href="#1698">1698: </a>    }
</span><span id="1699" class="l"><a class="l" href="#1699">1699: </a>
</span><span id="1700" class="l"><a class="l" href="#1700">1700: </a>    <span class="php-comment">/**
</span></span><span id="1701" class="l"><a class="l" href="#1701">1701: </a><span class="php-comment">     * Returns whether the current user has certain permissions on a calendar.
</span></span><span id="1702" class="l"><a class="l" href="#1702">1702: </a><span class="php-comment">     *
</span></span><span id="1703" class="l"><a class="l" href="#1703">1703: </a><span class="php-comment">     * @since Kronolith 3.0.6
</span></span><span id="1704" class="l"><a class="l" href="#1704">1704: </a><span class="php-comment">     *
</span></span><span id="1705" class="l"><a class="l" href="#1705">1705: </a><span class="php-comment">     * @param string $calendar  A calendar id.
</span></span><span id="1706" class="l"><a class="l" href="#1706">1706: </a><span class="php-comment">     * @param integer $perm     A Horde_Perms permission mask.
</span></span><span id="1707" class="l"><a class="l" href="#1707">1707: </a><span class="php-comment">     *
</span></span><span id="1708" class="l"><a class="l" href="#1708">1708: </a><span class="php-comment">     * @return boolean  True if the current user has the requested permissions.
</span></span><span id="1709" class="l"><a class="l" href="#1709">1709: </a><span class="php-comment">     */</span>
</span><span id="1710" class="l"><a class="l" href="#1710">1710: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_hasPermission" href="#_hasPermission">hasPermission</a>(<span class="php-var">$calendar</span>, <span class="php-var">$perm</span>)
</span><span id="1711" class="l"><a class="l" href="#1711">1711: </a>    {
</span><span id="1712" class="l"><a class="l" href="#1712">1712: </a>        <span class="php-keyword1">try</span> {
</span><span id="1713" class="l"><a class="l" href="#1713">1713: </a>            <span class="php-var">$share</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;getShare(<span class="php-var">$calendar</span>);
</span><span id="1714" class="l"><a class="l" href="#1714">1714: </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$share</span>-&gt;hasPermission(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(), <span class="php-var">$perm</span>)) {
</span><span id="1715" class="l"><a class="l" href="#1715">1715: </a>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Horde_Exception_NotFound();
</span><span id="1716" class="l"><a class="l" href="#1716">1716: </a>            }
</span><span id="1717" class="l"><a class="l" href="#1717">1717: </a>        } <span class="php-keyword1">catch</span> (Horde_Exception_NotFound <span class="php-var">$e</span>) {
</span><span id="1718" class="l"><a class="l" href="#1718">1718: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="1719" class="l"><a class="l" href="#1719">1719: </a>        }
</span><span id="1720" class="l"><a class="l" href="#1720">1720: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span id="1721" class="l"><a class="l" href="#1721">1721: </a>    }
</span><span id="1722" class="l"><a class="l" href="#1722">1722: </a>
</span><span id="1723" class="l"><a class="l" href="#1723">1723: </a>    <span class="php-comment">/**
</span></span><span id="1724" class="l"><a class="l" href="#1724">1724: </a><span class="php-comment">     * Creates a new share.
</span></span><span id="1725" class="l"><a class="l" href="#1725">1725: </a><span class="php-comment">     *
</span></span><span id="1726" class="l"><a class="l" href="#1726">1726: </a><span class="php-comment">     * @param array $info  Hash with calendar information.
</span></span><span id="1727" class="l"><a class="l" href="#1727">1727: </a><span class="php-comment">     *
</span></span><span id="1728" class="l"><a class="l" href="#1728">1728: </a><span class="php-comment">     * @return Horde_Share  The new share.
</span></span><span id="1729" class="l"><a class="l" href="#1729">1729: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="1730" class="l"><a class="l" href="#1730">1730: </a><span class="php-comment">     */</span>
</span><span id="1731" class="l"><a class="l" href="#1731">1731: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_addShare" href="#_addShare">addShare</a>(<span class="php-var">$info</span>)
</span><span id="1732" class="l"><a class="l" href="#1732">1732: </a>    {
</span><span id="1733" class="l"><a class="l" href="#1733">1733: </a>        <span class="php-keyword1">try</span> {
</span><span id="1734" class="l"><a class="l" href="#1734">1734: </a>            <span class="php-var">$calendar</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;newShare(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth(), <span class="php-keyword2">strval</span>(<span class="php-keyword1">new</span> Horde_Support_Randomid()), <span class="php-var">$info</span>[<span class="php-quote">'name'</span>]);
</span><span id="1735" class="l"><a class="l" href="#1735">1735: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1736" class="l"><a class="l" href="#1736">1736: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-var">$e</span>);
</span><span id="1737" class="l"><a class="l" href="#1737">1737: </a>        }
</span><span id="1738" class="l"><a class="l" href="#1738">1738: </a>
</span><span id="1739" class="l"><a class="l" href="#1739">1739: </a>        <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'color'</span>, <span class="php-var">$info</span>[<span class="php-quote">'color'</span>]);
</span><span id="1740" class="l"><a class="l" href="#1740">1740: </a>        <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'desc'</span>, <span class="php-var">$info</span>[<span class="php-quote">'description'</span>]);
</span><span id="1741" class="l"><a class="l" href="#1741">1741: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$info</span>[<span class="php-quote">'system'</span>])) {
</span><span id="1742" class="l"><a class="l" href="#1742">1742: </a>            <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'owner'</span>, <span class="php-keyword1">null</span>);
</span><span id="1743" class="l"><a class="l" href="#1743">1743: </a>        }
</span><span id="1744" class="l"><a class="l" href="#1744">1744: </a>        <span class="php-var">$tagger</span> = self::getTagger();
</span><span id="1745" class="l"><a class="l" href="#1745">1745: </a>        <span class="php-var">$tagger</span>-&gt;tag(<span class="php-var">$calendar</span>-&gt;getName(), <span class="php-var">$info</span>[<span class="php-quote">'tags'</span>], <span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'owner'</span>), <span class="php-quote">'calendar'</span>);
</span><span id="1746" class="l"><a class="l" href="#1746">1746: </a>
</span><span id="1747" class="l"><a class="l" href="#1747">1747: </a>        <span class="php-keyword1">try</span> {
</span><span id="1748" class="l"><a class="l" href="#1748">1748: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;addShare(<span class="php-var">$calendar</span>);
</span><span id="1749" class="l"><a class="l" href="#1749">1749: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1750" class="l"><a class="l" href="#1750">1750: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-var">$e</span>);
</span><span id="1751" class="l"><a class="l" href="#1751">1751: </a>        }
</span><span id="1752" class="l"><a class="l" href="#1752">1752: </a>
</span><span id="1753" class="l"><a class="l" href="#1753">1753: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>][] = <span class="php-var">$calendar</span>-&gt;getName();
</span><span id="1754" class="l"><a class="l" href="#1754">1754: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'display_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_calendars'</span>]));
</span><span id="1755" class="l"><a class="l" href="#1755">1755: </a>
</span><span id="1756" class="l"><a class="l" href="#1756">1756: </a>        <span class="php-keyword1">return</span> <span class="php-var">$calendar</span>;
</span><span id="1757" class="l"><a class="l" href="#1757">1757: </a>    }
</span><span id="1758" class="l"><a class="l" href="#1758">1758: </a>
</span><span id="1759" class="l"><a class="l" href="#1759">1759: </a>    <span class="php-comment">/**
</span></span><span id="1760" class="l"><a class="l" href="#1760">1760: </a><span class="php-comment">     * Updates an existing share.
</span></span><span id="1761" class="l"><a class="l" href="#1761">1761: </a><span class="php-comment">     *
</span></span><span id="1762" class="l"><a class="l" href="#1762">1762: </a><span class="php-comment">     * @param Horde_Share $share  The share to update.
</span></span><span id="1763" class="l"><a class="l" href="#1763">1763: </a><span class="php-comment">     * @param array $info         Hash with calendar information.
</span></span><span id="1764" class="l"><a class="l" href="#1764">1764: </a><span class="php-comment">     *
</span></span><span id="1765" class="l"><a class="l" href="#1765">1765: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="1766" class="l"><a class="l" href="#1766">1766: </a><span class="php-comment">     */</span>
</span><span id="1767" class="l"><a class="l" href="#1767">1767: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_updateShare" href="#_updateShare">updateShare</a>(&amp;<span class="php-var">$calendar</span>, <span class="php-var">$info</span>)
</span><span id="1768" class="l"><a class="l" href="#1768">1768: </a>    {
</span><span id="1769" class="l"><a class="l" href="#1769">1769: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() ||
</span><span id="1770" class="l"><a class="l" href="#1770">1770: </a>            (<span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'owner'</span>) != <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() &amp;&amp;
</span><span id="1771" class="l"><a class="l" href="#1771">1771: </a>             (!<span class="php-keyword2">is_null</span>(<span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'owner'</span>)) || !<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;isAdmin()))) {
</span><span id="1772" class="l"><a class="l" href="#1772">1772: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(_(<span class="php-quote">&quot;You are not allowed to change this calendar.&quot;</span>));
</span><span id="1773" class="l"><a class="l" href="#1773">1773: </a>        }
</span><span id="1774" class="l"><a class="l" href="#1774">1774: </a>
</span><span id="1775" class="l"><a class="l" href="#1775">1775: </a>        <span class="php-var">$original_name</span> = <span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'name'</span>);
</span><span id="1776" class="l"><a class="l" href="#1776">1776: </a>        <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'name'</span>, <span class="php-var">$info</span>[<span class="php-quote">'name'</span>]);
</span><span id="1777" class="l"><a class="l" href="#1777">1777: </a>        <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'color'</span>, <span class="php-var">$info</span>[<span class="php-quote">'color'</span>]);
</span><span id="1778" class="l"><a class="l" href="#1778">1778: </a>        <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'desc'</span>, <span class="php-var">$info</span>[<span class="php-quote">'description'</span>]);
</span><span id="1779" class="l"><a class="l" href="#1779">1779: </a>        <span class="php-var">$calendar</span>-&gt;set(<span class="php-quote">'owner'</span>, <span class="php-keyword1">empty</span>(<span class="php-var">$info</span>[<span class="php-quote">'system'</span>]) ? <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() : <span class="php-keyword1">null</span>);
</span><span id="1780" class="l"><a class="l" href="#1780">1780: </a>
</span><span id="1781" class="l"><a class="l" href="#1781">1781: </a>        <span class="php-keyword1">try</span> {
</span><span id="1782" class="l"><a class="l" href="#1782">1782: </a>            <span class="php-var">$result</span> = <span class="php-var">$calendar</span>-&gt;save();
</span><span id="1783" class="l"><a class="l" href="#1783">1783: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1784" class="l"><a class="l" href="#1784">1784: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Unable to save calendar \&quot;%s\&quot;: %s&quot;</span>), <span class="php-var">$info</span>[<span class="php-quote">'name'</span>], <span class="php-var">$e</span>-&gt;getMessage()));
</span><span id="1785" class="l"><a class="l" href="#1785">1785: </a>        }
</span><span id="1786" class="l"><a class="l" href="#1786">1786: </a>
</span><span id="1787" class="l"><a class="l" href="#1787">1787: </a>        <span class="php-var">$tagger</span> = self::getTagger();
</span><span id="1788" class="l"><a class="l" href="#1788">1788: </a>        <span class="php-var">$tagger</span>-&gt;replaceTags(<span class="php-var">$calendar</span>-&gt;getName(), <span class="php-var">$info</span>[<span class="php-quote">'tags'</span>], <span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'owner'</span>), <span class="php-quote">'calendar'</span>);
</span><span id="1789" class="l"><a class="l" href="#1789">1789: </a>    }
</span><span id="1790" class="l"><a class="l" href="#1790">1790: </a>
</span><span id="1791" class="l"><a class="l" href="#1791">1791: </a>    <span class="php-comment">/**
</span></span><span id="1792" class="l"><a class="l" href="#1792">1792: </a><span class="php-comment">     * Deletes a share.
</span></span><span id="1793" class="l"><a class="l" href="#1793">1793: </a><span class="php-comment">     *
</span></span><span id="1794" class="l"><a class="l" href="#1794">1794: </a><span class="php-comment">     * @param Horde_Share $calendar  The share to delete.
</span></span><span id="1795" class="l"><a class="l" href="#1795">1795: </a><span class="php-comment">     *
</span></span><span id="1796" class="l"><a class="l" href="#1796">1796: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="1797" class="l"><a class="l" href="#1797">1797: </a><span class="php-comment">     */</span>
</span><span id="1798" class="l"><a class="l" href="#1798">1798: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_deleteShare" href="#_deleteShare">deleteShare</a>(<span class="php-var">$calendar</span>)
</span><span id="1799" class="l"><a class="l" href="#1799">1799: </a>    {
</span><span id="1800" class="l"><a class="l" href="#1800">1800: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() ||
</span><span id="1801" class="l"><a class="l" href="#1801">1801: </a>            (<span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'owner'</span>) != <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() &amp;&amp;
</span><span id="1802" class="l"><a class="l" href="#1802">1802: </a>             (!<span class="php-keyword2">is_null</span>(<span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'owner'</span>)) || !<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;isAdmin()))) {
</span><span id="1803" class="l"><a class="l" href="#1803">1803: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(_(<span class="php-quote">&quot;You are not allowed to delete this calendar.&quot;</span>));
</span><span id="1804" class="l"><a class="l" href="#1804">1804: </a>        }
</span><span id="1805" class="l"><a class="l" href="#1805">1805: </a>
</span><span id="1806" class="l"><a class="l" href="#1806">1806: </a>        <span class="php-comment">// Delete the calendar.</span>
</span><span id="1807" class="l"><a class="l" href="#1807">1807: </a>        <span class="php-keyword1">try</span> {
</span><span id="1808" class="l"><a class="l" href="#1808">1808: </a>            self::getDriver()-&gt;<span class="php-keyword2">delete</span>(<span class="php-var">$calendar</span>-&gt;getName());
</span><span id="1809" class="l"><a class="l" href="#1809">1809: </a>        } <span class="php-keyword1">catch</span> (Exception <span class="php-var">$e</span>) {
</span><span id="1810" class="l"><a class="l" href="#1810">1810: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Unable to delete \&quot;%s\&quot;: %s&quot;</span>), <span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'name'</span>), <span class="php-var">$e</span>-&gt;getMessage()));
</span><span id="1811" class="l"><a class="l" href="#1811">1811: </a>        }
</span><span id="1812" class="l"><a class="l" href="#1812">1812: </a>
</span><span id="1813" class="l"><a class="l" href="#1813">1813: </a>        <span class="php-comment">// Remove share and all groups/permissions.</span>
</span><span id="1814" class="l"><a class="l" href="#1814">1814: </a>        <span class="php-keyword1">try</span> {
</span><span id="1815" class="l"><a class="l" href="#1815">1815: </a>            <span class="php-var">$result</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;removeShare(<span class="php-var">$calendar</span>);
</span><span id="1816" class="l"><a class="l" href="#1816">1816: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="1817" class="l"><a class="l" href="#1817">1817: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-var">$e</span>);
</span><span id="1818" class="l"><a class="l" href="#1818">1818: </a>        }
</span><span id="1819" class="l"><a class="l" href="#1819">1819: </a>    }
</span><span id="1820" class="l"><a class="l" href="#1820">1820: </a>
</span><span id="1821" class="l"><a class="l" href="#1821">1821: </a>    <span class="php-comment">/**
</span></span><span id="1822" class="l"><a class="l" href="#1822">1822: </a><span class="php-comment">     * Reads a submitted permissions form and updates the share permissions.
</span></span><span id="1823" class="l"><a class="l" href="#1823">1823: </a><span class="php-comment">     *
</span></span><span id="1824" class="l"><a class="l" href="#1824">1824: </a><span class="php-comment">     * @param Horde_Share_Object $share  The share to update.
</span></span><span id="1825" class="l"><a class="l" href="#1825">1825: </a><span class="php-comment">     *
</span></span><span id="1826" class="l"><a class="l" href="#1826">1826: </a><span class="php-comment">     * @return array  A list of error messages.
</span></span><span id="1827" class="l"><a class="l" href="#1827">1827: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="1828" class="l"><a class="l" href="#1828">1828: </a><span class="php-comment">     */</span>
</span><span id="1829" class="l"><a class="l" href="#1829">1829: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_readPermsForm" href="#_readPermsForm">readPermsForm</a>(<span class="php-var">$share</span>)
</span><span id="1830" class="l"><a class="l" href="#1830">1830: </a>    {
</span><span id="1831" class="l"><a class="l" href="#1831">1831: </a>        <span class="php-var">$auth</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Auth'</span>)-&gt;create();
</span><span id="1832" class="l"><a class="l" href="#1832">1832: </a>        <span class="php-var">$perm</span> = <span class="php-var">$share</span>-&gt;getPermission();
</span><span id="1833" class="l"><a class="l" href="#1833">1833: </a>        <span class="php-var">$errors</span> = <span class="php-keyword1">array</span>();
</span><span id="1834" class="l"><a class="l" href="#1834">1834: </a>
</span><span id="1835" class="l"><a class="l" href="#1835">1835: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'notify'</span>]) {
</span><span id="1836" class="l"><a class="l" href="#1836">1836: </a>            <span class="php-var">$identity</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]
</span><span id="1837" class="l"><a class="l" href="#1837">1837: </a>                -&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)
</span><span id="1838" class="l"><a class="l" href="#1838">1838: </a>                -&gt;create();
</span><span id="1839" class="l"><a class="l" href="#1839">1839: </a>            <span class="php-var">$mail</span> = <span class="php-keyword1">new</span> Horde_Mime_Mail(<span class="php-keyword1">array</span>(
</span><span id="1840" class="l"><a class="l" href="#1840">1840: </a>                <span class="php-quote">'From'</span> =&gt; <span class="php-var">$identity</span>-&gt;getDefaultFromAddress(<span class="php-keyword1">true</span>),
</span><span id="1841" class="l"><a class="l" href="#1841">1841: </a>                <span class="php-quote">'User-Agent'</span> =&gt; <span class="php-quote">'Kronolith '</span> . <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getVersion()));
</span><span id="1842" class="l"><a class="l" href="#1842">1842: </a>            <span class="php-var">$image</span> = self::getImagePart(<span class="php-quote">'big_share.png'</span>);
</span><span id="1843" class="l"><a class="l" href="#1843">1843: </a>            <span class="php-var">$view</span> = <span class="php-keyword1">new</span> Horde_View(<span class="php-keyword1">array</span>(<span class="php-quote">'templatePath'</span> =&gt; KRONOLITH_TEMPLATES . <span class="php-quote">'/share'</span>));
</span><span id="1844" class="l"><a class="l" href="#1844">1844: </a>            <span class="php-keyword1">new</span> Horde_View_Helper_Text(<span class="php-var">$view</span>);
</span><span id="1845" class="l"><a class="l" href="#1845">1845: </a>            <span class="php-var">$view</span>-&gt;identity = <span class="php-var">$identity</span>;
</span><span id="1846" class="l"><a class="l" href="#1846">1846: </a>            <span class="php-var">$view</span>-&gt;calendar = <span class="php-var">$share</span>-&gt;get(<span class="php-quote">'name'</span>);
</span><span id="1847" class="l"><a class="l" href="#1847">1847: </a>            <span class="php-var">$view</span>-&gt;imageId = <span class="php-var">$image</span>-&gt;getContentId();
</span><span id="1848" class="l"><a class="l" href="#1848">1848: </a>        }
</span><span id="1849" class="l"><a class="l" href="#1849">1849: </a>
</span><span id="1850" class="l"><a class="l" href="#1850">1850: </a>        <span class="php-comment">// Process owner and owner permissions.</span>
</span><span id="1851" class="l"><a class="l" href="#1851">1851: </a>        <span class="php-var">$old_owner</span> = <span class="php-var">$share</span>-&gt;get(<span class="php-quote">'owner'</span>);
</span><span id="1852" class="l"><a class="l" href="#1852">1852: </a>        <span class="php-var">$new_owner_backend</span> = Horde_Util::getFormData(<span class="php-quote">'owner_select'</span>, Horde_Util::getFormData(<span class="php-quote">'owner_input'</span>, <span class="php-var">$old_owner</span>));
</span><span id="1853" class="l"><a class="l" href="#1853">1853: </a>        <span class="php-var">$new_owner</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;convertUsername(<span class="php-var">$new_owner_backend</span>, <span class="php-keyword1">true</span>);
</span><span id="1854" class="l"><a class="l" href="#1854">1854: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$old_owner</span> !== <span class="php-var">$new_owner</span> &amp;&amp; !<span class="php-keyword1">empty</span>(<span class="php-var">$new_owner</span>)) {
</span><span id="1855" class="l"><a class="l" href="#1855">1855: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$old_owner</span> != <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth() &amp;&amp; !<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;isAdmin()) {
</span><span id="1856" class="l"><a class="l" href="#1856">1856: </a>                <span class="php-var">$errors</span>[] = _(<span class="php-quote">&quot;Only the owner or system administrator may change ownership or owner permissions for a share&quot;</span>);
</span><span id="1857" class="l"><a class="l" href="#1857">1857: </a>            } <span class="php-keyword1">elseif</span> (<span class="php-var">$auth</span>-&gt;hasCapability(<span class="php-quote">'list'</span>) &amp;&amp; !<span class="php-var">$auth</span>-&gt;exists(<span class="php-var">$new_owner_backend</span>)) {
</span><span id="1858" class="l"><a class="l" href="#1858">1858: </a>                <span class="php-var">$errors</span>[] = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;The user \&quot;%s\&quot; does not exist.&quot;</span>), <span class="php-var">$new_owner_backend</span>);
</span><span id="1859" class="l"><a class="l" href="#1859">1859: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1860" class="l"><a class="l" href="#1860">1860: </a>                <span class="php-var">$share</span>-&gt;set(<span class="php-quote">'owner'</span>, <span class="php-var">$new_owner</span>);
</span><span id="1861" class="l"><a class="l" href="#1861">1861: </a>                <span class="php-var">$share</span>-&gt;save();
</span><span id="1862" class="l"><a class="l" href="#1862">1862: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'notify'</span>]) {
</span><span id="1863" class="l"><a class="l" href="#1863">1863: </a>                    <span class="php-var">$view</span>-&gt;ownerChange = <span class="php-keyword1">true</span>;
</span><span id="1864" class="l"><a class="l" href="#1864">1864: </a>                    <span class="php-var">$multipart</span> = self::buildMimeMessage(<span class="php-var">$view</span>, <span class="php-quote">'notification'</span>, <span class="php-var">$image</span>);
</span><span id="1865" class="l"><a class="l" href="#1865">1865: </a>                    <span class="php-var">$to</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]
</span><span id="1866" class="l"><a class="l" href="#1866">1866: </a>                        -&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)
</span><span id="1867" class="l"><a class="l" href="#1867">1867: </a>                        -&gt;create(<span class="php-var">$new_owner</span>)
</span><span id="1868" class="l"><a class="l" href="#1868">1868: </a>                        -&gt;getDefaultFromAddress(<span class="php-keyword1">true</span>);
</span><span id="1869" class="l"><a class="l" href="#1869">1869: </a>                    <span class="php-var">$mail</span>-&gt;addHeader(<span class="php-quote">'Subject'</span>, _(<span class="php-quote">&quot;Ownership assignment&quot;</span>));
</span><span id="1870" class="l"><a class="l" href="#1870">1870: </a>                    <span class="php-var">$mail</span>-&gt;addHeader(<span class="php-quote">'To'</span>, <span class="php-var">$to</span>);
</span><span id="1871" class="l"><a class="l" href="#1871">1871: </a>                    <span class="php-var">$mail</span>-&gt;setBasePart(<span class="php-var">$multipart</span>);
</span><span id="1872" class="l"><a class="l" href="#1872">1872: </a>                    <span class="php-var">$mail</span>-&gt;send(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Mail'</span>));
</span><span id="1873" class="l"><a class="l" href="#1873">1873: </a>                    <span class="php-var">$view</span>-&gt;ownerChange = <span class="php-keyword1">false</span>;
</span><span id="1874" class="l"><a class="l" href="#1874">1874: </a>                }
</span><span id="1875" class="l"><a class="l" href="#1875">1875: </a>            }
</span><span id="1876" class="l"><a class="l" href="#1876">1876: </a>        }
</span><span id="1877" class="l"><a class="l" href="#1877">1877: </a>
</span><span id="1878" class="l"><a class="l" href="#1878">1878: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'notify'</span>]) {
</span><span id="1879" class="l"><a class="l" href="#1879">1879: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'hidden'</span>]) {
</span><span id="1880" class="l"><a class="l" href="#1880">1880: </a>                <span class="php-var">$view</span>-&gt;subscribe = Horde::url(<span class="php-quote">'calendars/subscribe.php'</span>, <span class="php-keyword1">true</span>)-&gt;add(<span class="php-quote">'calendar'</span>, <span class="php-var">$share</span>-&gt;getName());
</span><span id="1881" class="l"><a class="l" href="#1881">1881: </a>            }
</span><span id="1882" class="l"><a class="l" href="#1882">1882: </a>            <span class="php-var">$multipart</span> = self::buildMimeMessage(<span class="php-var">$view</span>, <span class="php-quote">'notification'</span>, <span class="php-var">$image</span>);
</span><span id="1883" class="l"><a class="l" href="#1883">1883: </a>        }
</span><span id="1884" class="l"><a class="l" href="#1884">1884: </a>
</span><span id="1885" class="l"><a class="l" href="#1885">1885: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;isAdmin() ||
</span><span id="1886" class="l"><a class="l" href="#1886">1886: </a>            !<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'world'</span>])) {
</span><span id="1887" class="l"><a class="l" href="#1887">1887: </a>            <span class="php-comment">// Process default permissions.</span>
</span><span id="1888" class="l"><a class="l" href="#1888">1888: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'default_show'</span>)) {
</span><span id="1889" class="l"><a class="l" href="#1889">1889: </a>                <span class="php-var">$perm</span>-&gt;addDefaultPermission(Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1890" class="l"><a class="l" href="#1890">1890: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1891" class="l"><a class="l" href="#1891">1891: </a>                <span class="php-var">$perm</span>-&gt;removeDefaultPermission(Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1892" class="l"><a class="l" href="#1892">1892: </a>            }
</span><span id="1893" class="l"><a class="l" href="#1893">1893: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'default_read'</span>)) {
</span><span id="1894" class="l"><a class="l" href="#1894">1894: </a>                <span class="php-var">$perm</span>-&gt;addDefaultPermission(Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="1895" class="l"><a class="l" href="#1895">1895: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1896" class="l"><a class="l" href="#1896">1896: </a>                <span class="php-var">$perm</span>-&gt;removeDefaultPermission(Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="1897" class="l"><a class="l" href="#1897">1897: </a>            }
</span><span id="1898" class="l"><a class="l" href="#1898">1898: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'default_edit'</span>)) {
</span><span id="1899" class="l"><a class="l" href="#1899">1899: </a>                <span class="php-var">$perm</span>-&gt;addDefaultPermission(Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="1900" class="l"><a class="l" href="#1900">1900: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1901" class="l"><a class="l" href="#1901">1901: </a>                <span class="php-var">$perm</span>-&gt;removeDefaultPermission(Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="1902" class="l"><a class="l" href="#1902">1902: </a>            }
</span><span id="1903" class="l"><a class="l" href="#1903">1903: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'default_delete'</span>)) {
</span><span id="1904" class="l"><a class="l" href="#1904">1904: </a>                <span class="php-var">$perm</span>-&gt;addDefaultPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="1905" class="l"><a class="l" href="#1905">1905: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1906" class="l"><a class="l" href="#1906">1906: </a>                <span class="php-var">$perm</span>-&gt;removeDefaultPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="1907" class="l"><a class="l" href="#1907">1907: </a>            }
</span><span id="1908" class="l"><a class="l" href="#1908">1908: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'default_delegate'</span>)) {
</span><span id="1909" class="l"><a class="l" href="#1909">1909: </a>                <span class="php-var">$perm</span>-&gt;addDefaultPermission(self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="1910" class="l"><a class="l" href="#1910">1910: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1911" class="l"><a class="l" href="#1911">1911: </a>                <span class="php-var">$perm</span>-&gt;removeDefaultPermission(self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="1912" class="l"><a class="l" href="#1912">1912: </a>            }
</span><span id="1913" class="l"><a class="l" href="#1913">1913: </a>
</span><span id="1914" class="l"><a class="l" href="#1914">1914: </a>            <span class="php-comment">// Process guest permissions.</span>
</span><span id="1915" class="l"><a class="l" href="#1915">1915: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'guest_show'</span>)) {
</span><span id="1916" class="l"><a class="l" href="#1916">1916: </a>                <span class="php-var">$perm</span>-&gt;addGuestPermission(Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1917" class="l"><a class="l" href="#1917">1917: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1918" class="l"><a class="l" href="#1918">1918: </a>                <span class="php-var">$perm</span>-&gt;removeGuestPermission(Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1919" class="l"><a class="l" href="#1919">1919: </a>            }
</span><span id="1920" class="l"><a class="l" href="#1920">1920: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'guest_read'</span>)) {
</span><span id="1921" class="l"><a class="l" href="#1921">1921: </a>                <span class="php-var">$perm</span>-&gt;addGuestPermission(Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="1922" class="l"><a class="l" href="#1922">1922: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1923" class="l"><a class="l" href="#1923">1923: </a>                <span class="php-var">$perm</span>-&gt;removeGuestPermission(Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="1924" class="l"><a class="l" href="#1924">1924: </a>            }
</span><span id="1925" class="l"><a class="l" href="#1925">1925: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'guest_edit'</span>)) {
</span><span id="1926" class="l"><a class="l" href="#1926">1926: </a>                <span class="php-var">$perm</span>-&gt;addGuestPermission(Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="1927" class="l"><a class="l" href="#1927">1927: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1928" class="l"><a class="l" href="#1928">1928: </a>                <span class="php-var">$perm</span>-&gt;removeGuestPermission(Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="1929" class="l"><a class="l" href="#1929">1929: </a>            }
</span><span id="1930" class="l"><a class="l" href="#1930">1930: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'guest_delete'</span>)) {
</span><span id="1931" class="l"><a class="l" href="#1931">1931: </a>                <span class="php-var">$perm</span>-&gt;addGuestPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="1932" class="l"><a class="l" href="#1932">1932: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1933" class="l"><a class="l" href="#1933">1933: </a>                <span class="php-var">$perm</span>-&gt;removeGuestPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="1934" class="l"><a class="l" href="#1934">1934: </a>            }
</span><span id="1935" class="l"><a class="l" href="#1935">1935: </a>            <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'guest_delegate'</span>)) {
</span><span id="1936" class="l"><a class="l" href="#1936">1936: </a>                <span class="php-var">$perm</span>-&gt;addGuestPermission(self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="1937" class="l"><a class="l" href="#1937">1937: </a>            } <span class="php-keyword1">else</span> {
</span><span id="1938" class="l"><a class="l" href="#1938">1938: </a>                <span class="php-var">$perm</span>-&gt;removeGuestPermission(self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="1939" class="l"><a class="l" href="#1939">1939: </a>            }
</span><span id="1940" class="l"><a class="l" href="#1940">1940: </a>        }
</span><span id="1941" class="l"><a class="l" href="#1941">1941: </a>
</span><span id="1942" class="l"><a class="l" href="#1942">1942: </a>        <span class="php-comment">// Process creator permissions.</span>
</span><span id="1943" class="l"><a class="l" href="#1943">1943: </a>        <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'creator_show'</span>)) {
</span><span id="1944" class="l"><a class="l" href="#1944">1944: </a>            <span class="php-var">$perm</span>-&gt;addCreatorPermission(Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1945" class="l"><a class="l" href="#1945">1945: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1946" class="l"><a class="l" href="#1946">1946: </a>            <span class="php-var">$perm</span>-&gt;removeCreatorPermission(Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1947" class="l"><a class="l" href="#1947">1947: </a>        }
</span><span id="1948" class="l"><a class="l" href="#1948">1948: </a>        <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'creator_read'</span>)) {
</span><span id="1949" class="l"><a class="l" href="#1949">1949: </a>            <span class="php-var">$perm</span>-&gt;addCreatorPermission(Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="1950" class="l"><a class="l" href="#1950">1950: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1951" class="l"><a class="l" href="#1951">1951: </a>            <span class="php-var">$perm</span>-&gt;removeCreatorPermission(Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="1952" class="l"><a class="l" href="#1952">1952: </a>        }
</span><span id="1953" class="l"><a class="l" href="#1953">1953: </a>        <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'creator_edit'</span>)) {
</span><span id="1954" class="l"><a class="l" href="#1954">1954: </a>            <span class="php-var">$perm</span>-&gt;addCreatorPermission(Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="1955" class="l"><a class="l" href="#1955">1955: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1956" class="l"><a class="l" href="#1956">1956: </a>            <span class="php-var">$perm</span>-&gt;removeCreatorPermission(Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="1957" class="l"><a class="l" href="#1957">1957: </a>        }
</span><span id="1958" class="l"><a class="l" href="#1958">1958: </a>        <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'creator_delete'</span>)) {
</span><span id="1959" class="l"><a class="l" href="#1959">1959: </a>            <span class="php-var">$perm</span>-&gt;addCreatorPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="1960" class="l"><a class="l" href="#1960">1960: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1961" class="l"><a class="l" href="#1961">1961: </a>            <span class="php-var">$perm</span>-&gt;removeCreatorPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="1962" class="l"><a class="l" href="#1962">1962: </a>        }
</span><span id="1963" class="l"><a class="l" href="#1963">1963: </a>        <span class="php-keyword1">if</span> (Horde_Util::getFormData(<span class="php-quote">'creator_delegate'</span>)) {
</span><span id="1964" class="l"><a class="l" href="#1964">1964: </a>            <span class="php-var">$perm</span>-&gt;addCreatorPermission(self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="1965" class="l"><a class="l" href="#1965">1965: </a>        } <span class="php-keyword1">else</span> {
</span><span id="1966" class="l"><a class="l" href="#1966">1966: </a>            <span class="php-var">$perm</span>-&gt;removeCreatorPermission(self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="1967" class="l"><a class="l" href="#1967">1967: </a>        }
</span><span id="1968" class="l"><a class="l" href="#1968">1968: </a>
</span><span id="1969" class="l"><a class="l" href="#1969">1969: </a>        <span class="php-comment">// Process user permissions.</span>
</span><span id="1970" class="l"><a class="l" href="#1970">1970: </a>        <span class="php-var">$u_names</span> = Horde_Util::getFormData(<span class="php-quote">'u_names'</span>);
</span><span id="1971" class="l"><a class="l" href="#1971">1971: </a>        <span class="php-var">$u_show</span> = Horde_Util::getFormData(<span class="php-quote">'u_show'</span>);
</span><span id="1972" class="l"><a class="l" href="#1972">1972: </a>        <span class="php-var">$u_read</span> = Horde_Util::getFormData(<span class="php-quote">'u_read'</span>);
</span><span id="1973" class="l"><a class="l" href="#1973">1973: </a>        <span class="php-var">$u_edit</span> = Horde_Util::getFormData(<span class="php-quote">'u_edit'</span>);
</span><span id="1974" class="l"><a class="l" href="#1974">1974: </a>        <span class="php-var">$u_delete</span> = Horde_Util::getFormData(<span class="php-quote">'u_delete'</span>);
</span><span id="1975" class="l"><a class="l" href="#1975">1975: </a>        <span class="php-var">$u_delegate</span> = Horde_Util::getFormData(<span class="php-quote">'u_delegate'</span>);
</span><span id="1976" class="l"><a class="l" href="#1976">1976: </a>
</span><span id="1977" class="l"><a class="l" href="#1977">1977: </a>        <span class="php-var">$current</span> = <span class="php-var">$perm</span>-&gt;getUserPermissions();
</span><span id="1978" class="l"><a class="l" href="#1978">1978: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'notify'</span>]) {
</span><span id="1979" class="l"><a class="l" href="#1979">1979: </a>            <span class="php-var">$mail</span>-&gt;addHeader(<span class="php-quote">'Subject'</span>, _(<span class="php-quote">&quot;Access permissions&quot;</span>));
</span><span id="1980" class="l"><a class="l" href="#1980">1980: </a>        }
</span><span id="1981" class="l"><a class="l" href="#1981">1981: </a>
</span><span id="1982" class="l"><a class="l" href="#1982">1982: </a>        <span class="php-var">$perm</span>-&gt;removeUserPermission(<span class="php-keyword1">null</span>, <span class="php-keyword1">null</span>, <span class="php-keyword1">false</span>);
</span><span id="1983" class="l"><a class="l" href="#1983">1983: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$u_names</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$user_backend</span>) {
</span><span id="1984" class="l"><a class="l" href="#1984">1984: </a>            <span class="php-comment">// Apply backend hooks</span>
</span><span id="1985" class="l"><a class="l" href="#1985">1985: </a>            <span class="php-var">$user</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;convertUsername(<span class="php-var">$user_backend</span>, <span class="php-keyword1">true</span>);
</span><span id="1986" class="l"><a class="l" href="#1986">1986: </a>            <span class="php-comment">// If the user is empty, or we've already set permissions</span>
</span><span id="1987" class="l"><a class="l" href="#1987">1987: </a>            <span class="php-comment">// via the owner_ options, don't do anything here.</span>
</span><span id="1988" class="l"><a class="l" href="#1988">1988: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$user</span>) || <span class="php-var">$user</span> == <span class="php-var">$new_owner</span>) {
</span><span id="1989" class="l"><a class="l" href="#1989">1989: </a>                <span class="php-keyword1">continue</span>;
</span><span id="1990" class="l"><a class="l" href="#1990">1990: </a>            }
</span><span id="1991" class="l"><a class="l" href="#1991">1991: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$auth</span>-&gt;hasCapability(<span class="php-quote">'list'</span>) &amp;&amp; !<span class="php-var">$auth</span>-&gt;exists(<span class="php-var">$user_backend</span>)) {
</span><span id="1992" class="l"><a class="l" href="#1992">1992: </a>                <span class="php-var">$errors</span>[] = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;The user \&quot;%s\&quot; does not exist.&quot;</span>), <span class="php-var">$user_backend</span>);
</span><span id="1993" class="l"><a class="l" href="#1993">1993: </a>                <span class="php-keyword1">continue</span>;
</span><span id="1994" class="l"><a class="l" href="#1994">1994: </a>            }
</span><span id="1995" class="l"><a class="l" href="#1995">1995: </a>
</span><span id="1996" class="l"><a class="l" href="#1996">1996: </a>            <span class="php-var">$has_perms</span> = <span class="php-keyword1">false</span>;
</span><span id="1997" class="l"><a class="l" href="#1997">1997: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$u_show</span>[<span class="php-var">$key</span>])) {
</span><span id="1998" class="l"><a class="l" href="#1998">1998: </a>                <span class="php-var">$perm</span>-&gt;addUserPermission(<span class="php-var">$user</span>, Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="1999" class="l"><a class="l" href="#1999">1999: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2000" class="l"><a class="l" href="#2000">2000: </a>            }
</span><span id="2001" class="l"><a class="l" href="#2001">2001: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$u_read</span>[<span class="php-var">$key</span>])) {
</span><span id="2002" class="l"><a class="l" href="#2002">2002: </a>                <span class="php-var">$perm</span>-&gt;addUserPermission(<span class="php-var">$user</span>, Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="2003" class="l"><a class="l" href="#2003">2003: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2004" class="l"><a class="l" href="#2004">2004: </a>            }
</span><span id="2005" class="l"><a class="l" href="#2005">2005: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$u_edit</span>[<span class="php-var">$key</span>])) {
</span><span id="2006" class="l"><a class="l" href="#2006">2006: </a>                <span class="php-var">$perm</span>-&gt;addUserPermission(<span class="php-var">$user</span>, Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="2007" class="l"><a class="l" href="#2007">2007: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2008" class="l"><a class="l" href="#2008">2008: </a>            }
</span><span id="2009" class="l"><a class="l" href="#2009">2009: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$u_delete</span>[<span class="php-var">$key</span>])) {
</span><span id="2010" class="l"><a class="l" href="#2010">2010: </a>                <span class="php-var">$perm</span>-&gt;addUserPermission(<span class="php-var">$user</span>, Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="2011" class="l"><a class="l" href="#2011">2011: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2012" class="l"><a class="l" href="#2012">2012: </a>            }
</span><span id="2013" class="l"><a class="l" href="#2013">2013: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$u_delegate</span>[<span class="php-var">$key</span>])) {
</span><span id="2014" class="l"><a class="l" href="#2014">2014: </a>                <span class="php-var">$perm</span>-&gt;addUserPermission(<span class="php-var">$user</span>, self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="2015" class="l"><a class="l" href="#2015">2015: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2016" class="l"><a class="l" href="#2016">2016: </a>            }
</span><span id="2017" class="l"><a class="l" href="#2017">2017: </a>
</span><span id="2018" class="l"><a class="l" href="#2018">2018: </a>            <span class="php-comment">// Notify users that have been added.</span>
</span><span id="2019" class="l"><a class="l" href="#2019">2019: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'notify'</span>] &amp;&amp;
</span><span id="2020" class="l"><a class="l" href="#2020">2020: </a>                !<span class="php-keyword1">isset</span>(<span class="php-var">$current</span>[<span class="php-var">$user</span>]) &amp;&amp; <span class="php-var">$has_perms</span>) {
</span><span id="2021" class="l"><a class="l" href="#2021">2021: </a>                <span class="php-var">$to</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]
</span><span id="2022" class="l"><a class="l" href="#2022">2022: </a>                    -&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)
</span><span id="2023" class="l"><a class="l" href="#2023">2023: </a>                    -&gt;create(<span class="php-var">$user</span>)
</span><span id="2024" class="l"><a class="l" href="#2024">2024: </a>                    -&gt;getDefaultFromAddress(<span class="php-keyword1">true</span>);
</span><span id="2025" class="l"><a class="l" href="#2025">2025: </a>                <span class="php-var">$mail</span>-&gt;addHeader(<span class="php-quote">'To'</span>, <span class="php-var">$to</span>);
</span><span id="2026" class="l"><a class="l" href="#2026">2026: </a>                <span class="php-var">$mail</span>-&gt;setBasePart(<span class="php-var">$multipart</span>);
</span><span id="2027" class="l"><a class="l" href="#2027">2027: </a>                <span class="php-var">$mail</span>-&gt;send(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Mail'</span>));
</span><span id="2028" class="l"><a class="l" href="#2028">2028: </a>            }
</span><span id="2029" class="l"><a class="l" href="#2029">2029: </a>        }
</span><span id="2030" class="l"><a class="l" href="#2030">2030: </a>
</span><span id="2031" class="l"><a class="l" href="#2031">2031: </a>        <span class="php-comment">// Process group permissions.</span>
</span><span id="2032" class="l"><a class="l" href="#2032">2032: </a>        <span class="php-var">$g_names</span> = Horde_Util::getFormData(<span class="php-quote">'g_names'</span>);
</span><span id="2033" class="l"><a class="l" href="#2033">2033: </a>        <span class="php-var">$g_show</span> = Horde_Util::getFormData(<span class="php-quote">'g_show'</span>);
</span><span id="2034" class="l"><a class="l" href="#2034">2034: </a>        <span class="php-var">$g_read</span> = Horde_Util::getFormData(<span class="php-quote">'g_read'</span>);
</span><span id="2035" class="l"><a class="l" href="#2035">2035: </a>        <span class="php-var">$g_edit</span> = Horde_Util::getFormData(<span class="php-quote">'g_edit'</span>);
</span><span id="2036" class="l"><a class="l" href="#2036">2036: </a>        <span class="php-var">$g_delete</span> = Horde_Util::getFormData(<span class="php-quote">'g_delete'</span>);
</span><span id="2037" class="l"><a class="l" href="#2037">2037: </a>        <span class="php-var">$g_delegate</span> = Horde_Util::getFormData(<span class="php-quote">'g_delegate'</span>);
</span><span id="2038" class="l"><a class="l" href="#2038">2038: </a>
</span><span id="2039" class="l"><a class="l" href="#2039">2039: </a>        <span class="php-var">$current</span> = <span class="php-var">$perm</span>-&gt;getGroupPermissions();
</span><span id="2040" class="l"><a class="l" href="#2040">2040: </a>        <span class="php-var">$perm</span>-&gt;removeGroupPermission(<span class="php-keyword1">null</span>, <span class="php-keyword1">null</span>, <span class="php-keyword1">false</span>);
</span><span id="2041" class="l"><a class="l" href="#2041">2041: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$g_names</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$group</span>) {
</span><span id="2042" class="l"><a class="l" href="#2042">2042: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$group</span>)) {
</span><span id="2043" class="l"><a class="l" href="#2043">2043: </a>                <span class="php-keyword1">continue</span>;
</span><span id="2044" class="l"><a class="l" href="#2044">2044: </a>            }
</span><span id="2045" class="l"><a class="l" href="#2045">2045: </a>
</span><span id="2046" class="l"><a class="l" href="#2046">2046: </a>            <span class="php-var">$has_perms</span> = <span class="php-keyword1">false</span>;
</span><span id="2047" class="l"><a class="l" href="#2047">2047: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$g_show</span>[<span class="php-var">$key</span>])) {
</span><span id="2048" class="l"><a class="l" href="#2048">2048: </a>                <span class="php-var">$perm</span>-&gt;addGroupPermission(<span class="php-var">$group</span>, Horde_Perms::SHOW, <span class="php-keyword1">false</span>);
</span><span id="2049" class="l"><a class="l" href="#2049">2049: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2050" class="l"><a class="l" href="#2050">2050: </a>            }
</span><span id="2051" class="l"><a class="l" href="#2051">2051: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$g_read</span>[<span class="php-var">$key</span>])) {
</span><span id="2052" class="l"><a class="l" href="#2052">2052: </a>                <span class="php-var">$perm</span>-&gt;addGroupPermission(<span class="php-var">$group</span>, Horde_Perms::READ, <span class="php-keyword1">false</span>);
</span><span id="2053" class="l"><a class="l" href="#2053">2053: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2054" class="l"><a class="l" href="#2054">2054: </a>            }
</span><span id="2055" class="l"><a class="l" href="#2055">2055: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$g_edit</span>[<span class="php-var">$key</span>])) {
</span><span id="2056" class="l"><a class="l" href="#2056">2056: </a>                <span class="php-var">$perm</span>-&gt;addGroupPermission(<span class="php-var">$group</span>, Horde_Perms::EDIT, <span class="php-keyword1">false</span>);
</span><span id="2057" class="l"><a class="l" href="#2057">2057: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2058" class="l"><a class="l" href="#2058">2058: </a>            }
</span><span id="2059" class="l"><a class="l" href="#2059">2059: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$g_delete</span>[<span class="php-var">$key</span>])) {
</span><span id="2060" class="l"><a class="l" href="#2060">2060: </a>                <span class="php-var">$perm</span>-&gt;addGroupPermission(<span class="php-var">$group</span>, Horde_Perms::<span class="php-keyword2">DELETE</span>, <span class="php-keyword1">false</span>);
</span><span id="2061" class="l"><a class="l" href="#2061">2061: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2062" class="l"><a class="l" href="#2062">2062: </a>            }
</span><span id="2063" class="l"><a class="l" href="#2063">2063: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$g_delegate</span>[<span class="php-var">$key</span>])) {
</span><span id="2064" class="l"><a class="l" href="#2064">2064: </a>                <span class="php-var">$perm</span>-&gt;addGroupPermission(<span class="php-var">$group</span>, self::PERMS_DELEGATE, <span class="php-keyword1">false</span>);
</span><span id="2065" class="l"><a class="l" href="#2065">2065: </a>                <span class="php-var">$has_perms</span> = <span class="php-keyword1">true</span>;
</span><span id="2066" class="l"><a class="l" href="#2066">2066: </a>            }
</span><span id="2067" class="l"><a class="l" href="#2067">2067: </a>
</span><span id="2068" class="l"><a class="l" href="#2068">2068: </a>            <span class="php-comment">// Notify users that have been added.</span>
</span><span id="2069" class="l"><a class="l" href="#2069">2069: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'share'</span>][<span class="php-quote">'notify'</span>] &amp;&amp;
</span><span id="2070" class="l"><a class="l" href="#2070">2070: </a>                !<span class="php-keyword1">isset</span>(<span class="php-var">$current</span>[<span class="php-var">$group</span>]) &amp;&amp; <span class="php-var">$has_perms</span>) {
</span><span id="2071" class="l"><a class="l" href="#2071">2071: </a>                <span class="php-var">$groupOb</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]
</span><span id="2072" class="l"><a class="l" href="#2072">2072: </a>                    -&gt;getInstance(<span class="php-quote">'Horde_Group'</span>)
</span><span id="2073" class="l"><a class="l" href="#2073">2073: </a>                    -&gt;getData(<span class="php-var">$group</span>);
</span><span id="2074" class="l"><a class="l" href="#2074">2074: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$groupOb</span>[<span class="php-quote">'email'</span>])) {
</span><span id="2075" class="l"><a class="l" href="#2075">2075: </a>                    <span class="php-var">$mail</span>-&gt;addHeader(<span class="php-quote">'To'</span>, <span class="php-var">$groupOb</span>[<span class="php-quote">'name'</span>] . <span class="php-quote">' &lt;'</span> . <span class="php-var">$groupOb</span>[<span class="php-quote">'email'</span>] . <span class="php-quote">'&gt;'</span>);
</span><span id="2076" class="l"><a class="l" href="#2076">2076: </a>                    <span class="php-var">$mail</span>-&gt;setBasePart(<span class="php-var">$multipart</span>);
</span><span id="2077" class="l"><a class="l" href="#2077">2077: </a>                    <span class="php-var">$mail</span>-&gt;send(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Mail'</span>));
</span><span id="2078" class="l"><a class="l" href="#2078">2078: </a>                }
</span><span id="2079" class="l"><a class="l" href="#2079">2079: </a>            }
</span><span id="2080" class="l"><a class="l" href="#2080">2080: </a>        }
</span><span id="2081" class="l"><a class="l" href="#2081">2081: </a>        <span class="php-keyword1">try</span> {
</span><span id="2082" class="l"><a class="l" href="#2082">2082: </a>            <span class="php-var">$share</span>-&gt;setPermission(<span class="php-var">$perm</span>);
</span><span id="2083" class="l"><a class="l" href="#2083">2083: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="2084" class="l"><a class="l" href="#2084">2084: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-var">$e</span>);
</span><span id="2085" class="l"><a class="l" href="#2085">2085: </a>        }
</span><span id="2086" class="l"><a class="l" href="#2086">2086: </a>
</span><span id="2087" class="l"><a class="l" href="#2087">2087: </a>        <span class="php-keyword1">return</span> <span class="php-var">$errors</span>;
</span><span id="2088" class="l"><a class="l" href="#2088">2088: </a>    }
</span><span id="2089" class="l"><a class="l" href="#2089">2089: </a>
</span><span id="2090" class="l"><a class="l" href="#2090">2090: </a>    <span class="php-comment">/**
</span></span><span id="2091" class="l"><a class="l" href="#2091">2091: </a><span class="php-comment">     * Subscribes to or updates a remote calendar.
</span></span><span id="2092" class="l"><a class="l" href="#2092">2092: </a><span class="php-comment">     *
</span></span><span id="2093" class="l"><a class="l" href="#2093">2093: </a><span class="php-comment">     * @param array $info     Hash with calendar information.
</span></span><span id="2094" class="l"><a class="l" href="#2094">2094: </a><span class="php-comment">     * @param string $update  If present, the original URL of the calendar to
</span></span><span id="2095" class="l"><a class="l" href="#2095">2095: </a><span class="php-comment">     *                        update.
</span></span><span id="2096" class="l"><a class="l" href="#2096">2096: </a><span class="php-comment">     *
</span></span><span id="2097" class="l"><a class="l" href="#2097">2097: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="2098" class="l"><a class="l" href="#2098">2098: </a><span class="php-comment">     */</span>
</span><span id="2099" class="l"><a class="l" href="#2099">2099: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_subscribeRemoteCalendar" href="#_subscribeRemoteCalendar">subscribeRemoteCalendar</a>(&amp;<span class="php-var">$info</span>, <span class="php-var">$update</span> = <span class="php-keyword1">false</span>)
</span><span id="2100" class="l"><a class="l" href="#2100">2100: </a>    {
</span><span id="2101" class="l"><a class="l" href="#2101">2101: </a>        <span class="php-keyword1">if</span> (!(<span class="php-keyword2">strlen</span>(<span class="php-var">$info</span>[<span class="php-quote">'name'</span>]) &amp;&amp; <span class="php-keyword2">strlen</span>(<span class="php-var">$info</span>[<span class="php-quote">'url'</span>]))) {
</span><span id="2102" class="l"><a class="l" href="#2102">2102: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(_(<span class="php-quote">&quot;You must specify a name and a URL.&quot;</span>));
</span><span id="2103" class="l"><a class="l" href="#2103">2103: </a>        }
</span><span id="2104" class="l"><a class="l" href="#2104">2104: </a>
</span><span id="2105" class="l"><a class="l" href="#2105">2105: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$info</span>[<span class="php-quote">'user'</span>]) || !<span class="php-keyword1">empty</span>(<span class="php-var">$info</span>[<span class="php-quote">'password'</span>])) {
</span><span id="2106" class="l"><a class="l" href="#2106">2106: </a>            <span class="php-var">$key</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuthCredential(<span class="php-quote">'password'</span>);
</span><span id="2107" class="l"><a class="l" href="#2107">2107: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$key</span>) {
</span><span id="2108" class="l"><a class="l" href="#2108">2108: </a>                <span class="php-var">$secret</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Secret'</span>);
</span><span id="2109" class="l"><a class="l" href="#2109">2109: </a>                <span class="php-var">$info</span>[<span class="php-quote">'user'</span>] = <span class="php-keyword2">base64_encode</span>(<span class="php-var">$secret</span>-&gt;write(<span class="php-var">$key</span>, <span class="php-var">$info</span>[<span class="php-quote">'user'</span>]));
</span><span id="2110" class="l"><a class="l" href="#2110">2110: </a>                <span class="php-var">$info</span>[<span class="php-quote">'password'</span>] = <span class="php-keyword2">base64_encode</span>(<span class="php-var">$secret</span>-&gt;write(<span class="php-var">$key</span>, <span class="php-var">$info</span>[<span class="php-quote">'password'</span>]));
</span><span id="2111" class="l"><a class="l" href="#2111">2111: </a>            }
</span><span id="2112" class="l"><a class="l" href="#2112">2112: </a>        }
</span><span id="2113" class="l"><a class="l" href="#2113">2113: </a>
</span><span id="2114" class="l"><a class="l" href="#2114">2114: </a>        <span class="php-var">$remote_calendars</span> = <span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'remote_cals'</span>));
</span><span id="2115" class="l"><a class="l" href="#2115">2115: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$update</span>) {
</span><span id="2116" class="l"><a class="l" href="#2116">2116: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$remote_calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="2117" class="l"><a class="l" href="#2117">2117: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>[<span class="php-quote">'url'</span>] == <span class="php-var">$update</span>) {
</span><span id="2118" class="l"><a class="l" href="#2118">2118: </a>                    <span class="php-var">$remote_calendars</span>[<span class="php-var">$key</span>] = <span class="php-var">$info</span>;
</span><span id="2119" class="l"><a class="l" href="#2119">2119: </a>                    <span class="php-keyword1">break</span>;
</span><span id="2120" class="l"><a class="l" href="#2120">2120: </a>                }
</span><span id="2121" class="l"><a class="l" href="#2121">2121: </a>            }
</span><span id="2122" class="l"><a class="l" href="#2122">2122: </a>        } <span class="php-keyword1">else</span> {
</span><span id="2123" class="l"><a class="l" href="#2123">2123: </a>            <span class="php-var">$remote_calendars</span>[] = <span class="php-var">$info</span>;
</span><span id="2124" class="l"><a class="l" href="#2124">2124: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>][] = <span class="php-var">$info</span>[<span class="php-quote">'url'</span>];
</span><span id="2125" class="l"><a class="l" href="#2125">2125: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'display_remote_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'display_remote_calendars'</span>]));
</span><span id="2126" class="l"><a class="l" href="#2126">2126: </a>        }
</span><span id="2127" class="l"><a class="l" href="#2127">2127: </a>
</span><span id="2128" class="l"><a class="l" href="#2128">2128: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'remote_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$remote_calendars</span>));
</span><span id="2129" class="l"><a class="l" href="#2129">2129: </a>    }
</span><span id="2130" class="l"><a class="l" href="#2130">2130: </a>
</span><span id="2131" class="l"><a class="l" href="#2131">2131: </a>    <span class="php-comment">/**
</span></span><span id="2132" class="l"><a class="l" href="#2132">2132: </a><span class="php-comment">     * Unsubscribes from a remote calendar.
</span></span><span id="2133" class="l"><a class="l" href="#2133">2133: </a><span class="php-comment">     *
</span></span><span id="2134" class="l"><a class="l" href="#2134">2134: </a><span class="php-comment">     * @param string $url  The calendar URL.
</span></span><span id="2135" class="l"><a class="l" href="#2135">2135: </a><span class="php-comment">     *
</span></span><span id="2136" class="l"><a class="l" href="#2136">2136: </a><span class="php-comment">     * @return array  Hash with the deleted calendar's information.
</span></span><span id="2137" class="l"><a class="l" href="#2137">2137: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="2138" class="l"><a class="l" href="#2138">2138: </a><span class="php-comment">     */</span>
</span><span id="2139" class="l"><a class="l" href="#2139">2139: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_unsubscribeRemoteCalendar" href="#_unsubscribeRemoteCalendar">unsubscribeRemoteCalendar</a>(<span class="php-var">$url</span>)
</span><span id="2140" class="l"><a class="l" href="#2140">2140: </a>    {
</span><span id="2141" class="l"><a class="l" href="#2141">2141: </a>        <span class="php-var">$url</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$url</span>);
</span><span id="2142" class="l"><a class="l" href="#2142">2142: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">strlen</span>(<span class="php-var">$url</span>)) {
</span><span id="2143" class="l"><a class="l" href="#2143">2143: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="2144" class="l"><a class="l" href="#2144">2144: </a>        }
</span><span id="2145" class="l"><a class="l" href="#2145">2145: </a>
</span><span id="2146" class="l"><a class="l" href="#2146">2146: </a>        <span class="php-var">$remote_calendars</span> = <span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'remote_cals'</span>));
</span><span id="2147" class="l"><a class="l" href="#2147">2147: </a>        <span class="php-var">$remote_calendar</span> = <span class="php-keyword1">null</span>;
</span><span id="2148" class="l"><a class="l" href="#2148">2148: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$remote_calendars</span> <span class="php-keyword1">as</span> <span class="php-var">$key</span> =&gt; <span class="php-var">$calendar</span>) {
</span><span id="2149" class="l"><a class="l" href="#2149">2149: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$calendar</span>[<span class="php-quote">'url'</span>] == <span class="php-var">$url</span>) {
</span><span id="2150" class="l"><a class="l" href="#2150">2150: </a>                <span class="php-var">$remote_calendar</span> = <span class="php-var">$calendar</span>;
</span><span id="2151" class="l"><a class="l" href="#2151">2151: </a>                <span class="php-keyword1">unset</span>(<span class="php-var">$remote_calendars</span>[<span class="php-var">$key</span>]);
</span><span id="2152" class="l"><a class="l" href="#2152">2152: </a>                <span class="php-keyword1">break</span>;
</span><span id="2153" class="l"><a class="l" href="#2153">2153: </a>            }
</span><span id="2154" class="l"><a class="l" href="#2154">2154: </a>        }
</span><span id="2155" class="l"><a class="l" href="#2155">2155: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$remote_calendar</span>) {
</span><span id="2156" class="l"><a class="l" href="#2156">2156: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(_(<span class="php-quote">&quot;The remote calendar was not found.&quot;</span>));
</span><span id="2157" class="l"><a class="l" href="#2157">2157: </a>        }
</span><span id="2158" class="l"><a class="l" href="#2158">2158: </a>
</span><span id="2159" class="l"><a class="l" href="#2159">2159: </a>        <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;setValue(<span class="php-quote">'remote_cals'</span>, <span class="php-keyword2">serialize</span>(<span class="php-var">$remote_calendars</span>));
</span><span id="2160" class="l"><a class="l" href="#2160">2160: </a>
</span><span id="2161" class="l"><a class="l" href="#2161">2161: </a>        <span class="php-keyword1">return</span> <span class="php-var">$remote_calendar</span>;
</span><span id="2162" class="l"><a class="l" href="#2162">2162: </a>    }
</span><span id="2163" class="l"><a class="l" href="#2163">2163: </a>
</span><span id="2164" class="l"><a class="l" href="#2164">2164: </a>    <span class="php-comment">/**
</span></span><span id="2165" class="l"><a class="l" href="#2165">2165: </a><span class="php-comment">     * Returns the feed URL for a calendar.
</span></span><span id="2166" class="l"><a class="l" href="#2166">2166: </a><span class="php-comment">     *
</span></span><span id="2167" class="l"><a class="l" href="#2167">2167: </a><span class="php-comment">     * @param string $calendar  A calendar name.
</span></span><span id="2168" class="l"><a class="l" href="#2168">2168: </a><span class="php-comment">     *
</span></span><span id="2169" class="l"><a class="l" href="#2169">2169: </a><span class="php-comment">     * @return string  The calendar's feed URL.
</span></span><span id="2170" class="l"><a class="l" href="#2170">2170: </a><span class="php-comment">     */</span>
</span><span id="2171" class="l"><a class="l" href="#2171">2171: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_feedUrl" href="#_feedUrl">feedUrl</a>(<span class="php-var">$calendar</span>)
</span><span id="2172" class="l"><a class="l" href="#2172">2172: </a>    {
</span><span id="2173" class="l"><a class="l" href="#2173">2173: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'urls'</span>][<span class="php-quote">'pretty'</span>]) &amp;&amp;
</span><span id="2174" class="l"><a class="l" href="#2174">2174: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'urls'</span>][<span class="php-quote">'pretty'</span>] == <span class="php-quote">'rewrite'</span>) {
</span><span id="2175" class="l"><a class="l" href="#2175">2175: </a>            <span class="php-keyword1">return</span> Horde::url(<span class="php-quote">'feed/'</span> . <span class="php-var">$calendar</span>, <span class="php-keyword1">true</span>, -<span class="php-num">1</span>);
</span><span id="2176" class="l"><a class="l" href="#2176">2176: </a>        }
</span><span id="2177" class="l"><a class="l" href="#2177">2177: </a>        <span class="php-keyword1">return</span> Horde::url(<span class="php-quote">'feed/index.php'</span>, <span class="php-keyword1">true</span>, -<span class="php-num">1</span>)
</span><span id="2178" class="l"><a class="l" href="#2178">2178: </a>            -&gt;add(<span class="php-quote">'c'</span>, <span class="php-var">$calendar</span>);
</span><span id="2179" class="l"><a class="l" href="#2179">2179: </a>    }
</span><span id="2180" class="l"><a class="l" href="#2180">2180: </a>
</span><span id="2181" class="l"><a class="l" href="#2181">2181: </a>    <span class="php-comment">/**
</span></span><span id="2182" class="l"><a class="l" href="#2182">2182: </a><span class="php-comment">     * Returs the HTML/javascript snippit needed to embed a calendar in an
</span></span><span id="2183" class="l"><a class="l" href="#2183">2183: </a><span class="php-comment">     * external website.
</span></span><span id="2184" class="l"><a class="l" href="#2184">2184: </a><span class="php-comment">     *
</span></span><span id="2185" class="l"><a class="l" href="#2185">2185: </a><span class="php-comment">     * @param string $calendar  A calendar name.
</span></span><span id="2186" class="l"><a class="l" href="#2186">2186: </a><span class="php-comment">     *
</span></span><span id="2187" class="l"><a class="l" href="#2187">2187: </a><span class="php-comment">     * @return string  The calendar's embed snippit.
</span></span><span id="2188" class="l"><a class="l" href="#2188">2188: </a><span class="php-comment">     */</span>
</span><span id="2189" class="l"><a class="l" href="#2189">2189: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_embedCode" href="#_embedCode">embedCode</a>(<span class="php-var">$calendar</span>)
</span><span id="2190" class="l"><a class="l" href="#2190">2190: </a>    {
</span><span id="2191" class="l"><a class="l" href="#2191">2191: </a>        <span class="php-comment">/* Get the base url */</span>
</span><span id="2192" class="l"><a class="l" href="#2192">2192: </a>        <span class="php-var">$imple</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Imple'</span>)-&gt;create(<span class="php-keyword1">array</span>(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'Embed'</span>), <span class="php-keyword1">array</span>(
</span><span id="2193" class="l"><a class="l" href="#2193">2193: </a>            <span class="php-quote">'calendar'</span> =&gt; <span class="php-quote">'internal_'</span> . <span class="php-var">$calendar</span>,
</span><span id="2194" class="l"><a class="l" href="#2194">2194: </a>            <span class="php-quote">'container'</span> =&gt; <span class="php-quote">'kronolithCal'</span>,
</span><span id="2195" class="l"><a class="l" href="#2195">2195: </a>            <span class="php-quote">'view'</span> =&gt; <span class="php-quote">'month'</span>
</span><span id="2196" class="l"><a class="l" href="#2196">2196: </a>        ), <span class="php-keyword1">true</span>);
</span><span id="2197" class="l"><a class="l" href="#2197">2197: </a>
</span><span id="2198" class="l"><a class="l" href="#2198">2198: </a>        <span class="php-var">$html</span> = <span class="php-quote">'&lt;div id=&quot;kronolithCal&quot;&gt;&lt;/div&gt;&lt;script src=&quot;'</span> . <span class="php-var">$imple</span>-&gt;getUrl()
</span><span id="2199" class="l"><a class="l" href="#2199">2199: </a>            . <span class="php-quote">'&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;'</span>;
</span><span id="2200" class="l"><a class="l" href="#2200">2200: </a>
</span><span id="2201" class="l"><a class="l" href="#2201">2201: </a>        <span class="php-keyword1">return</span> <span class="php-var">$html</span>;
</span><span id="2202" class="l"><a class="l" href="#2202">2202: </a>    }
</span><span id="2203" class="l"><a class="l" href="#2203">2203: </a>
</span><span id="2204" class="l"><a class="l" href="#2204">2204: </a>    <span class="php-comment">/**
</span></span><span id="2205" class="l"><a class="l" href="#2205">2205: </a><span class="php-comment">     * Parses a comma separated list of names and e-mail addresses into a list
</span></span><span id="2206" class="l"><a class="l" href="#2206">2206: </a><span class="php-comment">     * of attendee hashes.
</span></span><span id="2207" class="l"><a class="l" href="#2207">2207: </a><span class="php-comment">     *
</span></span><span id="2208" class="l"><a class="l" href="#2208">2208: </a><span class="php-comment">     * @param string $newAttendees  A comma separated attendee list.
</span></span><span id="2209" class="l"><a class="l" href="#2209">2209: </a><span class="php-comment">     *
</span></span><span id="2210" class="l"><a class="l" href="#2210">2210: </a><span class="php-comment">     * @return array  The attendee list with e-mail addresses as keys and
</span></span><span id="2211" class="l"><a class="l" href="#2211">2211: </a><span class="php-comment">     *                attendee information as values.
</span></span><span id="2212" class="l"><a class="l" href="#2212">2212: </a><span class="php-comment">     */</span>
</span><span id="2213" class="l"><a class="l" href="#2213">2213: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_parseAttendees" href="#_parseAttendees">parseAttendees</a>(<span class="php-var">$newAttendees</span>)
</span><span id="2214" class="l"><a class="l" href="#2214">2214: </a>    {
</span><span id="2215" class="l"><a class="l" href="#2215">2215: </a>        <span class="php-keyword1">global</span> <span class="php-var">$notification</span>;
</span><span id="2216" class="l"><a class="l" href="#2216">2216: </a>
</span><span id="2217" class="l"><a class="l" href="#2217">2217: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$newAttendees</span>)) {
</span><span id="2218" class="l"><a class="l" href="#2218">2218: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="2219" class="l"><a class="l" href="#2219">2219: </a>        }
</span><span id="2220" class="l"><a class="l" href="#2220">2220: </a>
</span><span id="2221" class="l"><a class="l" href="#2221">2221: </a>        <span class="php-var">$parser</span> = <span class="php-keyword1">new</span> Horde_Mail_Rfc822();
</span><span id="2222" class="l"><a class="l" href="#2222">2222: </a>        <span class="php-var">$attendees</span> = <span class="php-keyword1">array</span>();
</span><span id="2223" class="l"><a class="l" href="#2223">2223: </a>
</span><span id="2224" class="l"><a class="l" href="#2224">2224: </a>        <span class="php-keyword1">foreach</span> (Horde_Mime_Address::<span class="php-keyword2">explode</span>(<span class="php-var">$newAttendees</span>) <span class="php-keyword1">as</span> <span class="php-var">$newAttendee</span>) {
</span><span id="2225" class="l"><a class="l" href="#2225">2225: </a>            <span class="php-comment">// Parse the address without validation to see what we can get out</span>
</span><span id="2226" class="l"><a class="l" href="#2226">2226: </a>            <span class="php-comment">// of it. We allow email addresses (john@example.com), email</span>
</span><span id="2227" class="l"><a class="l" href="#2227">2227: </a>            <span class="php-comment">// address with user information (John Doe &lt;john@example.com&gt;),</span>
</span><span id="2228" class="l"><a class="l" href="#2228">2228: </a>            <span class="php-comment">// and plain names (John Doe).</span>
</span><span id="2229" class="l"><a class="l" href="#2229">2229: </a>            <span class="php-keyword1">try</span> {
</span><span id="2230" class="l"><a class="l" href="#2230">2230: </a>                <span class="php-var">$newAttendeeParsed</span> = <span class="php-var">$parser</span>-&gt;parseAddressList(<span class="php-var">$newAttendee</span>, <span class="php-keyword1">array</span>(
</span><span id="2231" class="l"><a class="l" href="#2231">2231: </a>                    <span class="php-quote">'default_domain'</span> =&gt; <span class="php-keyword1">null</span>,
</span><span id="2232" class="l"><a class="l" href="#2232">2232: </a>                    <span class="php-quote">'nest_groups'</span> =&gt; <span class="php-keyword1">false</span>,
</span><span id="2233" class="l"><a class="l" href="#2233">2233: </a>                    <span class="php-quote">'validate'</span> =&gt; <span class="php-keyword1">false</span>
</span><span id="2234" class="l"><a class="l" href="#2234">2234: </a>                ));
</span><span id="2235" class="l"><a class="l" href="#2235">2235: </a>                <span class="php-var">$error</span> = (!<span class="php-keyword1">isset</span>(<span class="php-var">$newAttendeeParsed</span>[<span class="php-num">0</span>]) || !<span class="php-keyword1">isset</span>(<span class="php-var">$newAttendeeParsed</span>[<span class="php-num">0</span>]-&gt;mailbox));
</span><span id="2236" class="l"><a class="l" href="#2236">2236: </a>            } <span class="php-keyword1">catch</span> (Horde_Mail_Exception <span class="php-var">$e</span>) {
</span><span id="2237" class="l"><a class="l" href="#2237">2237: </a>                <span class="php-var">$error</span> = <span class="php-keyword1">true</span>;
</span><span id="2238" class="l"><a class="l" href="#2238">2238: </a>            }
</span><span id="2239" class="l"><a class="l" href="#2239">2239: </a>
</span><span id="2240" class="l"><a class="l" href="#2240">2240: </a>            <span class="php-comment">// If we can't even get a mailbox out of the address, then it is</span>
</span><span id="2241" class="l"><a class="l" href="#2241">2241: </a>            <span class="php-comment">// likely unuseable. Reject it entirely.</span>
</span><span id="2242" class="l"><a class="l" href="#2242">2242: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$error</span>) {
</span><span id="2243" class="l"><a class="l" href="#2243">2243: </a>                <span class="php-var">$notification</span>-&gt;push(
</span><span id="2244" class="l"><a class="l" href="#2244">2244: </a>                    <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Unable to recognize \&quot;%s\&quot; as an email address.&quot;</span>), <span class="php-var">$newAttendee</span>),
</span><span id="2245" class="l"><a class="l" href="#2245">2245: </a>                    <span class="php-quote">'horde.error'</span>);
</span><span id="2246" class="l"><a class="l" href="#2246">2246: </a>                <span class="php-keyword1">continue</span>;
</span><span id="2247" class="l"><a class="l" href="#2247">2247: </a>            }
</span><span id="2248" class="l"><a class="l" href="#2248">2248: </a>
</span><span id="2249" class="l"><a class="l" href="#2249">2249: </a>            <span class="php-comment">// Loop through any addresses we found.</span>
</span><span id="2250" class="l"><a class="l" href="#2250">2250: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$newAttendeeParsed</span> <span class="php-keyword1">as</span> <span class="php-var">$newAttendeeParsedPart</span>) {
</span><span id="2251" class="l"><a class="l" href="#2251">2251: </a>                <span class="php-comment">// If there is only a mailbox part, then it is just a local</span>
</span><span id="2252" class="l"><a class="l" href="#2252">2252: </a>                <span class="php-comment">// name.</span>
</span><span id="2253" class="l"><a class="l" href="#2253">2253: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$newAttendeeParsedPart</span>-&gt;host)) {
</span><span id="2254" class="l"><a class="l" href="#2254">2254: </a>                    <span class="php-var">$attendees</span>[] = <span class="php-keyword1">array</span>(
</span><span id="2255" class="l"><a class="l" href="#2255">2255: </a>                        <span class="php-quote">'attendance'</span> =&gt; self::PART_REQUIRED,
</span><span id="2256" class="l"><a class="l" href="#2256">2256: </a>                        <span class="php-quote">'response'</span>   =&gt; self::RESPONSE_NONE,
</span><span id="2257" class="l"><a class="l" href="#2257">2257: </a>                        <span class="php-quote">'name'</span>       =&gt; <span class="php-var">$newAttendee</span>,
</span><span id="2258" class="l"><a class="l" href="#2258">2258: </a>                    );
</span><span id="2259" class="l"><a class="l" href="#2259">2259: </a>                    <span class="php-keyword1">continue</span>;
</span><span id="2260" class="l"><a class="l" href="#2260">2260: </a>                }
</span><span id="2261" class="l"><a class="l" href="#2261">2261: </a>
</span><span id="2262" class="l"><a class="l" href="#2262">2262: </a>                <span class="php-comment">// Build a full email address again and validate it.</span>
</span><span id="2263" class="l"><a class="l" href="#2263">2263: </a>                <span class="php-var">$name</span> = <span class="php-keyword1">empty</span>(<span class="php-var">$newAttendeeParsedPart</span>-&gt;personal)
</span><span id="2264" class="l"><a class="l" href="#2264">2264: </a>                    ? <span class="php-quote">''</span>
</span><span id="2265" class="l"><a class="l" href="#2265">2265: </a>                    : <span class="php-var">$newAttendeeParsedPart</span>-&gt;personal;
</span><span id="2266" class="l"><a class="l" href="#2266">2266: </a>
</span><span id="2267" class="l"><a class="l" href="#2267">2267: </a>                <span class="php-keyword1">try</span> {
</span><span id="2268" class="l"><a class="l" href="#2268">2268: </a>                    <span class="php-var">$newAttendeeParsedPartNew</span> = Horde_Mime::encodeAddress(Horde_Mime_Address::writeAddress(<span class="php-var">$newAttendeeParsedPart</span>-&gt;mailbox, <span class="php-var">$newAttendeeParsedPart</span>-&gt;host, <span class="php-var">$name</span>), <span class="php-quote">'UTF-8'</span>);
</span><span id="2269" class="l"><a class="l" href="#2269">2269: </a>                    <span class="php-var">$newAttendeeParsedPartValidated</span> = <span class="php-var">$parser</span>-&gt;parseAddressList(<span class="php-var">$newAttendeeParsedPartNew</span>, <span class="php-keyword1">array</span>(
</span><span id="2270" class="l"><a class="l" href="#2270">2270: </a>                        <span class="php-quote">'default_domain'</span> =&gt; <span class="php-keyword1">null</span>
</span><span id="2271" class="l"><a class="l" href="#2271">2271: </a>                    ));
</span><span id="2272" class="l"><a class="l" href="#2272">2272: </a>
</span><span id="2273" class="l"><a class="l" href="#2273">2273: </a>                    <span class="php-var">$email</span> = <span class="php-var">$newAttendeeParsedPart</span>-&gt;mailbox . <span class="php-quote">'@'</span>
</span><span id="2274" class="l"><a class="l" href="#2274">2274: </a>                        . <span class="php-var">$newAttendeeParsedPart</span>-&gt;host;
</span><span id="2275" class="l"><a class="l" href="#2275">2275: </a>                    <span class="php-comment">// Avoid overwriting existing attendees with the default</span>
</span><span id="2276" class="l"><a class="l" href="#2276">2276: </a>                    <span class="php-comment">// values.</span>
</span><span id="2277" class="l"><a class="l" href="#2277">2277: </a>                    <span class="php-var">$attendees</span>[Horde_String::lower(<span class="php-var">$email</span>)] = <span class="php-keyword1">array</span>(
</span><span id="2278" class="l"><a class="l" href="#2278">2278: </a>                        <span class="php-quote">'attendance'</span> =&gt; self::PART_REQUIRED,
</span><span id="2279" class="l"><a class="l" href="#2279">2279: </a>                        <span class="php-quote">'response'</span>   =&gt; self::RESPONSE_NONE,
</span><span id="2280" class="l"><a class="l" href="#2280">2280: </a>                        <span class="php-quote">'name'</span>       =&gt; <span class="php-var">$name</span>);
</span><span id="2281" class="l"><a class="l" href="#2281">2281: </a>                } <span class="php-keyword1">catch</span> (Horde_Mime_Exception <span class="php-var">$e</span>) {
</span><span id="2282" class="l"><a class="l" href="#2282">2282: </a>                    <span class="php-var">$notification</span>-&gt;push(<span class="php-var">$e</span>, <span class="php-quote">'horde.error'</span>);
</span><span id="2283" class="l"><a class="l" href="#2283">2283: </a>                }
</span><span id="2284" class="l"><a class="l" href="#2284">2284: </a>            }
</span><span id="2285" class="l"><a class="l" href="#2285">2285: </a>        }
</span><span id="2286" class="l"><a class="l" href="#2286">2286: </a>
</span><span id="2287" class="l"><a class="l" href="#2287">2287: </a>        <span class="php-keyword1">return</span> <span class="php-var">$attendees</span>;
</span><span id="2288" class="l"><a class="l" href="#2288">2288: </a>    }
</span><span id="2289" class="l"><a class="l" href="#2289">2289: </a>
</span><span id="2290" class="l"><a class="l" href="#2290">2290: </a>    <span class="php-comment">/**
</span></span><span id="2291" class="l"><a class="l" href="#2291">2291: </a><span class="php-comment">     * Returns a comma separated list of attendees and resources
</span></span><span id="2292" class="l"><a class="l" href="#2292">2292: </a><span class="php-comment">     *
</span></span><span id="2293" class="l"><a class="l" href="#2293">2293: </a><span class="php-comment">     * @return string  Attendee/Resource list.
</span></span><span id="2294" class="l"><a class="l" href="#2294">2294: </a><span class="php-comment">     */</span>
</span><span id="2295" class="l"><a class="l" href="#2295">2295: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_attendeeList" href="#_attendeeList">attendeeList</a>()
</span><span id="2296" class="l"><a class="l" href="#2296">2296: </a>    {
</span><span id="2297" class="l"><a class="l" href="#2297">2297: </a>        <span class="php-comment">/* Attendees */</span>
</span><span id="2298" class="l"><a class="l" href="#2298">2298: </a>        <span class="php-var">$attendees</span> = <span class="php-keyword1">array</span>();
</span><span id="2299" class="l"><a class="l" href="#2299">2299: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;get(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'attendees'</span>, Horde_Session::TYPE_ARRAY) <span class="php-keyword1">as</span> <span class="php-var">$email</span> =&gt; <span class="php-var">$attendee</span>) {
</span><span id="2300" class="l"><a class="l" href="#2300">2300: </a>            <span class="php-var">$attendees</span>[] = <span class="php-keyword1">empty</span>(<span class="php-var">$attendee</span>[<span class="php-quote">'name'</span>]) ? <span class="php-var">$email</span> : Horde_Mime_Address::trimAddress(<span class="php-var">$attendee</span>[<span class="php-quote">'name'</span>] . (<span class="php-keyword2">strpos</span>(<span class="php-var">$email</span>, <span class="php-quote">'@'</span>) === <span class="php-keyword1">false</span> ? <span class="php-quote">''</span> : <span class="php-quote">' &lt;'</span> . <span class="php-var">$email</span> . <span class="php-quote">'&gt;'</span>));
</span><span id="2301" class="l"><a class="l" href="#2301">2301: </a>        }
</span><span id="2302" class="l"><a class="l" href="#2302">2302: </a>
</span><span id="2303" class="l"><a class="l" href="#2303">2303: </a>        <span class="php-comment">/* Resources */</span>
</span><span id="2304" class="l"><a class="l" href="#2304">2304: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'session'</span>]-&gt;get(<span class="php-quote">'kronolith'</span>, <span class="php-quote">'resources'</span>, Horde_Session::TYPE_ARRAY) <span class="php-keyword1">as</span> <span class="php-var">$resource</span>) {
</span><span id="2305" class="l"><a class="l" href="#2305">2305: </a>            <span class="php-var">$attendees</span>[] = <span class="php-var">$resource</span>[<span class="php-quote">'name'</span>];
</span><span id="2306" class="l"><a class="l" href="#2306">2306: </a>        }
</span><span id="2307" class="l"><a class="l" href="#2307">2307: </a>
</span><span id="2308" class="l"><a class="l" href="#2308">2308: </a>        <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-var">$attendees</span>);
</span><span id="2309" class="l"><a class="l" href="#2309">2309: </a>    }
</span><span id="2310" class="l"><a class="l" href="#2310">2310: </a>
</span><span id="2311" class="l"><a class="l" href="#2311">2311: </a>    <span class="php-comment">/**
</span></span><span id="2312" class="l"><a class="l" href="#2312">2312: </a><span class="php-comment">     * Sends out iTip event notifications to all attendees of a specific
</span></span><span id="2313" class="l"><a class="l" href="#2313">2313: </a><span class="php-comment">     * event.
</span></span><span id="2314" class="l"><a class="l" href="#2314">2314: </a><span class="php-comment">     *
</span></span><span id="2315" class="l"><a class="l" href="#2315">2315: </a><span class="php-comment">     * Can be used to send event invitations, event updates as well as event
</span></span><span id="2316" class="l"><a class="l" href="#2316">2316: </a><span class="php-comment">     * cancellations.
</span></span><span id="2317" class="l"><a class="l" href="#2317">2317: </a><span class="php-comment">     *
</span></span><span id="2318" class="l"><a class="l" href="#2318">2318: </a><span class="php-comment">     * @param Kronolith_Event $event
</span></span><span id="2319" class="l"><a class="l" href="#2319">2319: </a><span class="php-comment">     *        The event in question.
</span></span><span id="2320" class="l"><a class="l" href="#2320">2320: </a><span class="php-comment">     * @param Horde_Notification_Handler $notification
</span></span><span id="2321" class="l"><a class="l" href="#2321">2321: </a><span class="php-comment">     *        A notification object used to show result status.
</span></span><span id="2322" class="l"><a class="l" href="#2322">2322: </a><span class="php-comment">     * @param integer $action
</span></span><span id="2323" class="l"><a class="l" href="#2323">2323: </a><span class="php-comment">     *        The type of notification to send. One of the Kronolith::ITIP_*
</span></span><span id="2324" class="l"><a class="l" href="#2324">2324: </a><span class="php-comment">     *        values.
</span></span><span id="2325" class="l"><a class="l" href="#2325">2325: </a><span class="php-comment">     * @param Horde_Date $instance
</span></span><span id="2326" class="l"><a class="l" href="#2326">2326: </a><span class="php-comment">     *        If cancelling a single instance of a recurring event, the date of
</span></span><span id="2327" class="l"><a class="l" href="#2327">2327: </a><span class="php-comment">     *        this intance.
</span></span><span id="2328" class="l"><a class="l" href="#2328">2328: </a><span class="php-comment">     */</span>
</span><span id="2329" class="l"><a class="l" href="#2329">2329: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_sendITipNotifications" href="#_sendITipNotifications">sendITipNotifications</a>(<span class="php-var">$event</span>, <span class="php-var">$notification</span>,
</span><span id="2330" class="l"><a class="l" href="#2330">2330: </a>                                                 <span class="php-var">$action</span>, <span class="php-var">$instance</span> = <span class="php-keyword1">null</span>)
</span><span id="2331" class="l"><a class="l" href="#2331">2331: </a>    {
</span><span id="2332" class="l"><a class="l" href="#2332">2332: </a>        <span class="php-keyword1">global</span> <span class="php-var">$conf</span>, <span class="php-var">$registry</span>;
</span><span id="2333" class="l"><a class="l" href="#2333">2333: </a>
</span><span id="2334" class="l"><a class="l" href="#2334">2334: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$event</span>-&gt;attendees) {
</span><span id="2335" class="l"><a class="l" href="#2335">2335: </a>            <span class="php-keyword1">return</span>;
</span><span id="2336" class="l"><a class="l" href="#2336">2336: </a>        }
</span><span id="2337" class="l"><a class="l" href="#2337">2337: </a>
</span><span id="2338" class="l"><a class="l" href="#2338">2338: </a>        <span class="php-var">$ident</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)-&gt;create(<span class="php-var">$event</span>-&gt;creator);
</span><span id="2339" class="l"><a class="l" href="#2339">2339: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$ident</span>-&gt;getValue(<span class="php-quote">'from_addr'</span>)) {
</span><span id="2340" class="l"><a class="l" href="#2340">2340: </a>            <span class="php-var">$notification</span>-&gt;push(<span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;You do not have an email address configured in your Personal Information Preferences. You must set one %shere%s before event notifications can be sent.&quot;</span>), Horde::getServiceLink(<span class="php-quote">'prefs'</span>, <span class="php-quote">'kronolith'</span>)-&gt;add(<span class="php-keyword1">array</span>(<span class="php-quote">'app'</span> =&gt; <span class="php-quote">'horde'</span>, <span class="php-quote">'group'</span> =&gt; <span class="php-quote">'identities'</span>))-&gt;<span class="php-keyword2">link</span>(), <span class="php-quote">'&lt;/a&gt;'</span>), <span class="php-quote">'horde.error'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'content.raw'</span>));
</span><span id="2341" class="l"><a class="l" href="#2341">2341: </a>            <span class="php-keyword1">return</span>;
</span><span id="2342" class="l"><a class="l" href="#2342">2342: </a>        }
</span><span id="2343" class="l"><a class="l" href="#2343">2343: </a>
</span><span id="2344" class="l"><a class="l" href="#2344">2344: </a>        <span class="php-comment">// Generate image mime part first and only once, because we</span>
</span><span id="2345" class="l"><a class="l" href="#2345">2345: </a>        <span class="php-comment">// need the Content-ID.</span>
</span><span id="2346" class="l"><a class="l" href="#2346">2346: </a>        <span class="php-var">$image</span> = self::getImagePart(<span class="php-quote">'big_invitation.png'</span>);
</span><span id="2347" class="l"><a class="l" href="#2347">2347: </a>
</span><span id="2348" class="l"><a class="l" href="#2348">2348: </a>        <span class="php-var">$share</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;getShare(<span class="php-var">$event</span>-&gt;calendar);
</span><span id="2349" class="l"><a class="l" href="#2349">2349: </a>        <span class="php-var">$view</span> = <span class="php-keyword1">new</span> Horde_View(<span class="php-keyword1">array</span>(<span class="php-quote">'templatePath'</span> =&gt; KRONOLITH_TEMPLATES . <span class="php-quote">'/itip'</span>));
</span><span id="2350" class="l"><a class="l" href="#2350">2350: </a>        <span class="php-keyword1">new</span> Horde_View_Helper_Text(<span class="php-var">$view</span>);
</span><span id="2351" class="l"><a class="l" href="#2351">2351: </a>        <span class="php-var">$view</span>-&gt;identity = <span class="php-var">$ident</span>;
</span><span id="2352" class="l"><a class="l" href="#2352">2352: </a>        <span class="php-var">$view</span>-&gt;event = <span class="php-var">$event</span>;
</span><span id="2353" class="l"><a class="l" href="#2353">2353: </a>        <span class="php-var">$view</span>-&gt;imageId = <span class="php-var">$image</span>-&gt;getContentId();
</span><span id="2354" class="l"><a class="l" href="#2354">2354: </a>
</span><span id="2355" class="l"><a class="l" href="#2355">2355: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$event</span>-&gt;attendees <span class="php-keyword1">as</span> <span class="php-var">$email</span> =&gt; <span class="php-var">$status</span>) {
</span><span id="2356" class="l"><a class="l" href="#2356">2356: </a>            <span class="php-comment">/* Don't bother sending an invitation/update if the recipient does
</span></span><span id="2357" class="l"><a class="l" href="#2357">2357: </a><span class="php-comment">             * not need to participate, or has declined participating, or
</span></span><span id="2358" class="l"><a class="l" href="#2358">2358: </a><span class="php-comment">             * doesn't have an email address. */</span>
</span><span id="2359" class="l"><a class="l" href="#2359">2359: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$email</span>, <span class="php-quote">'@'</span>) === <span class="php-keyword1">false</span> ||
</span><span id="2360" class="l"><a class="l" href="#2360">2360: </a>                <span class="php-var">$status</span>[<span class="php-quote">'attendance'</span>] == self::PART_NONE ||
</span><span id="2361" class="l"><a class="l" href="#2361">2361: </a>                <span class="php-var">$status</span>[<span class="php-quote">'response'</span>] == self::RESPONSE_DECLINED) {
</span><span id="2362" class="l"><a class="l" href="#2362">2362: </a>                <span class="php-keyword1">continue</span>;
</span><span id="2363" class="l"><a class="l" href="#2363">2363: </a>            }
</span><span id="2364" class="l"><a class="l" href="#2364">2364: </a>
</span><span id="2365" class="l"><a class="l" href="#2365">2365: </a>            <span class="php-comment">/* Determine all notification-specific strings. */</span>
</span><span id="2366" class="l"><a class="l" href="#2366">2366: </a>            <span class="php-keyword1">switch</span> (<span class="php-var">$action</span>) {
</span><span id="2367" class="l"><a class="l" href="#2367">2367: </a>            <span class="php-keyword1">case</span> self::ITIP_CANCEL:
</span><span id="2368" class="l"><a class="l" href="#2368">2368: </a>                <span class="php-comment">/* Cancellation. */</span>
</span><span id="2369" class="l"><a class="l" href="#2369">2369: </a>                <span class="php-var">$method</span> = <span class="php-quote">'CANCEL'</span>;
</span><span id="2370" class="l"><a class="l" href="#2370">2370: </a>                <span class="php-var">$filename</span> = <span class="php-quote">'event-cancellation.ics'</span>;
</span><span id="2371" class="l"><a class="l" href="#2371">2371: </a>                <span class="php-var">$view</span>-&gt;subject = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Cancelled: %s&quot;</span>), <span class="php-var">$event</span>-&gt;getTitle());
</span><span id="2372" class="l"><a class="l" href="#2372">2372: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$instance</span>)) {
</span><span id="2373" class="l"><a class="l" href="#2373">2373: </a>                    <span class="php-var">$view</span>-&gt;<span class="php-keyword2">header</span> = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;%s has cancelled \&quot;%s\&quot;.&quot;</span>), <span class="php-var">$ident</span>-&gt;getName(), <span class="php-var">$event</span>-&gt;getTitle());
</span><span id="2374" class="l"><a class="l" href="#2374">2374: </a>                } <span class="php-keyword1">else</span> {
</span><span id="2375" class="l"><a class="l" href="#2375">2375: </a>                    <span class="php-var">$view</span>-&gt;<span class="php-keyword2">header</span> = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;%s has cancelled an instance of the recurring \&quot;%s\&quot;.&quot;</span>), <span class="php-var">$ident</span>-&gt;getName(), <span class="php-var">$event</span>-&gt;getTitle());
</span><span id="2376" class="l"><a class="l" href="#2376">2376: </a>                }
</span><span id="2377" class="l"><a class="l" href="#2377">2377: </a>                <span class="php-keyword1">break</span>;
</span><span id="2378" class="l"><a class="l" href="#2378">2378: </a>
</span><span id="2379" class="l"><a class="l" href="#2379">2379: </a>            <span class="php-keyword1">case</span> self::ITIP_REQUEST:
</span><span id="2380" class="l"><a class="l" href="#2380">2380: </a>            <span class="php-keyword1">default</span>:
</span><span id="2381" class="l"><a class="l" href="#2381">2381: </a>                <span class="php-var">$method</span> = <span class="php-quote">'REQUEST'</span>;
</span><span id="2382" class="l"><a class="l" href="#2382">2382: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$status</span>[<span class="php-quote">'response'</span>] == self::RESPONSE_NONE) {
</span><span id="2383" class="l"><a class="l" href="#2383">2383: </a>                    <span class="php-comment">/* Invitation. */</span>
</span><span id="2384" class="l"><a class="l" href="#2384">2384: </a>                    <span class="php-var">$filename</span> = <span class="php-quote">'event-invitation.ics'</span>;
</span><span id="2385" class="l"><a class="l" href="#2385">2385: </a>                    <span class="php-var">$view</span>-&gt;subject = <span class="php-var">$event</span>-&gt;getTitle();
</span><span id="2386" class="l"><a class="l" href="#2386">2386: </a>                    <span class="php-var">$view</span>-&gt;<span class="php-keyword2">header</span> = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;%s wishes to make you aware of \&quot;%s\&quot;.&quot;</span>), <span class="php-var">$ident</span>-&gt;getName(), <span class="php-var">$event</span>-&gt;getTitle());
</span><span id="2387" class="l"><a class="l" href="#2387">2387: </a>                } <span class="php-keyword1">else</span> {
</span><span id="2388" class="l"><a class="l" href="#2388">2388: </a>                    <span class="php-comment">/* Update. */</span>
</span><span id="2389" class="l"><a class="l" href="#2389">2389: </a>                    <span class="php-var">$filename</span> = <span class="php-quote">'event-update.ics'</span>;
</span><span id="2390" class="l"><a class="l" href="#2390">2390: </a>                    <span class="php-var">$view</span>-&gt;subject = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;Updated: %s.&quot;</span>), <span class="php-var">$event</span>-&gt;getTitle());
</span><span id="2391" class="l"><a class="l" href="#2391">2391: </a>                    <span class="php-var">$view</span>-&gt;<span class="php-keyword2">header</span> = <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;%s wants to notify you about changes of \&quot;%s\&quot;.&quot;</span>), <span class="php-var">$ident</span>-&gt;getName(), <span class="php-var">$event</span>-&gt;getTitle());
</span><span id="2392" class="l"><a class="l" href="#2392">2392: </a>                }
</span><span id="2393" class="l"><a class="l" href="#2393">2393: </a>                <span class="php-keyword1">break</span>;
</span><span id="2394" class="l"><a class="l" href="#2394">2394: </a>            }
</span><span id="2395" class="l"><a class="l" href="#2395">2395: </a>
</span><span id="2396" class="l"><a class="l" href="#2396">2396: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;attendees) {
</span><span id="2397" class="l"><a class="l" href="#2397">2397: </a>                <span class="php-var">$attendees</span> = <span class="php-keyword1">array</span>();
</span><span id="2398" class="l"><a class="l" href="#2398">2398: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$event</span>-&gt;attendees <span class="php-keyword1">as</span> <span class="php-var">$mail</span> =&gt; <span class="php-var">$attendee</span>) {
</span><span id="2399" class="l"><a class="l" href="#2399">2399: </a>                    <span class="php-var">$attendees</span>[] = <span class="php-keyword1">empty</span>(<span class="php-var">$attendee</span>[<span class="php-quote">'name'</span>]) ? <span class="php-var">$mail</span> : Horde_Mime_Address::trimAddress(<span class="php-var">$attendee</span>[<span class="php-quote">'name'</span>] . (<span class="php-keyword2">strpos</span>(<span class="php-var">$mail</span>, <span class="php-quote">'@'</span>) === <span class="php-keyword1">false</span> ? <span class="php-quote">''</span> : <span class="php-quote">' &lt;'</span> . <span class="php-var">$mail</span> . <span class="php-quote">'&gt;'</span>));
</span><span id="2400" class="l"><a class="l" href="#2400">2400: </a>                }
</span><span id="2401" class="l"><a class="l" href="#2401">2401: </a>                <span class="php-var">$view</span>-&gt;organizer = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;convertUserName(<span class="php-var">$event</span>-&gt;creator, <span class="php-keyword1">false</span>);
</span><span id="2402" class="l"><a class="l" href="#2402">2402: </a>                <span class="php-var">$view</span>-&gt;attendees = <span class="php-var">$attendees</span>;
</span><span id="2403" class="l"><a class="l" href="#2403">2403: </a>            }
</span><span id="2404" class="l"><a class="l" href="#2404">2404: </a>
</span><span id="2405" class="l"><a class="l" href="#2405">2405: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$action</span> == self::ITIP_REQUEST) {
</span><span id="2406" class="l"><a class="l" href="#2406">2406: </a>                <span class="php-var">$attend_link</span> = Horde::url(<span class="php-quote">'attend.php'</span>, <span class="php-keyword1">true</span>, -<span class="php-num">1</span>)
</span><span id="2407" class="l"><a class="l" href="#2407">2407: </a>                    -&gt;add(<span class="php-keyword1">array</span>(<span class="php-quote">'c'</span> =&gt; <span class="php-var">$event</span>-&gt;calendar,
</span><span id="2408" class="l"><a class="l" href="#2408">2408: </a>                                <span class="php-quote">'e'</span> =&gt; <span class="php-var">$event</span>-&gt;id,
</span><span id="2409" class="l"><a class="l" href="#2409">2409: </a>                                <span class="php-quote">'u'</span> =&gt; <span class="php-var">$email</span>));
</span><span id="2410" class="l"><a class="l" href="#2410">2410: </a>                <span class="php-var">$view</span>-&gt;linkAccept    = (string)<span class="php-var">$attend_link</span>-&gt;add(<span class="php-quote">'a'</span>, <span class="php-quote">'accept'</span>);
</span><span id="2411" class="l"><a class="l" href="#2411">2411: </a>                <span class="php-var">$view</span>-&gt;linkTentative = (string)<span class="php-var">$attend_link</span>-&gt;add(<span class="php-quote">'a'</span>, <span class="php-quote">'tentative'</span>);
</span><span id="2412" class="l"><a class="l" href="#2412">2412: </a>                <span class="php-var">$view</span>-&gt;linkDecline   = (string)<span class="php-var">$attend_link</span>-&gt;add(<span class="php-quote">'a'</span>, <span class="php-quote">'decline'</span>);
</span><span id="2413" class="l"><a class="l" href="#2413">2413: </a>            }
</span><span id="2414" class="l"><a class="l" href="#2414">2414: </a>
</span><span id="2415" class="l"><a class="l" href="#2415">2415: </a>            <span class="php-comment">/* Build the iCalendar data */</span>
</span><span id="2416" class="l"><a class="l" href="#2416">2416: </a>            <span class="php-var">$iCal</span> = <span class="php-keyword1">new</span> Horde_Icalendar();
</span><span id="2417" class="l"><a class="l" href="#2417">2417: </a>            <span class="php-var">$iCal</span>-&gt;setAttribute(<span class="php-quote">'METHOD'</span>, <span class="php-var">$method</span>);
</span><span id="2418" class="l"><a class="l" href="#2418">2418: </a>            <span class="php-var">$iCal</span>-&gt;setAttribute(<span class="php-quote">'X-WR-CALNAME'</span>, <span class="php-var">$share</span>-&gt;get(<span class="php-quote">'name'</span>));
</span><span id="2419" class="l"><a class="l" href="#2419">2419: </a>            <span class="php-var">$vevent</span> = <span class="php-var">$event</span>-&gt;toiCalendar(<span class="php-var">$iCal</span>);
</span><span id="2420" class="l"><a class="l" href="#2420">2420: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$action</span> == self::ITIP_CANCEL &amp;&amp; !<span class="php-keyword1">empty</span>(<span class="php-var">$instance</span>)) {
</span><span id="2421" class="l"><a class="l" href="#2421">2421: </a>                <span class="php-comment">// Recurring event instance deletion, need to specify the</span>
</span><span id="2422" class="l"><a class="l" href="#2422">2422: </a>                <span class="php-comment">// RECURRENCE-ID but NOT the EXDATE.</span>
</span><span id="2423" class="l"><a class="l" href="#2423">2423: </a>                <span class="php-var">$vevent</span> = <span class="php-keyword2">array_pop</span>(<span class="php-var">$vevent</span>);
</span><span id="2424" class="l"><a class="l" href="#2424">2424: </a>                <span class="php-var">$vevent</span>-&gt;setAttribute(<span class="php-quote">'RECURRENCE-ID'</span>, <span class="php-var">$instance</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'VALUE'</span> =&gt; <span class="php-quote">'DATE'</span>));
</span><span id="2425" class="l"><a class="l" href="#2425">2425: </a>                <span class="php-var">$vevent</span>-&gt;removeAttribute(<span class="php-quote">'EXDATE'</span>);
</span><span id="2426" class="l"><a class="l" href="#2426">2426: </a>            }
</span><span id="2427" class="l"><a class="l" href="#2427">2427: </a>            <span class="php-var">$iCal</span>-&gt;addComponent(<span class="php-var">$vevent</span>);
</span><span id="2428" class="l"><a class="l" href="#2428">2428: </a>
</span><span id="2429" class="l"><a class="l" href="#2429">2429: </a>            <span class="php-comment">/* text/calendar part */</span>
</span><span id="2430" class="l"><a class="l" href="#2430">2430: </a>            <span class="php-var">$ics</span> = <span class="php-keyword1">new</span> Horde_Mime_Part();
</span><span id="2431" class="l"><a class="l" href="#2431">2431: </a>            <span class="php-var">$ics</span>-&gt;<span class="php-keyword2">setType</span>(<span class="php-quote">'text/calendar'</span>);
</span><span id="2432" class="l"><a class="l" href="#2432">2432: </a>            <span class="php-var">$ics</span>-&gt;setContents(<span class="php-var">$iCal</span>-&gt;exportvCalendar());
</span><span id="2433" class="l"><a class="l" href="#2433">2433: </a>            <span class="php-var">$ics</span>-&gt;setName(<span class="php-var">$filename</span>);
</span><span id="2434" class="l"><a class="l" href="#2434">2434: </a>            <span class="php-var">$ics</span>-&gt;setContentTypeParameter(<span class="php-quote">'METHOD'</span>, <span class="php-var">$method</span>);
</span><span id="2435" class="l"><a class="l" href="#2435">2435: </a>            <span class="php-var">$ics</span>-&gt;setCharset(<span class="php-quote">'UTF-8'</span>);
</span><span id="2436" class="l"><a class="l" href="#2436">2436: </a>            <span class="php-var">$ics</span>-&gt;setEOL(<span class="php-quote">&quot;\r\n&quot;</span>);
</span><span id="2437" class="l"><a class="l" href="#2437">2437: </a>
</span><span id="2438" class="l"><a class="l" href="#2438">2438: </a>            <span class="php-var">$multipart</span> = self::buildMimeMessage(<span class="php-var">$view</span>, <span class="php-quote">'notification'</span>, <span class="php-var">$image</span>);
</span><span id="2439" class="l"><a class="l" href="#2439">2439: </a>            <span class="php-var">$multipart</span>-&gt;addPart(<span class="php-var">$ics</span>);
</span><span id="2440" class="l"><a class="l" href="#2440">2440: </a>            <span class="php-var">$recipient</span> = <span class="php-keyword1">empty</span>(<span class="php-var">$status</span>[<span class="php-quote">'name'</span>]) ? <span class="php-var">$email</span> : Horde_Mime_Address::trimAddress(<span class="php-var">$status</span>[<span class="php-quote">'name'</span>] . <span class="php-quote">' &lt;'</span> . <span class="php-var">$email</span> . <span class="php-quote">'&gt;'</span>);
</span><span id="2441" class="l"><a class="l" href="#2441">2441: </a>            <span class="php-var">$mail</span> = <span class="php-keyword1">new</span> Horde_Mime_Mail(
</span><span id="2442" class="l"><a class="l" href="#2442">2442: </a>                <span class="php-keyword1">array</span>(<span class="php-quote">'Subject'</span> =&gt; <span class="php-var">$view</span>-&gt;subject,
</span><span id="2443" class="l"><a class="l" href="#2443">2443: </a>                      <span class="php-quote">'To'</span> =&gt; <span class="php-var">$recipient</span>,
</span><span id="2444" class="l"><a class="l" href="#2444">2444: </a>                      <span class="php-quote">'From'</span> =&gt; <span class="php-var">$ident</span>-&gt;getDefaultFromAddress(<span class="php-keyword1">true</span>),
</span><span id="2445" class="l"><a class="l" href="#2445">2445: </a>                      <span class="php-quote">'User-Agent'</span> =&gt; <span class="php-quote">'Kronolith '</span> . <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getVersion()));
</span><span id="2446" class="l"><a class="l" href="#2446">2446: </a>            <span class="php-var">$mail</span>-&gt;setBasePart(<span class="php-var">$multipart</span>);
</span><span id="2447" class="l"><a class="l" href="#2447">2447: </a>
</span><span id="2448" class="l"><a class="l" href="#2448">2448: </a>            <span class="php-keyword1">try</span> {
</span><span id="2449" class="l"><a class="l" href="#2449">2449: </a>                <span class="php-var">$mail</span>-&gt;send(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Mail'</span>));
</span><span id="2450" class="l"><a class="l" href="#2450">2450: </a>                <span class="php-var">$notification</span>-&gt;push(
</span><span id="2451" class="l"><a class="l" href="#2451">2451: </a>                    <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;The event notification to %s was successfully sent.&quot;</span>), <span class="php-var">$recipient</span>),
</span><span id="2452" class="l"><a class="l" href="#2452">2452: </a>                    <span class="php-quote">'horde.success'</span>
</span><span id="2453" class="l"><a class="l" href="#2453">2453: </a>                );
</span><span id="2454" class="l"><a class="l" href="#2454">2454: </a>            } <span class="php-keyword1">catch</span> (Horde_Mime_Exception <span class="php-var">$e</span>) {
</span><span id="2455" class="l"><a class="l" href="#2455">2455: </a>                <span class="php-var">$notification</span>-&gt;push(
</span><span id="2456" class="l"><a class="l" href="#2456">2456: </a>                    <span class="php-keyword2">sprintf</span>(_(<span class="php-quote">&quot;There was an error sending an event notification to %s: %s&quot;</span>), <span class="php-var">$recipient</span>, <span class="php-var">$e</span>-&gt;getMessage(), <span class="php-var">$e</span>-&gt;getCode()),
</span><span id="2457" class="l"><a class="l" href="#2457">2457: </a>                    <span class="php-quote">'horde.error'</span>
</span><span id="2458" class="l"><a class="l" href="#2458">2458: </a>                );
</span><span id="2459" class="l"><a class="l" href="#2459">2459: </a>            }
</span><span id="2460" class="l"><a class="l" href="#2460">2460: </a>        }
</span><span id="2461" class="l"><a class="l" href="#2461">2461: </a>    }
</span><span id="2462" class="l"><a class="l" href="#2462">2462: </a>
</span><span id="2463" class="l"><a class="l" href="#2463">2463: </a>    <span class="php-comment">/**
</span></span><span id="2464" class="l"><a class="l" href="#2464">2464: </a><span class="php-comment">     * Sends email notifications that a event has been added, edited, or
</span></span><span id="2465" class="l"><a class="l" href="#2465">2465: </a><span class="php-comment">     * deleted to users that want such notifications.
</span></span><span id="2466" class="l"><a class="l" href="#2466">2466: </a><span class="php-comment">     *
</span></span><span id="2467" class="l"><a class="l" href="#2467">2467: </a><span class="php-comment">     * @param Kronolith_Event $event  An event.
</span></span><span id="2468" class="l"><a class="l" href="#2468">2468: </a><span class="php-comment">     * @param string $action          The event action. One of &quot;add&quot;, &quot;edit&quot;,
</span></span><span id="2469" class="l"><a class="l" href="#2469">2469: </a><span class="php-comment">     *                                or &quot;delete&quot;.
</span></span><span id="2470" class="l"><a class="l" href="#2470">2470: </a><span class="php-comment">     *
</span></span><span id="2471" class="l"><a class="l" href="#2471">2471: </a><span class="php-comment">     * @throws Horde_Mime_Exception
</span></span><span id="2472" class="l"><a class="l" href="#2472">2472: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="2473" class="l"><a class="l" href="#2473">2473: </a><span class="php-comment">     */</span>
</span><span id="2474" class="l"><a class="l" href="#2474">2474: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_sendNotification" href="#_sendNotification">sendNotification</a>(<span class="php-var">$event</span>, <span class="php-var">$action</span>)
</span><span id="2475" class="l"><a class="l" href="#2475">2475: </a>    {
</span><span id="2476" class="l"><a class="l" href="#2476">2476: </a>        <span class="php-keyword1">global</span> <span class="php-var">$conf</span>;
</span><span id="2477" class="l"><a class="l" href="#2477">2477: </a>
</span><span id="2478" class="l"><a class="l" href="#2478">2478: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">in_array</span>(<span class="php-var">$action</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'add'</span>, <span class="php-quote">'edit'</span>, <span class="php-quote">'delete'</span>))) {
</span><span id="2479" class="l"><a class="l" href="#2479">2479: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-quote">'Unknown event action: '</span> . <span class="php-var">$action</span>);
</span><span id="2480" class="l"><a class="l" href="#2480">2480: </a>        }
</span><span id="2481" class="l"><a class="l" href="#2481">2481: </a>
</span><span id="2482" class="l"><a class="l" href="#2482">2482: </a>        <span class="php-var">$groups</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Group'</span>);
</span><span id="2483" class="l"><a class="l" href="#2483">2483: </a>        <span class="php-var">$calendar</span> = <span class="php-var">$event</span>-&gt;calendar;
</span><span id="2484" class="l"><a class="l" href="#2484">2484: </a>        <span class="php-var">$recipients</span> = <span class="php-keyword1">array</span>();
</span><span id="2485" class="l"><a class="l" href="#2485">2485: </a>        <span class="php-keyword1">try</span> {
</span><span id="2486" class="l"><a class="l" href="#2486">2486: </a>            <span class="php-var">$share</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;getShare(<span class="php-var">$calendar</span>);
</span><span id="2487" class="l"><a class="l" href="#2487">2487: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="2488" class="l"><a class="l" href="#2488">2488: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-var">$e</span>);
</span><span id="2489" class="l"><a class="l" href="#2489">2489: </a>        }
</span><span id="2490" class="l"><a class="l" href="#2490">2490: </a>
</span><span id="2491" class="l"><a class="l" href="#2491">2491: </a>        <span class="php-var">$senderIdentity</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)-&gt;create();
</span><span id="2492" class="l"><a class="l" href="#2492">2492: </a>
</span><span id="2493" class="l"><a class="l" href="#2493">2493: </a>        <span class="php-var">$owner</span> = <span class="php-var">$share</span>-&gt;get(<span class="php-quote">'owner'</span>);
</span><span id="2494" class="l"><a class="l" href="#2494">2494: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$owner</span>) {
</span><span id="2495" class="l"><a class="l" href="#2495">2495: </a>            <span class="php-var">$recipients</span>[<span class="php-var">$owner</span>] = self::_notificationPref(<span class="php-var">$owner</span>, <span class="php-quote">'owner'</span>);
</span><span id="2496" class="l"><a class="l" href="#2496">2496: </a>        }
</span><span id="2497" class="l"><a class="l" href="#2497">2497: </a>
</span><span id="2498" class="l"><a class="l" href="#2498">2498: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$share</span>-&gt;listUsers(Horde_Perms::READ) <span class="php-keyword1">as</span> <span class="php-var">$user</span>) {
</span><span id="2499" class="l"><a class="l" href="#2499">2499: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$recipients</span>[<span class="php-var">$user</span>])) {
</span><span id="2500" class="l"><a class="l" href="#2500">2500: </a>                <span class="php-var">$recipients</span>[<span class="php-var">$user</span>] = self::_notificationPref(<span class="php-var">$user</span>, <span class="php-quote">'read'</span>, <span class="php-var">$calendar</span>);
</span><span id="2501" class="l"><a class="l" href="#2501">2501: </a>            }
</span><span id="2502" class="l"><a class="l" href="#2502">2502: </a>        }
</span><span id="2503" class="l"><a class="l" href="#2503">2503: </a>
</span><span id="2504" class="l"><a class="l" href="#2504">2504: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$share</span>-&gt;listGroups(Horde_Perms::READ) <span class="php-keyword1">as</span> <span class="php-var">$group</span>) {
</span><span id="2505" class="l"><a class="l" href="#2505">2505: </a>            <span class="php-keyword1">try</span> {
</span><span id="2506" class="l"><a class="l" href="#2506">2506: </a>                <span class="php-var">$group_users</span> = <span class="php-var">$groups</span>-&gt;listUsers(<span class="php-var">$group</span>);
</span><span id="2507" class="l"><a class="l" href="#2507">2507: </a>            } <span class="php-keyword1">catch</span> (Horde_Group_Exception <span class="php-var">$e</span>) {
</span><span id="2508" class="l"><a class="l" href="#2508">2508: </a>                Horde::logMessage(<span class="php-var">$e</span>, <span class="php-quote">'ERR'</span>);
</span><span id="2509" class="l"><a class="l" href="#2509">2509: </a>                <span class="php-keyword1">continue</span>;
</span><span id="2510" class="l"><a class="l" href="#2510">2510: </a>            }
</span><span id="2511" class="l"><a class="l" href="#2511">2511: </a>
</span><span id="2512" class="l"><a class="l" href="#2512">2512: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$group_users</span> <span class="php-keyword1">as</span> <span class="php-var">$user</span>) {
</span><span id="2513" class="l"><a class="l" href="#2513">2513: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$recipients</span>[<span class="php-var">$user</span>])) {
</span><span id="2514" class="l"><a class="l" href="#2514">2514: </a>                    <span class="php-var">$recipients</span>[<span class="php-var">$user</span>] = self::_notificationPref(<span class="php-var">$user</span>, <span class="php-quote">'read'</span>, <span class="php-var">$calendar</span>);
</span><span id="2515" class="l"><a class="l" href="#2515">2515: </a>                }
</span><span id="2516" class="l"><a class="l" href="#2516">2516: </a>            }
</span><span id="2517" class="l"><a class="l" href="#2517">2517: </a>        }
</span><span id="2518" class="l"><a class="l" href="#2518">2518: </a>
</span><span id="2519" class="l"><a class="l" href="#2519">2519: </a>        <span class="php-var">$addresses</span> = <span class="php-keyword1">array</span>();
</span><span id="2520" class="l"><a class="l" href="#2520">2520: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$recipients</span> <span class="php-keyword1">as</span> <span class="php-var">$user</span> =&gt; <span class="php-var">$vals</span>) {
</span><span id="2521" class="l"><a class="l" href="#2521">2521: </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$vals</span>) {
</span><span id="2522" class="l"><a class="l" href="#2522">2522: </a>                <span class="php-keyword1">continue</span>;
</span><span id="2523" class="l"><a class="l" href="#2523">2523: </a>            }
</span><span id="2524" class="l"><a class="l" href="#2524">2524: </a>            <span class="php-var">$identity</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Identity'</span>)-&gt;create(<span class="php-var">$user</span>);
</span><span id="2525" class="l"><a class="l" href="#2525">2525: </a>            <span class="php-var">$email</span> = <span class="php-var">$identity</span>-&gt;getValue(<span class="php-quote">'from_addr'</span>);
</span><span id="2526" class="l"><a class="l" href="#2526">2526: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">strpos</span>(<span class="php-var">$email</span>, <span class="php-quote">'@'</span>) === <span class="php-keyword1">false</span>) {
</span><span id="2527" class="l"><a class="l" href="#2527">2527: </a>                <span class="php-keyword1">continue</span>;
</span><span id="2528" class="l"><a class="l" href="#2528">2528: </a>            }
</span><span id="2529" class="l"><a class="l" href="#2529">2529: </a>            <span class="php-keyword1">list</span>(<span class="php-var">$mailbox</span>, <span class="php-var">$host</span>) = <span class="php-keyword2">explode</span>(<span class="php-quote">'@'</span>, <span class="php-var">$email</span>);
</span><span id="2530" class="l"><a class="l" href="#2530">2530: </a>            <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$addresses</span>[<span class="php-var">$vals</span>[<span class="php-quote">'lang'</span>]][<span class="php-var">$vals</span>[<span class="php-quote">'tf'</span>]][<span class="php-var">$vals</span>[<span class="php-quote">'df'</span>]])) {
</span><span id="2531" class="l"><a class="l" href="#2531">2531: </a>                <span class="php-var">$addresses</span>[<span class="php-var">$vals</span>[<span class="php-quote">'lang'</span>]][<span class="php-var">$vals</span>[<span class="php-quote">'tf'</span>]][<span class="php-var">$vals</span>[<span class="php-quote">'df'</span>]] = <span class="php-keyword1">array</span>();
</span><span id="2532" class="l"><a class="l" href="#2532">2532: </a>            }
</span><span id="2533" class="l"><a class="l" href="#2533">2533: </a>            <span class="php-var">$addresses</span>[<span class="php-var">$vals</span>[<span class="php-quote">'lang'</span>]][<span class="php-var">$vals</span>[<span class="php-quote">'tf'</span>]][<span class="php-var">$vals</span>[<span class="php-quote">'df'</span>]][] = Horde_Mime_Address::writeAddress(<span class="php-var">$mailbox</span>, <span class="php-var">$host</span>, <span class="php-var">$identity</span>-&gt;getValue(<span class="php-quote">'fullname'</span>));
</span><span id="2534" class="l"><a class="l" href="#2534">2534: </a>        }
</span><span id="2535" class="l"><a class="l" href="#2535">2535: </a>
</span><span id="2536" class="l"><a class="l" href="#2536">2536: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$addresses</span>) {
</span><span id="2537" class="l"><a class="l" href="#2537">2537: </a>            <span class="php-keyword1">return</span>;
</span><span id="2538" class="l"><a class="l" href="#2538">2538: </a>        }
</span><span id="2539" class="l"><a class="l" href="#2539">2539: </a>
</span><span id="2540" class="l"><a class="l" href="#2540">2540: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$addresses</span> <span class="php-keyword1">as</span> <span class="php-var">$lang</span> =&gt; <span class="php-var">$twentyFour</span>) {
</span><span id="2541" class="l"><a class="l" href="#2541">2541: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;setLanguageEnvironment(<span class="php-var">$lang</span>);
</span><span id="2542" class="l"><a class="l" href="#2542">2542: </a>
</span><span id="2543" class="l"><a class="l" href="#2543">2543: </a>            <span class="php-keyword1">switch</span> (<span class="php-var">$action</span>) {
</span><span id="2544" class="l"><a class="l" href="#2544">2544: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'add'</span>:
</span><span id="2545" class="l"><a class="l" href="#2545">2545: </a>                <span class="php-var">$subject</span> = _(<span class="php-quote">&quot;Event added:&quot;</span>);
</span><span id="2546" class="l"><a class="l" href="#2546">2546: </a>                <span class="php-var">$notification_message</span> = _(<span class="php-quote">&quot;You requested to be notified when events are added to your calendars.&quot;</span>) . <span class="php-quote">&quot;\n\n&quot;</span> . _(<span class="php-quote">&quot;The event \&quot;%s\&quot; has been added to \&quot;%s\&quot; calendar, which is on %s at %s.&quot;</span>);
</span><span id="2547" class="l"><a class="l" href="#2547">2547: </a>                <span class="php-keyword1">break</span>;
</span><span id="2548" class="l"><a class="l" href="#2548">2548: </a>
</span><span id="2549" class="l"><a class="l" href="#2549">2549: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'edit'</span>:
</span><span id="2550" class="l"><a class="l" href="#2550">2550: </a>                <span class="php-var">$subject</span> = _(<span class="php-quote">&quot;Event edited:&quot;</span>);
</span><span id="2551" class="l"><a class="l" href="#2551">2551: </a>                <span class="php-var">$notification_message</span> = _(<span class="php-quote">&quot;You requested to be notified when events are edited in your calendars.&quot;</span>) . <span class="php-quote">&quot;\n\n&quot;</span> . _(<span class="php-quote">&quot;The event \&quot;%s\&quot; has been edited on \&quot;%s\&quot; calendar, which is on %s at %s.&quot;</span>);
</span><span id="2552" class="l"><a class="l" href="#2552">2552: </a>                <span class="php-keyword1">break</span>;
</span><span id="2553" class="l"><a class="l" href="#2553">2553: </a>
</span><span id="2554" class="l"><a class="l" href="#2554">2554: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'delete'</span>:
</span><span id="2555" class="l"><a class="l" href="#2555">2555: </a>                <span class="php-var">$subject</span> = _(<span class="php-quote">&quot;Event deleted:&quot;</span>);
</span><span id="2556" class="l"><a class="l" href="#2556">2556: </a>                <span class="php-var">$notification_message</span> = _(<span class="php-quote">&quot;You requested to be notified when events are deleted from your calendars.&quot;</span>) . <span class="php-quote">&quot;\n\n&quot;</span> . _(<span class="php-quote">&quot;The event \&quot;%s\&quot; has been deleted from \&quot;%s\&quot; calendar, which was on %s at %s.&quot;</span>);
</span><span id="2557" class="l"><a class="l" href="#2557">2557: </a>                <span class="php-keyword1">break</span>;
</span><span id="2558" class="l"><a class="l" href="#2558">2558: </a>            }
</span><span id="2559" class="l"><a class="l" href="#2559">2559: </a>
</span><span id="2560" class="l"><a class="l" href="#2560">2560: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$twentyFour</span> <span class="php-keyword1">as</span> <span class="php-var">$tf</span> =&gt; <span class="php-var">$dateFormat</span>) {
</span><span id="2561" class="l"><a class="l" href="#2561">2561: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$dateFormat</span> <span class="php-keyword1">as</span> <span class="php-var">$df</span> =&gt; <span class="php-var">$df_recipients</span>) {
</span><span id="2562" class="l"><a class="l" href="#2562">2562: </a>                    <span class="php-var">$message</span> = <span class="php-quote">&quot;\n&quot;</span>
</span><span id="2563" class="l"><a class="l" href="#2563">2563: </a>                        . <span class="php-keyword2">sprintf</span>(<span class="php-var">$notification_message</span>,
</span><span id="2564" class="l"><a class="l" href="#2564">2564: </a>                                  <span class="php-var">$event</span>-&gt;title,
</span><span id="2565" class="l"><a class="l" href="#2565">2565: </a>                                  <span class="php-var">$share</span>-&gt;get(<span class="php-quote">'name'</span>),
</span><span id="2566" class="l"><a class="l" href="#2566">2566: </a>                                  <span class="php-var">$event</span>-&gt;start-&gt;<span class="php-keyword2">strftime</span>(<span class="php-var">$df</span>),
</span><span id="2567" class="l"><a class="l" href="#2567">2567: </a>                                  <span class="php-var">$event</span>-&gt;start-&gt;<span class="php-keyword2">strftime</span>(<span class="php-var">$tf</span> ? <span class="php-quote">'%R'</span> : <span class="php-quote">'%I:%M%p'</span>))
</span><span id="2568" class="l"><a class="l" href="#2568">2568: </a>                        . <span class="php-quote">&quot;\n\n&quot;</span> . <span class="php-var">$event</span>-&gt;description;
</span><span id="2569" class="l"><a class="l" href="#2569">2569: </a>
</span><span id="2570" class="l"><a class="l" href="#2570">2570: </a>                    <span class="php-var">$mime_mail</span> = <span class="php-keyword1">new</span> Horde_Mime_Mail(<span class="php-keyword1">array</span>(
</span><span id="2571" class="l"><a class="l" href="#2571">2571: </a>                        <span class="php-quote">'Subject'</span> =&gt; <span class="php-var">$subject</span> . <span class="php-quote">' '</span> . <span class="php-var">$event</span>-&gt;title,
</span><span id="2572" class="l"><a class="l" href="#2572">2572: </a>                        <span class="php-quote">'To'</span> =&gt; <span class="php-keyword2">implode</span>(<span class="php-quote">','</span>, <span class="php-var">$df_recipients</span>),
</span><span id="2573" class="l"><a class="l" href="#2573">2573: </a>                        <span class="php-quote">'From'</span> =&gt; <span class="php-var">$senderIdentity</span>-&gt;getDefaultFromAddress(<span class="php-keyword1">true</span>),
</span><span id="2574" class="l"><a class="l" href="#2574">2574: </a>                        <span class="php-quote">'User-Agent'</span> =&gt; <span class="php-quote">'Kronolith '</span> . <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getVersion(),
</span><span id="2575" class="l"><a class="l" href="#2575">2575: </a>                        <span class="php-quote">'body'</span> =&gt; <span class="php-var">$message</span>));
</span><span id="2576" class="l"><a class="l" href="#2576">2576: </a>                    Horde::logMessage(<span class="php-keyword2">sprintf</span>(<span class="php-quote">'Sending event notifications for %s to %s'</span>, <span class="php-var">$event</span>-&gt;title, <span class="php-keyword2">implode</span>(<span class="php-quote">', '</span>, <span class="php-var">$df_recipients</span>)), <span class="php-quote">'DEBUG'</span>);
</span><span id="2577" class="l"><a class="l" href="#2577">2577: </a>                    <span class="php-var">$mime_mail</span>-&gt;send(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Mail'</span>));
</span><span id="2578" class="l"><a class="l" href="#2578">2578: </a>                }
</span><span id="2579" class="l"><a class="l" href="#2579">2579: </a>            }
</span><span id="2580" class="l"><a class="l" href="#2580">2580: </a>        }
</span><span id="2581" class="l"><a class="l" href="#2581">2581: </a>    }
</span><span id="2582" class="l"><a class="l" href="#2582">2582: </a>
</span><span id="2583" class="l"><a class="l" href="#2583">2583: </a>    <span class="php-comment">/**
</span></span><span id="2584" class="l"><a class="l" href="#2584">2584: </a><span class="php-comment">     * Check for resource declines and push notice to stack if found.
</span></span><span id="2585" class="l"><a class="l" href="#2585">2585: </a><span class="php-comment">     *
</span></span><span id="2586" class="l"><a class="l" href="#2586">2586: </a><span class="php-comment">     * @param Kronolith_Event $event
</span></span><span id="2587" class="l"><a class="l" href="#2587">2587: </a><span class="php-comment">     *
</span></span><span id="2588" class="l"><a class="l" href="#2588">2588: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="2589" class="l"><a class="l" href="#2589">2589: </a><span class="php-comment">     */</span>
</span><span id="2590" class="l"><a class="l" href="#2590">2590: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_notifyOfResourceRejection" href="#_notifyOfResourceRejection">notifyOfResourceRejection</a>(<span class="php-var">$event</span>)
</span><span id="2591" class="l"><a class="l" href="#2591">2591: </a>    {
</span><span id="2592" class="l"><a class="l" href="#2592">2592: </a>        <span class="php-var">$declined</span> = <span class="php-keyword1">array</span>();
</span><span id="2593" class="l"><a class="l" href="#2593">2593: </a>        <span class="php-var">$accepted</span> = <span class="php-keyword1">array</span>();
</span><span id="2594" class="l"><a class="l" href="#2594">2594: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$event</span>-&gt;getResources() <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$resource</span>) {
</span><span id="2595" class="l"><a class="l" href="#2595">2595: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$resource</span>[<span class="php-quote">'response'</span>] == self::RESPONSE_DECLINED) {
</span><span id="2596" class="l"><a class="l" href="#2596">2596: </a>                <span class="php-var">$r</span> = self::getDriver(<span class="php-quote">'Resource'</span>)-&gt;getResource(<span class="php-var">$id</span>);
</span><span id="2597" class="l"><a class="l" href="#2597">2597: </a>                <span class="php-var">$declined</span>[] = <span class="php-var">$r</span>-&gt;get(<span class="php-quote">'name'</span>);
</span><span id="2598" class="l"><a class="l" href="#2598">2598: </a>            } <span class="php-keyword1">elseif</span> (<span class="php-var">$resource</span>[<span class="php-quote">'response'</span>] == self::RESPONSE_ACCEPTED) {
</span><span id="2599" class="l"><a class="l" href="#2599">2599: </a>                <span class="php-var">$r</span> = self::getDriver(<span class="php-quote">'Resource'</span>)-&gt;getResource(<span class="php-var">$id</span>);
</span><span id="2600" class="l"><a class="l" href="#2600">2600: </a>                <span class="php-var">$accepted</span>[] = <span class="php-var">$r</span>-&gt;get(<span class="php-quote">'name'</span>);
</span><span id="2601" class="l"><a class="l" href="#2601">2601: </a>            }
</span><span id="2602" class="l"><a class="l" href="#2602">2602: </a>
</span><span id="2603" class="l"><a class="l" href="#2603">2603: </a>
</span><span id="2604" class="l"><a class="l" href="#2604">2604: </a>        }
</span><span id="2605" class="l"><a class="l" href="#2605">2605: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$declined</span>)) {
</span><span id="2606" class="l"><a class="l" href="#2606">2606: </a>            <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-keyword2">sprintf</span>(<span class="php-keyword2">ngettext</span>(<span class="php-quote">&quot;The following resource has declined your request: %s&quot;</span>,
</span><span id="2607" class="l"><a class="l" href="#2607">2607: </a>                                                            <span class="php-quote">&quot;The following resources have declined your request: %s&quot;</span>,
</span><span id="2608" class="l"><a class="l" href="#2608">2608: </a>                                                            <span class="php-keyword2">count</span>(<span class="php-var">$declined</span>)),
</span><span id="2609" class="l"><a class="l" href="#2609">2609: </a>                                                    <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-var">$declined</span>)),
</span><span id="2610" class="l"><a class="l" href="#2610">2610: </a>                                           <span class="php-quote">'horde.error'</span>);
</span><span id="2611" class="l"><a class="l" href="#2611">2611: </a>        }
</span><span id="2612" class="l"><a class="l" href="#2612">2612: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$accepted</span>)) {
</span><span id="2613" class="l"><a class="l" href="#2613">2613: </a>             <span class="php-var">$GLOBALS</span>[<span class="php-quote">'notification'</span>]-&gt;push(<span class="php-keyword2">sprintf</span>(<span class="php-keyword2">ngettext</span>(<span class="php-quote">&quot;The following resource has accepted your request: %s&quot;</span>,
</span><span id="2614" class="l"><a class="l" href="#2614">2614: </a>                                                            <span class="php-quote">&quot;The following resources have accepted your request: %s&quot;</span>,
</span><span id="2615" class="l"><a class="l" href="#2615">2615: </a>                                                            <span class="php-keyword2">count</span>(<span class="php-var">$accepted</span>)),
</span><span id="2616" class="l"><a class="l" href="#2616">2616: </a>                                                    <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-var">$accepted</span>)),
</span><span id="2617" class="l"><a class="l" href="#2617">2617: </a>                                           <span class="php-quote">'horde.success'</span>);
</span><span id="2618" class="l"><a class="l" href="#2618">2618: </a>        }
</span><span id="2619" class="l"><a class="l" href="#2619">2619: </a>    }
</span><span id="2620" class="l"><a class="l" href="#2620">2620: </a>
</span><span id="2621" class="l"><a class="l" href="#2621">2621: </a>    <span class="php-comment">/**
</span></span><span id="2622" class="l"><a class="l" href="#2622">2622: </a><span class="php-comment">     * Returns whether a user wants email notifications for a calendar.
</span></span><span id="2623" class="l"><a class="l" href="#2623">2623: </a><span class="php-comment">     *
</span></span><span id="2624" class="l"><a class="l" href="#2624">2624: </a><span class="php-comment">     * @access private
</span></span><span id="2625" class="l"><a class="l" href="#2625">2625: </a><span class="php-comment">     *
</span></span><span id="2626" class="l"><a class="l" href="#2626">2626: </a><span class="php-comment">     * @todo This method is causing a memory leak somewhere, noticeable if
</span></span><span id="2627" class="l"><a class="l" href="#2627">2627: </a><span class="php-comment">     *       importing a large amount of events.
</span></span><span id="2628" class="l"><a class="l" href="#2628">2628: </a><span class="php-comment">     *
</span></span><span id="2629" class="l"><a class="l" href="#2629">2629: </a><span class="php-comment">     * @param string $user      A user name.
</span></span><span id="2630" class="l"><a class="l" href="#2630">2630: </a><span class="php-comment">     * @param string $mode      The check &quot;mode&quot;. If &quot;owner&quot;, the method checks
</span></span><span id="2631" class="l"><a class="l" href="#2631">2631: </a><span class="php-comment">     *                          if the user wants notifications only for
</span></span><span id="2632" class="l"><a class="l" href="#2632">2632: </a><span class="php-comment">     *                          calendars he owns. If &quot;read&quot;, the method checks
</span></span><span id="2633" class="l"><a class="l" href="#2633">2633: </a><span class="php-comment">     *                          if the user wants notifications for all
</span></span><span id="2634" class="l"><a class="l" href="#2634">2634: </a><span class="php-comment">     *                          calendars he has read access to, or only for
</span></span><span id="2635" class="l"><a class="l" href="#2635">2635: </a><span class="php-comment">     *                          shown calendars and the specified calendar is
</span></span><span id="2636" class="l"><a class="l" href="#2636">2636: </a><span class="php-comment">     *                          currently shown.
</span></span><span id="2637" class="l"><a class="l" href="#2637">2637: </a><span class="php-comment">     * @param string $calendar  The name of the calendar if mode is &quot;read&quot;.
</span></span><span id="2638" class="l"><a class="l" href="#2638">2638: </a><span class="php-comment">     *
</span></span><span id="2639" class="l"><a class="l" href="#2639">2639: </a><span class="php-comment">     * @return mixed  The user's email, time, and language preferences if they
</span></span><span id="2640" class="l"><a class="l" href="#2640">2640: </a><span class="php-comment">     *                want a notification for this calendar.
</span></span><span id="2641" class="l"><a class="l" href="#2641">2641: </a><span class="php-comment">     */</span>
</span><span id="2642" class="l"><a class="l" href="#2642">2642: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="__notificationPref" href="#__notificationPref">_notificationPref</a>(<span class="php-var">$user</span>, <span class="php-var">$mode</span>, <span class="php-var">$calendar</span> = <span class="php-keyword1">null</span>)
</span><span id="2643" class="l"><a class="l" href="#2643">2643: </a>    {
</span><span id="2644" class="l"><a class="l" href="#2644">2644: </a>        <span class="php-var">$prefs</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Prefs'</span>)-&gt;create(<span class="php-quote">'kronolith'</span>, <span class="php-keyword1">array</span>(
</span><span id="2645" class="l"><a class="l" href="#2645">2645: </a>            <span class="php-quote">'cache'</span> =&gt; <span class="php-keyword1">false</span>,
</span><span id="2646" class="l"><a class="l" href="#2646">2646: </a>            <span class="php-quote">'user'</span> =&gt; <span class="php-var">$user</span>
</span><span id="2647" class="l"><a class="l" href="#2647">2647: </a>        ));
</span><span id="2648" class="l"><a class="l" href="#2648">2648: </a>        <span class="php-var">$vals</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'lang'</span> =&gt; <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'language'</span>),
</span><span id="2649" class="l"><a class="l" href="#2649">2649: </a>                      <span class="php-quote">'tf'</span> =&gt; <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'twentyFour'</span>),
</span><span id="2650" class="l"><a class="l" href="#2650">2650: </a>                      <span class="php-quote">'df'</span> =&gt; <span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'date_format'</span>));
</span><span id="2651" class="l"><a class="l" href="#2651">2651: </a>
</span><span id="2652" class="l"><a class="l" href="#2652">2652: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'event_notification_exclude_self'</span>) &amp;&amp;
</span><span id="2653" class="l"><a class="l" href="#2653">2653: </a>            <span class="php-var">$user</span> == <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth()) {
</span><span id="2654" class="l"><a class="l" href="#2654">2654: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="2655" class="l"><a class="l" href="#2655">2655: </a>        }
</span><span id="2656" class="l"><a class="l" href="#2656">2656: </a>
</span><span id="2657" class="l"><a class="l" href="#2657">2657: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'event_notification'</span>)) {
</span><span id="2658" class="l"><a class="l" href="#2658">2658: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'owner'</span>:
</span><span id="2659" class="l"><a class="l" href="#2659">2659: </a>            <span class="php-keyword1">return</span> <span class="php-var">$mode</span> == <span class="php-quote">'owner'</span> ? <span class="php-var">$vals</span> : <span class="php-keyword1">false</span>;
</span><span id="2660" class="l"><a class="l" href="#2660">2660: </a>
</span><span id="2661" class="l"><a class="l" href="#2661">2661: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'read'</span>:
</span><span id="2662" class="l"><a class="l" href="#2662">2662: </a>            <span class="php-keyword1">return</span> <span class="php-var">$mode</span> == <span class="php-quote">'read'</span> ? <span class="php-var">$vals</span> : <span class="php-keyword1">false</span>;
</span><span id="2663" class="l"><a class="l" href="#2663">2663: </a>
</span><span id="2664" class="l"><a class="l" href="#2664">2664: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'show'</span>:
</span><span id="2665" class="l"><a class="l" href="#2665">2665: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$mode</span> == <span class="php-quote">'read'</span>) {
</span><span id="2666" class="l"><a class="l" href="#2666">2666: </a>                <span class="php-var">$display_calendars</span> = <span class="php-keyword2">unserialize</span>(<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'display_cals'</span>));
</span><span id="2667" class="l"><a class="l" href="#2667">2667: </a>                <span class="php-keyword1">return</span> <span class="php-keyword2">in_array</span>(<span class="php-var">$calendar</span>, <span class="php-var">$display_calendars</span>) ? <span class="php-var">$vals</span> : <span class="php-keyword1">false</span>;
</span><span id="2668" class="l"><a class="l" href="#2668">2668: </a>            }
</span><span id="2669" class="l"><a class="l" href="#2669">2669: </a>        }
</span><span id="2670" class="l"><a class="l" href="#2670">2670: </a>
</span><span id="2671" class="l"><a class="l" href="#2671">2671: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="2672" class="l"><a class="l" href="#2672">2672: </a>    }
</span><span id="2673" class="l"><a class="l" href="#2673">2673: </a>
</span><span id="2674" class="l"><a class="l" href="#2674">2674: </a>    <span class="php-comment">/**
</span></span><span id="2675" class="l"><a class="l" href="#2675">2675: </a><span class="php-comment">     * Builds the body MIME part of a multipart message.
</span></span><span id="2676" class="l"><a class="l" href="#2676">2676: </a><span class="php-comment">     *
</span></span><span id="2677" class="l"><a class="l" href="#2677">2677: </a><span class="php-comment">     * @param Horde_View $view        A view to render the HTML and plain text
</span></span><span id="2678" class="l"><a class="l" href="#2678">2678: </a><span class="php-comment">     *                                templates for the messate.
</span></span><span id="2679" class="l"><a class="l" href="#2679">2679: </a><span class="php-comment">     * @param string $template        The template base name for the view.
</span></span><span id="2680" class="l"><a class="l" href="#2680">2680: </a><span class="php-comment">     * @param Horde_Mime_Part $image  The MIME part of a related image.
</span></span><span id="2681" class="l"><a class="l" href="#2681">2681: </a><span class="php-comment">     *
</span></span><span id="2682" class="l"><a class="l" href="#2682">2682: </a><span class="php-comment">     * @return Horde_Mime_Part  A multipart/alternative MIME part.
</span></span><span id="2683" class="l"><a class="l" href="#2683">2683: </a><span class="php-comment">     */</span>
</span><span id="2684" class="l"><a class="l" href="#2684">2684: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_buildMimeMessage" href="#_buildMimeMessage">buildMimeMessage</a>(Horde_View <span class="php-var">$view</span>, <span class="php-var">$template</span>,
</span><span id="2685" class="l"><a class="l" href="#2685">2685: </a>                                            Horde_Mime_Part <span class="php-var">$image</span>)
</span><span id="2686" class="l"><a class="l" href="#2686">2686: </a>    {
</span><span id="2687" class="l"><a class="l" href="#2687">2687: </a>        <span class="php-var">$multipart</span> = <span class="php-keyword1">new</span> Horde_Mime_Part();
</span><span id="2688" class="l"><a class="l" href="#2688">2688: </a>        <span class="php-var">$multipart</span>-&gt;<span class="php-keyword2">setType</span>(<span class="php-quote">'multipart/alternative'</span>);
</span><span id="2689" class="l"><a class="l" href="#2689">2689: </a>        <span class="php-var">$bodyText</span> = <span class="php-keyword1">new</span> Horde_Mime_Part();
</span><span id="2690" class="l"><a class="l" href="#2690">2690: </a>        <span class="php-var">$bodyText</span>-&gt;<span class="php-keyword2">setType</span>(<span class="php-quote">'text/plain'</span>);
</span><span id="2691" class="l"><a class="l" href="#2691">2691: </a>        <span class="php-var">$bodyText</span>-&gt;setCharset(<span class="php-quote">'UTF-8'</span>);
</span><span id="2692" class="l"><a class="l" href="#2692">2692: </a>        <span class="php-var">$bodyText</span>-&gt;setContents(<span class="php-var">$view</span>-&gt;render(<span class="php-var">$template</span> . <span class="php-quote">'.plain.php'</span>));
</span><span id="2693" class="l"><a class="l" href="#2693">2693: </a>        <span class="php-var">$bodyText</span>-&gt;setDisposition(<span class="php-quote">'inline'</span>);
</span><span id="2694" class="l"><a class="l" href="#2694">2694: </a>        <span class="php-var">$multipart</span>-&gt;addPart(<span class="php-var">$bodyText</span>);
</span><span id="2695" class="l"><a class="l" href="#2695">2695: </a>        <span class="php-var">$bodyHtml</span> = <span class="php-keyword1">new</span> Horde_Mime_Part();
</span><span id="2696" class="l"><a class="l" href="#2696">2696: </a>        <span class="php-var">$bodyHtml</span>-&gt;<span class="php-keyword2">setType</span>(<span class="php-quote">'text/html'</span>);
</span><span id="2697" class="l"><a class="l" href="#2697">2697: </a>        <span class="php-var">$bodyHtml</span>-&gt;setCharset(<span class="php-quote">'UTF-8'</span>);
</span><span id="2698" class="l"><a class="l" href="#2698">2698: </a>        <span class="php-var">$bodyHtml</span>-&gt;setContents(<span class="php-var">$view</span>-&gt;render(<span class="php-var">$template</span> . <span class="php-quote">'.html.php'</span>));
</span><span id="2699" class="l"><a class="l" href="#2699">2699: </a>        <span class="php-var">$bodyHtml</span>-&gt;setDisposition(<span class="php-quote">'inline'</span>);
</span><span id="2700" class="l"><a class="l" href="#2700">2700: </a>        <span class="php-var">$related</span> = <span class="php-keyword1">new</span> Horde_Mime_Part();
</span><span id="2701" class="l"><a class="l" href="#2701">2701: </a>        <span class="php-var">$related</span>-&gt;<span class="php-keyword2">setType</span>(<span class="php-quote">'multipart/related'</span>);
</span><span id="2702" class="l"><a class="l" href="#2702">2702: </a>        <span class="php-var">$related</span>-&gt;setContentTypeParameter(<span class="php-quote">'start'</span>, <span class="php-var">$bodyHtml</span>-&gt;setContentId());
</span><span id="2703" class="l"><a class="l" href="#2703">2703: </a>        <span class="php-var">$related</span>-&gt;addPart(<span class="php-var">$bodyHtml</span>);
</span><span id="2704" class="l"><a class="l" href="#2704">2704: </a>        <span class="php-var">$related</span>-&gt;addPart(<span class="php-var">$image</span>);
</span><span id="2705" class="l"><a class="l" href="#2705">2705: </a>        <span class="php-var">$multipart</span>-&gt;addPart(<span class="php-var">$related</span>);
</span><span id="2706" class="l"><a class="l" href="#2706">2706: </a>        <span class="php-keyword1">return</span> <span class="php-var">$multipart</span>;
</span><span id="2707" class="l"><a class="l" href="#2707">2707: </a>    }
</span><span id="2708" class="l"><a class="l" href="#2708">2708: </a>
</span><span id="2709" class="l"><a class="l" href="#2709">2709: </a>    <span class="php-comment">/**
</span></span><span id="2710" class="l"><a class="l" href="#2710">2710: </a><span class="php-comment">     * Returns a MIME part for an image to be embedded into a HTML document.
</span></span><span id="2711" class="l"><a class="l" href="#2711">2711: </a><span class="php-comment">     *
</span></span><span id="2712" class="l"><a class="l" href="#2712">2712: </a><span class="php-comment">     * @param string $file  An image file name.
</span></span><span id="2713" class="l"><a class="l" href="#2713">2713: </a><span class="php-comment">     *
</span></span><span id="2714" class="l"><a class="l" href="#2714">2714: </a><span class="php-comment">     * @return Horde_Mime_Part  A MIME part representing the image.
</span></span><span id="2715" class="l"><a class="l" href="#2715">2715: </a><span class="php-comment">     */</span>
</span><span id="2716" class="l"><a class="l" href="#2716">2716: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getImagePart" href="#_getImagePart">getImagePart</a>(<span class="php-var">$file</span>)
</span><span id="2717" class="l"><a class="l" href="#2717">2717: </a>    {
</span><span id="2718" class="l"><a class="l" href="#2718">2718: </a>        <span class="php-var">$background</span> = Horde_Themes::img(<span class="php-var">$file</span>);
</span><span id="2719" class="l"><a class="l" href="#2719">2719: </a>        <span class="php-var">$image</span> = <span class="php-keyword1">new</span> Horde_Mime_Part();
</span><span id="2720" class="l"><a class="l" href="#2720">2720: </a>        <span class="php-var">$image</span>-&gt;<span class="php-keyword2">setType</span>(<span class="php-quote">'image/png'</span>);
</span><span id="2721" class="l"><a class="l" href="#2721">2721: </a>        <span class="php-var">$image</span>-&gt;setContents(<span class="php-keyword2">file_get_contents</span>(<span class="php-var">$background</span>-&gt;fs));
</span><span id="2722" class="l"><a class="l" href="#2722">2722: </a>        <span class="php-var">$image</span>-&gt;setContentId();
</span><span id="2723" class="l"><a class="l" href="#2723">2723: </a>        <span class="php-var">$image</span>-&gt;setDisposition(<span class="php-quote">'attachment'</span>);
</span><span id="2724" class="l"><a class="l" href="#2724">2724: </a>        <span class="php-keyword1">return</span> <span class="php-var">$image</span>;
</span><span id="2725" class="l"><a class="l" href="#2725">2725: </a>    }
</span><span id="2726" class="l"><a class="l" href="#2726">2726: </a>
</span><span id="2727" class="l"><a class="l" href="#2727">2727: </a>    <span class="php-comment">/**
</span></span><span id="2728" class="l"><a class="l" href="#2728">2728: </a><span class="php-comment">     * @return Horde_Date
</span></span><span id="2729" class="l"><a class="l" href="#2729">2729: </a><span class="php-comment">     */</span>
</span><span id="2730" class="l"><a class="l" href="#2730">2730: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_currentDate" href="#_currentDate">currentDate</a>()
</span><span id="2731" class="l"><a class="l" href="#2731">2731: </a>    {
</span><span id="2732" class="l"><a class="l" href="#2732">2732: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$date</span> = Horde_Util::getFormData(<span class="php-quote">'date'</span>)) {
</span><span id="2733" class="l"><a class="l" href="#2733">2733: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$date</span> . <span class="php-quote">'000000'</span>);
</span><span id="2734" class="l"><a class="l" href="#2734">2734: </a>        }
</span><span id="2735" class="l"><a class="l" href="#2735">2735: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$date</span> = Horde_Util::getFormData(<span class="php-quote">'datetime'</span>)) {
</span><span id="2736" class="l"><a class="l" href="#2736">2736: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$date</span>);
</span><span id="2737" class="l"><a class="l" href="#2737">2737: </a>        }
</span><span id="2738" class="l"><a class="l" href="#2738">2738: </a>
</span><span id="2739" class="l"><a class="l" href="#2739">2739: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$_SERVER</span>[<span class="php-quote">'REQUEST_TIME'</span>]);
</span><span id="2740" class="l"><a class="l" href="#2740">2740: </a>    }
</span><span id="2741" class="l"><a class="l" href="#2741">2741: </a>
</span><span id="2742" class="l"><a class="l" href="#2742">2742: </a>    <span class="php-comment">/**
</span></span><span id="2743" class="l"><a class="l" href="#2743">2743: </a><span class="php-comment">     * Parses a complete date-time string into a Horde_Date object.
</span></span><span id="2744" class="l"><a class="l" href="#2744">2744: </a><span class="php-comment">     *
</span></span><span id="2745" class="l"><a class="l" href="#2745">2745: </a><span class="php-comment">     * @param string $date       The date-time string to parse.
</span></span><span id="2746" class="l"><a class="l" href="#2746">2746: </a><span class="php-comment">     * @param boolean $withtime  Whether time is included in the string.
</span></span><span id="2747" class="l"><a class="l" href="#2747">2747: </a><span class="php-comment">     *
</span></span><span id="2748" class="l"><a class="l" href="#2748">2748: </a><span class="php-comment">     * @return Horde_Date  The parsed date.
</span></span><span id="2749" class="l"><a class="l" href="#2749">2749: </a><span class="php-comment">     * @throws Horde_Date_Exception
</span></span><span id="2750" class="l"><a class="l" href="#2750">2750: </a><span class="php-comment">     */</span>
</span><span id="2751" class="l"><a class="l" href="#2751">2751: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_parseDate" href="#_parseDate">parseDate</a>(<span class="php-var">$date</span>, <span class="php-var">$withtime</span> = <span class="php-keyword1">true</span>)
</span><span id="2752" class="l"><a class="l" href="#2752">2752: </a>    {
</span><span id="2753" class="l"><a class="l" href="#2753">2753: </a>        <span class="php-comment">// strptime() is not available on Windows.</span>
</span><span id="2754" class="l"><a class="l" href="#2754">2754: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">function_exists</span>(<span class="php-quote">'strptime'</span>)) {
</span><span id="2755" class="l"><a class="l" href="#2755">2755: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$date</span>);
</span><span id="2756" class="l"><a class="l" href="#2756">2756: </a>        }
</span><span id="2757" class="l"><a class="l" href="#2757">2757: </a>
</span><span id="2758" class="l"><a class="l" href="#2758">2758: </a>        <span class="php-comment">// strptime() is locale dependent, i.e. %p is not always matching</span>
</span><span id="2759" class="l"><a class="l" href="#2759">2759: </a>        <span class="php-comment">// AM/PM. Set the locale to C to workaround this, but grab the</span>
</span><span id="2760" class="l"><a class="l" href="#2760">2760: </a>        <span class="php-comment">// locale's D_FMT before that.</span>
</span><span id="2761" class="l"><a class="l" href="#2761">2761: </a>        <span class="php-var">$format</span> = Horde_Nls::getLangInfo(D_FMT);
</span><span id="2762" class="l"><a class="l" href="#2762">2762: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$withtime</span>) {
</span><span id="2763" class="l"><a class="l" href="#2763">2763: </a>            <span class="php-var">$format</span> .= <span class="php-quote">' '</span>
</span><span id="2764" class="l"><a class="l" href="#2764">2764: </a>                . (<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'twentyFour'</span>) ? <span class="php-quote">'%H:%M'</span> : <span class="php-quote">'%I:%M %p'</span>);
</span><span id="2765" class="l"><a class="l" href="#2765">2765: </a>        }
</span><span id="2766" class="l"><a class="l" href="#2766">2766: </a>        <span class="php-var">$old_locale</span> = <span class="php-keyword2">setlocale</span>(LC_TIME, <span class="php-num">0</span>);
</span><span id="2767" class="l"><a class="l" href="#2767">2767: </a>        <span class="php-keyword2">setlocale</span>(LC_TIME, <span class="php-quote">'C'</span>);
</span><span id="2768" class="l"><a class="l" href="#2768">2768: </a>
</span><span id="2769" class="l"><a class="l" href="#2769">2769: </a>        <span class="php-comment">// Try exact format match first.</span>
</span><span id="2770" class="l"><a class="l" href="#2770">2770: </a>        <span class="php-var">$date_arr</span> = strptime(<span class="php-var">$date</span>, <span class="php-var">$format</span>);
</span><span id="2771" class="l"><a class="l" href="#2771">2771: </a>        <span class="php-keyword2">setlocale</span>(LC_TIME, <span class="php-var">$old_locale</span>);
</span><span id="2772" class="l"><a class="l" href="#2772">2772: </a>
</span><span id="2773" class="l"><a class="l" href="#2773">2773: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$date_arr</span>) {
</span><span id="2774" class="l"><a class="l" href="#2774">2774: </a>            <span class="php-comment">// Try with locale dependent parsing next.</span>
</span><span id="2775" class="l"><a class="l" href="#2775">2775: </a>            <span class="php-var">$date_arr</span> = strptime(<span class="php-var">$date</span>, <span class="php-var">$format</span>);
</span><span id="2776" class="l"><a class="l" href="#2776">2776: </a>            <span class="php-keyword1">if</span> (!<span class="php-var">$date_arr</span>) {
</span><span id="2777" class="l"><a class="l" href="#2777">2777: </a>                <span class="php-comment">// Try throwing at Horde_Date finally.</span>
</span><span id="2778" class="l"><a class="l" href="#2778">2778: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Horde_Date(<span class="php-var">$date</span>);
</span><span id="2779" class="l"><a class="l" href="#2779">2779: </a>            }
</span><span id="2780" class="l"><a class="l" href="#2780">2780: </a>        }
</span><span id="2781" class="l"><a class="l" href="#2781">2781: </a>
</span><span id="2782" class="l"><a class="l" href="#2782">2782: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Horde_Date(
</span><span id="2783" class="l"><a class="l" href="#2783">2783: </a>            <span class="php-keyword1">array</span>(<span class="php-quote">'year'</span>  =&gt; <span class="php-var">$date_arr</span>[<span class="php-quote">'tm_year'</span>] + <span class="php-num">1900</span>,
</span><span id="2784" class="l"><a class="l" href="#2784">2784: </a>                  <span class="php-quote">'month'</span> =&gt; <span class="php-var">$date_arr</span>[<span class="php-quote">'tm_mon'</span>] + <span class="php-num">1</span>,
</span><span id="2785" class="l"><a class="l" href="#2785">2785: </a>                  <span class="php-quote">'mday'</span>  =&gt; <span class="php-var">$date_arr</span>[<span class="php-quote">'tm_mday'</span>],
</span><span id="2786" class="l"><a class="l" href="#2786">2786: </a>                  <span class="php-quote">'hour'</span>  =&gt; <span class="php-var">$date_arr</span>[<span class="php-quote">'tm_hour'</span>],
</span><span id="2787" class="l"><a class="l" href="#2787">2787: </a>                  <span class="php-quote">'min'</span>   =&gt; <span class="php-var">$date_arr</span>[<span class="php-quote">'tm_min'</span>],
</span><span id="2788" class="l"><a class="l" href="#2788">2788: </a>                  <span class="php-quote">'sec'</span>   =&gt; <span class="php-var">$date_arr</span>[<span class="php-quote">'tm_sec'</span>]));
</span><span id="2789" class="l"><a class="l" href="#2789">2789: </a>    }
</span><span id="2790" class="l"><a class="l" href="#2790">2790: </a>
</span><span id="2791" class="l"><a class="l" href="#2791">2791: </a>    <span class="php-comment">/**
</span></span><span id="2792" class="l"><a class="l" href="#2792">2792: </a><span class="php-comment">     * @param string $tabname
</span></span><span id="2793" class="l"><a class="l" href="#2793">2793: </a><span class="php-comment">     */</span>
</span><span id="2794" class="l"><a class="l" href="#2794">2794: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_tabs" href="#_tabs">tabs</a>(<span class="php-var">$tabname</span> = <span class="php-keyword1">null</span>)
</span><span id="2795" class="l"><a class="l" href="#2795">2795: </a>    {
</span><span id="2796" class="l"><a class="l" href="#2796">2796: </a>        <span class="php-var">$date</span> = self::currentDate();
</span><span id="2797" class="l"><a class="l" href="#2797">2797: </a>        <span class="php-var">$date_stamp</span> = <span class="php-var">$date</span>-&gt;dateString();
</span><span id="2798" class="l"><a class="l" href="#2798">2798: </a>
</span><span id="2799" class="l"><a class="l" href="#2799">2799: </a>        <span class="php-var">$tabs</span> = <span class="php-keyword1">new</span> Horde_Core_Ui_Tabs(<span class="php-quote">'view'</span>, Horde_Variables::getDefaultVariables());
</span><span id="2800" class="l"><a class="l" href="#2800">2800: </a>        <span class="php-var">$tabs</span>-&gt;preserve(<span class="php-quote">'date'</span>, <span class="php-var">$date_stamp</span>);
</span><span id="2801" class="l"><a class="l" href="#2801">2801: </a>
</span><span id="2802" class="l"><a class="l" href="#2802">2802: </a>        <span class="php-var">$tabs</span>-&gt;addTab(_(<span class="php-quote">&quot;Day&quot;</span>), Horde::url(<span class="php-quote">'day.php'</span>),
</span><span id="2803" class="l"><a class="l" href="#2803">2803: </a>                      <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'day'</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabday'</span>, <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowView(\'Day\', \''</span> . <span class="php-var">$date_stamp</span> . <span class="php-quote">'\');'</span>));
</span><span id="2804" class="l"><a class="l" href="#2804">2804: </a>        <span class="php-var">$tabs</span>-&gt;addTab(_(<span class="php-quote">&quot;Work Week&quot;</span>), Horde::url(<span class="php-quote">'workweek.php'</span>),
</span><span id="2805" class="l"><a class="l" href="#2805">2805: </a>                      <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'workweek'</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabworkweek'</span>, <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowView(\'WorkWeek\', \''</span> . <span class="php-var">$date_stamp</span> . <span class="php-quote">'\');'</span>));
</span><span id="2806" class="l"><a class="l" href="#2806">2806: </a>        <span class="php-var">$tabs</span>-&gt;addTab(_(<span class="php-quote">&quot;Week&quot;</span>), Horde::url(<span class="php-quote">'week.php'</span>),
</span><span id="2807" class="l"><a class="l" href="#2807">2807: </a>                      <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'week'</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabweek'</span>, <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowView(\'Week\', \''</span> . <span class="php-var">$date_stamp</span> . <span class="php-quote">'\');'</span>));
</span><span id="2808" class="l"><a class="l" href="#2808">2808: </a>        <span class="php-var">$tabs</span>-&gt;addTab(_(<span class="php-quote">&quot;Month&quot;</span>), Horde::url(<span class="php-quote">'month.php'</span>),
</span><span id="2809" class="l"><a class="l" href="#2809">2809: </a>                      <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'month'</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabmonth'</span>, <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowView(\'Month\', \''</span> . <span class="php-var">$date_stamp</span> . <span class="php-quote">'\');'</span>));
</span><span id="2810" class="l"><a class="l" href="#2810">2810: </a>        <span class="php-var">$tabs</span>-&gt;addTab(_(<span class="php-quote">&quot;Year&quot;</span>), Horde::url(<span class="php-quote">'year.php'</span>),
</span><span id="2811" class="l"><a class="l" href="#2811">2811: </a>                      <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'year'</span>, <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabyear'</span>, <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowView(\'Year\', \''</span> . <span class="php-var">$date_stamp</span> . <span class="php-quote">'\');'</span>));
</span><span id="2812" class="l"><a class="l" href="#2812">2812: </a>
</span><span id="2813" class="l"><a class="l" href="#2813">2813: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$tabname</span> === <span class="php-keyword1">null</span>) {
</span><span id="2814" class="l"><a class="l" href="#2814">2814: </a>            <span class="php-var">$tabname</span> = <span class="php-keyword2">basename</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'PHP_SELF'</span>]) == <span class="php-quote">'index.php'</span> ? <span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'defaultview'</span>) : <span class="php-keyword2">str_replace</span>(<span class="php-quote">'.php'</span>, <span class="php-quote">''</span>, <span class="php-keyword2">basename</span>(<span class="php-var">$_SERVER</span>[<span class="php-quote">'PHP_SELF'</span>]));
</span><span id="2815" class="l"><a class="l" href="#2815">2815: </a>        }
</span><span id="2816" class="l"><a class="l" href="#2816">2816: </a>        <span class="php-keyword1">echo</span> <span class="php-var">$tabs</span>-&gt;render(<span class="php-var">$tabname</span>);
</span><span id="2817" class="l"><a class="l" href="#2817">2817: </a>    }
</span><span id="2818" class="l"><a class="l" href="#2818">2818: </a>
</span><span id="2819" class="l"><a class="l" href="#2819">2819: </a>    <span class="php-comment">/**
</span></span><span id="2820" class="l"><a class="l" href="#2820">2820: </a><span class="php-comment">     * @param string $tabname
</span></span><span id="2821" class="l"><a class="l" href="#2821">2821: </a><span class="php-comment">     * @param Kronolith_Event $event
</span></span><span id="2822" class="l"><a class="l" href="#2822">2822: </a><span class="php-comment">     */</span>
</span><span id="2823" class="l"><a class="l" href="#2823">2823: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_eventTabs" href="#_eventTabs">eventTabs</a>(<span class="php-var">$tabname</span>, <span class="php-var">$event</span>)
</span><span id="2824" class="l"><a class="l" href="#2824">2824: </a>    {
</span><span id="2825" class="l"><a class="l" href="#2825">2825: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$event</span>-&gt;initialized) {
</span><span id="2826" class="l"><a class="l" href="#2826">2826: </a>            <span class="php-keyword1">return</span>;
</span><span id="2827" class="l"><a class="l" href="#2827">2827: </a>        }
</span><span id="2828" class="l"><a class="l" href="#2828">2828: </a>
</span><span id="2829" class="l"><a class="l" href="#2829">2829: </a>        <span class="php-var">$tabs</span> = <span class="php-keyword1">new</span> Horde_Core_Ui_Tabs(<span class="php-quote">'event'</span>, Horde_Variables::getDefaultVariables());
</span><span id="2830" class="l"><a class="l" href="#2830">2830: </a>
</span><span id="2831" class="l"><a class="l" href="#2831">2831: </a>        <span class="php-var">$date</span> = self::currentDate();
</span><span id="2832" class="l"><a class="l" href="#2832">2832: </a>        <span class="php-var">$tabs</span>-&gt;preserve(<span class="php-quote">'datetime'</span>, <span class="php-var">$date</span>-&gt;dateString());
</span><span id="2833" class="l"><a class="l" href="#2833">2833: </a>
</span><span id="2834" class="l"><a class="l" href="#2834">2834: </a>        <span class="php-var">$tabs</span>-&gt;addTab(
</span><span id="2835" class="l"><a class="l" href="#2835">2835: </a>            <span class="php-keyword2">htmlspecialchars</span>(<span class="php-var">$event</span>-&gt;getTitle()),
</span><span id="2836" class="l"><a class="l" href="#2836">2836: </a>            <span class="php-var">$event</span>-&gt;getViewUrl(),
</span><span id="2837" class="l"><a class="l" href="#2837">2837: </a>            <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'Event'</span>,
</span><span id="2838" class="l"><a class="l" href="#2838">2838: </a>                  <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabEvent'</span>,
</span><span id="2839" class="l"><a class="l" href="#2839">2839: </a>                  <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowTab(\'Event\');'</span>));
</span><span id="2840" class="l"><a class="l" href="#2840">2840: </a>        <span class="php-comment">/* We check for read permissions, because we can always save a copy if
</span></span><span id="2841" class="l"><a class="l" href="#2841">2841: </a><span class="php-comment">         * we can read the event. */</span>
</span><span id="2842" class="l"><a class="l" href="#2842">2842: </a>        <span class="php-keyword1">if</span> ((!<span class="php-var">$event</span>-&gt;<span class="php-keyword1">private</span> ||
</span><span id="2843" class="l"><a class="l" href="#2843">2843: </a>             <span class="php-var">$event</span>-&gt;creator == <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuth()) &amp;&amp;
</span><span id="2844" class="l"><a class="l" href="#2844">2844: </a>            <span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::READ) &amp;&amp;
</span><span id="2845" class="l"><a class="l" href="#2845">2845: </a>            self::getDefaultCalendar(Horde_Perms::EDIT)) {
</span><span id="2846" class="l"><a class="l" href="#2846">2846: </a>            <span class="php-var">$tabs</span>-&gt;addTab(
</span><span id="2847" class="l"><a class="l" href="#2847">2847: </a>                <span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::EDIT) ? _(<span class="php-quote">&quot;_Edit&quot;</span>) : _(<span class="php-quote">&quot;Save As New&quot;</span>),
</span><span id="2848" class="l"><a class="l" href="#2848">2848: </a>                <span class="php-var">$event</span>-&gt;getEditUrl(),
</span><span id="2849" class="l"><a class="l" href="#2849">2849: </a>                <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'EditEvent'</span>,
</span><span id="2850" class="l"><a class="l" href="#2850">2850: </a>                      <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabEditEvent'</span>,
</span><span id="2851" class="l"><a class="l" href="#2851">2851: </a>                      <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowTab(\'EditEvent\');'</span>));
</span><span id="2852" class="l"><a class="l" href="#2852">2852: </a>        }
</span><span id="2853" class="l"><a class="l" href="#2853">2853: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>)) {
</span><span id="2854" class="l"><a class="l" href="#2854">2854: </a>            <span class="php-var">$tabs</span>-&gt;addTab(
</span><span id="2855" class="l"><a class="l" href="#2855">2855: </a>                _(<span class="php-quote">&quot;De_lete&quot;</span>),
</span><span id="2856" class="l"><a class="l" href="#2856">2856: </a>                <span class="php-var">$event</span>-&gt;getDeleteUrl(<span class="php-keyword1">array</span>(<span class="php-quote">'confirm'</span> =&gt; <span class="php-num">1</span>)),
</span><span id="2857" class="l"><a class="l" href="#2857">2857: </a>                <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'DeleteEvent'</span>,
</span><span id="2858" class="l"><a class="l" href="#2858">2858: </a>                      <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabDeleteEvent'</span>,
</span><span id="2859" class="l"><a class="l" href="#2859">2859: </a>                      <span class="php-quote">'onclick'</span> =&gt; <span class="php-quote">'return ShowTab(\'DeleteEvent\');'</span>));
</span><span id="2860" class="l"><a class="l" href="#2860">2860: </a>        }
</span><span id="2861" class="l"><a class="l" href="#2861">2861: </a>        <span class="php-var">$tabs</span>-&gt;addTab(
</span><span id="2862" class="l"><a class="l" href="#2862">2862: </a>            _(<span class="php-quote">&quot;Export&quot;</span>),
</span><span id="2863" class="l"><a class="l" href="#2863">2863: </a>            <span class="php-var">$event</span>-&gt;getExportUrl(),
</span><span id="2864" class="l"><a class="l" href="#2864">2864: </a>            <span class="php-keyword1">array</span>(<span class="php-quote">'tabname'</span> =&gt; <span class="php-quote">'ExportEvent'</span>,
</span><span id="2865" class="l"><a class="l" href="#2865">2865: </a>                  <span class="php-quote">'id'</span> =&gt; <span class="php-quote">'tabExportEvent'</span>));
</span><span id="2866" class="l"><a class="l" href="#2866">2866: </a>
</span><span id="2867" class="l"><a class="l" href="#2867">2867: </a>        <span class="php-keyword1">echo</span> <span class="php-var">$tabs</span>-&gt;render(<span class="php-var">$tabname</span>);
</span><span id="2868" class="l"><a class="l" href="#2868">2868: </a>    }
</span><span id="2869" class="l"><a class="l" href="#2869">2869: </a>
</span><span id="2870" class="l"><a class="l" href="#2870">2870: </a>    <span class="php-comment">/**
</span></span><span id="2871" class="l"><a class="l" href="#2871">2871: </a><span class="php-comment">     * Attempts to return a single, concrete Kronolith_Driver instance based
</span></span><span id="2872" class="l"><a class="l" href="#2872">2872: </a><span class="php-comment">     * on a driver name.
</span></span><span id="2873" class="l"><a class="l" href="#2873">2873: </a><span class="php-comment">     *
</span></span><span id="2874" class="l"><a class="l" href="#2874">2874: </a><span class="php-comment">     * This singleton method automatically retrieves all parameters required
</span></span><span id="2875" class="l"><a class="l" href="#2875">2875: </a><span class="php-comment">     * for the specified driver.
</span></span><span id="2876" class="l"><a class="l" href="#2876">2876: </a><span class="php-comment">     *
</span></span><span id="2877" class="l"><a class="l" href="#2877">2877: </a><span class="php-comment">     * @param string $driver    The type of concrete Kronolith_Driver subclass
</span></span><span id="2878" class="l"><a class="l" href="#2878">2878: </a><span class="php-comment">     *                          to return.
</span></span><span id="2879" class="l"><a class="l" href="#2879">2879: </a><span class="php-comment">     * @param string $calendar  The calendar name. The format depends on the
</span></span><span id="2880" class="l"><a class="l" href="#2880">2880: </a><span class="php-comment">     *                          driver being used.
</span></span><span id="2881" class="l"><a class="l" href="#2881">2881: </a><span class="php-comment">     *
</span></span><span id="2882" class="l"><a class="l" href="#2882">2882: </a><span class="php-comment">     * @return Kronolith_Driver  The newly created concrete Kronolith_Driver
</span></span><span id="2883" class="l"><a class="l" href="#2883">2883: </a><span class="php-comment">     *                           instance.
</span></span><span id="2884" class="l"><a class="l" href="#2884">2884: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="2885" class="l"><a class="l" href="#2885">2885: </a><span class="php-comment">     */</span>
</span><span id="2886" class="l"><a class="l" href="#2886">2886: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getDriver" href="#_getDriver">getDriver</a>(<span class="php-var">$driver</span> = <span class="php-keyword1">null</span>, <span class="php-var">$calendar</span> = <span class="php-keyword1">null</span>)
</span><span id="2887" class="l"><a class="l" href="#2887">2887: </a>    {
</span><span id="2888" class="l"><a class="l" href="#2888">2888: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$driver</span>) {
</span><span id="2889" class="l"><a class="l" href="#2889">2889: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'internal'</span>:
</span><span id="2890" class="l"><a class="l" href="#2890">2890: </a>            <span class="php-var">$driver</span> = <span class="php-quote">''</span>;
</span><span id="2891" class="l"><a class="l" href="#2891">2891: </a>            <span class="php-keyword1">break</span>;
</span><span id="2892" class="l"><a class="l" href="#2892">2892: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'external'</span>:
</span><span id="2893" class="l"><a class="l" href="#2893">2893: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'tasklists'</span>:
</span><span id="2894" class="l"><a class="l" href="#2894">2894: </a>            <span class="php-var">$driver</span> = <span class="php-quote">'Horde'</span>;
</span><span id="2895" class="l"><a class="l" href="#2895">2895: </a>            <span class="php-keyword1">break</span>;
</span><span id="2896" class="l"><a class="l" href="#2896">2896: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'remote'</span>:
</span><span id="2897" class="l"><a class="l" href="#2897">2897: </a>            <span class="php-var">$driver</span> = <span class="php-quote">'Ical'</span>;
</span><span id="2898" class="l"><a class="l" href="#2898">2898: </a>            <span class="php-keyword1">break</span>;
</span><span id="2899" class="l"><a class="l" href="#2899">2899: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'holiday'</span>:
</span><span id="2900" class="l"><a class="l" href="#2900">2900: </a>            <span class="php-var">$driver</span> = <span class="php-quote">'Holidays'</span>;
</span><span id="2901" class="l"><a class="l" href="#2901">2901: </a>            <span class="php-keyword1">break</span>;
</span><span id="2902" class="l"><a class="l" href="#2902">2902: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'resource'</span>:
</span><span id="2903" class="l"><a class="l" href="#2903">2903: </a>            <span class="php-var">$driver</span> = <span class="php-quote">'Resource'</span>;
</span><span id="2904" class="l"><a class="l" href="#2904">2904: </a>            <span class="php-keyword1">break</span>;
</span><span id="2905" class="l"><a class="l" href="#2905">2905: </a>        }
</span><span id="2906" class="l"><a class="l" href="#2906">2906: </a>
</span><span id="2907" class="l"><a class="l" href="#2907">2907: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$driver</span>)) {
</span><span id="2908" class="l"><a class="l" href="#2908">2908: </a>            <span class="php-var">$driver</span> = Horde_String::<span class="php-keyword2">ucfirst</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'calendar'</span>][<span class="php-quote">'driver'</span>]);
</span><span id="2909" class="l"><a class="l" href="#2909">2909: </a>        }
</span><span id="2910" class="l"><a class="l" href="#2910">2910: </a>
</span><span id="2911" class="l"><a class="l" href="#2911">2911: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(self::<span class="php-var">$_instances</span>[<span class="php-var">$driver</span>])) {
</span><span id="2912" class="l"><a class="l" href="#2912">2912: </a>            <span class="php-keyword1">switch</span> (<span class="php-var">$driver</span>) {
</span><span id="2913" class="l"><a class="l" href="#2913">2913: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Sql'</span>:
</span><span id="2914" class="l"><a class="l" href="#2914">2914: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Resource'</span>:
</span><span id="2915" class="l"><a class="l" href="#2915">2915: </a>                <span class="php-var">$params</span> = Horde::getDriverConfig(<span class="php-quote">'calendar'</span>, <span class="php-quote">'sql'</span>);
</span><span id="2916" class="l"><a class="l" href="#2916">2916: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$params</span>[<span class="php-quote">'driverconfig'</span>] != <span class="php-quote">'Horde'</span>) {
</span><span id="2917" class="l"><a class="l" href="#2917">2917: </a>                    <span class="php-var">$customParams</span> = <span class="php-var">$params</span>;
</span><span id="2918" class="l"><a class="l" href="#2918">2918: </a>                    <span class="php-keyword1">unset</span>(<span class="php-var">$customParams</span>[<span class="php-quote">'driverconfig'</span>], <span class="php-var">$customParams</span>[<span class="php-quote">'table'</span>], <span class="php-var">$customParams</span>[<span class="php-quote">'utc'</span>]);
</span><span id="2919" class="l"><a class="l" href="#2919">2919: </a>                    <span class="php-var">$params</span>[<span class="php-quote">'db'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Core_Factory_Db'</span>)-&gt;create(<span class="php-quote">'kronolith'</span>, <span class="php-var">$customParams</span>);
</span><span id="2920" class="l"><a class="l" href="#2920">2920: </a>                } <span class="php-keyword1">else</span> {
</span><span id="2921" class="l"><a class="l" href="#2921">2921: </a>                    <span class="php-var">$params</span>[<span class="php-quote">'db'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Db_Adapter'</span>);
</span><span id="2922" class="l"><a class="l" href="#2922">2922: </a>                }
</span><span id="2923" class="l"><a class="l" href="#2923">2923: </a>                <span class="php-keyword1">break</span>;
</span><span id="2924" class="l"><a class="l" href="#2924">2924: </a>
</span><span id="2925" class="l"><a class="l" href="#2925">2925: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Kolab'</span>:
</span><span id="2926" class="l"><a class="l" href="#2926">2926: </a>                <span class="php-var">$params</span>[<span class="php-quote">'storage'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Kolab_Storage'</span>);
</span><span id="2927" class="l"><a class="l" href="#2927">2927: </a>                <span class="php-keyword1">break</span>;
</span><span id="2928" class="l"><a class="l" href="#2928">2928: </a>
</span><span id="2929" class="l"><a class="l" href="#2929">2929: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Ical'</span>:
</span><span id="2930" class="l"><a class="l" href="#2930">2930: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Mock'</span>:
</span><span id="2931" class="l"><a class="l" href="#2931">2931: </a>                <span class="php-var">$params</span> = <span class="php-keyword1">array</span>();
</span><span id="2932" class="l"><a class="l" href="#2932">2932: </a>                <span class="php-keyword1">break</span>;
</span><span id="2933" class="l"><a class="l" href="#2933">2933: </a>
</span><span id="2934" class="l"><a class="l" href="#2934">2934: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Horde'</span>:
</span><span id="2935" class="l"><a class="l" href="#2935">2935: </a>                <span class="php-var">$params</span>[<span class="php-quote">'registry'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>];
</span><span id="2936" class="l"><a class="l" href="#2936">2936: </a>                <span class="php-keyword1">break</span>;
</span><span id="2937" class="l"><a class="l" href="#2937">2937: </a>
</span><span id="2938" class="l"><a class="l" href="#2938">2938: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Holidays'</span>:
</span><span id="2939" class="l"><a class="l" href="#2939">2939: </a>                <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'conf'</span>][<span class="php-quote">'holidays'</span>][<span class="php-quote">'enable'</span>])) {
</span><span id="2940" class="l"><a class="l" href="#2940">2940: </a>                    <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(_(<span class="php-quote">&quot;Holidays are disabled&quot;</span>));
</span><span id="2941" class="l"><a class="l" href="#2941">2941: </a>                }
</span><span id="2942" class="l"><a class="l" href="#2942">2942: </a>                <span class="php-var">$params</span>[<span class="php-quote">'language'</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'language'</span>];
</span><span id="2943" class="l"><a class="l" href="#2943">2943: </a>                <span class="php-keyword1">break</span>;
</span><span id="2944" class="l"><a class="l" href="#2944">2944: </a>
</span><span id="2945" class="l"><a class="l" href="#2945">2945: </a>            <span class="php-keyword1">default</span>:
</span><span id="2946" class="l"><a class="l" href="#2946">2946: </a>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-quote">'No calendar driver specified'</span>);
</span><span id="2947" class="l"><a class="l" href="#2947">2947: </a>                <span class="php-keyword1">break</span>;
</span><span id="2948" class="l"><a class="l" href="#2948">2948: </a>            }
</span><span id="2949" class="l"><a class="l" href="#2949">2949: </a>
</span><span id="2950" class="l"><a class="l" href="#2950">2950: </a>            self::<span class="php-var">$_instances</span>[<span class="php-var">$driver</span>] = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Kronolith_Factory_Driver'</span>)-&gt;create(<span class="php-var">$driver</span>, <span class="php-var">$params</span>);
</span><span id="2951" class="l"><a class="l" href="#2951">2951: </a>        }
</span><span id="2952" class="l"><a class="l" href="#2952">2952: </a>
</span><span id="2953" class="l"><a class="l" href="#2953">2953: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_null</span>(<span class="php-var">$calendar</span>)) {
</span><span id="2954" class="l"><a class="l" href="#2954">2954: </a>            self::<span class="php-var">$_instances</span>[<span class="php-var">$driver</span>]-&gt;open(<span class="php-var">$calendar</span>);
</span><span id="2955" class="l"><a class="l" href="#2955">2955: </a>            <span class="php-comment">/* Remote calendar parameters are per calendar. */</span>
</span><span id="2956" class="l"><a class="l" href="#2956">2956: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$driver</span> == <span class="php-quote">'Ical'</span>) {
</span><span id="2957" class="l"><a class="l" href="#2957">2957: </a>                self::<span class="php-var">$_instances</span>[<span class="php-var">$driver</span>]-&gt;setParams(self::getRemoteParams(<span class="php-var">$calendar</span>));
</span><span id="2958" class="l"><a class="l" href="#2958">2958: </a>            }
</span><span id="2959" class="l"><a class="l" href="#2959">2959: </a>        }
</span><span id="2960" class="l"><a class="l" href="#2960">2960: </a>
</span><span id="2961" class="l"><a class="l" href="#2961">2961: </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$_instances</span>[<span class="php-var">$driver</span>];
</span><span id="2962" class="l"><a class="l" href="#2962">2962: </a>    }
</span><span id="2963" class="l"><a class="l" href="#2963">2963: </a>
</span><span id="2964" class="l"><a class="l" href="#2964">2964: </a>    <span class="php-comment">/**
</span></span><span id="2965" class="l"><a class="l" href="#2965">2965: </a><span class="php-comment">     * Check for HTTP authentication credentials
</span></span><span id="2966" class="l"><a class="l" href="#2966">2966: </a><span class="php-comment">     */</span>
</span><span id="2967" class="l"><a class="l" href="#2967">2967: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getRemoteParams" href="#_getRemoteParams">getRemoteParams</a>(<span class="php-var">$calendar</span>)
</span><span id="2968" class="l"><a class="l" href="#2968">2968: </a>    {
</span><span id="2969" class="l"><a class="l" href="#2969">2969: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$calendar</span>)) {
</span><span id="2970" class="l"><a class="l" href="#2970">2970: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="2971" class="l"><a class="l" href="#2971">2971: </a>        }
</span><span id="2972" class="l"><a class="l" href="#2972">2972: </a>
</span><span id="2973" class="l"><a class="l" href="#2973">2973: </a>        <span class="php-var">$cals</span> = <span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'remote_cals'</span>));
</span><span id="2974" class="l"><a class="l" href="#2974">2974: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$cals</span> <span class="php-keyword1">as</span> <span class="php-var">$cal</span>) {
</span><span id="2975" class="l"><a class="l" href="#2975">2975: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$cal</span>[<span class="php-quote">'url'</span>] == <span class="php-var">$calendar</span>) {
</span><span id="2976" class="l"><a class="l" href="#2976">2976: </a>                <span class="php-var">$user</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$cal</span>[<span class="php-quote">'user'</span>]) ? <span class="php-var">$cal</span>[<span class="php-quote">'user'</span>] : <span class="php-quote">''</span>;
</span><span id="2977" class="l"><a class="l" href="#2977">2977: </a>                <span class="php-var">$password</span> = <span class="php-keyword1">isset</span>(<span class="php-var">$cal</span>[<span class="php-quote">'password'</span>]) ? <span class="php-var">$cal</span>[<span class="php-quote">'password'</span>] : <span class="php-quote">''</span>;
</span><span id="2978" class="l"><a class="l" href="#2978">2978: </a>                <span class="php-var">$key</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;getAuthCredential(<span class="php-quote">'password'</span>);
</span><span id="2979" class="l"><a class="l" href="#2979">2979: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$key</span> &amp;&amp; <span class="php-var">$password</span>) {
</span><span id="2980" class="l"><a class="l" href="#2980">2980: </a>                    <span class="php-var">$secret</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'injector'</span>]-&gt;getInstance(<span class="php-quote">'Horde_Secret'</span>);
</span><span id="2981" class="l"><a class="l" href="#2981">2981: </a>                    <span class="php-var">$user</span> = <span class="php-var">$secret</span>-&gt;read(<span class="php-var">$key</span>, <span class="php-keyword2">base64_decode</span>(<span class="php-var">$user</span>));
</span><span id="2982" class="l"><a class="l" href="#2982">2982: </a>                    <span class="php-var">$password</span> = <span class="php-var">$secret</span>-&gt;read(<span class="php-var">$key</span>, <span class="php-keyword2">base64_decode</span>(<span class="php-var">$password</span>));
</span><span id="2983" class="l"><a class="l" href="#2983">2983: </a>                }
</span><span id="2984" class="l"><a class="l" href="#2984">2984: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$user</span>)) {
</span><span id="2985" class="l"><a class="l" href="#2985">2985: </a>                    <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-quote">'user'</span> =&gt; <span class="php-var">$user</span>, <span class="php-quote">'password'</span> =&gt; <span class="php-var">$password</span>);
</span><span id="2986" class="l"><a class="l" href="#2986">2986: </a>                }
</span><span id="2987" class="l"><a class="l" href="#2987">2987: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="2988" class="l"><a class="l" href="#2988">2988: </a>            }
</span><span id="2989" class="l"><a class="l" href="#2989">2989: </a>        }
</span><span id="2990" class="l"><a class="l" href="#2990">2990: </a>
</span><span id="2991" class="l"><a class="l" href="#2991">2991: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="2992" class="l"><a class="l" href="#2992">2992: </a>    }
</span><span id="2993" class="l"><a class="l" href="#2993">2993: </a>
</span><span id="2994" class="l"><a class="l" href="#2994">2994: </a>    <span class="php-comment">/**
</span></span><span id="2995" class="l"><a class="l" href="#2995">2995: </a><span class="php-comment">     * Get a named Kronolith_View_* object and load it with the
</span></span><span id="2996" class="l"><a class="l" href="#2996">2996: </a><span class="php-comment">     * appropriate date parameters.
</span></span><span id="2997" class="l"><a class="l" href="#2997">2997: </a><span class="php-comment">     *
</span></span><span id="2998" class="l"><a class="l" href="#2998">2998: </a><span class="php-comment">     * @param string $view The name of the view.
</span></span><span id="2999" class="l"><a class="l" href="#2999">2999: </a><span class="php-comment">     */</span>
</span><span id="3000" class="l"><a class="l" href="#3000">3000: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getView" href="#_getView">getView</a>(<span class="php-var">$view</span>)
</span><span id="3001" class="l"><a class="l" href="#3001">3001: </a>    {
</span><span id="3002" class="l"><a class="l" href="#3002">3002: </a>        <span class="php-keyword1">switch</span> (<span class="php-var">$view</span>) {
</span><span id="3003" class="l"><a class="l" href="#3003">3003: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'Day'</span>:
</span><span id="3004" class="l"><a class="l" href="#3004">3004: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'Month'</span>:
</span><span id="3005" class="l"><a class="l" href="#3005">3005: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'Week'</span>:
</span><span id="3006" class="l"><a class="l" href="#3006">3006: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'WorkWeek'</span>:
</span><span id="3007" class="l"><a class="l" href="#3007">3007: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'Year'</span>:
</span><span id="3008" class="l"><a class="l" href="#3008">3008: </a>            <span class="php-var">$class</span> = <span class="php-quote">'Kronolith_View_'</span> . <span class="php-var">$view</span>;
</span><span id="3009" class="l"><a class="l" href="#3009">3009: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> <span class="php-var">$class</span>(self::currentDate());
</span><span id="3010" class="l"><a class="l" href="#3010">3010: </a>
</span><span id="3011" class="l"><a class="l" href="#3011">3011: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'Event'</span>:
</span><span id="3012" class="l"><a class="l" href="#3012">3012: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'EditEvent'</span>:
</span><span id="3013" class="l"><a class="l" href="#3013">3013: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'DeleteEvent'</span>:
</span><span id="3014" class="l"><a class="l" href="#3014">3014: </a>        <span class="php-keyword1">case</span> <span class="php-quote">'ExportEvent'</span>:
</span><span id="3015" class="l"><a class="l" href="#3015">3015: </a>            <span class="php-keyword1">try</span> {
</span><span id="3016" class="l"><a class="l" href="#3016">3016: </a>                <span class="php-keyword1">if</span> (<span class="php-var">$uid</span> = Horde_Util::getFormData(<span class="php-quote">'uid'</span>)) {
</span><span id="3017" class="l"><a class="l" href="#3017">3017: </a>                    <span class="php-var">$event</span> = self::getDriver()-&gt;getByUID(<span class="php-var">$uid</span>);
</span><span id="3018" class="l"><a class="l" href="#3018">3018: </a>                } <span class="php-keyword1">else</span> {
</span><span id="3019" class="l"><a class="l" href="#3019">3019: </a>                    <span class="php-var">$event</span> = self::getDriver(Horde_Util::getFormData(<span class="php-quote">'type'</span>),
</span><span id="3020" class="l"><a class="l" href="#3020">3020: </a>                                             Horde_Util::getFormData(<span class="php-quote">'calendar'</span>))
</span><span id="3021" class="l"><a class="l" href="#3021">3021: </a>                        -&gt;getEvent(Horde_Util::getFormData(<span class="php-quote">'eventID'</span>),
</span><span id="3022" class="l"><a class="l" href="#3022">3022: </a>                                   Horde_Util::getFormData(<span class="php-quote">'datetime'</span>));
</span><span id="3023" class="l"><a class="l" href="#3023">3023: </a>                }
</span><span id="3024" class="l"><a class="l" href="#3024">3024: </a>            } <span class="php-keyword1">catch</span> (Horde_Exception <span class="php-var">$e</span>) {
</span><span id="3025" class="l"><a class="l" href="#3025">3025: </a>                <span class="php-var">$event</span> = <span class="php-var">$e</span>-&gt;getMessage();
</span><span id="3026" class="l"><a class="l" href="#3026">3026: </a>            }
</span><span id="3027" class="l"><a class="l" href="#3027">3027: </a>            <span class="php-keyword1">switch</span> (<span class="php-var">$view</span>) {
</span><span id="3028" class="l"><a class="l" href="#3028">3028: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'Event'</span>:
</span><span id="3029" class="l"><a class="l" href="#3029">3029: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$event</span>) &amp;&amp;
</span><span id="3030" class="l"><a class="l" href="#3030">3030: </a>                    !<span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::READ)) {
</span><span id="3031" class="l"><a class="l" href="#3031">3031: </a>                    <span class="php-var">$event</span> = _(<span class="php-quote">&quot;Permission Denied&quot;</span>);
</span><span id="3032" class="l"><a class="l" href="#3032">3032: </a>                }
</span><span id="3033" class="l"><a class="l" href="#3033">3033: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Kronolith_View_Event(<span class="php-var">$event</span>);
</span><span id="3034" class="l"><a class="l" href="#3034">3034: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'EditEvent'</span>:
</span><span id="3035" class="l"><a class="l" href="#3035">3035: </a>                <span class="php-comment">/* We check for read permissions, because we can always save a
</span></span><span id="3036" class="l"><a class="l" href="#3036">3036: </a><span class="php-comment">                 * copy if we can read the event. */</span>
</span><span id="3037" class="l"><a class="l" href="#3037">3037: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$event</span>) &amp;&amp;
</span><span id="3038" class="l"><a class="l" href="#3038">3038: </a>                    !<span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::READ)) {
</span><span id="3039" class="l"><a class="l" href="#3039">3039: </a>                    <span class="php-var">$event</span> = _(<span class="php-quote">&quot;Permission Denied&quot;</span>);
</span><span id="3040" class="l"><a class="l" href="#3040">3040: </a>                }
</span><span id="3041" class="l"><a class="l" href="#3041">3041: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Kronolith_View_EditEvent(<span class="php-var">$event</span>);
</span><span id="3042" class="l"><a class="l" href="#3042">3042: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'DeleteEvent'</span>:
</span><span id="3043" class="l"><a class="l" href="#3043">3043: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$event</span>) &amp;&amp;
</span><span id="3044" class="l"><a class="l" href="#3044">3044: </a>                    !<span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::<span class="php-keyword2">DELETE</span>)) {
</span><span id="3045" class="l"><a class="l" href="#3045">3045: </a>                    <span class="php-var">$event</span> = _(<span class="php-quote">&quot;Permission Denied&quot;</span>);
</span><span id="3046" class="l"><a class="l" href="#3046">3046: </a>                }
</span><span id="3047" class="l"><a class="l" href="#3047">3047: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Kronolith_View_DeleteEvent(<span class="php-var">$event</span>);
</span><span id="3048" class="l"><a class="l" href="#3048">3048: </a>            <span class="php-keyword1">case</span> <span class="php-quote">'ExportEvent'</span>:
</span><span id="3049" class="l"><a class="l" href="#3049">3049: </a>                <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_string</span>(<span class="php-var">$event</span>) &amp;&amp;
</span><span id="3050" class="l"><a class="l" href="#3050">3050: </a>                    !<span class="php-var">$event</span>-&gt;hasPermission(Horde_Perms::READ)) {
</span><span id="3051" class="l"><a class="l" href="#3051">3051: </a>                    <span class="php-var">$event</span> = _(<span class="php-quote">&quot;Permission Denied&quot;</span>);
</span><span id="3052" class="l"><a class="l" href="#3052">3052: </a>                }
</span><span id="3053" class="l"><a class="l" href="#3053">3053: </a>                <span class="php-keyword1">return</span> <span class="php-keyword1">new</span> Kronolith_View_ExportEvent(<span class="php-var">$event</span>);
</span><span id="3054" class="l"><a class="l" href="#3054">3054: </a>            }
</span><span id="3055" class="l"><a class="l" href="#3055">3055: </a>        }
</span><span id="3056" class="l"><a class="l" href="#3056">3056: </a>    }
</span><span id="3057" class="l"><a class="l" href="#3057">3057: </a>
</span><span id="3058" class="l"><a class="l" href="#3058">3058: </a>    <span class="php-comment">/**
</span></span><span id="3059" class="l"><a class="l" href="#3059">3059: </a><span class="php-comment">     * Should we show event location, based on the show_location pref?
</span></span><span id="3060" class="l"><a class="l" href="#3060">3060: </a><span class="php-comment">     */</span>
</span><span id="3061" class="l"><a class="l" href="#3061">3061: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_viewShowLocation" href="#_viewShowLocation">viewShowLocation</a>()
</span><span id="3062" class="l"><a class="l" href="#3062">3062: </a>    {
</span><span id="3063" class="l"><a class="l" href="#3063">3063: </a>        <span class="php-var">$show</span> = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'show_location'</span>));
</span><span id="3064" class="l"><a class="l" href="#3064">3064: </a>        <span class="php-keyword1">return</span> @<span class="php-keyword2">in_array</span>(<span class="php-quote">'screen'</span>, <span class="php-var">$show</span>);
</span><span id="3065" class="l"><a class="l" href="#3065">3065: </a>    }
</span><span id="3066" class="l"><a class="l" href="#3066">3066: </a>
</span><span id="3067" class="l"><a class="l" href="#3067">3067: </a>    <span class="php-comment">/**
</span></span><span id="3068" class="l"><a class="l" href="#3068">3068: </a><span class="php-comment">     * Should we show event time, based on the show_time preference?
</span></span><span id="3069" class="l"><a class="l" href="#3069">3069: </a><span class="php-comment">     */</span>
</span><span id="3070" class="l"><a class="l" href="#3070">3070: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_viewShowTime" href="#_viewShowTime">viewShowTime</a>()
</span><span id="3071" class="l"><a class="l" href="#3071">3071: </a>    {
</span><span id="3072" class="l"><a class="l" href="#3072">3072: </a>        <span class="php-var">$show</span> = @<span class="php-keyword2">unserialize</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'show_time'</span>));
</span><span id="3073" class="l"><a class="l" href="#3073">3073: </a>        <span class="php-keyword1">return</span> @<span class="php-keyword2">in_array</span>(<span class="php-quote">'screen'</span>, <span class="php-var">$show</span>);
</span><span id="3074" class="l"><a class="l" href="#3074">3074: </a>    }
</span><span id="3075" class="l"><a class="l" href="#3075">3075: </a>
</span><span id="3076" class="l"><a class="l" href="#3076">3076: </a>    <span class="php-comment">/**
</span></span><span id="3077" class="l"><a class="l" href="#3077">3077: </a><span class="php-comment">     * Returns the background color for a calendar.
</span></span><span id="3078" class="l"><a class="l" href="#3078">3078: </a><span class="php-comment">     *
</span></span><span id="3079" class="l"><a class="l" href="#3079">3079: </a><span class="php-comment">     * @param array|Horde_Share_Object $calendar  A calendar share or a hash
</span></span><span id="3080" class="l"><a class="l" href="#3080">3080: </a><span class="php-comment">     *                                            from a remote calender
</span></span><span id="3081" class="l"><a class="l" href="#3081">3081: </a><span class="php-comment">     *                                            definition.
</span></span><span id="3082" class="l"><a class="l" href="#3082">3082: </a><span class="php-comment">     *
</span></span><span id="3083" class="l"><a class="l" href="#3083">3083: </a><span class="php-comment">     * @return string  A HTML color code.
</span></span><span id="3084" class="l"><a class="l" href="#3084">3084: </a><span class="php-comment">     */</span>
</span><span id="3085" class="l"><a class="l" href="#3085">3085: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_backgroundColor" href="#_backgroundColor">backgroundColor</a>(<span class="php-var">$calendar</span>)
</span><span id="3086" class="l"><a class="l" href="#3086">3086: </a>    {
</span><span id="3087" class="l"><a class="l" href="#3087">3087: </a>        <span class="php-var">$color</span> = <span class="php-quote">''</span>;
</span><span id="3088" class="l"><a class="l" href="#3088">3088: </a>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_array</span>(<span class="php-var">$calendar</span>)) {
</span><span id="3089" class="l"><a class="l" href="#3089">3089: </a>            <span class="php-var">$color</span> = <span class="php-var">$calendar</span>-&gt;get(<span class="php-quote">'color'</span>);
</span><span id="3090" class="l"><a class="l" href="#3090">3090: </a>        } <span class="php-keyword1">elseif</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$calendar</span>[<span class="php-quote">'color'</span>])) {
</span><span id="3091" class="l"><a class="l" href="#3091">3091: </a>            <span class="php-var">$color</span> = <span class="php-var">$calendar</span>[<span class="php-quote">'color'</span>];
</span><span id="3092" class="l"><a class="l" href="#3092">3092: </a>        }
</span><span id="3093" class="l"><a class="l" href="#3093">3093: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">empty</span>(<span class="php-var">$color</span>) ? <span class="php-quote">'#dddddd'</span> : <span class="php-var">$color</span>;
</span><span id="3094" class="l"><a class="l" href="#3094">3094: </a>    }
</span><span id="3095" class="l"><a class="l" href="#3095">3095: </a>
</span><span id="3096" class="l"><a class="l" href="#3096">3096: </a>    <span class="php-comment">/**
</span></span><span id="3097" class="l"><a class="l" href="#3097">3097: </a><span class="php-comment">     * Returns the foreground color for a calendar or a background color.
</span></span><span id="3098" class="l"><a class="l" href="#3098">3098: </a><span class="php-comment">     *
</span></span><span id="3099" class="l"><a class="l" href="#3099">3099: </a><span class="php-comment">     * @param array|Horde_Share_Object|string $calendar  A color string, a
</span></span><span id="3100" class="l"><a class="l" href="#3100">3100: </a><span class="php-comment">     *                                                   calendar share or a
</span></span><span id="3101" class="l"><a class="l" href="#3101">3101: </a><span class="php-comment">     *                                                   hash from a remote
</span></span><span id="3102" class="l"><a class="l" href="#3102">3102: </a><span class="php-comment">     *                                                   calender definition.
</span></span><span id="3103" class="l"><a class="l" href="#3103">3103: </a><span class="php-comment">     *
</span></span><span id="3104" class="l"><a class="l" href="#3104">3104: </a><span class="php-comment">     * @return string  A HTML color code.
</span></span><span id="3105" class="l"><a class="l" href="#3105">3105: </a><span class="php-comment">     */</span>
</span><span id="3106" class="l"><a class="l" href="#3106">3106: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_foregroundColor" href="#_foregroundColor">foregroundColor</a>(<span class="php-var">$calendar</span>)
</span><span id="3107" class="l"><a class="l" href="#3107">3107: </a>    {
</span><span id="3108" class="l"><a class="l" href="#3108">3108: </a>        <span class="php-keyword1">return</span> Horde_Image::brightness(<span class="php-keyword2">is_string</span>(<span class="php-var">$calendar</span>) ? <span class="php-var">$calendar</span> : self::backgroundColor(<span class="php-var">$calendar</span>)) &lt; <span class="php-num">128</span> ? <span class="php-quote">'#fff'</span> : <span class="php-quote">'#000'</span>;
</span><span id="3109" class="l"><a class="l" href="#3109">3109: </a>    }
</span><span id="3110" class="l"><a class="l" href="#3110">3110: </a>
</span><span id="3111" class="l"><a class="l" href="#3111">3111: </a>    <span class="php-comment">/**
</span></span><span id="3112" class="l"><a class="l" href="#3112">3112: </a><span class="php-comment">     * Returns the CSS color definition for a calendar.
</span></span><span id="3113" class="l"><a class="l" href="#3113">3113: </a><span class="php-comment">     *
</span></span><span id="3114" class="l"><a class="l" href="#3114">3114: </a><span class="php-comment">     * @param array|Horde_Share_Object $calendar  A calendar share or a hash
</span></span><span id="3115" class="l"><a class="l" href="#3115">3115: </a><span class="php-comment">     *                                            from a remote calender
</span></span><span id="3116" class="l"><a class="l" href="#3116">3116: </a><span class="php-comment">     *                                            definition.
</span></span><span id="3117" class="l"><a class="l" href="#3117">3117: </a><span class="php-comment">     * @param boolean $with_attribute             Whether to wrap the colors
</span></span><span id="3118" class="l"><a class="l" href="#3118">3118: </a><span class="php-comment">     *                                            inside a &quot;style&quot; attribute.
</span></span><span id="3119" class="l"><a class="l" href="#3119">3119: </a><span class="php-comment">     *
</span></span><span id="3120" class="l"><a class="l" href="#3120">3120: </a><span class="php-comment">     * @return string  A CSS string with color definitions.
</span></span><span id="3121" class="l"><a class="l" href="#3121">3121: </a><span class="php-comment">     */</span>
</span><span id="3122" class="l"><a class="l" href="#3122">3122: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getCSSColors" href="#_getCSSColors">getCSSColors</a>(<span class="php-var">$calendar</span>, <span class="php-var">$with_attribute</span> = <span class="php-keyword1">true</span>)
</span><span id="3123" class="l"><a class="l" href="#3123">3123: </a>    {
</span><span id="3124" class="l"><a class="l" href="#3124">3124: </a>        <span class="php-var">$css</span> = <span class="php-quote">'background-color:'</span> . self::backgroundColor(<span class="php-var">$calendar</span>) . <span class="php-quote">';color:'</span> . self::foregroundColor(<span class="php-var">$calendar</span>);
</span><span id="3125" class="l"><a class="l" href="#3125">3125: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$with_attribute</span>) {
</span><span id="3126" class="l"><a class="l" href="#3126">3126: </a>            <span class="php-var">$css</span> = <span class="php-quote">' style=&quot;'</span> . <span class="php-var">$css</span> . <span class="php-quote">'&quot;'</span>;
</span><span id="3127" class="l"><a class="l" href="#3127">3127: </a>        }
</span><span id="3128" class="l"><a class="l" href="#3128">3128: </a>        <span class="php-keyword1">return</span> <span class="php-var">$css</span>;
</span><span id="3129" class="l"><a class="l" href="#3129">3129: </a>    }
</span><span id="3130" class="l"><a class="l" href="#3130">3130: </a>
</span><span id="3131" class="l"><a class="l" href="#3131">3131: </a>    <span class="php-comment">/**
</span></span><span id="3132" class="l"><a class="l" href="#3132">3132: </a><span class="php-comment">     * Returns whether to display the ajax view.
</span></span><span id="3133" class="l"><a class="l" href="#3133">3133: </a><span class="php-comment">     *
</span></span><span id="3134" class="l"><a class="l" href="#3134">3134: </a><span class="php-comment">     * return boolean  True if the ajax view should be displayed.
</span></span><span id="3135" class="l"><a class="l" href="#3135">3135: </a><span class="php-comment">     */</span>
</span><span id="3136" class="l"><a class="l" href="#3136">3136: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_showAjaxView" href="#_showAjaxView">showAjaxView</a>()
</span><span id="3137" class="l"><a class="l" href="#3137">3137: </a>    {
</span><span id="3138" class="l"><a class="l" href="#3138">3138: </a>        <span class="php-keyword1">global</span> <span class="php-var">$prefs</span>, <span class="php-var">$session</span>;
</span><span id="3139" class="l"><a class="l" href="#3139">3139: </a>
</span><span id="3140" class="l"><a class="l" href="#3140">3140: </a>        <span class="php-var">$mode</span> = <span class="php-var">$session</span>-&gt;get(<span class="php-quote">'horde'</span>, <span class="php-quote">'mode'</span>);
</span><span id="3141" class="l"><a class="l" href="#3141">3141: </a>        <span class="php-keyword1">return</span> (<span class="php-var">$mode</span> == <span class="php-quote">'dynamic'</span> || (<span class="php-var">$prefs</span>-&gt;getValue(<span class="php-quote">'dynamic_view'</span>) &amp;&amp; <span class="php-var">$mode</span> == <span class="php-quote">'auto'</span>)) &amp;&amp; Horde::ajaxAvailable();
</span><span id="3142" class="l"><a class="l" href="#3142">3142: </a>    }
</span><span id="3143" class="l"><a class="l" href="#3143">3143: </a>
</span><span id="3144" class="l"><a class="l" href="#3144">3144: </a>    <span class="php-comment">/**
</span></span><span id="3145" class="l"><a class="l" href="#3145">3145: </a><span class="php-comment">     * Sorts an event list.
</span></span><span id="3146" class="l"><a class="l" href="#3146">3146: </a><span class="php-comment">     *
</span></span><span id="3147" class="l"><a class="l" href="#3147">3147: </a><span class="php-comment">     * @since Kronolith 3.0.5
</span></span><span id="3148" class="l"><a class="l" href="#3148">3148: </a><span class="php-comment">     *
</span></span><span id="3149" class="l"><a class="l" href="#3149">3149: </a><span class="php-comment">     * @param array $days  A list of days with events.
</span></span><span id="3150" class="l"><a class="l" href="#3150">3150: </a><span class="php-comment">     *
</span></span><span id="3151" class="l"><a class="l" href="#3151">3151: </a><span class="php-comment">     * @return array  The sorted day list.
</span></span><span id="3152" class="l"><a class="l" href="#3152">3152: </a><span class="php-comment">     */</span>
</span><span id="3153" class="l"><a class="l" href="#3153">3153: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_sortEvents" href="#_sortEvents">sortEvents</a>(<span class="php-var">$days</span>)
</span><span id="3154" class="l"><a class="l" href="#3154">3154: </a>    {
</span><span id="3155" class="l"><a class="l" href="#3155">3155: </a>        <span class="php-keyword1">foreach</span> (<span class="php-var">$days</span> <span class="php-keyword1">as</span> <span class="php-var">$day</span> =&gt; <span class="php-var">$devents</span>) {
</span><span id="3156" class="l"><a class="l" href="#3156">3156: </a>            <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$devents</span>)) {
</span><span id="3157" class="l"><a class="l" href="#3157">3157: </a>                <span class="php-keyword2">uasort</span>(<span class="php-var">$devents</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'Kronolith'</span>, <span class="php-quote">'_sortEventStartTime'</span>));
</span><span id="3158" class="l"><a class="l" href="#3158">3158: </a>                <span class="php-var">$days</span>[<span class="php-var">$day</span>] = <span class="php-var">$devents</span>;
</span><span id="3159" class="l"><a class="l" href="#3159">3159: </a>            }
</span><span id="3160" class="l"><a class="l" href="#3160">3160: </a>        }
</span><span id="3161" class="l"><a class="l" href="#3161">3161: </a>        <span class="php-keyword1">return</span> <span class="php-var">$days</span>;
</span><span id="3162" class="l"><a class="l" href="#3162">3162: </a>    }
</span><span id="3163" class="l"><a class="l" href="#3163">3163: </a>
</span><span id="3164" class="l"><a class="l" href="#3164">3164: </a>    <span class="php-comment">/**
</span></span><span id="3165" class="l"><a class="l" href="#3165">3165: </a><span class="php-comment">     * Used with usort() to sort events based on their start times.
</span></span><span id="3166" class="l"><a class="l" href="#3166">3166: </a><span class="php-comment">     */</span>
</span><span id="3167" class="l"><a class="l" href="#3167">3167: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> <a id="__sortEventStartTime" href="#__sortEventStartTime">_sortEventStartTime</a>(<span class="php-var">$a</span>, <span class="php-var">$b</span>)
</span><span id="3168" class="l"><a class="l" href="#3168">3168: </a>    {
</span><span id="3169" class="l"><a class="l" href="#3169">3169: </a>        <span class="php-var">$diff</span> = <span class="php-var">$a</span>-&gt;start-&gt;compareDateTime(<span class="php-var">$b</span>-&gt;start);
</span><span id="3170" class="l"><a class="l" href="#3170">3170: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$diff</span> == <span class="php-num">0</span>) {
</span><span id="3171" class="l"><a class="l" href="#3171">3171: </a>            <span class="php-keyword1">return</span> <span class="php-keyword2">strcoll</span>(<span class="php-var">$a</span>-&gt;title, <span class="php-var">$b</span>-&gt;title);
</span><span id="3172" class="l"><a class="l" href="#3172">3172: </a>        } <span class="php-keyword1">else</span> {
</span><span id="3173" class="l"><a class="l" href="#3173">3173: </a>            <span class="php-keyword1">return</span> <span class="php-var">$diff</span>;
</span><span id="3174" class="l"><a class="l" href="#3174">3174: </a>        }
</span><span id="3175" class="l"><a class="l" href="#3175">3175: </a>    }
</span><span id="3176" class="l"><a class="l" href="#3176">3176: </a>
</span><span id="3177" class="l"><a class="l" href="#3177">3177: </a>    <span class="php-comment">/**
</span></span><span id="3178" class="l"><a class="l" href="#3178">3178: </a><span class="php-comment">     * Obtain a Kronolith_Tagger instance
</span></span><span id="3179" class="l"><a class="l" href="#3179">3179: </a><span class="php-comment">     *
</span></span><span id="3180" class="l"><a class="l" href="#3180">3180: </a><span class="php-comment">     * @return Kronolith_Tagger
</span></span><span id="3181" class="l"><a class="l" href="#3181">3181: </a><span class="php-comment">     */</span>
</span><span id="3182" class="l"><a class="l" href="#3182">3182: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getTagger" href="#_getTagger">getTagger</a>()
</span><span id="3183" class="l"><a class="l" href="#3183">3183: </a>    {
</span><span id="3184" class="l"><a class="l" href="#3184">3184: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(self::<span class="php-var">$_tagger</span>)) {
</span><span id="3185" class="l"><a class="l" href="#3185">3185: </a>            self::<span class="php-var">$_tagger</span> = <span class="php-keyword1">new</span> Kronolith_Tagger();
</span><span id="3186" class="l"><a class="l" href="#3186">3186: </a>        }
</span><span id="3187" class="l"><a class="l" href="#3187">3187: </a>        <span class="php-keyword1">return</span> self::<span class="php-var">$_tagger</span>;
</span><span id="3188" class="l"><a class="l" href="#3188">3188: </a>    }
</span><span id="3189" class="l"><a class="l" href="#3189">3189: </a>
</span><span id="3190" class="l"><a class="l" href="#3190">3190: </a>    <span class="php-comment">/**
</span></span><span id="3191" class="l"><a class="l" href="#3191">3191: </a><span class="php-comment">     * Obtain an internal calendar. Use this where we don't know if we will
</span></span><span id="3192" class="l"><a class="l" href="#3192">3192: </a><span class="php-comment">     * have a Horde_Share or a Kronolith_Resource based calendar.
</span></span><span id="3193" class="l"><a class="l" href="#3193">3193: </a><span class="php-comment">     *
</span></span><span id="3194" class="l"><a class="l" href="#3194">3194: </a><span class="php-comment">     * @param string $target  The calendar id to retrieve.
</span></span><span id="3195" class="l"><a class="l" href="#3195">3195: </a><span class="php-comment">     *
</span></span><span id="3196" class="l"><a class="l" href="#3196">3196: </a><span class="php-comment">     * @return Kronolith_Resource|Horde_Share_Object
</span></span><span id="3197" class="l"><a class="l" href="#3197">3197: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="3198" class="l"><a class="l" href="#3198">3198: </a><span class="php-comment">     */</span>
</span><span id="3199" class="l"><a class="l" href="#3199">3199: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getInternalCalendar" href="#_getInternalCalendar">getInternalCalendar</a>(<span class="php-var">$target</span>)
</span><span id="3200" class="l"><a class="l" href="#3200">3200: </a>    {
</span><span id="3201" class="l"><a class="l" href="#3201">3201: </a>        <span class="php-keyword1">if</span> (Kronolith::getDriver(<span class="php-quote">'Resource'</span>)-&gt;isResourceCalendar(<span class="php-var">$target</span>)) {
</span><span id="3202" class="l"><a class="l" href="#3202">3202: </a>            <span class="php-var">$driver</span> = self::getDriver(<span class="php-quote">'Resource'</span>);
</span><span id="3203" class="l"><a class="l" href="#3203">3203: </a>            <span class="php-var">$id</span> = <span class="php-var">$driver</span>-&gt;getResourceIdByCalendar(<span class="php-var">$target</span>);
</span><span id="3204" class="l"><a class="l" href="#3204">3204: </a>            <span class="php-keyword1">return</span> <span class="php-var">$driver</span>-&gt;getResource(<span class="php-var">$id</span>);
</span><span id="3205" class="l"><a class="l" href="#3205">3205: </a>        } <span class="php-keyword1">else</span> {
</span><span id="3206" class="l"><a class="l" href="#3206">3206: </a>            <span class="php-keyword1">return</span> <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;getShare(<span class="php-var">$target</span>);
</span><span id="3207" class="l"><a class="l" href="#3207">3207: </a>        }
</span><span id="3208" class="l"><a class="l" href="#3208">3208: </a>    }
</span><span id="3209" class="l"><a class="l" href="#3209">3209: </a>
</span><span id="3210" class="l"><a class="l" href="#3210">3210: </a>    <span class="php-comment">/**
</span></span><span id="3211" class="l"><a class="l" href="#3211">3211: </a><span class="php-comment">     * Determines parameters needed to do an address search
</span></span><span id="3212" class="l"><a class="l" href="#3212">3212: </a><span class="php-comment">     *
</span></span><span id="3213" class="l"><a class="l" href="#3213">3213: </a><span class="php-comment">     * @return array  An array with two keys: 'fields' and 'sources'.
</span></span><span id="3214" class="l"><a class="l" href="#3214">3214: </a><span class="php-comment">     */</span>
</span><span id="3215" class="l"><a class="l" href="#3215">3215: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_getAddressbookSearchParams" href="#_getAddressbookSearchParams">getAddressbookSearchParams</a>()
</span><span id="3216" class="l"><a class="l" href="#3216">3216: </a>    {
</span><span id="3217" class="l"><a class="l" href="#3217">3217: </a>        <span class="php-var">$src</span> = <span class="php-keyword2">json_decode</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'search_sources'</span>));
</span><span id="3218" class="l"><a class="l" href="#3218">3218: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$src</span>)) {
</span><span id="3219" class="l"><a class="l" href="#3219">3219: </a>            <span class="php-var">$src</span> = <span class="php-keyword1">array</span>();
</span><span id="3220" class="l"><a class="l" href="#3220">3220: </a>        }
</span><span id="3221" class="l"><a class="l" href="#3221">3221: </a>
</span><span id="3222" class="l"><a class="l" href="#3222">3222: </a>        <span class="php-var">$fields</span> = <span class="php-keyword2">json_decode</span>(<span class="php-var">$GLOBALS</span>[<span class="php-quote">'prefs'</span>]-&gt;getValue(<span class="php-quote">'search_fields'</span>), <span class="php-keyword1">true</span>);
</span><span id="3223" class="l"><a class="l" href="#3223">3223: </a>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$fields</span>)) {
</span><span id="3224" class="l"><a class="l" href="#3224">3224: </a>            <span class="php-var">$fields</span> = <span class="php-keyword1">array</span>();
</span><span id="3225" class="l"><a class="l" href="#3225">3225: </a>        }
</span><span id="3226" class="l"><a class="l" href="#3226">3226: </a>
</span><span id="3227" class="l"><a class="l" href="#3227">3227: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(
</span><span id="3228" class="l"><a class="l" href="#3228">3228: </a>            <span class="php-quote">'fields'</span> =&gt; <span class="php-var">$fields</span>,
</span><span id="3229" class="l"><a class="l" href="#3229">3229: </a>            <span class="php-quote">'sources'</span> =&gt; <span class="php-var">$src</span>
</span><span id="3230" class="l"><a class="l" href="#3230">3230: </a>        );
</span><span id="3231" class="l"><a class="l" href="#3231">3231: </a>    }
</span><span id="3232" class="l"><a class="l" href="#3232">3232: </a>
</span><span id="3233" class="l"><a class="l" href="#3233">3233: </a>    <span class="php-comment">/**
</span></span><span id="3234" class="l"><a class="l" href="#3234">3234: </a><span class="php-comment">     * Checks whether an API (application) exists and the user has permission
</span></span><span id="3235" class="l"><a class="l" href="#3235">3235: </a><span class="php-comment">     * to access it.
</span></span><span id="3236" class="l"><a class="l" href="#3236">3236: </a><span class="php-comment">     *
</span></span><span id="3237" class="l"><a class="l" href="#3237">3237: </a><span class="php-comment">     * @param string $api    The API (application) to check.
</span></span><span id="3238" class="l"><a class="l" href="#3238">3238: </a><span class="php-comment">     * @param integer $perm  The permission to check.
</span></span><span id="3239" class="l"><a class="l" href="#3239">3239: </a><span class="php-comment">     *
</span></span><span id="3240" class="l"><a class="l" href="#3240">3240: </a><span class="php-comment">     * @return boolean  True if the API can be accessed.
</span></span><span id="3241" class="l"><a class="l" href="#3241">3241: </a><span class="php-comment">     */</span>
</span><span id="3242" class="l"><a class="l" href="#3242">3242: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_hasApiPermission" href="#_hasApiPermission">hasApiPermission</a>(<span class="php-var">$api</span>, <span class="php-var">$perm</span> = Horde_Perms::READ)
</span><span id="3243" class="l"><a class="l" href="#3243">3243: </a>    {
</span><span id="3244" class="l"><a class="l" href="#3244">3244: </a>        <span class="php-var">$app</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;hasInterface(<span class="php-var">$api</span>);
</span><span id="3245" class="l"><a class="l" href="#3245">3245: </a>        <span class="php-keyword1">return</span> (<span class="php-var">$app</span> &amp;&amp; <span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;hasPermission(<span class="php-var">$app</span>, <span class="php-var">$perm</span>));
</span><span id="3246" class="l"><a class="l" href="#3246">3246: </a>    }
</span><span id="3247" class="l"><a class="l" href="#3247">3247: </a>
</span><span id="3248" class="l"><a class="l" href="#3248">3248: </a>    <span class="php-comment">/**
</span></span><span id="3249" class="l"><a class="l" href="#3249">3249: </a><span class="php-comment">     * Remove all events owned by the specified user in all calendars.
</span></span><span id="3250" class="l"><a class="l" href="#3250">3250: </a><span class="php-comment">     *
</span></span><span id="3251" class="l"><a class="l" href="#3251">3251: </a><span class="php-comment">     * @since  Kronolith 3.0.10
</span></span><span id="3252" class="l"><a class="l" href="#3252">3252: </a><span class="php-comment">     *
</span></span><span id="3253" class="l"><a class="l" href="#3253">3253: </a><span class="php-comment">     * @param string $user  The user name to delete events for.
</span></span><span id="3254" class="l"><a class="l" href="#3254">3254: </a><span class="php-comment">     *
</span></span><span id="3255" class="l"><a class="l" href="#3255">3255: </a><span class="php-comment">     * @throws Kronolith_Exception
</span></span><span id="3256" class="l"><a class="l" href="#3256">3256: </a><span class="php-comment">     * @throws Horde_Exception_NotFound
</span></span><span id="3257" class="l"><a class="l" href="#3257">3257: </a><span class="php-comment">     * @throws Horde_Exception_PermissionDenied
</span></span><span id="3258" class="l"><a class="l" href="#3258">3258: </a><span class="php-comment">     */</span>
</span><span id="3259" class="l"><a class="l" href="#3259">3259: </a>    <span class="php-keyword1">static</span> <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <a id="_removeUserEvents" href="#_removeUserEvents">removeUserEvents</a>(<span class="php-var">$user</span>)
</span><span id="3260" class="l"><a class="l" href="#3260">3260: </a>    {
</span><span id="3261" class="l"><a class="l" href="#3261">3261: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$GLOBALS</span>[<span class="php-quote">'registry'</span>]-&gt;isAdmin()) {
</span><span id="3262" class="l"><a class="l" href="#3262">3262: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Horde_Exception_PermissionDenied();
</span><span id="3263" class="l"><a class="l" href="#3263">3263: </a>        }
</span><span id="3264" class="l"><a class="l" href="#3264">3264: </a>
</span><span id="3265" class="l"><a class="l" href="#3265">3265: </a>        <span class="php-keyword1">try</span> {
</span><span id="3266" class="l"><a class="l" href="#3266">3266: </a>            <span class="php-var">$shares</span> = <span class="php-var">$GLOBALS</span>[<span class="php-quote">'kronolith_shares'</span>]-&gt;listShares(
</span><span id="3267" class="l"><a class="l" href="#3267">3267: </a>                <span class="php-var">$user</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'perm'</span> =&gt; Horde_Perms::EDIT));
</span><span id="3268" class="l"><a class="l" href="#3268">3268: </a>        } <span class="php-keyword1">catch</span> (Horde_Share_Exception <span class="php-var">$e</span>) {
</span><span id="3269" class="l"><a class="l" href="#3269">3269: </a>            Horde::logMessage(<span class="php-var">$shares</span>, <span class="php-quote">'ERR'</span>);
</span><span id="3270" class="l"><a class="l" href="#3270">3270: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> Kronolith_Exception(<span class="php-var">$shares</span>);
</span><span id="3271" class="l"><a class="l" href="#3271">3271: </a>        }
</span><span id="3272" class="l"><a class="l" href="#3272">3272: </a>
</span><span id="3273" class="l"><a class="l" href="#3273">3273: </a>        <span class="php-keyword1">foreach</span> (<span class="php-keyword2">array_keys</span>(<span class="php-var">$shares</span>) <span class="php-keyword1">as</span> <span class="php-var">$calendar</span>) {
</span><span id="3274" class="l"><a class="l" href="#3274">3274: </a>            <span class="php-var">$driver</span> = Kronolith::getDriver(<span class="php-keyword1">null</span>, <span class="php-var">$calendar</span>);
</span><span id="3275" class="l"><a class="l" href="#3275">3275: </a>            <span class="php-var">$events</span> = <span class="php-var">$driver</span>-&gt;listEvents(<span class="php-keyword1">null</span>, <span class="php-keyword1">null</span>, <span class="php-keyword1">false</span>, <span class="php-keyword1">false</span>, <span class="php-keyword1">false</span>);
</span><span id="3276" class="l"><a class="l" href="#3276">3276: </a>            <span class="php-var">$uids</span> = <span class="php-keyword1">array</span>();
</span><span id="3277" class="l"><a class="l" href="#3277">3277: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$events</span> <span class="php-keyword1">as</span> <span class="php-var">$dayevents</span>) {
</span><span id="3278" class="l"><a class="l" href="#3278">3278: </a>                <span class="php-keyword1">foreach</span> (<span class="php-var">$dayevents</span> <span class="php-keyword1">as</span> <span class="php-var">$event</span>) {
</span><span id="3279" class="l"><a class="l" href="#3279">3279: </a>                    <span class="php-var">$uids</span>[] = <span class="php-var">$event</span>-&gt;uid;
</span><span id="3280" class="l"><a class="l" href="#3280">3280: </a>                }
</span><span id="3281" class="l"><a class="l" href="#3281">3281: </a>            }
</span><span id="3282" class="l"><a class="l" href="#3282">3282: </a>            <span class="php-keyword1">foreach</span> (<span class="php-var">$uids</span> <span class="php-keyword1">as</span> <span class="php-var">$uid</span>) {
</span><span id="3283" class="l"><a class="l" href="#3283">3283: </a>                <span class="php-var">$event</span> = <span class="php-var">$driver</span>-&gt;getByUID(<span class="php-var">$uid</span>, <span class="php-keyword1">array</span>(<span class="php-var">$calendar</span>));
</span><span id="3284" class="l"><a class="l" href="#3284">3284: </a>                <span class="php-var">$driver</span>-&gt;deleteEvent(<span class="php-var">$event</span>-&gt;id);
</span><span id="3285" class="l"><a class="l" href="#3285">3285: </a>            }
</span><span id="3286" class="l"><a class="l" href="#3286">3286: </a>        }
</span><span id="3287" class="l"><a class="l" href="#3287">3287: </a>    }
</span><span id="3288" class="l"><a class="l" href="#3288">3288: </a>
</span><span id="3289" class="l"><a class="l" href="#3289">3289: </a>}
</span><span id="3290" class="l"><a class="l" href="#3290">3290: </a></span></code></pre>

	<div id="footer">
		 API documentation generated by <a href="http://apigen.org">ApiGen</a>
	</div>
</div>
</div>
<script src="resources/combined.js?721046668"></script>
<script src="elementlist.js?328801949"></script>
</body>
</html>
